From: Kai Uwe Broulik <kde@privat.broulik.de>
Date: Mon, 13 May 2013 15:34:27 +0000
Subject: Add support for the Power Supply property of UPower which indicates if a battery
X-Git-Url: http://quickgit.kde.org/?p=kdelibs.git&a=commitdiff&h=b86adffd69a972f612e0fb00f8c4e8154142c730
---
Add support for the Power Supply property of UPower which indicates if a battery
is actually powering the machine (ie. laptop battery) or just reported by one
of your peripherals (eg. mouse, keyboard).
This will eventually allow other parties such as the battery notifier to disregard
them when calculating overall battery percentage or PowerDevil to notify about

REVIEW: 110384
CCBUG: 300787
---


--- a/solid/solid/backends/fakehw/fakebattery.cpp
+++ b/solid/solid/backends/fakehw/fakebattery.cpp
@@ -90,6 +90,11 @@
     return fakeDevice()->property("isRechargeable").toBool();
 }
 
+bool FakeBattery::isPowerSupply() const
+{
+    return fakeDevice()->property("isPowerSupply").toBool();
+}
+
 Solid::Battery::ChargeState FakeBattery::chargeState() const
 {
     QString state = fakeDevice()->property("chargeState").toString();

--- a/solid/solid/backends/fakehw/fakebattery.h
+++ b/solid/solid/backends/fakehw/fakebattery.h
@@ -46,6 +46,7 @@
     virtual int chargePercent() const;
 
     virtual bool isRechargeable() const;
+    virtual bool isPowerSupply() const;
     virtual Solid::Battery::ChargeState chargeState() const;
 
     void setChargeState(Solid::Battery::ChargeState newState);

--- a/solid/solid/backends/fakehw/fakecomputer.xml
+++ b/solid/solid/backends/fakehw/fakecomputer.xml
@@ -32,9 +32,22 @@
             <property key="voltageUnit">mV</property>
             <property key="voltage">11999</property>
             <property key="isRechargeable">true</property>
+            <property key="isPowerSupply">true</property>
             <property key="chargeState">discharging</property>
         </device>
-
+        <device udi="/org/kde/solid/fakehw/acpi_BAT1">
+            <property key="name">Miraculous Mouse</property>
+            <property key="vendor">Orange Inc.</property>
+            <property key="interfaces">Battery</property>
+            <property key="parent">/org/kde/solid/fakehw/computer</property>
+            <property key="isPluged">false</property>
+            <property key="batteryType">mouse</property>
+            <!-- Battery properties beyond charge percentage are only reported by UPower
+                 for primary batteries, not for other batteries like this mouse -->
+            <property key="isRechargeable">true</property>
+            <property key="isPowerSupply">true</property>
+            <property key="chargeState">discharging</property>
+        </device>
 
 
         <!-- So that it looks like a laptop,

--- a/solid/solid/backends/hal/halbattery.cpp
+++ b/solid/solid/backends/hal/halbattery.cpp
@@ -88,6 +88,17 @@
     return m_device->prop("battery.is_rechargeable").toBool();
 }
 
+bool Battery::isPowerSupply() const
+{
+    // NOTE Hal doesn't support the is power supply property, so we're assuming that primary
+    // and UPS batteries are power supply and all the others are not
+    if (type() == Solid::Battery::PrimaryBattery || type() == Solid::Battery::UpsBattery) {
+      return true;
+    }
+
+    return false;
+}
+
 Solid::Battery::ChargeState Battery::chargeState() const
 {
     bool charging = m_device->prop("battery.rechargeable.is_charging").toBool();

--- a/solid/solid/backends/hal/halbattery.h
+++ b/solid/solid/backends/hal/halbattery.h
@@ -45,12 +45,14 @@
     virtual int chargePercent() const;
 
     virtual bool isRechargeable() const;
+    virtual bool isPowerSupply() const;
     virtual Solid::Battery::ChargeState chargeState() const;
 
 Q_SIGNALS:
     void chargePercentChanged(int value, const QString &udi);
     void chargeStateChanged(int newState, const QString &udi);
     void plugStateChanged(bool newState, const QString &udi);
+    void powerSupplyStateChanged(bool newState, const QString &udi); // dummy
 
 private Q_SLOTS:
     void slotPropertyChanged(const QMap<QString,int> &changes);

--- a/solid/solid/backends/upower/upowerbattery.cpp
+++ b/solid/solid/backends/upower/upowerbattery.cpp
@@ -83,6 +83,11 @@
     return m_device.data()->prop("IsRechargeable").toBool();
 }
 
+bool Battery::isPowerSupply() const
+{
+    return m_device.data()->prop("PowerSupply").toBool();
+}
+
 Solid::Battery::ChargeState Battery::chargeState() const
 {
     Solid::Battery::ChargeState result = Solid::Battery::NoCharge;
@@ -116,6 +121,7 @@
         const bool old_isPlugged = m_isPlugged;
         const int old_chargePercent = m_chargePercent;
         const Solid::Battery::ChargeState old_chargeState = m_chargeState;
+        const bool old_isPowerSupply = m_isPowerSupply;
         updateCache();
 
         if (old_chargePercent != m_chargePercent)
@@ -132,6 +138,11 @@
         {
             emit plugStateChanged(m_isPlugged, m_device.data()->udi());
         }
+
+        if (old_isPowerSupply != m_isPowerSupply)
+        {
+            emit powerSupplyStateChanged(m_isPowerSupply, m_device.data()->udi());
+        }
     }
 }
 
@@ -140,6 +151,7 @@
     m_isPlugged = isPlugged();
     m_chargePercent = chargePercent();
     m_chargeState = chargeState();
+    m_isPowerSupply = isPowerSupply();
 }
 
 #include "backends/upower/upowerbattery.moc"

--- a/solid/solid/backends/upower/upowerbattery.h
+++ b/solid/solid/backends/upower/upowerbattery.h
@@ -46,6 +46,7 @@
     virtual int chargePercent() const;
 
     virtual bool isRechargeable() const;
+    virtual bool isPowerSupply() const;
     virtual Solid::Battery::ChargeState chargeState() const;
 
     // TODO report stuff like capacity, technology, time-to-full, time-to-empty, energy rates, vendor, etc.
@@ -54,6 +55,7 @@
     void chargePercentChanged(int value, const QString &udi);
     void chargeStateChanged(int newState, const QString &udi);
     void plugStateChanged(bool newState, const QString &udi);
+    void powerSupplyStateChanged(bool newState, const QString &udi);
 
 private Q_SLOTS:
     void slotChanged();
@@ -64,6 +66,7 @@
     bool m_isPlugged;
     int m_chargePercent;
     Solid::Battery::ChargeState m_chargeState;
+    bool m_isPowerSupply;
 };
 }
 }

--- a/solid/solid/backends/upower/upowerdevice.cpp
+++ b/solid/solid/backends/upower/upowerdevice.cpp
@@ -83,7 +83,7 @@
         case Solid::DeviceInterface::GenericInterface:
             return true;
         case Solid::DeviceInterface::Battery:
-            return (uptype == 2 || uptype == 3 || uptype == 5 || uptype == 6);
+            return (uptype == 2 || uptype == 3 || uptype == 5 || uptype == 6 || uptype == 7 || uptype == 8);
         case Solid::DeviceInterface::AcAdapter:
             return (uptype == 1);
         default:

--- a/solid/solid/battery.cpp
+++ b/solid/solid/battery.cpp
@@ -48,6 +48,12 @@
     return_SOLID_CALL(Ifaces::Battery *, d->backendObject(), false, isPlugged());
 }
 
+bool Solid::Battery::isPowerSupply() const
+{
+    Q_D(const Battery);
+    return_SOLID_CALL(Ifaces::Battery *, d->backendObject(), true, isPowerSupply());
+}
+
 Solid::Battery::BatteryType Solid::Battery::type() const
 {
     Q_D(const Battery);

--- a/solid/solid/battery.h
+++ b/solid/solid/battery.h
@@ -110,6 +110,14 @@
         bool isPlugged() const;
 
         /**
+         * Indicates if this battery is powering the machine or from an attached deviced.
+         *
+         * @since 4.11
+         * @return true the battery is a powersupply, false otherwise
+         */
+        bool isPowerSupply() const;
+
+        /**
          * Retrieves the type of device holding this battery.
          *
          * @return the type of device holding this battery

--- a/solid/solid/ifaces/battery.h
+++ b/solid/solid/ifaces/battery.h
@@ -75,6 +75,13 @@
         virtual bool isRechargeable() const = 0;
 
         /**
+         * Indicates if the battery is powering the machine.
+         *
+         * @return true if the battery is powersupply, false otherwise
+         */
+        virtual bool isPowerSupply() const = 0;
+
+        /**
          * Retrieves the current charge state of the battery. It can be in a stable
          * state (no charge), charging or discharging.
          *

From: Kai Uwe Broulik <kde@privat.broulik.de>
Date: Tue, 04 Jun 2013 13:21:35 +0000
Subject: Add missing Q_PROPERTY
X-Git-Url: http://quickgit.kde.org/?p=kdelibs.git&a=commitdiff&h=0a53c75a44e2e7106490b37c2fff6ad247390f2a
---
Add missing Q_PROPERTY
---


--- a/solid/solid/battery.h
+++ b/solid/solid/battery.h
@@ -38,6 +38,7 @@
         Q_OBJECT
         Q_ENUMS(BatteryType ChargeState)
         Q_PROPERTY(bool plugged READ isPlugged)
+        Q_PROPERTY(bool powerSupply READ isPowerSupply)
         Q_PROPERTY(BatteryType type READ type)
         Q_PROPERTY(int chargePercent READ chargePercent)
         Q_PROPERTY(bool rechargeable READ isRechargeable)

From: Kai Uwe Broulik <kde@privat.broulik.de>
Date: Tue, 04 Jun 2013 13:25:43 +0000
Subject: Add missing signal connection
X-Git-Url: http://quickgit.kde.org/?p=kdelibs.git&a=commitdiff&h=076f57e7d38315bd965d139908b8b397d363fd18
---
Add missing signal connection
---


--- a/solid/solid/battery.cpp
+++ b/solid/solid/battery.cpp
@@ -35,6 +35,9 @@
 
     connect(backendObject, SIGNAL(plugStateChanged(bool,QString)),
              this, SIGNAL(plugStateChanged(bool,QString)));
+
+    connect(backendObject, SIGNAL(powerSupplyStateChanged(bool,QString)),
+             this, SIGNAL(powerSupplyStateChanged(bool,QString)));
 }
 
 Solid::Battery::~Battery()

From: Kai Uwe Broulik <kde@privat.broulik.de>
Date: Tue, 04 Jun 2013 13:40:16 +0000
Subject: Add support for battery capacity
X-Git-Url: http://quickgit.kde.org/?p=kdelibs.git&a=commitdiff&h=2f674db466ead221afc29da0022e2c7ccf59c36e
---
Add support for battery capacity

REVIEW: 110607
---


--- a/solid/solid/backends/fakehw/fakebattery.cpp
+++ b/solid/solid/backends/fakehw/fakebattery.cpp
@@ -85,6 +85,16 @@
     return percent;
 }
 
+int FakeBattery::capacity() const
+{
+    int last_full = fakeDevice()->property("lastFullLevel").toInt();
+    int max = fakeDevice()->property("maxLevel").toInt();
+
+    int percent = (100 * last_full) / max;
+
+    return percent;
+}
+
 bool FakeBattery::isRechargeable() const
 {
     return fakeDevice()->property("isRechargeable").toBool();

--- a/solid/solid/backends/fakehw/fakebattery.h
+++ b/solid/solid/backends/fakehw/fakebattery.h
@@ -44,6 +44,7 @@
     virtual Solid::Battery::BatteryType type() const;
 
     virtual int chargePercent() const;
+    virtual int capacity() const;
 
     virtual bool isRechargeable() const;
     virtual bool isPowerSupply() const;

--- a/solid/solid/backends/hal/halbattery.cpp
+++ b/solid/solid/backends/hal/halbattery.cpp
@@ -83,6 +83,14 @@
     return m_device->prop("battery.charge_level.percentage").toInt();
 }
 
+int Battery::capacity() const
+{
+    const qreal lastFull = m_device->prop("battery.charge_level.last_full").toDouble();
+    const qreal designFull = m_device->prop("battery.charge_level.design").toDouble();
+
+    return lastFull / designFull;
+}
+
 bool Battery::isRechargeable() const
 {
     return m_device->prop("battery.is_rechargeable").toBool();
@@ -125,6 +133,12 @@
         emit chargePercentChanged(chargePercent(), m_device->udi());
     }
 
+    if (changes.contains("battery.charge_level.last_full")
+           || changes.contains("battery.charge_level.design"))
+    {
+        emit capacityChanged(capacity(), m_device->udi());
+    }
+
     if (changes.contains("battery.rechargeable.is_charging")
            || changes.contains("battery.rechargeable.is_discharging"))
     {

--- a/solid/solid/backends/hal/halbattery.h
+++ b/solid/solid/backends/hal/halbattery.h
@@ -43,6 +43,7 @@
     virtual Solid::Battery::BatteryType type() const;
 
     virtual int chargePercent() const;
+    virtual int capacity() const;
 
     virtual bool isRechargeable() const;
     virtual bool isPowerSupply() const;
@@ -50,6 +51,7 @@
 
 Q_SIGNALS:
     void chargePercentChanged(int value, const QString &udi);
+    void capacityChanged(int value, const QString &udi);
     void chargeStateChanged(int newState, const QString &udi);
     void plugStateChanged(bool newState, const QString &udi);
     void powerSupplyStateChanged(bool newState, const QString &udi); // dummy

--- a/solid/solid/backends/upower/upowerbattery.cpp
+++ b/solid/solid/backends/upower/upowerbattery.cpp
@@ -78,6 +78,11 @@
     return qRound(m_device.data()->prop("Percentage").toDouble());
 }
 
+int Battery::capacity() const
+{
+    return m_device.data()->prop("Capacity").toDouble();
+}
+
 bool Battery::isRechargeable() const
 {
     return m_device.data()->prop("IsRechargeable").toBool();
@@ -118,15 +123,20 @@
 void Battery::slotChanged()
 {
     if (m_device) {
+        const int old_chargePercent = m_chargePercent;
+        const int old_capacity = m_capacity;
+        const Solid::Battery::ChargeState old_chargeState = m_chargeState;
         const bool old_isPlugged = m_isPlugged;
-        const int old_chargePercent = m_chargePercent;
-        const Solid::Battery::ChargeState old_chargeState = m_chargeState;
         const bool old_isPowerSupply = m_isPowerSupply;
         updateCache();
 
         if (old_chargePercent != m_chargePercent)
         {
             emit chargePercentChanged(m_chargePercent, m_device.data()->udi());
+        }
+
+        if (old_capacity != m_capacity) {
+            emit capacityChanged(m_capacity, m_device.data()->udi());
         }
 
         if (old_chargeState != m_chargeState)
@@ -150,6 +160,7 @@
 {
     m_isPlugged = isPlugged();
     m_chargePercent = chargePercent();
+    m_capacity = capacity();
     m_chargeState = chargeState();
     m_isPowerSupply = isPowerSupply();
 }

--- a/solid/solid/backends/upower/upowerbattery.h
+++ b/solid/solid/backends/upower/upowerbattery.h
@@ -44,15 +44,18 @@
     virtual Solid::Battery::BatteryType type() const;
 
     virtual int chargePercent() const;
+    virtual int capacity() const;
 
     virtual bool isRechargeable() const;
     virtual bool isPowerSupply() const;
+
     virtual Solid::Battery::ChargeState chargeState() const;
 
-    // TODO report stuff like capacity, technology, time-to-full, time-to-empty, energy rates, vendor, etc.
+    // TODO report stuff like technology, time-to-full, time-to-empty, energy rates, vendor, etc.
 
 Q_SIGNALS:
     void chargePercentChanged(int value, const QString &udi);
+    void capacityChanged(int value, const QString &udi);
     void chargeStateChanged(int newState, const QString &udi);
     void plugStateChanged(bool newState, const QString &udi);
     void powerSupplyStateChanged(bool newState, const QString &udi);
@@ -65,6 +68,7 @@
 
     bool m_isPlugged;
     int m_chargePercent;
+    int m_capacity;
     Solid::Battery::ChargeState m_chargeState;
     bool m_isPowerSupply;
 };

--- a/solid/solid/battery.cpp
+++ b/solid/solid/battery.cpp
@@ -29,6 +29,9 @@
 {
     connect(backendObject, SIGNAL(chargePercentChanged(int,QString)),
              this, SIGNAL(chargePercentChanged(int,QString)));
+
+    connect(backendObject, SIGNAL(capacityChanged(int,QString)),
+             this, SIGNAL(capacityChanged(int,QString)));
 
     connect(backendObject, SIGNAL(chargeStateChanged(int,QString)),
              this, SIGNAL(chargeStateChanged(int,QString)));
@@ -69,6 +72,12 @@
     return_SOLID_CALL(Ifaces::Battery *, d->backendObject(), 0, chargePercent());
 }
 
+int Solid::Battery::capacity() const
+{
+    Q_D(const Battery);
+    return_SOLID_CALL(Ifaces::Battery *, d->backendObject(), 100, capacity());
+}
+
 bool Solid::Battery::isRechargeable() const
 {
     Q_D(const Battery);

--- a/solid/solid/battery.h
+++ b/solid/solid/battery.h
@@ -41,6 +41,7 @@
         Q_PROPERTY(bool powerSupply READ isPowerSupply)
         Q_PROPERTY(BatteryType type READ type)
         Q_PROPERTY(int chargePercent READ chargePercent)
+        Q_PROPERTY(int capacity READ capacity)
         Q_PROPERTY(bool rechargeable READ isRechargeable)
         Q_PROPERTY(ChargeState chargeState READ chargeState)
         Q_DECLARE_PRIVATE(Battery)
@@ -136,6 +137,14 @@
          */
         int chargePercent() const;
 
+        /**
+         * Retrieves the battery capacity normalised to percent,
+         * meaning how much energy can it hold compared to what it is designed to.
+         *
+         * @since 4.11
+         * @return the battery capacity normalised to percent
+         */
+        int capacity() const;
 
 
         /**

--- a/solid/solid/ifaces/battery.h
+++ b/solid/solid/ifaces/battery.h
@@ -66,6 +66,15 @@
          */
         virtual int chargePercent() const = 0;
 
+        /**
+         * Retrieves the battery capacity normalised to percent,
+         * meaning how much energy can it hold compared to what it is designed to.
+         *
+         * @since 4.11
+         * @return the battery capacity normalised to percent
+         */
+        virtual int capacity() const = 0;
+
 
         /**
          * Indicates if the battery is rechargeable.

