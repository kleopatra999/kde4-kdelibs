Index: kate/syntax/data/lilypond.xml
===================================================================
--- kate/syntax/data/lilypond.xml	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kate/syntax/data/lilypond.xml	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -8,7 +8,7 @@
   <!ENTITY scripts "\d+|accent|marcato|staccat(issim)?o|espressivo|tenuto|portato|(up|down)(bow|mordent|prall)|flageolet|thumb|[lr](heel|toe)|open|stopped|turn|reverseturn|trill|mordent|prall(prall|mordent|down|up)?|lineprall|signumcongruentiae|(short|long|verylong)?fermata|segno|(var)?coda">
   <!ENTITY keywords "accepts|alias|consists|defaultchild|denies|description|grobdescriptions|include|invalid|name|objectid|once|remove|sequential|simultaneous|type|version|score|book|bookpart">
   <!ENTITY deprecatedkeywords "consistsend">
-  <!ENTITY commands "acciaccatura|addQuote|afterGrace|aikenHeads|allowPageTurn|alternative|apply(Context|Music|Output)|appoggiatura|arpeggio(Arrow(Down|Up)|Bracket|Normal|Parenthesis)?|(a|de)scendens|auctum|augmentum|autoBeamO(ff|n)|autochange|balloon(Grob)?Text|bar|barNumberCheck|bendAfter|breathe|break|cadenzaO(ff|n)|cavum|clef(\s+(treble|violin|G|alto|C|(sub)?bass|F|french|(mezzo)?soprano|(var)?baritone|percussion|tab))?|(end)?(de)?cr|cresc(TextCresc|Hairpin)|(cue|transposedCue)During|default|deminutum|dim(Text(Decresc|Decr|Dim)|Hairpin)|display(Lily)?Music|divisio(Maior|Maxima|Minima)|(dynamic|dots|phrasingSlur|slur|stem|tie|tuplet)(Down|Neutral|Up)|(balloon|text)LengthO(ff|n)|featherDurations|figure(mode|s)|finalis|flexa|(french|german|italian|semiGerman)Chords|glissando|grace|harmonic|(unH|h)ideNotes|(hide|show)StaffSwitch|inclinatum|(keep|remove)WithTag|key(\s+&pitch;)?|killCues|label|laissezVibrer|linea|mark|maxima|melisma(End)?|mergeDifferently(Head|Dott)edO(ff|n)|newSpacingSection|no(Beam|Break|PageBreak|PageTurn)|normalsize|numericTimeSignature|octaveCheck|oneVoice|oriscus|ottava|page(-ref|Break|Turn)|parallelMusic|parenthesize|partcombine|partial(\s*&duration;)?|pes|pitchedTrill|pointAndClickO(ff|n)|quilisma|quoteDuring|relative(\s+&pitch;)?|RemoveEmptyStaffContext|repeat(\s+(unfold|volta|tremolo|percent)(\s+\d+)?)?|repeatTie|resetRelativeOctave|rest|sacredHarpHeads|scaleDurations|scoreTweak|easyHeadsO(ff|n)|shift(Durations|Off|On{1,3})|(slur|tie)(Both|Dashed|Dotted|Solid)|small|spacingTweaks|(start|stop)(Group|(Text|Trill)Span|Staff)|stemBoth|stropha|super|(sustain|sostenuto)O(ff|n)|table-of-contents|tag|times?(\s*\d+/\d+)?|tiny|tocItem|transpose(\s+&pitch;\s*&pitch;)?|transposition(\s+&pitch;)|tweak|unfoldRepeats|virg(ul)?a|voice(One|Two|Three|Four)|withMusicProperty|cm|mm|in|pt|major|minor|ionian|locrian|aeolian|mixolydian|lydian|phrygian|dorian">
+  <!ENTITY commands "acciaccatura|addQuote|afterGrace|aikenHeads|allowPageTurn|alternative|apply(Context|Music|Output)|appoggiatura|arpeggio(Arrow(Down|Up)|Bracket|Normal|Parenthesis)?|(a|de)scendens|auctum|augmentum|autoBeamO(ff|n)|autochange|balloon(Grob)?Text|bar|barNumberCheck|bendAfter|breathe|break|cadenzaO(ff|n)|cavum|clef(\s+(treble|violin|G|alto|C|tenor|(sub)?bass|F|french|(mezzo)?soprano|(var)?baritone|percussion|tab))?|(end)?(de)?cr|cresc(TextCresc|Hairpin)|(cue|transposedCue)During|default|deminutum|dim(Text(Decresc|Decr|Dim)|Hairpin)|display(Lily)?Music|divisio(Maior|Maxima|Minima)|(dynamic|dots|phrasingSlur|slur|stem|tie|tuplet)(Down|Neutral|Up)|(balloon|text)LengthO(ff|n)|featherDurations|figure(mode|s)|finalis|flexa|(french|german|italian|semiGerman)Chords|glissando|grace|harmonic|(unH|h)ideNotes|(hide|show)StaffSwitch|inclinatum|(keep|remove)WithTag|key(\s+&pitch;)?|killCues|label|laissezVibrer|linea|mark|maxima|melisma(End)?|mergeDifferently(Head|Dott)edO(ff|n)|newSpacingSection|no(Beam|Break|PageBreak|PageTurn)|normalsize|numericTimeSignature|octaveCheck|oneVoice|oriscus|ottava|page(-ref|Break|Turn)|parallelMusic|parenthesize|partcombine|partial(\s*&duration;)?|pes|pitchedTrill|pointAndClickO(ff|n)|quilisma|quoteDuring|relative(\s+&pitch;)?|RemoveEmptyStaffContext|repeat(\s+(unfold|volta|tremolo|percent)(\s+\d+)?)?|repeatTie|resetRelativeOctave|rest|sacredHarpHeads|scaleDurations|scoreTweak|easyHeadsO(ff|n)|shift(Durations|Off|On{1,3})|(slur|tie)(Both|Dashed|Dotted|Solid)|small|spacingTweaks|(start|stop)(Group|(Text|Trill)Span|Staff)|stemBoth|stropha|super|(sustain|sostenuto)O(ff|n)|table-of-contents|tag|times?(\s*\d+/\d+)?|tiny|tocItem|transpose(\s+&pitch;\s*&pitch;)?|transposition(\s+&pitch;)|tweak|unfoldRepeats|virg(ul)?a|voice(One|Two|Three|Four)|withMusicProperty|cm|mm|in|pt|major|minor|ionian|locrian|aeolian|mixolydian|lydian|phrygian|dorian">
   <!ENTITY deprecatedcommands "arpeggio(Up|Down|Neutral)|newpage|script(Up|Down|Both)|(empty|fat)Text|setEasyHeads|(default|voice|modernVoice|piano|forget)Accidentals|(modern(Voice)?|piano)Cautionaries|noResetKey|compressMusic|octave|(sustain|sostenuto)(Down|Up)|set(Hairpin|Text)(Cresc|Decresc|Dim)|setTextDecr">
   <!ENTITY markupnotextargs "arrow-head|beam|char|(semi|sesqui|double)?(flat|sharp)|draw-(circle|line)|epsfile|filled-box|fret-diagram(-terse|-verbose)?|fromproperty|harp-pedal|(justify|wordwrap)-(field|string)|lookup|markalphabet|markletter|musicglyph|natural|note-by-number|note|null|simple|(back)?slashed-digit|stencil|strut|tied-lyric|triangle|verbatim-file">
   <!ENTITY markupwithtextargs "markup|bold|(rounded-)?box|bracket|caps|(center|general|left|right)-align|circle|((center|dir|left|right)-)?column|combine|concat|dynamic|fill-line|finger|fontCaps|(abs-)?fontsize|fraction|halign|hbracket|hcenter-in|hcenter|hspace|huge|italic|justify|larger?|line|lower|magnify|medium|normal-size-(sub|super)|normal-text|normalsize|number|on-the-fly|override|pad-(around|markup|to-box|x)|page-ref|postscript|put-adjacent|raise|roman|rotate|sans|small(er)?|smallCaps|sub|super|teeny|text|tiny|translate(-scaled)?|transparent|typewriter|underline|upright|vcenter|whiteout|with-(color|dimensions|url)|wordwrap|(markup|column-|justified-|override-|wordwrap-)lines|wordwrap-(string-)?internal">
@@ -26,7 +26,7 @@
 ]>
 <language name="LilyPond" section="Other"
           style="lilypond" indenter="lilypond"
-          version="3.03" kateversion="3.0"
+          version="3.04" kateversion="3.0"
           extensions="*.ly;*.LY;*.ily;*.ILY;*.lyi;*.LYI"
           mimetype="text/x-lilypond"
           author="Wilbert Berendsen (info@wilbertberendsen.nl)" license="LGPL">
Index: kioslave/file/file_unix.cpp
===================================================================
--- kioslave/file/file_unix.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kioslave/file/file_unix.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -531,8 +531,10 @@
        *****/
 
       kDebug( 7101 ) << "Deleting directory " << url.url();
-      if (!deleteRecursive(path))
-          return;
+      if (metaData(QLatin1String("recurse")) == QLatin1String("true")) {
+          if (!deleteRecursive(path))
+              return;
+      }
       if ( ::rmdir( _path.data() ) == -1 ) {
 	if ((errno == EACCES) || (errno == EPERM))
 	  error(KIO::ERR_ACCESS_DENIED, path);
Index: kio/kio/accessmanagerreply_p.cpp
===================================================================
--- kio/kio/accessmanagerreply_p.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kio/kio/accessmanagerreply_p.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -141,7 +141,8 @@
             }
         }
 
-        setAttribute(QNetworkRequest::User, kioJob->metaData().toVariant());
+        setAttribute(static_cast<QNetworkRequest::Attribute>(KIO::AccessManager::MetaData),
+                     kioJob->metaData().toVariant());
         d->m_metaDataRead = true;
     }
 
@@ -215,10 +216,10 @@
             break;
         default:
             setError(QNetworkReply::UnknownNetworkError, errorString());
-            setAttribute(static_cast<QNetworkRequest::Attribute>(KIO::AccessManager::KioError), errcode);
             kDebug() << errcode;
     }
 
+    setAttribute(static_cast<QNetworkRequest::Attribute>(KIO::AccessManager::KioError), errcode);
     emit finished();
 }
 
Index: kio/kio/job.h
===================================================================
--- kio/kio/job.h	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kio/kio/job.h	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -47,9 +47,9 @@
      * Removes a single directory.
      *
      * The directory is assumed to be empty.
+     * The job will fail if the directory is not empty.
+     * Use KIO::del() (DeleteJob) to delete non-empty directories.
      *
-     *
-     *
      * @param url The URL of the directory to remove.
      * @return A pointer to the job handling the operation.
      */
Index: kio/kio/deletejob.cpp
===================================================================
--- kio/kio/deletejob.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kio/kio/deletejob.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -219,7 +219,7 @@
         // Fast path for KFileItems in directory views
         while(m_currentStat != m_srcList.end()) {
             m_currentURL = (*m_currentStat);
-            KFileItem cachedItem = KDirLister::cachedItemForUrl(m_currentURL);
+            const KFileItem cachedItem = KDirLister::cachedItemForUrl(m_currentURL);
             if (cachedItem.isNull())
                 break;
             //kDebug(7007) << "Found cached info about" << m_currentURL << "isDir=" << cachedItem.isDir() << "isLink=" << cachedItem.isLink();
@@ -343,6 +343,7 @@
                 // Call rmdir - works for kioslaves with canDeleteRecursive too,
                 // CMD_DEL will trigger the recursive deletion in the slave.
                 SimpleJob* job = KIO::rmdir( *it );
+                job->addMetaData(QString::fromLatin1("recurse"), "true");
                 Scheduler::scheduleJob(job);
                 dirs.erase(it);
                 q->addSubjob( job );
Index: kio/tests/jobtest.h
===================================================================
--- kio/tests/jobtest.h	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kio/tests/jobtest.h	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -64,6 +64,8 @@
     void deleteManyDirs();
     void deleteManyFilesIndependently();
     void deleteManyFilesTogether();
+    void rmdirEmpty();
+    void rmdirNotEmpty();
     void stat();
     void mimeType();
     //void newApiPerformance();
Index: kio/tests/jobtest.cpp
===================================================================
--- kio/tests/jobtest.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kio/tests/jobtest.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -1315,6 +1315,26 @@
     deleteManyFilesTogether(false);
 }
 
+void JobTest::rmdirEmpty()
+{
+    const QString dir = homeTmpDir() + "dir";
+    QDir().mkdir(dir);
+    QVERIFY(QFile::exists(dir));
+    KIO::Job* job = KIO::rmdir(dir);
+    QVERIFY(job->exec());
+    QVERIFY(!QFile::exists(dir));
+}
+
+void JobTest::rmdirNotEmpty()
+{
+    const QString dir = homeTmpDir() + "dir";
+    createTestDirectory(dir);
+    createTestDirectory(dir + "/subdir");
+    KIO::Job* job = KIO::rmdir(dir);
+    QVERIFY(!job->exec());
+    QVERIFY(QFile::exists(dir));
+}
+
 void JobTest::stat()
 {
 #if 1
Index: kdecore/services/kmimetype.cpp
===================================================================
--- kdecore/services/kmimetype.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kdecore/services/kmimetype.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -233,6 +233,11 @@
     return KMimeType::Ptr();
 }
 
+static bool mimeTypeListSortByName(const KMimeType::Ptr& m1, const KMimeType::Ptr& m2)
+{
+    return m1->name() < m2->name();
+}
+
 /*
 
 As agreed on the XDG list (and unlike the current shared-mime spec):
@@ -341,6 +346,8 @@
         if (accuracy)
             *accuracy = 20;
         // We have to pick one...
+        // At least make this deterministic
+        qSort(mimeList.begin(), mimeList.end(), mimeTypeListSortByName);
         return mimeList.first();
     }
 
Index: kdecore/localization/klocale_p.h
===================================================================
--- kdecore/localization/klocale_p.h	(.../tags/KDE/4.3.2/kdelibs)	(wersja 0)
+++ kdecore/localization/klocale_p.h	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -0,0 +1,29 @@
+/*  This file is part of the KDE libraries
+ *  Copyright 2009 David Faure <faure@kde.org>
+ *
+ *  This library is free software; you can redistribute it and/or
+ *  modify it under the terms of the GNU Library General Public
+ *  License as published by the Free Software Foundation; either
+ *  version 2 of the License, or (at your option) any later version.
+ *
+ *  This library is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *  Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU Library General Public License
+ *  along with this library; see the file COPYING.LIB.  If not, write to
+ *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+ *  Boston, MA 02110-1301, USA.
+ */
+
+#ifndef KLOCALE_P_H
+#define KLOCALE_P_H
+
+class QMutex;
+
+// Used by both KLocale and KLocalizedString, since they call each other.
+QMutex* kLocaleMutex();
+
+#endif /* KLOCALE_P_H */
+
Index: kdecore/localization/klocalizedstring.cpp
===================================================================
--- kdecore/localization/klocalizedstring.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kdecore/localization/klocalizedstring.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -24,6 +24,7 @@
 #include <kglobal.h>
 #include <kdebug.h>
 #include <klocale.h>
+#include <klocale_p.h>
 #include <kcomponentdata.h>
 #include <klibrary.h>
 #include <kstandarddirs.h>
@@ -126,8 +127,6 @@
 
     QHash<QString, KuitSemantics*> formatters;
 
-    QMutex mutex;
-
     KLocalizedStringPrivateStatics () :
         theFence("|/|"),
         startInterp("$["),
@@ -144,9 +143,7 @@
 
         translits(),
 
-        formatters(),
-
-        mutex(QMutex::Recursive)
+        formatters()
     {}
 
     ~KLocalizedStringPrivateStatics ()
@@ -216,7 +213,7 @@
 QString KLocalizedStringPrivate::toString (const KLocale *locale) const
 {
     KLocalizedStringPrivateStatics *s = staticsKLSP;
-    QMutexLocker lock(&s->mutex);
+    QMutexLocker lock(kLocaleMutex());
 
     // Assure the message has been supplied.
     if (msg.isEmpty())
@@ -474,7 +471,7 @@
                                              const QString &ctxt) const
 {
     KLocalizedStringPrivateStatics *s = staticsKLSP;
-    QMutexLocker lock(&s->mutex);
+    QMutexLocker lock(kLocaleMutex());
 
     QString final = text;
 
@@ -499,7 +496,7 @@
                                                        bool &fallback) const
 {
     KLocalizedStringPrivateStatics *s = staticsKLSP;
-    QMutexLocker lock(&s->mutex);
+    QMutexLocker lock(kLocaleMutex());
 
     if (s->ktrs == NULL)
         // Scripting engine not available.
@@ -564,7 +561,7 @@
     // fallback is set to true if Transcript evaluation requested so.
 
     KLocalizedStringPrivateStatics *s = staticsKLSP;
-    QMutexLocker lock(&s->mutex);
+    QMutexLocker lock(kLocaleMutex());
 
     result.clear();
     fallback = false;
@@ -716,7 +713,7 @@
 QVariant KLocalizedStringPrivate::segmentToValue (const QString &seg) const
 {
     KLocalizedStringPrivateStatics *s = staticsKLSP;
-    QMutexLocker lock(&s->mutex);
+    QMutexLocker lock(kLocaleMutex());
 
     // Return invalid variant if segment is either not a proper
     // value reference, or the reference is out of bounds.
@@ -751,7 +748,7 @@
                                                  const QString &final) const
 {
     KLocalizedStringPrivateStatics *s = staticsKLSP;
-    QMutexLocker lock(&s->mutex);
+    QMutexLocker lock(kLocaleMutex());
 
     if (s->ktrs == NULL)
         // Scripting engine not available.
@@ -945,7 +942,7 @@
 void KLocalizedStringPrivate::loadTranscript ()
 {
     KLocalizedStringPrivateStatics *s = staticsKLSP;
-    QMutexLocker lock(&s->mutex);
+    QMutexLocker lock(kLocaleMutex());
 
     s->loadTranscriptCalled = true;
     s->ktrs = NULL; // null indicates that Transcript is not available
@@ -979,7 +976,8 @@
         return;
     }
     KLocalizedStringPrivateStatics *s = staticsKLSP;
-    QMutexLocker lock(&s->mutex);
+    // Very important: do not the mutex here.
+    //QMutexLocker lock(kLocaleMutex());
 
     // Find script modules for all included language/catalogs that have them,
     // and remember their paths.
Index: kdecore/localization/klocale.cpp
===================================================================
--- kdecore/localization/klocale.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kdecore/localization/klocale.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -22,6 +22,7 @@
 */
 
 #include "klocale.h"
+#include "klocale_p.h"
 
 #include <config.h>
 
@@ -242,7 +243,6 @@
   // Handling of translation catalogs
   QStringList languageList;
 
-  QMutex* mutex;
   QList<KCatalogName> catalogNames; // list of all catalogs (regardless of language)
   QList<KCatalog> catalogs; // list of all found catalogs, one instance per catalog name and language
   int numberOfSysCatalogs; // number of catalogs that each app draws from
@@ -276,7 +276,6 @@
 KLocalePrivate::KLocalePrivate(const QString& catalog, KConfig *config, const QString &language_, const QString &country_)
     : language(language_),
       country(country_),
-      mutex(new QMutex(QMutex::Recursive)),
       useTranscript(false),
       codecForEncoding(0),
       languages(0), calendar(0),
@@ -311,7 +310,7 @@
 void KLocalePrivate::initMainCatalogs()
 {
   KLocaleStaticData *s = staticData;
-  QMutexLocker lock(mutex);
+  QMutexLocker lock(kLocaleMutex());
 
   if (!s->maincatalog.isEmpty()) {
       // If setMainCatalog was called, then we use that (e.g. korgac calls setMainCatalog("korganizer") to use korganizer.po)
@@ -541,7 +540,7 @@
 
 bool KLocalePrivate::setLanguage(const QString & _language, KConfig *config)
 {
-  QMutexLocker lock(mutex);
+  QMutexLocker lock(kLocaleMutex());
   languageList.removeAll( _language );
   languageList.prepend( _language ); // let us consider this language to be the most important one
 
@@ -563,7 +562,7 @@
 
 bool KLocalePrivate::setLanguage(const QStringList & languages)
 {
-  QMutexLocker lock(mutex);
+  QMutexLocker lock(kLocaleMutex());
   // This list might contain
   // 1) some empty strings that we have to eliminate
   // 2) duplicate entries like in de:fr:de, where we have to keep the first occurrence of a language in order
@@ -685,7 +684,7 @@
 
 void KLocale::insertCatalog( const QString & catalog )
 {
-  QMutexLocker lock(d->mutex);
+  QMutexLocker lock(kLocaleMutex());
     int pos = d->catalogNames.indexOf(KCatalogName(catalog));
     if (pos != -1) {
         ++d->catalogNames[pos].loadCount;
@@ -736,7 +735,7 @@
 
 void KLocale::removeCatalog(const QString &catalog)
 {
-    QMutexLocker lock(d->mutex);
+    QMutexLocker lock(kLocaleMutex());
     int pos = d->catalogNames.indexOf(KCatalogName(catalog));
     if (pos == -1)
         return;
@@ -749,7 +748,7 @@
 
 void KLocale::setActiveCatalog(const QString &catalog)
 {
-    QMutexLocker lock(d->mutex);
+    QMutexLocker lock(kLocaleMutex());
     int pos = d->catalogNames.indexOf(KCatalogName(catalog));
     if (pos == -1)
         return;
@@ -759,7 +758,6 @@
 
 KLocale::~KLocale()
 {
-    delete d->mutex;
     delete d->calendar;
     delete d->languages;
     delete d;
@@ -788,7 +786,7 @@
                 << "Fix the program" << endl;
   }
 
-  QMutexLocker locker(mutex);
+  QMutexLocker locker(kLocaleMutex());
   // determine the fallback string
   QString fallback;
   if ( msgid_plural == NULL )
@@ -1370,7 +1368,7 @@
     //Kibi-byte             KiB             2^10    1,024 bytes
 
     if (d->byteSizeFmt.size() == 0) {
-        QMutexLocker lock(d->mutex);
+        QMutexLocker lock(kLocaleMutex());
         // Pretranslated format strings for byte sizes.
         #define CACHEBYTEFMT(x) { \
             QString s; \
@@ -2568,7 +2566,6 @@
 {
   d->languages = 0; // Don't copy languages
   d->calendar = 0; // Don't copy the calendar
-  d->mutex = 0; // Don't copy the mutex
 }
 
 KLocale & KLocale::operator=(const KLocale & rhs)
@@ -2583,8 +2580,7 @@
 
 void KLocale::copyCatalogsTo(KLocale *locale)
 {
-    QMutexLocker lock(d->mutex);
-    QMutexLocker lockOther(locale->d->mutex);
+    QMutexLocker lock(kLocaleMutex());
     locale->d->catalogNames = d->catalogNames;
     locale->d->updateCatalogs();
 }
@@ -2656,3 +2652,9 @@
 {
     return d->dateTimeDigitSet;
 }
+
+Q_GLOBAL_STATIC_WITH_ARGS(QMutex, s_kLocaleMutex, (QMutex::Recursive))
+QMutex* kLocaleMutex()
+{
+    return s_kLocaleMutex();
+}
Index: kdecore/tests/kmimetypetest.cpp
===================================================================
--- kdecore/tests/kmimetypetest.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kdecore/tests/kmimetypetest.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -166,14 +166,12 @@
     QTest::newRow("old kdelnk file is x-desktop too") << "foo.kdelnk" << "application/x-desktop";
     QTest::newRow("double-extension file") << "foo.tar.bz2" << "application/x-bzip-compressed-tar";
     QTest::newRow("single-extension file") << "foo.bz2" << "application/x-bzip";
-//    QTest::newRow(".doc should assume msword") << "somefile.doc" << "application/msword";
+    QTest::newRow(".doc should assume msword") << "somefile.doc" << "application/msword"; // #204139
     QTest::newRow("glob that uses [] syntax, 1") << "Makefile" << "text/x-makefile";
     QTest::newRow("glob that uses [] syntax, 2") << "makefile" << "text/x-makefile";
     QTest::newRow("glob that ends with *, no extension") << "README" << "text/x-readme";
     QTest::newRow("glob that ends with *, extension") << "README.foo" << "text/x-readme";
     QTest::newRow("glob that ends with *, also matches *.txt. Higher weight wins.") << "README.txt" << "text/plain";
-    // This test has undefined results if we can't use sniffing to sort out whether it's word or text/plain.
-    //QTest::newRow("glob that ends with *, also matches *.doc, which is either word or text/plain.") << "README.doc" << "text/plain";
     QTest::newRow("glob that ends with *, also matches *.nfo. Higher weight wins.") << "README.nfo" << "text/x-nfo";
     // fdo bug 15436, needs shared-mime-info >= 0.40 (and this tests the globs2-parsing code).
     QTest::newRow("glob that ends with *, also matches *.pdf. *.pdf has higher weight") << "README.pdf" << "application/pdf";
Index: khtml/khtml_ext.cpp
===================================================================
--- khtml/khtml_ext.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ khtml/khtml_ext.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -193,33 +193,35 @@
 {
     if ( m_extensionProxy )
     {
-        callExtensionProxyMethod( "cut()" );
+        callExtensionProxyMethod( "cut" );
         return;
     }
 
     if ( !m_editableFormWidget )
         return;
 
-    if ( m_editableFormWidget->inherits( "QLineEdit" ) )
-        static_cast<QLineEdit *>( &(*m_editableFormWidget) )->cut();
-    else if ( m_editableFormWidget->inherits( "QTextEdit" ) )
-        static_cast<QTextEdit *>( &(*m_editableFormWidget) )->cut();
+    QLineEdit* lineEdit = qobject_cast<QLineEdit *>( m_editableFormWidget );
+    if ( lineEdit && !lineEdit->isReadOnly() )
+        lineEdit->cut();
+    QTextEdit* textEdit = qobject_cast<QTextEdit *>( m_editableFormWidget );
+    if ( textEdit && !textEdit->isReadOnly() )
+        textEdit->cut();
 }
 
 void KHTMLPartBrowserExtension::copy()
 {
     if ( m_extensionProxy )
     {
-        callExtensionProxyMethod( "copy()" );
+        callExtensionProxyMethod( "copy" );
         return;
     }
 
-    kDebug( 6050 ) << "************! KHTMLPartBrowserExtension::copy()";
     if ( !m_editableFormWidget )
     {
         // get selected text and paste to the clipboard
         QString text = m_part->selectedText();
         text.replace( QChar( 0xa0 ), ' ' );
+        //kDebug(6050) << text;
 
         QClipboard *cb = QApplication::clipboard();
         disconnect( cb, SIGNAL( selectionChanged() ), m_part, SLOT( slotClearSelection() ) );
@@ -249,10 +251,12 @@
     }
     else
     {
-        if ( m_editableFormWidget->inherits( "QLineEdit" ) )
-            static_cast<QLineEdit *>( &(*m_editableFormWidget) )->copy();
-        else if ( m_editableFormWidget->inherits( "QTextEdit" ) )
-            static_cast<QTextEdit *>( &(*m_editableFormWidget) )->copy();
+        QLineEdit* lineEdit = qobject_cast<QLineEdit *>( m_editableFormWidget );
+        if ( lineEdit )
+            lineEdit->copy();
+        QTextEdit* textEdit = qobject_cast<QTextEdit *>( m_editableFormWidget );
+        if ( textEdit )
+            textEdit->copy();
     }
 }
 
@@ -285,17 +289,19 @@
 {
     if ( m_extensionProxy )
     {
-        callExtensionProxyMethod( "paste()" );
+        callExtensionProxyMethod( "paste" );
         return;
     }
 
     if ( !m_editableFormWidget )
         return;
 
-    if ( m_editableFormWidget->inherits( "QLineEdit" ) )
-        static_cast<QLineEdit *>( &(*m_editableFormWidget) )->paste();
-    else if ( m_editableFormWidget->inherits( "QTextEdit" ) )
-        static_cast<QTextEdit *>( &(*m_editableFormWidget) )->paste();
+    QLineEdit* lineEdit = qobject_cast<QLineEdit *>( m_editableFormWidget );
+    if ( lineEdit && !lineEdit->isReadOnly() )
+        lineEdit->paste();
+    QTextEdit* textEdit = qobject_cast<QTextEdit *>( m_editableFormWidget );
+    if ( textEdit && !textEdit->isReadOnly() )
+        textEdit->paste();
 }
 
 void KHTMLPartBrowserExtension::callExtensionProxyMethod( const char *method )
@@ -303,10 +309,6 @@
     if ( !m_extensionProxy )
         return;
 
-    int slot = m_extensionProxy->metaObject()->indexOfSlot( method );
-    if ( slot == -1 )
-        return;
-
     QMetaObject::invokeMethod(m_extensionProxy, method, Qt::DirectConnection);
 }
 
Index: khtml/khtml_part.cpp
===================================================================
--- khtml/khtml_part.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ khtml/khtml_part.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -609,8 +609,7 @@
 
   if ( d->m_view )
   {
-    d->m_view->hide();
-    d->m_view->viewport()->hide();
+    widget()->hide();
     d->m_view->m_part = 0;
   }
 
@@ -5549,10 +5548,14 @@
 
 void KHTMLPart::emitSelectionChanged()
 {
-  emit d->m_extension->enableAction( "copy", hasSelection() );
-
-  emit d->m_extension->selectionInfo( selectedText() );
-  emit selectionChanged();
+    // Don't emit signals about our selection if this is a frameset;
+    // the active frame has the selection (#187403)
+    if (!d->m_activeFrame)
+    {
+        emit d->m_extension->enableAction( "copy", hasSelection() );
+        emit d->m_extension->selectionInfo( selectedText() );
+        emit selectionChanged();
+    }
 }
 
 int KHTMLPart::zoomFactor() const
Index: khtml/html/html_formimpl.cpp
===================================================================
--- khtml/html/html_formimpl.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ khtml/html/html_formimpl.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -1005,7 +1005,7 @@
 
 bool HTMLGenericFormElementImpl::isFocusable() const
 {
-    if (disabled() || readOnly())
+    if (disabled())
 	return false;
 
     //Non-widget INPUT TYPE="image" and <BUTTON> support focus, too.
Index: khtml/rendering/render_form.cpp
===================================================================
--- khtml/rendering/render_form.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ khtml/rendering/render_form.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -265,10 +265,10 @@
 {
     m_widget->setEnabled(!element()->disabled());
 
-    // If we've disabled/made r/o a focused element, clear its focus,
+    // If we've disabled a focused element, clear its focus,
     // so Qt doesn't do funny stuff like let one type into a disabled
     // line edit.
-    if ((element()->disabled() || element()->readOnly()) && element()->focused())
+    if (element()->disabled() && element()->focused())
         document()->quietResetFocus();
 
     RenderWidget::updateFromElement();
Index: kded/kded.cpp
===================================================================
--- kded/kded.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kded/kded.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -516,7 +516,8 @@
    {
       if(!delayedCheck)
          updateDirWatch(); // this would search all the directories
-      runBuildSycoca();
+      if (bCheckSycoca)
+         runBuildSycoca();
       recreateDone();
       if(delayedCheck)
       {
@@ -810,9 +811,6 @@
 
           Kded *kded = Kded::self();
 
-          if (bCheckSycoca)
-              runBuildSycoca();
-
           kded->recreate(true); // initial
 
           if (bCheckUpdates)
Index: kdeui/dialogs/kaboutapplicationdialog.cpp
===================================================================
--- kdeui/dialogs/kaboutapplicationdialog.cpp	(.../tags/KDE/4.3.2/kdelibs)	(wersja 1032821)
+++ kdeui/dialogs/kaboutapplicationdialog.cpp	(.../branches/KDE/4.3/kdelibs)	(wersja 1032821)
@@ -172,7 +172,8 @@
 
         const QList<KAboutPerson> lst = aboutData->authors();
         for (int i = 0; i < lst.size(); ++i) {
-            authorPageText += QString("<p style=\"margin: 0px;\">%1</p>").arg(lst.at(i).name());
+            QString pname = i18nc("@item Author name in about dialog", "%1", lst.at(i).name());
+            authorPageText += QString("<p style=\"margin: 0px;\">%1</p>").arg(pname);
             if (!lst.at(i).emailAddress().isEmpty())
                 authorPageText += QString("<p style=\"margin: 0px; margin-left: 15px;\"><a href=\"mailto:%1\">%1</a></p>").arg(lst.at(i).emailAddress());
             if (!lst.at(i).webAddress().isEmpty())
@@ -196,7 +197,8 @@
 
         const QList<KAboutPerson> lst = aboutData->credits();
         for (int i = 0; i < lst.size(); ++i) {
-            creditsPageText += QString("<p style=\"margin: 0px;\">%1</p>").arg(lst.at(i).name());
+            QString pname = i18nc("@item Contributor name in about dialog.", "%1", lst.at(i).name());
+            creditsPageText += QString("<p style=\"margin: 0px;\">%1</p>").arg(pname);
             if (!lst.at(i).emailAddress().isEmpty())
                 creditsPageText += QString("<p style=\"margin: 0px; margin-left: 15px;\"><a href=\"mailto:%1\">%1</a></p>").arg(lst.at(i).emailAddress());
             if (!lst.at(i).webAddress().isEmpty())

Zmiany atrybutów dla: .
___________________________________________________________________
Dodane: svn:externals
   + 


