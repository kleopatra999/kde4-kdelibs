Index: khtml/khtmlview.cpp
===================================================================
--- khtml/khtmlview.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/khtmlview.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -97,6 +97,10 @@
 
 #if QT_VERSION < 0x040500
   #define FIX_QT_BROKEN_QWIDGET_SCROLL
+  #define SCROLLBAR_WIDTH_HACK
+#include <QStyle>
+#include <QLayout>
+#include <QStyleOption>
 #endif
 
 #include <limits.h>
@@ -752,10 +756,15 @@
         if (RenderWidget* rw = m_kwp->renderWidget()) {
             int ret = rw->width()-rw->paddingLeft()-rw->paddingRight()-rw->borderLeft()-rw->borderRight();
             if (verticalScrollBar()->isVisible()) {
-                ret -= style()->pixelMetric(QStyle::PM_ScrollBarExtent);
-                int lhs = style()->pixelMetric(QStyle::PM_LayoutHorizontalSpacing);
-                if (lhs > 0)
-                    ret -= lhs;
+                ret -= verticalScrollBar()->sizeHint().width();
+#ifdef SCROLLBAR_WIDTH_HACK
+        // ### hackish turnaround for a bug in QAbstractScrollArea triggered by Oxygen.
+        QStyleOption opt(0);
+        opt.init(this);
+        if (style()->styleHint(QStyle::SH_ScrollView_FrameOnlyAroundContents, &opt, this)) {
+                    ret -= style()->pixelMetric(QStyle::PM_DefaultFrameWidth)*2;
+        }
+#endif
                 ret = qMax(0, ret);
             }
             return ret;
@@ -771,10 +780,15 @@
         if (RenderWidget* rw = m_kwp->renderWidget()) {
             int ret = rw->height()-rw->paddingBottom()-rw->paddingTop()-rw->borderTop()-rw->borderBottom();
             if (horizontalScrollBar()->isVisible()) {
-                ret -= style()->pixelMetric(QStyle::PM_ScrollBarExtent);
-                int lvs = style()->pixelMetric(QStyle::PM_LayoutVerticalSpacing);
-                if (lvs > 0)
-                    ret -= lvs;
+                ret -= horizontalScrollBar()->sizeHint().height();
+#ifdef SCROLLBAR_WIDTH_HACK
+                // ### hackish turnaround for a bug in QAbstractScrollArea triggered by Oxygen.
+                QStyleOption opt(0);
+                opt.init(this);
+                if (style()->styleHint(QStyle::SH_ScrollView_FrameOnlyAroundContents, &opt, this)) {
+                    ret -= style()->pixelMetric(QStyle::PM_DefaultFrameWidth)*2;
+                }
+#endif
                 ret = qMax(0, ret);
             }
             return ret;
@@ -904,8 +918,17 @@
 
     QApplication::sendPostedEvents(viewport(), QEvent::Paint);
 
-    if ( m_part && m_part->xmlDocImpl() )
-        m_part->xmlDocImpl()->dispatchWindowEvent( EventImpl::RESIZE_EVENT, false, false );
+    if ( m_part && m_part->xmlDocImpl() ) {
+        if (m_part->parentPart()) {
+            // sub-frame : queue the resize event until our toplevel is done layouting
+            khtml::ChildFrame *cf = m_part->parentPart()->frame( m_part );
+            cf->m_partContainerElement->postResizeEvent();
+        } else {
+            // toplevel : dispatch sub-frames'resize events before our own
+            HTMLPartContainerElementImpl::sendPostedResizeEvents();
+            m_part->xmlDocImpl()->dispatchWindowEvent( EventImpl::RESIZE_EVENT, false, false );
+        }
+    }
 }
 
 void KHTMLView::paintEvent( QPaintEvent *e )
Index: khtml/misc/idstring.cpp
===================================================================
--- khtml/misc/idstring.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/misc/idstring.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -25,25 +25,62 @@
 
 namespace khtml {
 
+CaseNormalizeMode IDTableBase::MappingKey::caseNormalizationMode;
+
+bool IDTableBase::MappingKey::operator==(const MappingKey& other) const
+{
+    if (IDTableBase::MappingKey::caseNormalizationMode == IDS_CaseSensitive)
+        return str == other.str;
+    else
+        return !strcasecmp(str, other.str);
+}
+
+static inline unsigned int qHash(const IDTableBase::MappingKey& key) {
+    if (key.str.isNull() || key.caseNormalizationMode == IDS_CaseSensitive) {
+        return qHash(key.str);
+    } else if (key.caseNormalizationMode == IDS_NormalizeLower) {
+        return key.str.implementation()->lowerHash();
+    } else { // caseNormalizationMode == IDS_NormalizeUpper
+        return key.str.implementation()->upperHash();
+    }
+}
+
 void IDTableBase::releaseId(unsigned id)
 {
+    IDTableBase::MappingKey::caseNormalizationMode = IDS_CaseSensitive;
+
     m_mappingLookup.remove(m_mappings[id].name);
     m_idFreeList.append(id);
 }
 
-unsigned short IDTableBase::grabId(const DOMString& name)
+unsigned short IDTableBase::grabId(const DOMString& origName, CaseNormalizeMode cnm)
 {
     unsigned short newId;
 
-    // Check for existing one
-    QHash<DOMString, unsigned short>::const_iterator i = m_mappingLookup.constFind(name);
+    // Check for existing one, ignoring case if needed
+    IDTableBase::MappingKey::caseNormalizationMode = cnm;
+    QHash<MappingKey, unsigned short>::const_iterator i = m_mappingLookup.constFind(origName);
     if (i != m_mappingLookup.constEnd()) {
         newId = *i;
         refId(newId);
         return newId;
     }
 
-    // Nope. Allocate new ID.
+    // Nope. Allocate new ID. If there is normalization going on, we may now have to 
+    // update our case so the canonical mapping is of the expected case.
+    DOMString name;
+    switch (cnm) {
+    case IDS_CaseSensitive:
+        name = origName;
+        break;
+    case IDS_NormalizeUpper:
+        name = origName.upper();
+        break;
+    case IDS_NormalizeLower:
+        name = origName.lower();
+        break;
+    }
+
     if (!m_idFreeList.isEmpty()) {
         // Grab from freelist..
         newId = m_idFreeList.last();
@@ -73,6 +110,8 @@
 
 void IDTableBase::addStaticMapping(unsigned id, const DOMString& name)
 {
+    IDTableBase::MappingKey::caseNormalizationMode = IDS_CaseSensitive;
+
     assert(id == m_mappings.size());
     assert(!m_mappingLookup.contains(name));
     m_mappings.append(Mapping(name));
Index: khtml/misc/idstring.h
===================================================================
--- khtml/misc/idstring.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/misc/idstring.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -32,6 +32,15 @@
 
 namespace khtml {
 
+// When we're working with a case-insensitive language, IDString can lookup
+// IDs from strings ignoring the case itself; however it needs to be told
+// what the canonical case is, so it knows what hash code to look for.
+enum CaseNormalizeMode {
+    IDS_CaseSensitive,
+    IDS_NormalizeUpper, 
+    IDS_NormalizeLower  
+};
+
 /**
  An IDString is used to manage an identifier namespace that has some predefined constants,
  but can be extended with new ones at runtime
@@ -79,9 +88,9 @@
         return nw;
     }
 
-    static IDString<TableFactory> fromString(const DOMString& string) {
+    static IDString<TableFactory> fromString(const DOMString& string, CaseNormalizeMode cnm = IDS_CaseSensitive) {
         IDString<TableFactory> nw;
-        nw.m_id = TableFactory::idTable()->grabId(string); // Refs it already.
+        nw.m_id = TableFactory::idTable()->grabId(string, cnm); // Refs it already.
         return nw;
     }
 
@@ -105,6 +114,21 @@
         Mapping(const DOMString& _name): refCount(0), name(_name)
         {}
     };
+    
+
+public:
+    // Wraps around DOMString and lets us trigger key sensitivity for lookup;
+    // that's done via a global fiddle --- warning, warning, warning.
+    struct MappingKey
+    {
+        DOMString str;
+        bool operator==(const MappingKey& other) const;
+        
+        MappingKey() {}
+        MappingKey(const DOMString& v): str(v) {}
+        
+        static CaseNormalizeMode caseNormalizationMode;
+    };
 protected:
     void refId(unsigned id) {
         if (id == 0xFFFF)
@@ -124,7 +148,7 @@
         return m_mappings[id].name;
     }
 
-    unsigned short grabId(const DOMString& string);
+    unsigned short grabId(const DOMString& string, CaseNormalizeMode cnm);
 
 public:
     // Registers a compile-type known ID constant with the name.
@@ -139,7 +163,7 @@
 
     WTF::Vector <unsigned> m_idFreeList;
     WTF::Vector <Mapping>  m_mappings;
-    QHash       <DOMString, unsigned short> m_mappingLookup;
+    QHash       <MappingKey, unsigned short> m_mappingLookup;
 };
 
 template<typename TableFactory>
Index: khtml/test_regression_fontoverload.cpp
===================================================================
--- khtml/test_regression_fontoverload.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/test_regression_fontoverload.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -36,7 +36,12 @@
 #include <QtGui/QX11Info>
 #include <QtGui/QPainter>
 #include <fixx11h.h>
+#include <QtGlobal>
 
+#if QT_VERSION >= 0x040500
+  #define QT_45
+#endif
+
 struct MetricsInfo {
     const char* name;
     int ascent;
@@ -174,29 +179,49 @@
     int   pixS;
     XFontStruct* xfs;
 
+    QtFontDim fallBackWidth() const {
+        QtFontDim fbw = xfs->min_bounds.width;
+        if (xfs->per_char) {
+            if (haveMetrics)
+                fbw = m_ascent; //### we really should get rid of these and regen..
+            else
+                fbw = xfs->ascent;
+        }
+        return fbw;
+    }
+
+#ifdef QT_45
+    void recalcAdvances(QGlyphLayout *glyphs, QTextEngine::ShaperFlags flags) const
+    {
+        QFontEngineXLFD::recalcAdvances(glyphs, flags);
+
+        // Go through the glyhs with glyph 0 and fix up their x advance
+        // to make sense (or at least match Qt3)
+        QtFontDim fbw = fallBackWidth();
+
+        for (int c = 0; c < glyphs->numGlyphs; ++c) {
+            if (!glyphs->glyphs[c])
+                glyphs->advances_x[c] = fbw;
+        }
+    }
+#else
     void recalcAdvances(int len, QGlyphLayout *glyphs, QTextEngine::ShaperFlags flags) const
     {
         QFontEngineXLFD::recalcAdvances(len, glyphs, flags);
 
         // Go through the glyhs with glyph 0 and fix up their x advance
         // to make sense (or at least match Qt3)
-        // ### set proper GPLv2 and Qt (c) when committed
-        QtFontDim fallBackWidth = xfs->min_bounds.width;
-        if (xfs->per_char) {
-            if (haveMetrics)
-                fallBackWidth = m_ascent; //### we really should get rid of these and regen..
-            else
-                fallBackWidth = xfs->ascent;
-        }
+        QtFontDim fbw = fallBackWidth();
 
         QGlyphLayout* g = glyphs + len;
         while (g != glyphs) {
             --g;
             if (!g->glyph) {
-                g->advance.x = fallBackWidth;
+                g->advance.x = fbw;
             }
         }
     }
+#endif
 
     Type type() const
     {
@@ -246,10 +271,18 @@
 
 void QX11PaintEngine::drawFreetype(const QPointF &p, const QTextItemInt &si)
 {
-    if (!si.num_glyphs) return;
+#ifdef QT_45
+    int cnt = si.glyphs.numGlyphs;
+#else
+    int cnt = si.num_glyph;
+#endif
 
+
+    if (!cnt) return;
+
     QFakeFontEngine *eng = static_cast<QFakeFontEngine*>(si.fontEngine);
 
+
     int x       = int(p.x());
     int y       = int(p.y());
     int pixS    = int(eng->pixS);
@@ -259,14 +292,19 @@
     
     if (si.flags & QTextItem::RightToLeft)
     {
-        x       = x + advance * (si.num_glyphs - 1);
+        x       = x + advance * (cnt - 1);
         advance = -advance;
     }
 
-    for (int pos = 0; pos < si.num_glyphs; ++pos)
+    for (int pos = 0; pos < cnt; ++pos)
     {
         QRect rect;
+
+#ifdef QT_45
+        switch (si.chars[pos].unicode())
+#else
         switch (si.glyphs[pos].glyph)
+#endif
         {
         case ' ':
             rect = QRect();
Index: khtml/khtml_part.cpp
===================================================================
--- khtml/khtml_part.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/khtml_part.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -90,6 +90,7 @@
 #include <klocale.h>
 #include <kmessagebox.h>
 #include <kstandardaction.h>
+#include <kstandardguiitem.h>
 #include <kactioncollection.h>
 #include <kfiledialog.h>
 #include <kmimetypetrader.h>
@@ -415,14 +416,18 @@
           // Nobody else does it...
           d->m_paIncZoomFactor->setShortcut( KShortcut("CTRL++; CTRL+=") );
           d->m_paDecZoomFactor->setShortcut( QKeySequence(Qt::CTRL + Qt::Key_Minus) );
+          d->m_paIncZoomFactor->setShortcutContext( Qt::WidgetWithChildrenShortcut );
+          d->m_paDecZoomFactor->setShortcutContext( Qt::WidgetWithChildrenShortcut );
       }
   }
 
   d->m_paFind = actionCollection()->addAction( KStandardAction::Find, "find", this, SLOT( slotFind() ) );
+  d->m_paFind->setShortcutContext( Qt::WidgetWithChildrenShortcut ); // default context conflicts when splitting konqueror
   d->m_paFind->setWhatsThis( i18n( "Find text<br /><br />"
                                    "Shows a dialog that allows you to find text on the displayed page." ) );
 
   d->m_paFindNext = actionCollection()->addAction( KStandardAction::FindNext, "findNext", this, SLOT( slotFindNext() ) );
+  d->m_paFindNext->setShortcutContext( Qt::WidgetWithChildrenShortcut );
   d->m_paFindNext->setWhatsThis( i18n( "Find next<br /><br />"
                                        "Find the next occurrence of the text that you "
                                        "have found using the <b>Find Text</b> function" ) );
@@ -477,6 +482,7 @@
   d->m_paToggleCaretMode = new KToggleAction(i18n("Toggle Caret Mode"), this );
   actionCollection()->addAction( "caretMode", d->m_paToggleCaretMode );
   d->m_paToggleCaretMode->setShortcut( QKeySequence(Qt::Key_F7) );
+  d->m_paToggleCaretMode->setShortcutContext( Qt::WidgetWithChildrenShortcut );
   connect( d->m_paToggleCaretMode, SIGNAL( triggered( bool ) ), this, SLOT(slotToggleCaretMode()) );
   d->m_paToggleCaretMode->setChecked(isCaretMode());
   if (parentPart())
@@ -6602,10 +6608,14 @@
     int response = KMessageBox::Cancel;
     if (!message.isEmpty())
     {
+            // Dangerous flag makes the Cancel button the default
             response = KMessageBox::warningContinueCancel( 0,
                                                            message.subs(Qt::escape(linkURL.prettyUrl())).toString(),
                                                            i18n( "Security Warning" ),
-                                                           KGuiItem(button));
+                                                           KGuiItem(button),
+                                                           KStandardGuiItem::cancel(),
+                                                           QString(), // no don't ask again info
+                                                           KMessageBox::Notify | KMessageBox::Dangerous );
     }
     else
     {
Index: khtml/html/htmltokenizer.cpp
===================================================================
--- khtml/html/htmltokenizer.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/htmltokenizer.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -75,12 +75,12 @@
 
 #ifndef NDEBUG
 static const int sTokenizerChunkSize = 2048;
-static const int sTokenizerFastYeldDelay = 220;
-static const int sTokenizerYeldDelay = 650;
+static const int sTokenizerFastYieldDelay = 220;
+static const int sTokenizerYieldDelay = 650;
 #else
 static const int sTokenizerChunkSize = 4096;
-static const int sTokenizerFastYeldDelay = 180;
-static const int sTokenizerYeldDelay = 450;
+static const int sTokenizerFastYieldDelay = 180;
+static const int sTokenizerYieldDelay = 450;
 #endif
 
 #define KHTML_ALLOC_QCHAR_VEC( N ) (QChar*) malloc( sizeof(QChar)*( N ) )
@@ -147,10 +147,11 @@
     parser = new KHTMLParser(_view, _doc);
     m_executingScript = 0;
     m_autoCloseTimer = 0;
-    m_tokenizerYeldDelay = sTokenizerFastYeldDelay;
-    m_yeldTimer = 0;
+    m_tokenizerYieldDelay = sTokenizerFastYieldDelay;
+    m_yieldTimer = 0;
     m_prospectiveTokenizer = 0;
     onHold = false;
+    m_documentTokenizer = true;
 
     reset();
 }
@@ -165,17 +166,18 @@
     parser = new KHTMLParser( i, _doc );
     m_executingScript = 0;
     m_autoCloseTimer = 0;
-    m_tokenizerYeldDelay = sTokenizerFastYeldDelay;
-    m_yeldTimer = 0;
+    m_tokenizerYieldDelay = sTokenizerFastYieldDelay;
+    m_yieldTimer = 0;
     m_prospectiveTokenizer = 0;
     onHold = false;
+    m_documentTokenizer = false;
 
     reset();
 }
 
-void HTMLTokenizer::setNormalYeldDelay()
+void HTMLTokenizer::setNormalYieldDelay()
 {
-    m_tokenizerYeldDelay = sTokenizerYeldDelay;
+    m_tokenizerYieldDelay = sTokenizerYieldDelay;
 }
 
 void HTMLTokenizer::reset()
@@ -202,9 +204,9 @@
         m_autoCloseTimer = 0;
     }
 
-    if (m_yeldTimer > 0) {
-        killTimer(m_yeldTimer);
-        m_yeldTimer = 0;
+    if (m_yieldTimer > 0) {
+        killTimer(m_yieldTimer);
+        m_yieldTimer = 0;
     }
     currToken.reset();
     doctypeToken.reset();
@@ -1175,7 +1177,7 @@
                     DOMString tagName(ptr);
                     DocumentImpl *doc = parser->docPtr();
                     if (Element::khtmlValidQualifiedName(tagName)) {
-                        safeLocalName = LocalName::fromString(tagName.lower());
+                        safeLocalName = LocalName::fromString(tagName, IDS_NormalizeLower);
                         tagID = safeLocalName.id();
                     }
 #ifdef TOKEN_DEBUG
@@ -1239,7 +1241,7 @@
                     if(curchar <= ' ' || curchar == '=' || curchar == '>') {
                         unsigned int a;
                         cBuffer[cBufferPos] = '\0';
-                        a = LocalName::fromString(DOMString(cBuffer).lower()).id();
+                        a = LocalName::fromString(DOMString(cBuffer), IDS_NormalizeLower).id(); // ### still deep copy?
                         if (a > ATTR_LAST_ATTR)
                             a = 0;
 
@@ -1249,7 +1251,7 @@
                                 currToken.flat = true;
                                 cBuffer[cBufferPos - 1] = '\0';
                                 if (cBufferPos>1)
-                                    a = LocalName::fromString(DOMString(cBuffer).lower()).id();
+                                    a = LocalName::fromString(DOMString(cBuffer), IDS_NormalizeLower).id();
                                 if (a > ATTR_LAST_ATTR)
                                     a = 0;
                                 cBuffer[cBufferPos - 1] = '/';
@@ -1631,12 +1633,13 @@
 inline bool HTMLTokenizer::continueProcessing(int& processedCount)
 {
     // We don't want to be checking elapsed time with every character, so we only check after we've
-    // processed a certain number of characters.
+    // processed a certain number of characters. We also do not do suspension if we're
+    // parsing something like innerHTML.
     if (!m_executingScript && processedCount > sTokenizerChunkSize && cachedScript.isEmpty()) {
         processedCount = 0;
-        if ( m_time.elapsed() > m_tokenizerYeldDelay) {
-            m_yeldTimer = startTimer(0);
-            m_tokenizerYeldDelay = sTokenizerFastYeldDelay;
+        if ( m_time.elapsed() > m_tokenizerYieldDelay && m_documentTokenizer) {
+            m_yieldTimer = startTimer(0);
+            m_tokenizerYieldDelay = sTokenizerFastYieldDelay;
             return false;
         }
     }
@@ -1684,7 +1687,7 @@
         setSrc(str);
 
     // Once a timer is set, it has control of when the tokenizer continues.
-    if (m_yeldTimer > 0)
+    if (m_yieldTimer > 0)
         return;
 
     int processedCount = 0;
@@ -1898,15 +1901,15 @@
         }
     }
 
-    if (noMoreData && cachedScript.isEmpty() && !m_executingScript && m_yeldTimer<=0)
+    if (noMoreData && cachedScript.isEmpty() && !m_executingScript && m_yieldTimer<=0)
         end(); // this actually causes us to be deleted
 }
 
 void HTMLTokenizer::timerEvent( QTimerEvent *e )
 {
-    if ( e->timerId() == m_yeldTimer ) {
-        killTimer(m_yeldTimer);
-        m_yeldTimer = 0;
+    if ( e->timerId() == m_yieldTimer ) {
+        killTimer(m_yieldTimer);
+        m_yieldTimer = 0;
         write( TokenizerString(), true ); 
     } else if ( e->timerId() == m_autoCloseTimer && cachedScript.isEmpty() ) {
          finish();
@@ -1988,7 +1991,7 @@
     // this indicates we will not receive any more data... but if we are waiting on
     // an external script to load, we can't finish parsing until that is done
     noMoreData = true;
-    if (cachedScript.isEmpty() && !m_executingScript && !onHold && m_yeldTimer <= 0)
+    if (cachedScript.isEmpty() && !m_executingScript && !onHold && m_yieldTimer <= 0)
         end(); // this actually causes us to be deleted
 }
 
Index: khtml/html/html_blockimpl.cpp
===================================================================
--- khtml/html/html_blockimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_blockimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -321,8 +321,8 @@
             break;
         case ATTR_NAME:
             if (id() == ID_LAYER && inDocument() && m_name != attr->value()) {
-                document()->underDocNamedCache().remove(m_name.string(),        this);
-                document()->underDocNamedCache().add   (attr->value().string(), this);
+                document()->underDocNamedCache().remove(m_name,        this);
+                document()->underDocNamedCache().add   (attr->value(), this);
             }
             //fallthrough
         default:
@@ -333,24 +333,24 @@
 void HTMLLayerElementImpl::removedFromDocument()
 {
     if (id() == ID_LAYER)
-      document()->underDocNamedCache().remove(m_name.string(), this);
+      document()->underDocNamedCache().remove(m_name, this);
     HTMLDivElementImpl::removedFromDocument();
 }
 
 void HTMLLayerElementImpl::insertedIntoDocument()
 {
     if (id() == ID_LAYER)
-      document()->underDocNamedCache().add(m_name.string(), this);
+      document()->underDocNamedCache().add(m_name, this);
     HTMLDivElementImpl::insertedIntoDocument();
 }
 
-void HTMLLayerElementImpl::removeId(const QString& id)
+void HTMLLayerElementImpl::removeId(const DOMString& id)
 {
     document()->underDocNamedCache().remove(id, this);
     HTMLDivElementImpl::removeId(id);
 }
 
-void HTMLLayerElementImpl::addId   (const QString& id)
+void HTMLLayerElementImpl::addId   (const DOMString& id)
 {
     document()->underDocNamedCache().add(id, this);
     HTMLDivElementImpl::addId(id);
Index: khtml/html/html_miscimpl.cpp
===================================================================
--- khtml/html/html_miscimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_miscimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -331,7 +331,7 @@
     QList<HTMLGenericFormElementImpl*>& l = static_cast<HTMLFormElementImpl*>( m_refNode )->formElements;
     for (unsigned i = strt; i < (unsigned)l.count(); i++)
     {
-        if (l.at( i )->isEnumeratable())
+        if (l.at( i )->isEnumerable())
         {
             if (dist == 0)
             {
@@ -353,7 +353,7 @@
     unsigned length = 0;
     QList<HTMLGenericFormElementImpl*> l = static_cast<HTMLFormElementImpl*>( m_refNode )->formElements;
     for ( unsigned i = 0; i < (unsigned)l.count(); i++ )
-        if ( l.at( i )->isEnumeratable() )
+        if ( l.at( i )->isEnumerable() )
             ++length;
     return length;
 }
@@ -374,7 +374,7 @@
     for ( ; currentNamePos < (unsigned)l.count(); ++currentNamePos )
     {
         HTMLGenericFormElementImpl* el = l.at(currentNamePos);
-        if (el->isEnumeratable() &&
+        if (el->isEnumerable() &&
              ((el->getAttribute(ATTR_ID)   == name) ||
               (el->getAttribute(ATTR_NAME) == name)))
         {
Index: khtml/html/html_formimpl.cpp
===================================================================
--- khtml/html/html_formimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_formimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -127,7 +127,7 @@
     int len = 0;
     QListIterator<HTMLGenericFormElementImpl*> it(formElements);
     while (it.hasNext())
-	if (it.next()->isEnumeratable())
+	if (it.next()->isEnumerable())
 	    ++len;
 
     return len;
@@ -769,8 +769,8 @@
         break;
     case ATTR_NAME:
         if (inDocument() && m_name != attr->value()) {
-            document()->underDocNamedCache().remove(m_name.string(),        this);
-            document()->underDocNamedCache().add   (attr->value().string(), this);
+            document()->underDocNamedCache().remove(m_name,        this);
+            document()->underDocNamedCache().add   (attr->value(), this);
         }
         m_name = attr->value();
         //Fallthrough intentional
@@ -781,23 +781,23 @@
 
 void HTMLFormElementImpl::removedFromDocument()
 {
-    document()->underDocNamedCache().remove(m_name.string(), this);
+    document()->underDocNamedCache().remove(m_name, this);
     HTMLElementImpl::removedFromDocument();
 }
 
 void HTMLFormElementImpl::insertedIntoDocument()
 {
-    document()->underDocNamedCache().add(m_name.string(), this);
+    document()->underDocNamedCache().add(m_name, this);
     HTMLElementImpl::insertedIntoDocument();
 }
 
-void HTMLFormElementImpl::removeId(const QString& id)
+void HTMLFormElementImpl::removeId(const DOMString& id)
 {
     document()->underDocNamedCache().remove(id, this);
     HTMLElementImpl::removeId(id);
 }
 
-void HTMLFormElementImpl::addId   (const QString& id)
+void HTMLFormElementImpl::addId   (const DOMString& id)
 {
     document()->underDocNamedCache().add(id, this);
     HTMLElementImpl::addId(id);
@@ -2314,6 +2314,12 @@
         setRecalcListItems();
 }
 
+void HTMLSelectElementImpl::removeChildren()
+{
+    HTMLGenericFormElementImpl::removeChildren();
+    setRecalcListItems();
+}
+
 NodeImpl *HTMLSelectElementImpl::appendChild ( NodeImpl *newChild, int &exceptioncode )
 {
     NodeImpl* const result = HTMLGenericFormElementImpl::appendChild(newChild, exceptioncode);
Index: khtml/html/html_objectimpl.cpp
===================================================================
--- khtml/html/html_objectimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_objectimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -134,6 +134,26 @@
     dispatchHTMLEvent(EventImpl::LOAD_EVENT, false, false);
 }
 
+void HTMLPartContainerElementImpl::postResizeEvent()
+{
+   QApplication::postEvent( this, new QEvent(static_cast<QEvent::Type>(DOMCFResizeEvent)) );
+}
+
+void HTMLPartContainerElementImpl::sendPostedResizeEvents()
+{
+    QApplication::sendPostedEvents(0, DOMCFResizeEvent);
+}
+
+bool HTMLPartContainerElementImpl::event(QEvent *e)
+{
+    if (e->type() == static_cast<QEvent::Type>(DOMCFResizeEvent)) {
+        dispatchWindowEvent(EventImpl::RESIZE_EVENT, false, false);
+        e->accept();
+        return true;
+    }
+    return QObject::event(e);
+}
+
 // -------------------------------------------------------------------------
 HTMLObjectBaseElementImpl::HTMLObjectBaseElementImpl(DocumentImpl *doc)
     : HTMLPartContainerElementImpl(doc)
@@ -177,8 +197,8 @@
             break;
         case ATTR_NAME:
             if (inDocument() && m_name != attr->value()) {
-                document()->underDocNamedCache().remove(m_name.string(),        this);
-                document()->underDocNamedCache().add   (attr->value().string(), this);
+                document()->underDocNamedCache().remove(m_name,        this);
+                document()->underDocNamedCache().add   (attr->value(), this);
             }
             m_name = attr->value();
             //fallthrough
@@ -218,23 +238,23 @@
 
 void HTMLObjectBaseElementImpl::removedFromDocument()
 {
-    document()->underDocNamedCache().remove(m_name.string(), this);
+    document()->underDocNamedCache().remove(m_name, this);
     HTMLElementImpl::removedFromDocument();
 }
 
 void HTMLObjectBaseElementImpl::insertedIntoDocument()
 {
-    document()->underDocNamedCache().add(m_name.string(), this);
+    document()->underDocNamedCache().add(m_name, this);
     HTMLElementImpl::insertedIntoDocument();
 }
 
-void HTMLObjectBaseElementImpl::removeId(const QString& id)
+void HTMLObjectBaseElementImpl::removeId(const DOMString& id)
 {
     document()->underDocNamedCache().remove(id, this);
     HTMLElementImpl::removeId(id);
 }
 
-void HTMLObjectBaseElementImpl::addId   (const QString& id)
+void HTMLObjectBaseElementImpl::addId   (const DOMString& id)
 {
     document()->underDocNamedCache().add(id, this);
     HTMLElementImpl::addId(id);
Index: khtml/html/html_imageimpl.cpp
===================================================================
--- khtml/html/html_imageimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_imageimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -177,8 +177,8 @@
 	break;
     case ATTR_NAME:
         if (inDocument() && m_name != attr->value()) {
-            document()->underDocNamedCache().remove(m_name.string(),        this);
-            document()->underDocNamedCache().add   (attr->value().string(), this);
+            document()->underDocNamedCache().remove(m_name,        this);
+            document()->underDocNamedCache().add   (attr->value(), this);
         }
         m_name = attr->value();
         //fallthrough
@@ -252,23 +252,23 @@
 
 void HTMLImageElementImpl::removedFromDocument()
 {
-    document()->underDocNamedCache().remove(m_name.string(), this);
+    document()->underDocNamedCache().remove(m_name, this);
     HTMLElementImpl::removedFromDocument();
 }
 
 void HTMLImageElementImpl::insertedIntoDocument()
 {
-    document()->underDocNamedCache().add(m_name.string(), this);
+    document()->underDocNamedCache().add(m_name, this);
     HTMLElementImpl::insertedIntoDocument();
 }
 
-void HTMLImageElementImpl::removeId(const QString& id)
+void HTMLImageElementImpl::removeId(const DOMString& id)
 {
     document()->underDocNamedCache().remove(id, this);
     HTMLElementImpl::removeId(id);
 }
 
-void HTMLImageElementImpl::addId   (const QString& id)
+void HTMLImageElementImpl::addId   (const DOMString& id)
 {
     document()->underDocNamedCache().add(id, this);
     HTMLElementImpl::addId(id);
Index: khtml/html/html_tableimpl.h
===================================================================
--- khtml/html/html_tableimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_tableimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -216,6 +216,10 @@
         //else things are unchanged.
     }
 
+    void clear() {
+        ptr = 0;
+    }
+
     void operator =(ChildType* child) {
         ptr = child;
     }
@@ -277,6 +281,7 @@
     virtual NodeImpl *insertBefore ( NodeImpl *newChild, NodeImpl *refChild, int &exceptioncode );
     virtual void      replaceChild ( NodeImpl *newChild, NodeImpl *oldChild, int &exceptioncode );
     virtual void      removeChild ( NodeImpl *oldChild, int &exceptioncode );
+    virtual void      removeChildren();
     virtual NodeImpl *appendChild ( NodeImpl *newChild, int &exceptioncode );
     
     virtual void parseAttribute(AttributeImpl *attr);
Index: khtml/html/htmltokenizer.h
===================================================================
--- khtml/html/htmltokenizer.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/htmltokenizer.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -83,10 +83,7 @@
                 localname = LocalName::fromId(buffer->unicode());
             }
             else if ( !attrName.isEmpty() && attrName != "/" ) {
-                DOMString prefix, local;
-                splitPrefixLocalName(DOMString(attrName.toLower()).implementation(), prefix, local);
-                localname = LocalName::fromString(local);
-                prefixname = PrefixName::fromString(prefix);
+                splitPrefixLocalName(attrName, prefixname, localname, true /* htmlCompat*/);
             }
 
             if (value && localname.id()) {
@@ -174,7 +171,7 @@
     void finish();
     void timerEvent( QTimerEvent *e );
     bool continueProcessing(int&);
-    void setNormalYeldDelay();
+    void setNormalYieldDelay();
     virtual void setOnHold(bool _onHold);
     void abort() { m_abort = true; }
     virtual void setAutoClose(bool b=true);
@@ -403,10 +400,13 @@
     // autoClose mode is used when the tokenizer was created by a script document.writing
     // on an already loaded document
     int m_autoCloseTimer;
-    int m_tokenizerYeldDelay;
-    int m_yeldTimer;
+    int m_tokenizerYieldDelay;
+    int m_yieldTimer;
     QTime m_time;
 
+    // Set true if this tokenizer is used for documents and not fragments
+    bool m_documentTokenizer; 
+
 #define CBUFLEN 1024
     char cBuffer[CBUFLEN+2];
     unsigned int cBufferPos;
Index: khtml/html/html_blockimpl.h
===================================================================
--- khtml/html/html_blockimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_blockimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -95,8 +95,8 @@
 
     virtual void removedFromDocument();
     virtual void insertedIntoDocument();
-    virtual void addId(const QString& id);
-    virtual void removeId(const QString& id);
+    virtual void addId(const DOMString& id);
+    virtual void removeId(const DOMString& id);
 private:
     DOMString m_name;
     bool fixed;
Index: khtml/html/html_formimpl.h
===================================================================
--- khtml/html/html_formimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_formimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -67,8 +67,8 @@
 
     virtual void insertedIntoDocument();
     virtual void removedFromDocument();
-    virtual void addId(const QString& id);
-    virtual void removeId(const QString& id);
+    virtual void addId(const DOMString& id);
+    virtual void removeId(const DOMString& id);
 
 
     long length() const;
@@ -155,7 +155,7 @@
     void setDisabled(bool _disabled);
 
     virtual bool isFocusable() const;
-    virtual bool isEnumeratable() const { return false; }
+    virtual bool isEnumerable() const { return false; }
     
     virtual bool isDefault() const { return false; }
 
@@ -166,6 +166,7 @@
     void setName(const DOMString& name);
 
     virtual bool isGenericFormElement() const { return true; }
+    virtual bool isHiddenInput() const { return false; }
 
     /*
      * override in derived classes to get the encoded name=value pair
@@ -203,7 +204,7 @@
     };
 
     virtual Id id() const;
-    virtual bool isEnumeratable() const { return true; }
+    virtual bool isEnumerable() const { return true; }
 
     DOMString type() const;
     typeEnum buttonType() const { return KDE_CAST_BF_ENUM(typeEnum, m_type); }
@@ -267,8 +268,9 @@
 
     virtual Id id() const;
 
-    virtual bool isEnumeratable() const { return inputType() != IMAGE; }
+    virtual bool isEnumerable() const { return inputType() != IMAGE; }
     virtual bool isDefault() const { return m_defaultChecked; }
+    virtual bool isHiddenInput() const { return inputType() == HIDDEN; }
 
     bool autoComplete() const { return m_autocomplete; }
 
@@ -396,7 +398,7 @@
     long selectedIndex() const;
     void setSelectedIndex( long index );
 
-    virtual bool isEnumeratable() const { return true; }
+    virtual bool isEnumerable() const { return true; }
 
     long length() const;
 
@@ -419,6 +421,7 @@
     virtual NodeImpl *insertBefore ( NodeImpl *newChild, NodeImpl *refChild, int &exceptioncode );
     virtual void      replaceChild ( NodeImpl *newChild, NodeImpl *oldChild, int &exceptioncode );
     virtual void      removeChild ( NodeImpl *oldChild, int &exceptioncode );
+    virtual void      removeChildren();
     virtual NodeImpl *appendChild ( NodeImpl *newChild, int &exceptioncode );
     virtual NodeImpl *addChild( NodeImpl* newChild );
 
@@ -471,7 +474,7 @@
     void setSelectedIndex( long index );
 
     // ### this is just a rough guess
-    virtual bool isEnumeratable() const { return false; }
+    virtual bool isEnumerable() const { return false; }
 
     virtual void parseAttribute(AttributeImpl *attr);
     virtual bool encoding(const QTextCodec*, khtml::encodingList&, bool);
@@ -554,7 +557,7 @@
 
     WrapMethod wrap() const { return m_wrap; }
 
-    virtual bool isEnumeratable() const { return true; }
+    virtual bool isEnumerable() const { return true; }
 
     DOMString type() const;
 
Index: khtml/html/html_objectimpl.h
===================================================================
--- khtml/html/html_objectimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_objectimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -46,6 +46,9 @@
 {
     Q_OBJECT
 public:
+
+    enum DOMChildFrameEvents { DOMCFResizeEvent = 0x3030 };
+
     HTMLPartContainerElementImpl(DocumentImpl *doc);
     ~HTMLPartContainerElementImpl();
 
@@ -70,11 +73,15 @@
     // if KHTMLPart should not make a kpart for it, but rather let it be handled directly.
     virtual bool mimetypeHandledInternally(const QString& mime);
 
+    virtual bool event(QEvent *e);
+
     // IMPORTANT: you should call this when requesting a URL, to make sure
     // that we don't get stale references to iframes or such.
     void clearChildWidget();
     QWidget* childWidget() const { return m_childWidget; }
 
+    void postResizeEvent();
+    static void sendPostedResizeEvents();
 public slots:
     void slotEmitLoadEvent();
 private:
@@ -113,8 +120,8 @@
 
     virtual void insertedIntoDocument();
     virtual void removedFromDocument();
-    virtual void addId(const QString& id);
-    virtual void removeId(const QString& id);
+    virtual void addId(const DOMString& id);
+    virtual void removeId(const DOMString& id);
 
     HTMLEmbedElementImpl* relevantEmbed();
 
Index: khtml/html/htmlparser.cpp
===================================================================
--- khtml/html/htmlparser.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/htmlparser.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -955,7 +955,6 @@
         // a bit a special case, since the frame is inlined...
     case ID_IFRAME:
         n = new HTMLIFrameElementImpl(document);
-        if (!t->flat) discard_until = ID_IFRAME+ID_CLOSE_TAG;
         break;
 
 // form elements
Index: khtml/html/html_imageimpl.h
===================================================================
--- khtml/html/html_imageimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_imageimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -51,8 +51,8 @@
     virtual void attach();
     virtual void removedFromDocument();
     virtual void insertedIntoDocument();
-    virtual void addId(const QString& id);
-    virtual void removeId(const QString& id);
+    virtual void addId(const DOMString& id);
+    virtual void removeId(const DOMString& id);
 
 
     long width() const;
Index: khtml/html/html_tableimpl.cpp
===================================================================
--- khtml/html/html_tableimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/html/html_tableimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -395,7 +395,16 @@
     handleChildRemove( oldChild );
     HTMLElementImpl::removeChild( oldChild, exceptioncode);
 }
- 
+
+void HTMLTableElementImpl::removeChildren()
+{
+    HTMLElementImpl::removeChildren();
+    tCaption.clear();
+    head.clear();
+    foot.clear();
+    firstBody.clear();
+}
+
 static inline bool isTableCellAncestor(NodeImpl* n)
 {
     return n->id() == ID_THEAD || n->id() == ID_TBODY ||
Index: khtml/ecma/kjs_dom.cpp
===================================================================
--- khtml/ecma/kjs_dom.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/ecma/kjs_dom.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1056,6 +1056,17 @@
   DOM::DocumentImpl& doc  = static_cast<DOM::DocumentImpl&>(node);
 
   KJS::UString str = args[0]->toString(exec);
+
+  // we can do it fast, without copying the data
+  if (id == DOMDocument::GetElementById) {
+#ifdef KJS_VERBOSE
+      kDebug(6070) << "DOMDocument::GetElementById looking for " << args[0]->toString(exec).qstring();
+#endif
+      // create DOMStringImpl without copying
+      DOMStringImpl shallowCopy(DOMStringImpl::ShallowCopy, (QChar*)str.data(), str.size());
+      return getDOMNode(exec, doc.getElementById(DOMString(&shallowCopy)));
+  }
+
   DOM::DOMString s = str.domString();
 
   switch(id) {
@@ -1087,11 +1098,6 @@
   case DOMDocument::GetElementsByTagNameNS: // DOM2
     return getDOMNodeList(exec,doc.getElementsByTagNameNS(args[0]->toString(exec).domString(),
                                                           args[1]->toString(exec).domString()));
-  case DOMDocument::GetElementById:
-#ifdef KJS_VERBOSE
-  kDebug(6070) << "DOMDocument::GetElementById looking for " << args[0]->toString(exec).qstring();
-#endif
-    return getDOMNode(exec,doc.getElementById(args[0]->toString(exec).domString()));
   case DOMDocument::CreateRange:
     return getDOMRange(exec,doc.createRange());
   case DOMDocument::CreateNodeIterator:
@@ -1550,6 +1556,10 @@
   if (getIndexSlot(this, *m_impl, propertyName, slot))
     return true;
 
+  // Could also be a name... A local name, that is.
+//  if (
+//  slot.setCustom(this, nameGetter)
+
   return DOMObject::getOwnPropertySlot(exec, propertyName, slot);
 }
 
Index: khtml/ecma/kjs_css.cpp
===================================================================
--- khtml/ecma/kjs_css.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/ecma/kjs_css.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -222,12 +222,12 @@
   CSSStyleDeclarationImpl &styleDecl = *m_impl;
 
   if (propertyName == "cssText") {
-    styleDecl.setCssText(value->toString(exec).domString());
+    styleDecl.setCssText(valueToStringWithNullCheck(exec, value));
   }
   else {
     bool pxSuffix;
     QString prop = cssPropertyName(propertyName, &pxSuffix);
-    QString propvalue = value->toString(exec).qstring();
+    QString propvalue = valueToStringWithNullCheck(exec, value).string();
 
     if (pxSuffix)
       propvalue += QLatin1String("px");
Index: khtml/ecma/kjs_html.cpp
===================================================================
--- khtml/ecma/kjs_html.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/ecma/kjs_html.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -236,15 +236,14 @@
     return true;
   }
 
-  QString         propertyQString   = propertyName.qstring();
+  DOM::DOMString  propertyDOMString = propertyName.domString();
 
   //See whether to return named items under document.
-  ElementMappingCache::ItemInfo* info = docImpl->underDocNamedCache().get(propertyQString);
+  ElementMappingCache::ItemInfo* info = docImpl->underDocNamedCache().get(propertyDOMString);
   if (info) {
     //May be a false positive, but we can try to avoid doing it the hard way in
     //simpler cases. The trickiness here is that the cache is kept under both
     //name and id, but we sometimes ignore id for IE compat
-    DOM::DOMString  propertyDOMString = propertyName.domString();
 
     bool matched = false;
     if (info->nd && DOM::HTMLMappedNameCollectionImpl::matchesName(info->nd,
@@ -264,7 +263,7 @@
 
   // Check for frames/iframes with name==propertyName
   if ( part ) {
-    if (part->findFrame( propertyQString )) {
+    if (part->findFrame( propertyName.qstring() )) {
       slot.setCustom(this, frameNameGetter);
       return true;
     }
@@ -299,13 +298,14 @@
   DOM::DocumentImpl* docImpl = thisObj->impl();
 
   //Return named items under document (e.g. images, applets, etc.)
-  ElementMappingCache::ItemInfo* info = docImpl->underDocNamedCache().get(propertyName.qstring());
+  DOMString name = propertyName.domString();
+  ElementMappingCache::ItemInfo* info = docImpl->underDocNamedCache().get(name);
   if (info && info->nd)
     return getDOMNode(exec, info->nd);
   else {
     //No cached mapping, do it the hard way..
     DOM::HTMLMappedNameCollectionImpl* coll = new DOM::HTMLMappedNameCollectionImpl(docImpl,
-                                        HTMLCollectionImpl::DOCUMENT_NAMED_ITEMS, propertyName.domString());
+                                        HTMLCollectionImpl::DOCUMENT_NAMED_ITEMS, name);
 
     if (info && coll->length() == 1) {
         info->nd = static_cast<DOM::ElementImpl*>(coll->firstItem());
Index: khtml/ecma/kjs_window.cpp
===================================================================
--- khtml/ecma/kjs_window.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/ecma/kjs_window.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -73,6 +73,12 @@
 
 #include <rendering/render_replaced.h>
 
+#if QT_VERSION < 0x040500
+  #define SCROLLBAR_WIDTH_HACK
+#include <QStyle>
+#include <QLayout>
+#include <QStyleOption>
+#endif
 
 using namespace KJS;
 using namespace DOM;
@@ -608,7 +614,7 @@
   // allow shortcuts like 'Image1' instead of document.images.Image1
   DOM::DocumentImpl *doc = part->xmlDocImpl();
   if (isSafeScript(exec) && doc && doc->isHTMLDocument()) {
-    DOM::ElementMappingCache::ItemInfo* info = doc ->underDocNamedCache().get(propertyName.qstring());
+    DOM::ElementMappingCache::ItemInfo* info = doc ->underDocNamedCache().get(propertyName.domString());
     if (info || doc->getElementById(propertyName.domString())) {
       slot.setCustom(this, namedItemGetter);
       return true;
@@ -658,7 +664,7 @@
   KHTMLPart *part = qobject_cast<KHTMLPart*>(thisObj->m_frame->m_part);
   DOM::DocumentImpl* doc = part->xmlDocImpl();
 
-  DOM::ElementMappingCache::ItemInfo* info = doc->underDocNamedCache().get(p.qstring());
+  DOM::ElementMappingCache::ItemInfo* info = doc->underDocNamedCache().get(p.domString());
   if (info) {
     if (info->nd)
       return getDOMNode(exec, info->nd);
@@ -901,10 +907,15 @@
       int ret = part->view()->visibleHeight();
       // match Gecko which does not subtract the scrollbars
       if (part->view()->horizontalScrollBar()->isVisible()) {
-          ret += part->view()->style()->pixelMetric(QStyle::PM_ScrollBarExtent);
-          int lvs = part->view()->style()->pixelMetric(QStyle::PM_LayoutVerticalSpacing);
-          if (lvs > 0)
-              ret += lvs;
+          ret += part->view()->horizontalScrollBar()->sizeHint().height();
+#ifdef SCROLLBAR_WIDTH_HACK
+          // ### hackish turnaround for a bug in QAbstractScrollArea triggered by Oxygen.
+          QStyleOption opt(0);
+          opt.init(part->view());
+          if (part->view()->style()->styleHint(QStyle::SH_ScrollView_FrameOnlyAroundContents, &opt, part->view())) {
+              ret += part->view()->style()->pixelMetric(QStyle::PM_DefaultFrameWidth)*2;
+          }
+#endif
       }
       return jsNumber(ret);
     }
@@ -915,10 +926,15 @@
       int ret = part->view()->visibleWidth();
       // match Gecko which does not subtract the scrollbars
       if (part->view()->verticalScrollBar()->isVisible()) {
-          ret += part->view()->style()->pixelMetric(QStyle::PM_ScrollBarExtent);
-          int lhs = part->view()->style()->pixelMetric(QStyle::PM_LayoutHorizontalSpacing);
-          if (lhs > 0)
-              ret += lhs;
+          ret += part->view()->verticalScrollBar()->sizeHint().width();
+#ifdef SCROLLBAR_WIDTH_HACK
+          // ### hackish turnaround for a bug in QAbstractScrollArea triggered by Oxygen.
+          QStyleOption opt(0);
+          opt.init(part->view());
+          if (part->view()->style()->styleHint(QStyle::SH_ScrollView_FrameOnlyAroundContents, &opt, part->view())) {
+              ret += part->view()->style()->pixelMetric(QStyle::PM_DefaultFrameWidth)*2;
+          }
+#endif
       }
       return jsNumber(ret);
     }
Index: khtml/rendering/bidi.cpp
===================================================================
--- khtml/rendering/bidi.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/rendering/bidi.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -4,7 +4,7 @@
  * Copyright (C) 2000-2003 Lars Knoll (knoll@kde.org)
  *           (C) 2003-2007 Apple Computer, Inc.
  *           (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
- *           (C) 2007 Germain Garand (germain@ebooksfrance.org)
+ *           (C) 2007-2009 Germain Garand (germain@ebooksfrance.org)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -50,10 +50,10 @@
 // an iterator which goes through a BidiParagraph
 struct BidiIterator
 {
-    BidiIterator() : par(0), obj(0), pos(0) {}
-    BidiIterator(RenderBlock *_par, RenderObject *_obj, unsigned int _pos) : par(_par), obj(_obj), pos(_pos) {}
+    BidiIterator() : par(0), obj(0), pos(0), endOfInline(false) {}
+    BidiIterator(RenderBlock *_par, RenderObject *_obj, unsigned int _pos, bool eoi=false) : par(_par), obj(_obj), pos(_pos), endOfInline(eoi) {}
 
-    void increment( BidiState &bidi );
+    void increment( BidiState *bidi=0, bool skipInlines=true );
 
     bool atEnd() const;
 
@@ -63,6 +63,7 @@
     RenderBlock *par;
     RenderObject *obj;
     unsigned int pos;
+    bool endOfInline;
 };
 
 struct BidiState {
@@ -96,7 +97,6 @@
 static bool isLineEmpty = true;
 static bool previousLineBrokeAtBR = false;
 static QChar::Direction dir = QChar::DirON;
-static bool adjustEmbedding;
 static bool emptyRun = true;
 static int numSpaces;
 
@@ -125,21 +125,6 @@
     return result;
 }
 
-static int inlineWidth(RenderObject* child, bool start = true, bool end = true)
-{
-    int extraWidth = 0;
-    RenderObject* parent = child->parent();
-    while (parent->isInline() && !parent->isInlineBlockOrInlineTable()) {
-        if (start && parent->firstChild() == child)
-            extraWidth += getBorderPaddingMargin(parent, false);
-        if (end && parent->lastChild() == child)
-            extraWidth += getBorderPaddingMargin(parent, true);
-        child = parent;
-        parent = child->parent();
-    }
-    return extraWidth;
-}
-
 #ifndef NDEBUG
 static bool inBidiRunDetach;
 #endif
@@ -259,35 +244,49 @@
 {
     return !(status1 == status2);
 }
-        
-static inline RenderObject *Bidinext(RenderObject *par, RenderObject *current, BidiState &bidi,
-                                     bool skipInlines = true)
+
+// when modifying this function, make sure you check InlineMinMaxIterator::next() as well.
+static inline RenderObject *Bidinext(RenderObject *par, RenderObject *current, BidiState *bidi=0,
+                                     bool skipInlines = true, bool* endOfInline = 0)
 {
     RenderObject *next = 0;
-
+    bool oldEndOfInline = endOfInline ? *endOfInline : false;
+    if (oldEndOfInline)
+        *endOfInline = false;
     while(current != 0)
     {
         //kDebug( 6040 ) << "current = " << current;
-        if (!current->isFloating() && !current->isReplaced() && !current->isPositioned()) {
+        if (!oldEndOfInline && !current->isFloating() && !current->isReplaced() && !current->isPositioned()) {
             next = current->firstChild();
-            if ( next && adjustEmbedding ) {
+            if ( next && bidi) {
                 EUnicodeBidi ub = next->style()->unicodeBidi();
                 if ( ub != UBNormal && !emptyRun ) {
                     EDirection dir = next->style()->direction();
                     QChar::Direction d = ( ub == Embed ? ( dir == RTL ? QChar::DirRLE : QChar::DirLRE )
                                         : ( dir == RTL ? QChar::DirRLO : QChar::DirLRO ) );
-                    embed( d, bidi );
+                    embed( d, *bidi );
                 }
             }
         }
         if (!next) {
+            if (!skipInlines && !oldEndOfInline && current->isInlineFlow() && endOfInline) {
+                next = current;
+                *endOfInline = true;
+                break;
+            }
+
             while (current && current != par) {
                 next = current->nextSibling();
                 if (next) break;
-                if ( adjustEmbedding && current->style()->unicodeBidi() != UBNormal && !emptyRun ) {
-                    embed( QChar::DirPDF, bidi );
+                if ( bidi && current->style()->unicodeBidi() != UBNormal && !emptyRun ) {
+                    embed( QChar::DirPDF, *bidi );
                 }
                 current = current->parent();
+                if (!skipInlines && current && current != par && current->isInlineFlow() && endOfInline) {
+                    next = current;
+                    *endOfInline = true;
+                    break;
+                }
             }
         }
 
@@ -302,7 +301,7 @@
     return next;
 }
 
-static RenderObject *first( RenderObject *par, BidiState &bidi, bool skipInlines = true )
+static RenderObject *first( RenderObject *par, BidiState *bidi, bool skipInlines = true )
 {
     if(!par->firstChild()) return 0;
     RenderObject *o = par->firstChild();
@@ -319,17 +318,17 @@
     return o;
 }
 
-inline void BidiIterator::increment (BidiState &bidi)
+inline void BidiIterator::increment(BidiState *bidi, bool skipInlines)
 {
     if(!obj) return;
     if(obj->isText()) {
         pos++;
         if(pos >= static_cast<RenderText *>(obj)->stringLength()) {
-            obj = Bidinext( par, obj, bidi );
+            obj = Bidinext( par, obj, bidi, skipInlines );
             pos = 0;
         }
     } else {
-        obj = Bidinext( par, obj, bidi );
+        obj = Bidinext( par, obj, bidi, skipInlines, &endOfInline );
         pos = 0;
     }
 }
@@ -384,7 +383,7 @@
         if (text->text()) {
             for (int i = bidiRun->start; i < bidiRun->stop; i++) {
                 const QChar c = text->text()[i];
-                if (c.category() == QChar::Separator_Space || c == '\n')
+                if (c.unicode() == '\n' || c.category() == QChar::Separator_Space)
                     numSpaces++;
             }
         }
@@ -453,7 +452,7 @@
     }
 }
 
-static void checkMidpoints(BidiIterator& lBreak, BidiState &bidi)
+static void checkMidpoints(BidiIterator& lBreak)
 {
     // Check to see if our last midpoint is a start point beyond the line break.  If so,
     // shave it off the list, and shave off a trailing space if the previous end point isn't
@@ -464,7 +463,7 @@
         const BidiIterator& startpoint = midpoints[sNumMidpoints-1];
         BidiIterator currpoint = endpoint;
         while (!currpoint.atEnd() && currpoint != startpoint && currpoint != lBreak)
-            currpoint.increment( bidi );
+            currpoint.increment();
         if (currpoint == lBreak) {
             // We hit the line break before the start point.  Shave off the start point.
             sNumMidpoints--;
@@ -491,7 +490,24 @@
         smidpoints->resize(sNumMidpoints+10);
 
     BidiIterator* midpoints = smidpoints->data();
-    midpoints[sNumMidpoints++] = midpoint;
+
+    // do not place midpoints in inline flows that are going to be skipped by the bidi iteration process.
+    // Place them at the next non-skippable object instead.
+    // #### eventually, we may want to have the same iteration in bidi and in findNextLineBreak,
+    //      then this extra complexity can go away.
+    if (midpoint.obj && midpoint.obj->isInlineFlow() && (midpoint.obj->firstChild() || midpoint.endOfInline)) {
+        BidiIterator n = midpoint;
+        n.increment();
+        assert(!n.endOfInline);
+        // we'll recycle the endOfInline flag to mean : don't include this stop point, stop right before it.
+        // this is necessary because we just advanced our position to skip an inline, so we passed the real stop point
+        n.endOfInline = true;
+        if (!n.atEnd())
+            midpoints[sNumMidpoints++] = n;
+    } else {
+        assert(!midpoint.endOfInline);
+        midpoints[sNumMidpoints++] = midpoint;
+    }
 }
 
 static void appendRunsForObject(int start, int end, RenderObject* obj, BidiState &bidi)
@@ -527,8 +543,9 @@
             betweenMidpoints = true;
             sCurrMidpoint++;
             if (nextMidpoint.pos != UINT_MAX) { // UINT_MAX means stop at the object and don't include any of it.
-                addRun(new (obj->renderArena())
-                    BidiRun(start, nextMidpoint.pos+1, obj, bidi.context, dir));
+               if (!nextMidpoint.endOfInline) // In this context, this flag means the stop point is exclusive, not inclusive (see addMidpoint).
+                   addRun(new (obj->renderArena())
+                       BidiRun(start, nextMidpoint.pos+1, obj, bidi.context, dir));
                 return appendRunsForObject(nextMidpoint.pos+1, end, obj, bidi);
             }
         }
@@ -544,24 +561,20 @@
     kDebug(6041) << "appendRun: dir="<<(int)dir;
 #endif
 
-    bool b = adjustEmbedding;
-    adjustEmbedding = false;
-
     int start = bidi.sor.pos;
     RenderObject *obj = bidi.sor.obj;
     while( obj && obj != bidi.eor.obj ) {
         appendRunsForObject(start, obj->length(), obj, bidi);
         start = 0;
-        obj = Bidinext( bidi.sor.par, obj, bidi );
+        obj = Bidinext( bidi.sor.par, obj);
     }
     if (obj)
         appendRunsForObject(start, bidi.eor.pos+1, obj, bidi);
 
-    bidi.eor.increment( bidi );
+    bidi.eor.increment();
     bidi.sor = bidi.eor;
     dir = QChar::DirON;
     bidi.status.eor = QChar::DirON;
-    adjustEmbedding = b;
 }
 
 static void embed( QChar::Direction d, BidiState &bidi )
@@ -569,8 +582,6 @@
 #if BIDI_DEBUG > 1
     qDebug("*** embed dir=%d emptyrun=%d", d, emptyRun );
 #endif
-    bool b = adjustEmbedding ;
-    adjustEmbedding = false;
     if ( d == QChar::DirPDF ) {
 	BidiContext *c = bidi.context->parent;
 	if (c) {
@@ -630,7 +641,6 @@
 	    bidi.status.eor = runDir;
 	}
     }
-    adjustEmbedding = b;
 }
 
 InlineFlowBox* RenderBlock::createLineBoxes(RenderObject* obj)
@@ -1268,9 +1278,7 @@
 
 	// this causes the operator ++ to open and close embedding levels as needed
 	// for the CSS unicode-bidi property
-	adjustEmbedding = true;
-        bidi.current.increment( bidi );
-	adjustEmbedding = false;
+        bidi.current.increment( &bidi );
 
 	if ( bidi.current == end ) {
 	    if ( emptyRun )
@@ -1340,45 +1348,6 @@
 #endif
 }
 
-#ifdef APPLE_CHANGES    // KDE handles compact blocks differently
-static void buildCompactRuns(RenderObject* compactObj, BidiState &bidi)
-{
-    sBuildingCompactRuns = true;
-    if (!compactObj->isRenderBlock()) {
-        // Just append a run for our object.
-        isLineEmpty = false;
-        addRun(new (compactObj->renderArena()) BidiRun(0, compactObj->length(), compactObj, bidi.context, dir));
-    }
-    else {
-        // Format the compact like it is its own single line.  We build up all the runs for
-        // the little compact and then reorder them for bidi.
-        RenderBlock* compactBlock = static_cast<RenderBlock*>(compactObj);
-        adjustEmbedding = true;
-        BidiIterator start(compactBlock, first(compactBlock, bidi), 0);
-        adjustEmbedding = false;
-        BidiIterator end = start;
-
-        betweenMidpoints = false;
-        isLineEmpty = true;
-        previousLineBrokeAtBR = true;
-
-        end = compactBlock->findNextLineBreak(start, bidi);
-        if (!isLineEmpty)
-            compactBlock->bidiReorderLine(start, end, bidi);
-    }
-
-
-    sCompactFirstBidiRun = sFirstBidiRun;
-    sCompactLastBidiRun = sLastBidiRun;
-    sCompactBidiRunCount = sBidiRunCount;
-
-    sNumMidpoints = 0;
-    sCurrMidpoint = 0;
-    betweenMidpoints = false;
-    sBuildingCompactRuns = false;
-}
-#endif
-
 void RenderBlock::layoutInlineChildren(bool relayoutChildren, int breakBeforeLine)
 {
     BidiState bidi;
@@ -1416,7 +1385,7 @@
 
     if (firstChild()) {
         // layout replaced elements
-        RenderObject *o = first( this, bidi, false );
+        RenderObject *o = first( this, 0, false );
         while ( o ) {
             invalidateVerticalPosition();
             if (o->markedForRepaint()) {
@@ -1445,7 +1414,7 @@
                     o->dirtyInlineBoxes(fullLayout);
                 o->setNeedsLayout(false);
             }
-            o = Bidinext( this, o, bidi, false );
+            o = Bidinext( this, o, 0, false );
         }
 
         BidiContext *startEmbed;
@@ -1462,7 +1431,6 @@
 	bidi.status.last = QChar::DirON;
 
         bidi.context = startEmbed;
-        adjustEmbedding = true;
 
         // We want to skip ahead to the first dirty line
         BidiIterator start;
@@ -1493,12 +1461,8 @@
             }
             startLine = 0;
         }
-        
         BidiIterator end = start;
-
         bool endLineMatched = false;
-        
-        adjustEmbedding = false;
         m_firstLine = true;
 
         if (!smidpoints)
@@ -1531,13 +1495,6 @@
                 oldStart = start;
                 oldBidi = bidi;
             }
-#ifdef APPLE_CHANGES    // KDE handles compact blocks differently
-            if (m_firstLine && firstChild() && firstChild()->isCompact()) {
-                buildCompactRuns(firstChild(), bidi);
-                start.obj = firstChild()->nextSibling();
-                end = start;
-            }
-#endif
             if (lineCount == breakBeforeLine) {
                 m_height = pageTopAfter(oldPos);
                 pagebreakHint = true;
@@ -1555,15 +1512,6 @@
                 // At the same time we figure out where border/padding/margin should be applied for
                 // inline flow boxes.
 
-#ifdef APPLE_CHANGES    // KDE handles compact blocks differently
-                if (sCompactFirstBidiRun) {
-                    // We have a compact line sharing this line.  Link the compact runs
-                    // to our runs to create a single line of runs.
-                    sCompactLastBidiRun->nextRun = sFirstBidiRun;
-                    sFirstBidiRun = sCompactFirstBidiRun;
-                    sBidiRunCount += sCompactBidiRunCount;
-                }
-#endif
                 RootInlineBox* lineBox = 0;
                 if (sBidiRunCount) {
                     lineBox = constructLine(start, end);
@@ -1598,13 +1546,9 @@
                 }
 
                 if( end == start || (end.obj && end.obj->isBR() && !start.obj->isBR() ) ) {
-                    adjustEmbedding = true;
-                    end.increment(bidi);
-                    adjustEmbedding = false;
+                    end.increment(&bidi);
                 } else if (end.obj && end.obj->style()->preserveLF() && end.current() == QChar('\n')) {
-                    adjustEmbedding = true;
-                    end.increment(bidi);
-                    adjustEmbedding = false;
+                    end.increment(&bidi);
                 }
 
                 if (lineBox)
@@ -1777,9 +1721,7 @@
         pos = last->lineBreakPos();
         bidi.status = last->lineBreakBidiStatus();
     } else {
-        adjustEmbedding = true;
-        startObj = first(this, bidi, 0);
-        adjustEmbedding = false;
+        startObj = first(this, &bidi, false);
     }
         
     start = BidiIterator(this, startObj, pos);
@@ -1879,9 +1821,10 @@
 
 static inline bool requiresLineBox(BidiIterator& it)
 {
-    if (it.obj->isFloatingOrPositioned() || it.obj->isInlineFlow())
+    if (it.obj->isFloatingOrPositioned())
         return false;
-    
+    if (it.obj->isInlineFlow())
+        return (getBorderPaddingMargin(it.obj, it.endOfInline) != 0);
     if (it.obj->style()->preserveWS() || it.obj->isBR())
         return true;
 
@@ -1901,9 +1844,8 @@
     assert(inlineObj->parent() == this);
 
     BidiIterator it(this, inlineObj, 0);
-    BidiState state;
     while (!it.atEnd() && !requiresLineBox(it))
-        it.increment(state);
+        it.increment(0, false /*skipInlines*/);
 
     return !it.atEnd();
 }
@@ -1921,6 +1863,7 @@
     BidiIterator posStart = start;
     bool hadPosStart = false;
 
+    // Skip initial whitespace
     while (!start.atEnd() && !requiresLineBox(start)) {
         if( start.obj->isFloating() || start.obj->isPosWithStaticDim()) {
             RenderObject *o = start.obj;
@@ -1931,22 +1874,22 @@
                 width = lineWidth(m_height);
             }
             else if (o->isPositioned()) {
+                // add midpoints to have positioned objects at the correct static location
+                // while still skipping initial whitespace.
                 if (!hadPosStart) {
                     hadPosStart = true;
                     posStart = start;
-                    // end
+                    // include this object then stop
                     addMidpoint(BidiIterator(0, o, 0));
                 } else {
-                    // start/end
+                    // start/stop
                     addMidpoint(BidiIterator(0, o, 0));
                     addMidpoint(BidiIterator(0, o, 0));
                 }
                 setStaticPosition(this, o);
             }
         }
-        adjustEmbedding = true;
-        start.increment(bidi);
-        adjustEmbedding = false;
+        start.increment(&bidi, false /*skipInlines*/);
     }
 
     if (hadPosStart && !start.atEnd())
@@ -1955,12 +1898,17 @@
     if ( start.atEnd() ){
         if (hadPosStart) {
             start = posStart;
-            posStart.increment(bidi);
+            posStart.increment();
             return posStart;
         }
         return start;
     }
 
+    // This variable says we have encountered an object after which initial whitespace should be ignored (e.g. InlineFlows at the begining of a line).
+    // Either we have nothing to do, if there is no whitespace after the object... or we have to enter the ignoringSpaces state.
+    // This dilemma will be resolved when we have a peek at the next object.
+    bool checkShouldIgnoreInitialWhitespace = false;
+
     // This variable is used only if whitespace isn't set to PRE, and it tells us whether
     // or not we are currently ignoring whitespace.
     bool ignoringSpaces = false;
@@ -1970,17 +1918,18 @@
     // this to detect when we encounter a second space so we know we have to terminate
     // a run.
     bool currentCharacterIsSpace = false;
+
     RenderObject* trailingSpaceObject = 0;
 
     BidiIterator lBreak = start;
-
-    RenderObject *o = start.obj;
-    RenderObject *last = o;
+    InlineMinMaxIterator it(start.par, start.obj, start.endOfInline, false /*skipPositioned*/);
+    InlineMinMaxIterator lastIt = it;
     int pos = start.pos;
 
     bool prevLineBrokeCleanly = previousLineBrokeAtBR;
     previousLineBrokeAtBR = false;
 
+    RenderObject* o = it.current;
     while( o ) {
 #ifdef DEBUG_LINEBREAKS
         kDebug(6041) << "new object "<< o <<" width = " << w <<" tmpw = " << tmpW;
@@ -1989,6 +1938,7 @@
             if( w + tmpW <= width ) {
                 lBreak.obj = o;
                 lBreak.pos = 0;
+                lBreak.endOfInline = it.endOfInline;
 
                 // A <br> always breaks a line, so don't let the line be collapsed
                 // away. Also, the space at the end of a line with a <br> does not
@@ -2039,19 +1989,22 @@
                 }
             }
         } else if (o->isInlineFlow()) {
-            // Only empty inlines matter.  We treat those similarly to replaced elements.
-            KHTMLAssert(!o->firstChild());
-            if (o->isWordBreak()) {
+            tmpW += getBorderPaddingMargin(o, it.endOfInline);
+            if (isLineEmpty) isLineEmpty = !tmpW;
+            if (o->isWordBreak()) { // #### shouldn't be an InlineFlow!
                 w += tmpW;
                 tmpW = 0;
                 lBreak.obj = o;
                 lBreak.pos = 0;
+                lBreak.endOfInline = it.endOfInline;
+            } else if (!it.endOfInline) {
+                 // this is the beginning of the line (other non-initial inline flows are handled directly when
+                 // incrementing the iterator below). We want to skip initial whitespace as much as possible.
+                 checkShouldIgnoreInitialWhitespace = true;
             }
-            tmpW += o->marginLeft()+o->borderLeft()+o->paddingLeft()+
-                    o->marginRight()+o->borderRight()+o->paddingRight();
         } else if ( o->isReplaced() || o->isGlyph() ) {
             EWhiteSpace currWS = o->style()->whiteSpace();
-            EWhiteSpace lastWS = last->style()->whiteSpace();
+            EWhiteSpace lastWS = lastIt.current->style()->whiteSpace();
 
             // WinIE marquees have different whitespace characteristics by default when viewed from
             // the outside vs. the inside.  Text inside is NOWRAP, and so we altered the marquee's
@@ -2059,8 +2012,8 @@
             // for the marquee when checking for line breaking.
             if (o->isHTMLMarquee() && o->layer() && o->layer()->marquee())
                 currWS = o->layer()->marquee()->whiteSpace();
-            if (last->isHTMLMarquee() && last->layer() && last->layer()->marquee())
-                lastWS = last->layer()->marquee()->whiteSpace();
+            if (lastIt.current->isHTMLMarquee() && lastIt.current->layer() && lastIt.current->layer()->marquee())
+                lastWS = lastIt.current->layer()->marquee()->whiteSpace();
 
             // Break on replaced elements if either has normal white-space.
             if (currWS == NORMAL || lastWS == NORMAL) {
@@ -2068,9 +2021,10 @@
                 tmpW = 0;
                 lBreak.obj = o;
                 lBreak.pos = 0;
+                lBreak.endOfInline = false;
             }
 
-            tmpW += o->width()+o->marginLeft()+o->marginRight()+inlineWidth(o);
+            tmpW += o->width()+o->marginLeft()+o->marginRight();
             if (ignoringSpaces) {
                 BidiIterator startMid( 0, o, 0 );
                 addMidpoint(startMid);
@@ -2081,21 +2035,7 @@
             trailingSpaceObject = 0;
 
             if (o->isListMarker() && o->style()->listStylePosition() == OUTSIDE) {
-                // The marker must not have an effect on whitespace at the start
-                // of the line.  We start ignoring spaces to make sure that any additional
-                // spaces we see will be discarded.
-                //
-                // Optimize for a common case. If we can't find whitespace after the list
-                // item, then this is all moot. -dwh
-                RenderObject* next = Bidinext( start.par, o, bidi );
-                if (!style()->preserveWS() && next && next->isText() && static_cast<RenderText*>(next)->stringLength() > 0 &&
-                     (static_cast<RenderText*>(next)->text()[0].category() == QChar::Separator_Space ||
-                      static_cast<RenderText*>(next)->text()[0] == '\n')) {
-                    currentCharacterIsSpace = true;
-                    ignoringSpaces = true;
-                    BidiIterator endMid( 0, o, 0 );
-                    addMidpoint(endMid);
-                }
+                checkShouldIgnoreInitialWhitespace = true;
             }
         } else if ( o->isText() ) {
             RenderText *t = static_cast<RenderText *>(o);
@@ -2112,9 +2052,6 @@
 #ifdef APPLE_CHANGES
             int wordSpacing = o->style()->wordSpacing();
 #endif
-            bool appliedStartWidth = pos > 0; // If the span originated on a previous line,
-                                              // then assume the start width has been applied.
-            bool appliedEndWidth = false;
             bool nextIsSoftBreakable = false;
 
             while(len) {
@@ -2122,7 +2059,7 @@
                 bool isSoftBreakable = nextIsSoftBreakable;
                 nextIsSoftBreakable = false;
                 const QChar c = str[pos];
-                currentCharacterIsSpace = c == ' ';
+                currentCharacterIsSpace = c.unicode() == ' ';
 
                 if (preserveWS || !currentCharacterIsSpace)
                     isLineEmpty = false;
@@ -2174,13 +2111,9 @@
                     }
                 }
 
-                if ( (preserveLF && c == '\n') || (autoWrap && (isBreakable( str, pos, strlen ) || isSoftBreakable)) ) {
+                if ( (preserveLF && c.unicode() == '\n') || (autoWrap && (isBreakable( str, pos, strlen ) || isSoftBreakable)) ) {
 
                     tmpW += t->width(lastSpace, pos - lastSpace, f);
-                    if (!appliedStartWidth) {
-                        tmpW += inlineWidth(o, true, false);
-                        appliedStartWidth = true;
-                    }
 #ifdef APPLE_CHANGES
                     applyWordSpacing = (wordSpacing && currentCharacterIsSpace && !previousCharacterIsSpace &&
                         !t->containsOnlyWhitespace(pos+1, strlen-(pos+1)));
@@ -2217,9 +2150,10 @@
                             tmpW -= t->width(pos-1, 1, f);
                     }
 
-                    if( preserveLF && *(str+pos) == '\n' ) {
+                    if( preserveLF && (str+pos)->unicode() == '\n' ) {
                         lBreak.obj = o;
                         lBreak.pos = pos;
+                        lBreak.endOfInline = false;
 
 #ifdef DEBUG_LINEBREAKS
                         kDebug(6041) << "forced break sol: " << start.obj << " " << start.pos << "   end: " << lBreak.obj << " " << lBreak.pos << "   width=" << w;
@@ -2232,6 +2166,7 @@
                         tmpW = 0;
                         lBreak.obj = o;
                         lBreak.pos = pos;
+                        lBreak.endOfInline = false;
                     }
 
                     lastSpace = pos;
@@ -2272,28 +2207,48 @@
             // IMPORTANT: pos is > length here!
             if (!ignoringSpaces)
                 tmpW += t->width(lastSpace, pos - lastSpace, f);
-            if (!appliedStartWidth)
-                tmpW += inlineWidth(o, true, false);
-            if (!appliedEndWidth)
-                tmpW += inlineWidth(o, false, true);
         } else
             KHTMLAssert( false );
 
-        RenderObject* next = Bidinext(start.par, o, bidi);
-        bool autoWrap = o->style()->autoWrap();
+        InlineMinMaxIterator savedIt = lastIt;
+        lastIt = it;
+        o = it.next();
+
+        // advance the iterator to the next non-inline-flow
+        while (o && o->isInlineFlow() && !o->isWordBreak()) {
+            tmpW += getBorderPaddingMargin(o, it.endOfInline);
+            if (isLineEmpty) isLineEmpty = !tmpW;
+            o = it.next();
+        }
+
+        if (checkShouldIgnoreInitialWhitespace) {
+            // Check if we should switch to ignoringSpaces state
+            if (!style()->preserveWS() && it.current && it.current->isText()) {
+                const RenderText* rt = static_cast<RenderText*>(it.current);
+                if (rt->stringLength() > 0 && (rt->text()[0].category() == QChar::Separator_Space || rt->text()[0] == '\n')) {
+                    currentCharacterIsSpace = true;
+                    ignoringSpaces = true;
+                    BidiIterator endMid( 0, lastIt.current, 0 );
+                    addMidpoint(endMid);
+                }
+            }
+            checkShouldIgnoreInitialWhitespace = false;
+        }
+
+        bool autoWrap = lastIt.current->style()->autoWrap();
         bool checkForBreak = autoWrap;
-        if (w && w + tmpW > width && lBreak.obj && !o->style()->preserveLF() && !autoWrap)
+        if (w && w + tmpW > width && lBreak.obj && !lastIt.current->style()->preserveLF() && !autoWrap)
             checkForBreak = true;
-        else if (next && o->isText() && next->isText() && !next->isBR()) {
-            if (autoWrap || next->style()->autoWrap()) {
+        else if (it.current && lastIt.current->isText() && it.current->isText() && !it.current->isBR()) {
+            if (autoWrap || it.current->style()->autoWrap()) {
                 if (currentCharacterIsSpace)
                     checkForBreak = true;
                 else {
                     checkForBreak = false;
-                    RenderText* nextText = static_cast<RenderText*>(next);
+                    RenderText* nextText = static_cast<RenderText*>(it.current);
                     if (nextText->stringLength() != 0) {
                         QChar c = nextText->text()[0];
-                        if (c == ' ' || c == '\t' || (c == '\n' && !next->style()->preserveLF())) {
+                        if (c == ' ' || c == '\t' || (c == '\n' && !it.current->style()->preserveLF())) {
                             // If the next item on the line is text, and if we did not end with
                             // a space, then the next text run continues our word (and so it needs to
                             // keep adding to |tmpW|.  Just update and continue.
@@ -2305,8 +2260,9 @@
                     if (canPlaceOnLine && checkForBreak) {
                         w += tmpW;
                         tmpW = 0;
-                        lBreak.obj = next;
+                        lBreak.obj = it.current;
                         lBreak.pos = 0;
+                        lBreak.endOfInline = it.endOfInline;
                     }
                 }
             }
@@ -2316,7 +2272,7 @@
             //kDebug() << " too wide w=" << w << " tmpW = " << tmpW << " width = " << width;
             //kDebug() << "start=" << start.obj << " current=" << o;
             // if we have floats, try to get below them.
-            if (currentCharacterIsSpace && !ignoringSpaces && !o->style()->preserveWS())
+            if (currentCharacterIsSpace && !ignoringSpaces && !lastIt.current->style()->preserveWS())
                 trailingSpaceObject = 0;
 
             int fb = nearestFloatBottom(m_height);
@@ -2340,24 +2296,26 @@
             // |width| may have been adjusted because we got shoved down past a float (thus
             // giving us more room), so we need to retest, and only jump to
             // the end label if we still don't fit on the line. -dwh
-            if (w + tmpW > width)
+            if (w + tmpW > width) {
+                it = lastIt;
+                lastIt = savedIt;
+                o = it.current;
                 goto end;
+            }
         }
 
-        last = o;
-        o = next;
-
-        if (!last->isFloatingOrPositioned() && last->isReplaced() && last->style()->autoWrap()) {
+        if (!lastIt.current->isFloatingOrPositioned() && lastIt.current->isReplaced() && lastIt.current->style()->autoWrap()) {
             // Go ahead and add in tmpW.
             w += tmpW;
             tmpW = 0;
             lBreak.obj = o;
             lBreak.pos = 0;
+            lBreak.endOfInline = it.endOfInline;
         }
 
         // Clear out our character space bool, since inline <pre>s don't collapse whitespace
         // with adjacent inline normal/nowrap spans.
-        if (last->style()->preserveWS())
+        if (lastIt.current->style()->preserveWS())
             currentCharacterIsSpace = false;
 
         pos = 0;
@@ -2366,9 +2324,10 @@
 #ifdef DEBUG_LINEBREAKS
     kDebug( 6041 ) << "end of par, width = " << width << " linewidth = " << w + tmpW;
 #endif
-    if( w + tmpW <= width || (last && !last->style()->autoWrap())) {
+    if( w + tmpW <= width || (lastIt.current && !lastIt.current->style()->autoWrap())) {
         lBreak.obj = 0;
         lBreak.pos = 0;
+        lBreak.endOfInline = false;
     }
 
  end:
@@ -2380,21 +2339,25 @@
             if(pos != 0) {
                 lBreak.obj = o;
                 lBreak.pos = pos - 1;
+                lBreak.endOfInline = it.endOfInline;
             } else {
-                lBreak.obj = last;
-                lBreak.pos = last->isText() ? last->length() : 0;
+                lBreak.obj = lastIt.current;
+                lBreak.pos = lastIt.current->isText() ? lastIt.current->length() : 0;
+                lBreak.endOfInline = lastIt.endOfInline;
             }
         } else if( lBreak.obj ) {
-            if( last != o ) {
+            if( lastIt.current != o ) {
                 // better to break between object boundaries than in the middle of a word
                 lBreak.obj = o;
                 lBreak.pos = 0;
+                lBreak.endOfInline = it.endOfInline;
             } else {
                 // Don't ever break in the middle of a word if we can help it.
                 // There's no room at all. We just have to be on this line,
                 // even though we'll spill out.
                 lBreak.obj = o;
                 lBreak.pos = pos;
+                lBreak.endOfInline = it.endOfInline;
             }
         }
     }
@@ -2403,15 +2366,18 @@
         start = posStart;
 
     // make sure we consume at least one char/object.
-    if( lBreak == start )
-        lBreak.increment(bidi);
+    // and avoid returning an InlineFlow
+    // (FIXME: turn those wordbreaks into empty text objects - they shouldn't be inline flows!)
+    if( lBreak == start || (lBreak.obj && lBreak.obj->isInlineFlow() && !lBreak.obj->isWordBreak())) {
+        lBreak.increment();
+    }
 
 #ifdef DEBUG_LINEBREAKS
     kDebug(6041) << "regular break sol: " << start.obj << " " << start.pos << "   end: " << lBreak.obj << " " << lBreak.pos << "   width=" << w;
 #endif
 
     // Sanity check our midpoints.
-    checkMidpoints(lBreak, bidi);
+    checkMidpoints(lBreak);
 
     if (trailingSpaceObject) {
         // This object is either going to be part of the last midpoint, or it is going
@@ -2438,7 +2404,7 @@
     // code.
     if (lBreak.pos > 0) {
         lBreak.pos--;
-        lBreak.increment(bidi);
+        lBreak.increment();
     }
 
     if (lBreak.obj && lBreak.pos >= 2 && lBreak.obj->isText()) {
Index: khtml/rendering/render_line.cpp
===================================================================
--- khtml/rendering/render_line.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/rendering/render_line.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -418,8 +418,8 @@
 
     RenderObject* curr = endObject;
     RenderObject* parent = curr->parent();
-    while (parent && (!parent->isRenderBlock() || parent == object())) {
-        if (parent->lastChild() != curr)
+    while (parent && !parent->isRenderBlock()) {
+        if (parent->lastChild() != curr || parent == object())
             return false;
 
         curr = parent;
@@ -438,14 +438,13 @@
 
     RenderFlow* flow = static_cast<RenderFlow*>(object());
 
-    if (!flow->firstChild())
-        includeLeftEdge = includeRightEdge = true; // Empty inlines never split across lines.
-    else if (parent()) { // The root inline box never has borders/margins/padding.
+    // The root inline box never has borders/margins/padding.
+    if (parent()) {
         bool ltr = flow->style()->direction() == LTR;
 
         // Check to see if all initial lines are unconstructed.  If so, then
         // we know the inline began on this line.
-        if (!flow->firstLineBox()->isConstructed()) {
+        if (!flow->firstLineBox()->isConstructed() && !object()->isInlineContinuation()) {
             if (ltr && flow->firstLineBox() == this)
                 includeLeftEdge = true;
             else if (!ltr && flow->lastLineBox() == this)
Index: khtml/rendering/render_style.h
===================================================================
--- khtml/rendering/render_style.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/rendering/render_style.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -436,6 +436,10 @@
     REPEAT, REPEAT_X, REPEAT_Y, NO_REPEAT
 };
 
+enum EBackgroundAttachment {
+    BGASCROLL, BGAFIXED, BGALOCAL
+};
+
 struct LengthSize {
     Length width;
     Length height;
@@ -449,7 +453,7 @@
     CachedImage* backgroundImage() const { return m_image; }
     Length backgroundXPosition() const { return m_xPosition; }
     Length backgroundYPosition() const { return m_yPosition; }
-    bool backgroundAttachment() const { return m_bgAttachment; }
+    EBackgroundAttachment backgroundAttachment() const { return KDE_CAST_BF_ENUM(EBackgroundAttachment, m_bgAttachment); }
     EBackgroundBox backgroundClip() const { return KDE_CAST_BF_ENUM(EBackgroundBox, m_bgClip); }
     EBackgroundBox backgroundOrigin() const { return KDE_CAST_BF_ENUM(EBackgroundBox, m_bgOrigin); }
     EBackgroundRepeat backgroundRepeat() const { return KDE_CAST_BF_ENUM(EBackgroundRepeat, m_bgRepeat); }
@@ -470,7 +474,7 @@
     void setBackgroundImage(CachedImage* i) { m_image = i; m_imageSet = true; }
     void setBackgroundXPosition(const Length& l) { m_xPosition = l; m_xPosSet = true; }
     void setBackgroundYPosition(const Length& l) { m_yPosition = l; m_yPosSet = true; }
-    void setBackgroundAttachment(bool b) { m_bgAttachment = b; m_attachmentSet = true; }
+    void setBackgroundAttachment(EBackgroundAttachment b) { m_bgAttachment = b; m_attachmentSet = true; }
     void setBackgroundClip(EBackgroundBox b) { m_bgClip = b; m_clipSet = true; }
     void setBackgroundOrigin(EBackgroundBox b) { m_bgOrigin = b; m_originSet = true; }
     void setBackgroundRepeat(EBackgroundRepeat r) { m_bgRepeat = r; m_repeatSet = true; }
@@ -503,7 +507,7 @@
         return m_next ? m_next->hasImage() : false;
     }
     bool hasFixedImage() const {
-        if (m_image && !m_bgAttachment)
+        if (m_image && m_bgAttachment == BGAFIXED)
             return true;
         return m_next ? m_next->hasFixedImage() : false;
     }
@@ -516,7 +520,7 @@
     Length m_xPosition;
     Length m_yPosition;
 
-    bool m_bgAttachment : 1;
+    KDE_BF_ENUM(EBackgroundAttachment) m_bgAttachment : 2;
     KDE_BF_ENUM(EBackgroundBox) m_bgClip : 2;
     KDE_BF_ENUM(EBackgroundBox) m_bgOrigin : 2;
     KDE_BF_ENUM(EBackgroundRepeat) m_bgRepeat : 2;
@@ -1188,7 +1192,7 @@
     const QColor & backgroundColor() const { return background->m_color; }
     CachedImage *backgroundImage() const { return background->m_background.m_image; }
     EBackgroundRepeat backgroundRepeat() const { return static_cast<EBackgroundRepeat>(background->m_background.m_bgRepeat); }
-    bool backgroundAttachment() const { return background->m_background.m_bgAttachment; }
+    EBackgroundAttachment backgroundAttachment() const { return KDE_CAST_BF_ENUM(EBackgroundAttachment, background->m_background.m_bgAttachment); }
     Length backgroundXPosition() const { return background->m_background.m_xPosition; }
     Length backgroundYPosition() const { return background->m_background.m_yPosition; }
     BackgroundLayer* accessBackgroundLayers() { return &(background.access()->m_background); }
@@ -1474,7 +1478,7 @@
 #endif
 
     // Initial values for all the properties
-    static bool initialBackgroundAttachment() { return true; }
+    static EBackgroundAttachment initialBackgroundAttachment() { return BGASCROLL; }
     static EBackgroundBox initialBackgroundClip() { return BGBORDER; }
     static EBackgroundBox initialBackgroundOrigin() { return BGPADDING; }
     static EBackgroundRepeat initialBackgroundRepeat() { return REPEAT; }
Index: khtml/rendering/render_box.cpp
===================================================================
--- khtml/rendering/render_box.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/rendering/render_box.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -585,7 +585,7 @@
 
         // CSS2 chapter 14.2.1
 
-        if (bgLayer->backgroundAttachment()) {
+        if (bgLayer->backgroundAttachment() != BGAFIXED) {
             //scroll
             int hpab = 0, vpab = 0, left = 0, top = 0; // Init to 0 for background-origin of 'border'
             if (bgLayer->backgroundOrigin() != BGBORDER) {
@@ -672,7 +672,7 @@
                     sy -= top % scaledImageHeight;
                 }
             }
-	    if (layer())
+	    if (layer() && bgLayer->backgroundAttachment() == BGALOCAL)
 		layer()->scrollOffset(sx, sy);
         }
         else
Index: khtml/rendering/render_object.cpp
===================================================================
--- khtml/rendering/render_object.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/rendering/render_object.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -2593,8 +2593,9 @@
                 vpos += -b.height()/2 - lineHeight( firstLine )/2 + baselinePosition( firstLine );
             } else if ( va == TEXT_BOTTOM ) {
                 vpos += QFontMetrics(f).descent() + QFontMetrics(f).leading()/2;
-                if ( !isReplaced() )
-                    vpos -= fontMetrics(firstLine).descent();
+                if ( !isReplaced() ) {
+                    vpos -= (lineHeight(firstLine) - baselinePosition(firstLine));
+                }
             } else if ( va == BASELINE_MIDDLE )
                 vpos += - lineHeight( firstLine )/2 + baselinePosition( firstLine );
         }
Index: khtml/rendering/render_canvas.cpp
===================================================================
--- khtml/rendering/render_canvas.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/rendering/render_canvas.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -4,7 +4,7 @@
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 2003 Apple Computer, Inc.
  *           (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
- *           (C) 2007-2008 Germain Garand (germain@ebooksfrance.org)
+ *           (C) 2007-2009 Germain Garand (germain@ebooksfrance.org)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -33,6 +33,12 @@
 #include <kdebug.h>
 #include <kglobal.h>
 #include <QScrollBar>
+#if QT_VERSION < 0x040500
+    #define SCROLLBAR_WIDTH_HACK
+    #include <QStyle>
+    #include <QLayout>
+    #include <QStyleOption>
+#endif
 
 using namespace khtml;
 
@@ -232,41 +238,62 @@
 
     if (!m_pagedMode && m_view) {
 
+        // we need to adjust the document's size to make sure we don't enter
+        // an endless cycle of scrollbars being added, then removed at the next layout.
+
         bool vss = m_view->verticalScrollBar()->isVisible();
         bool hss = m_view->horizontalScrollBar()->isVisible();
-        QSize s = m_view->maximumViewportSize();
 
-        int zoomedDocWidth = m_cachedDocWidth*zLevel/100;
-        int zoomedDocHeight = m_cachedDocHeight*zLevel/100;
-        if ( zoomedDocWidth > s.width() )
-            s.setWidth( s.width()-m_view->verticalScrollBar()->sizeHint().width() );
-        if ( zoomedDocHeight > s.height() )
-            s.setHeight( s.height()-m_view->horizontalScrollBar()->sizeHint().height() );
-   
+        // calculate the extent of scrollbars
+        int vsPixSize = m_view->verticalScrollBar()->sizeHint().width();
+        int hsPixSize = m_view->horizontalScrollBar()->sizeHint().height();
+
+#ifdef SCROLLBAR_WIDTH_HACK 
+        // ### hackish turnaround for a bug in QAbstractScrollArea triggered by Oxygen.
+        QStyleOption opt(0);
+        opt.init(m_view);
+        if (m_view->style()->styleHint(QStyle::SH_ScrollView_FrameOnlyAroundContents, &opt, m_view)) {
+            int fudge = m_view->style()->pixelMetric(QStyle::PM_DefaultFrameWidth)*2;
+            vsPixSize += fudge;
+            hsPixSize += fudge;
+        }
+#endif
+
+        // this variable holds the size the viewport will have after the inner content is resized to
+        // the new document dimensions
+        QSize viewport = m_view->maximumViewportSize();
+
+        // of course, if the scrollbar policy isn't auto, there's no point adjusting any value..
+        int overrideH = m_view->verticalScrollBarPolicy() == Qt::ScrollBarAsNeeded ? 0 : hDocH;
+        int overrideW = m_view->verticalScrollBarPolicy() == Qt::ScrollBarAsNeeded ? 0 : hDocW;
+        
+        if ( !overrideW && hDocW > viewport.width() )
+            viewport.setHeight( viewport.height() - hsPixSize );
+        if ( !overrideH && hDocH > viewport.height() )
+            viewport.setWidth( viewport.width() - vsPixSize );
+            
         // if we are about to show a scrollbar, and the document is sized to the viewport w or h,
         // then reserve the scrollbar space so that it doesn't trigger the _other_ scrollbar
 
-        if (!vss && m_width - m_view->verticalScrollBar()->sizeHint().width() == s.width() &&
-            zoomedDocWidth <= m_width)
-            hDocW = qMin( zoomedDocWidth, s.width() );
+        if (!vss && m_width - vsPixSize == viewport.width() &&
+            hDocW <= m_width)
+            hDocW = qMin( hDocW, viewport.width() );
 
-        if (!hss && m_height - m_view->horizontalScrollBar()->sizeHint().height() == s.height() &&
-            zoomedDocHeight <= m_height)
-            hDocH = qMin( zoomedDocHeight, s.height() );
+        if (!hss && m_height - hsPixSize == viewport.height() &&
+            hDocH <= m_height)
+            hDocH = qMin( hDocH, viewport.height() );
 
         // likewise, if a scrollbar is shown, and we have a cunning plan to turn it off,
         // think again if we are falling downright in the hysteresis zone
 
-        if (vss && s.width() > zoomedDocWidth && zoomedDocWidth > m_view->visibleWidth())
-            hDocW = s.width()+1;
+        if (vss && viewport.width() > hDocW && hDocW > m_view->visibleWidth())
+            hDocW = viewport.width()+1;
 
-        if (hss && s.height() > zoomedDocHeight && zoomedDocHeight > m_view->visibleHeight())
-            hDocH = s.height()+1;
+        if (hss && viewport.height() > hDocH && hDocH > m_view->visibleHeight())
+            hDocH = viewport.height()+1;
 
-        m_view->resizeContents(hDocW, hDocH);
+        m_view->resizeContents((overrideW ? overrideW : hDocW), (overrideH ? overrideH : hDocH));
 
-        setWidth( m_viewportWidth = s.width() );
-        setHeight( m_viewportHeight = s.height() );
     }
     layer()->resize( qMax( m_cachedDocWidth,int( m_width ) ), qMax( m_cachedDocHeight,m_height ) );
 }
@@ -318,7 +345,7 @@
            int d1, d2, d3, d4;
            const BackgroundLayer* bgLayer = ro->style()->backgroundLayers();
            while (bgLayer) {
-               CachedImage* bg = bgLayer->backgroundAttachment() ? 0 : bgLayer->backgroundImage();
+               CachedImage* bg = bgLayer->backgroundAttachment() == BGAFIXED ? bgLayer->backgroundImage() : 0;
                if (bg && bg->isComplete() && !bg->isTransparent() && !bg->isErrorImage()) {
                    int xpos, ypos;
                    absolutePosition(xpos,ypos);
Index: khtml/rendering/bidi.h
===================================================================
--- khtml/rendering/bidi.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/rendering/bidi.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -24,6 +24,7 @@
 #define BIDI_H
 
 #include <QtCore/QString>
+#include "rendering/render_object.h"
 
 namespace khtml {
     class RenderArena;
@@ -108,6 +109,70 @@
         QChar::Direction last;
     };
 
+    struct InlineMinMaxIterator
+    {
+    /* InlineMinMaxIterator is a class that will iterate over all render objects that contribute to
+       inline min/max width calculations.  Note the following about the way it walks:
+       (1) Positioned content is skipped (since it does not contribute to min/max width of a block)
+       (2) We do not drill into the children of floats or replaced elements, since you can't break
+           in the middle of such an element.
+       (3) Inline flows (e.g., <a>, <span>, <i>) are walked twice, since each side can have
+           distinct borders/margin/padding that contribute to the min/max width.
+    */
+        RenderObject* parent;
+        RenderObject* current;
+        bool endOfInline;
+        bool skipPositioned;
+        InlineMinMaxIterator(RenderObject* p, RenderObject* o, bool eOI=false, bool skipPos=true)
+            :parent(p), current(o), endOfInline(eOI), skipPositioned(skipPos) {}
+        inline RenderObject* next();
+    };
+
+    inline RenderObject* InlineMinMaxIterator::next()
+    {
+        RenderObject* result = 0;
+        bool oldEndOfInline = endOfInline;
+        endOfInline = false;
+        while (current != 0 || (current == parent))
+        {
+            //kDebug( 6040 ) << "current = " << current;
+            if (!oldEndOfInline &&
+                (current == parent ||
+                (!current->isFloating() && !current->isReplaced() && !current->isPositioned())))
+                result = current->firstChild();
+            if (!result) {
+                // We hit the end of our inline. (It was empty, e.g., <span></span>.)
+                if (!oldEndOfInline && current->isInlineFlow()) {
+                    result = current;
+                    endOfInline = true;
+                    break;
+                }
+                while (current && current != parent) {
+                    result = current->nextSibling();
+                    if (result) break;
+                    current = current->parent();
+                    if (current && current != parent && current->isInlineFlow()) {
+                        result = current;
+                        endOfInline = true;
+                        break;
+                    }
+                }
+            }
+
+            if (!result) break;
+
+            if ((!skipPositioned || !result->isPositioned()) && (result->isText() || result->isBR() ||
+                result->isFloatingOrPositioned() || result->isReplaced() || result->isGlyph() || result->isInlineFlow()))
+                break;
+
+            current = result;
+            result = 0;
+        }
+
+        // Update our position.
+        current = result;
+        return current;
+    }
 }
 
 #endif
Index: khtml/rendering/render_block.cpp
===================================================================
--- khtml/rendering/render_block.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/rendering/render_block.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -5,7 +5,7 @@
  *           (C) 1999-2003 Antti Koivisto (koivisto@kde.org)
  *           (C) 2002-2003 Dirk Mueller (mueller@kde.org)
  *           (C) 2003-2008 Apple Computer, Inc.
- *           (C) 2004-2008 Germain Garand (germain@ebooksfrance.org)
+ *           (C) 2004-2009 Germain Garand (germain@ebooksfrance.org)
  *           (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
  *           (C) 2006 Charles Samuels (charles@kde.org)
  *
@@ -591,47 +591,82 @@
     RenderObject* prev = oldChild->previousSibling();
     RenderObject* next = oldChild->nextSibling();
     bool mergedBlocks = false;
-    if (!documentBeingDestroyed() && !isInline() && !oldChild->isInline() && !oldChild->continuation() &&
-        prev && prev->isAnonymousBlock() && prev->childrenInline() &&
-        next && next->isAnonymousBlock() && next->childrenInline()) {
-        // Take all the children out of the |next| block and put them in
-        // the |prev| block.
-        RenderObject* o = next->firstChild();
-        while (o) {
-            RenderObject* no = o;
-            o = no->nextSibling();
-            prev->appendChildNode(next->removeChildNode(no));
-            no->setNeedsLayoutAndMinMaxRecalc();
-        }
-        prev->setNeedsLayoutAndMinMaxRecalc();
+    bool checkContinuationMerge = false;
+    if (!documentBeingDestroyed() && !isInline() && !oldChild->isInline() && !oldChild->continuation()) {
+        if (prev && prev->isAnonymousBlock() && prev->childrenInline() &&
+            next && next->isAnonymousBlock() && next->childrenInline()) {
+            // Take all the children out of the |next| block and put them in
+            // the |prev| block.
+            RenderObject* o = next->firstChild();
+            while (o) {
+                RenderObject* no = o;
+                o = no->nextSibling();
+                prev->appendChildNode(next->removeChildNode(no));
+            }
 
-        // Nuke the now-empty block.
-        static_cast<RenderBlock*>(next)->deleteLineBoxTree();
-        next->detach();
+            // Detach the now-empty block.
+            static_cast<RenderBlock*>(next)->deleteLineBoxTree();
+            next->detach();
 
-        mergedBlocks = true;
-    }
+            mergedBlocks = true;
+        }
 
+        // Check if there are continuations we could merge
+        checkContinuationMerge = (mergedBlocks || (!prev && !next)) && continuation() && isAnonymousBlock() &&
+                                 continuation()->parent() && continuation()->parent()->isAnonymousBlock() && continuation()->isRenderInline() && 
+                                 previousSibling() && previousSibling()->isAnonymousBlock() && previousSibling()->lastChild() && previousSibling()->lastChild()->continuation() &&
+                                 previousSibling()->lastChild()->isRenderInline() && (previousSibling()->lastChild()->continuation() == this);
+    } 
+
     RenderFlow::removeChild(oldChild);
 
     if (mergedBlocks && prev && !prev->previousSibling() && !prev->nextSibling()) {
         // The remerge has knocked us down to containing only a single anonymous
         // box.  We can go ahead and pull the content right back up into our
         // box.
-        RenderBlock* anonBlock = static_cast<RenderBlock*>(removeChildNode(prev));
+        RenderBlock* anonBlock = static_cast<RenderBlock*>(prev);
         m_childrenInline = true;
         RenderObject* o = anonBlock->firstChild();
         while (o) {
             RenderObject* no = o;
             o = no->nextSibling();
             appendChildNode(anonBlock->removeChildNode(no));
-            no->setNeedsLayoutAndMinMaxRecalc();
         }
 
-        // Nuke the now-empty block.
+        // Detach the now-empty block.
         anonBlock->deleteLineBoxTree();
         anonBlock->detach();
     }
+    if (checkContinuationMerge && (!prev && !next || m_childrenInline)) {
+        // |oldChild| was a block that splitted an inline into continuations.
+        // Now that we only have inline content left, we may merge back those continuations
+        // into a single inline.
+        prev = previousSibling()->lastChild();
+        assert(prev->isRenderInline());
+        RenderObject* o = firstChild();
+        // Move our remaining children back to our antecedent in the
+        // continuation chain
+        while (o) {
+                RenderObject* no = o;
+                o = no->nextSibling();
+                prev->appendChildNode(removeChildNode(no));
+        }
+        // And move our continuation's content to the same location
+        next = continuation();
+        o = next->firstChild();
+        while (o) {
+                RenderObject* no = o;
+                o = no->nextSibling();
+                prev->appendChildNode(next->removeChildNode(no));
+        }
+
+        static_cast<RenderFlow*>(prev)->setContinuation( next->continuation() );
+        setContinuation( 0 );
+
+        next->detach();
+        deleteLineBoxTree();
+        detach();
+    }
 }
 
 bool RenderBlock::isSelfCollapsingBlock() const
@@ -2634,7 +2669,7 @@
 
     if (m_layer->horizontalScrollbarHeight()) {
         QRect horizRect(_tx + borderLeft(),
-                        _ty + height() + borderTop() + borderBottomExtra() - borderBottom() - m_layer->horizontalScrollbarHeight(),
+                        _ty + height() - borderBottom() + borderBottomExtra() - m_layer->horizontalScrollbarHeight(),
                         width()-borderLeft()-borderRight(),
                         m_layer->horizontalScrollbarHeight());
         if (horizRect.contains(_x, _y)) {
@@ -2837,74 +2872,6 @@
     // ### compare with min/max width set in style sheet...
 }
 
-struct InlineMinMaxIterator
-{
-/* InlineMinMaxIterator is a class that will iterate over all render objects that contribute to
-   inline min/max width calculations.  Note the following about the way it walks:
-   (1) Positioned content is skipped (since it does not contribute to min/max width of a block)
-   (2) We do not drill into the children of floats or replaced elements, since you can't break
-       in the middle of such an element.
-   (3) Inline flows (e.g., <a>, <span>, <i>) are walked twice, since each side can have
-       distinct borders/margin/padding that contribute to the min/max width.
-*/
-    RenderObject* parent;
-    RenderObject* current;
-    bool endOfInline;
-
-    InlineMinMaxIterator(RenderObject* p, RenderObject* o, bool end = false)
-        :parent(p), current(o), endOfInline(end) {}
-
-    RenderObject* next();
-};
-
-RenderObject* InlineMinMaxIterator::next()
-{
-    RenderObject* result = 0;
-    bool oldEndOfInline = endOfInline;
-    endOfInline = false;
-    while (current != 0 || (current == parent))
-    {
-        //kDebug( 6040 ) << "current = " << current;
-        if (!oldEndOfInline &&
-            (current == parent ||
-             (!current->isFloating() && !current->isReplaced() && !current->isPositioned())))
-            result = current->firstChild();
-        if (!result) {
-            // We hit the end of our inline. (It was empty, e.g., <span></span>.)
-            if (!oldEndOfInline && current->isInlineFlow()) {
-                result = current;
-                endOfInline = true;
-                break;
-            }
-
-            while (current && current != parent) {
-                result = current->nextSibling();
-                if (result) break;
-                current = current->parent();
-                if (current && current != parent && current->isInlineFlow()) {
-                    result = current;
-                    endOfInline = true;
-                    break;
-                }
-            }
-        }
-
-        if (!result) break;
-
-        if (!result->isPositioned() && (result->isText() || result->isBR() ||
-            result->isFloating() || result->isReplaced() ||
-            result->isInlineFlow()))
-            break;
-
-        current = result;
-        result = 0;
-    }
-
-    // Update our position.
-    current = result;
-    return current;
-}
-
 // bidi.cpp defines the following functions too.
 // Maybe these should not be static, after all...
 
Index: khtml/css/parser.h
===================================================================
--- khtml/css/parser.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/parser.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1,24 +1,23 @@
-/* A Bison parser, made by GNU Bison 2.3.  */
 
-/* Skeleton interface for Bison's Yacc-like parsers in C
+/* A Bison parser, made by GNU Bison 2.4.1.  */
 
-   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004, 2005, 2006
+/* Skeleton interface for Bison's Yacc-like parsers in C
+   
+      Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004, 2005, 2006
    Free Software Foundation, Inc.
-
-   This program is free software; you can redistribute it and/or modify
+   
+   This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2, or (at your option)
-   any later version.
-
+   the Free Software Foundation, either version 3 of the License, or
+   (at your option) any later version.
+   
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
-
+   
    You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 51 Franklin Street, Fifth Floor,
-   Boston, MA 02110-1301, USA.  */
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */
 
 /* As a special exception, you may create a larger work that contains
    part or all of the Bison parser skeleton and distribute that work
@@ -29,17 +28,18 @@
    special exception, which will cause the skeleton and the resulting
    Bison output files to be licensed under the GNU General Public
    License without this special exception.
-
+   
    This special exception was added by the Free Software Foundation in
    version 2.2 of Bison.  */
 
+
 /* Tokens.  */
 #ifndef YYTOKENTYPE
 # define YYTOKENTYPE
    /* Put the tokens into the symbol table, so that GDB and other debuggers
       know about them.  */
    enum yytokentype {
-     UNIMPORTANT_TOK = 258,
+     REDUCE = 258,
      S = 259,
      SGML_CD = 260,
      INCLUDES = 261,
@@ -94,68 +94,14 @@
      UNICODERANGE = 310
    };
 #endif
-/* Tokens.  */
-#define UNIMPORTANT_TOK 258
-#define S 259
-#define SGML_CD 260
-#define INCLUDES 261
-#define DASHMATCH 262
-#define BEGINSWITH 263
-#define ENDSWITH 264
-#define CONTAINS 265
-#define STRING 266
-#define IDENT 267
-#define NTH 268
-#define HASH 269
-#define HEXCOLOR 270
-#define IMPORT_SYM 271
-#define PAGE_SYM 272
-#define MEDIA_SYM 273
-#define FONT_FACE_SYM 274
-#define CHARSET_SYM 275
-#define NAMESPACE_SYM 276
-#define KHTML_RULE_SYM 277
-#define KHTML_DECLS_SYM 278
-#define KHTML_VALUE_SYM 279
-#define KHTML_MEDIAQUERY_SYM 280
-#define IMPORTANT_SYM 281
-#define MEDIA_ONLY 282
-#define MEDIA_NOT 283
-#define MEDIA_AND 284
-#define QEMS 285
-#define EMS 286
-#define EXS 287
-#define PXS 288
-#define CMS 289
-#define MMS 290
-#define INS 291
-#define PTS 292
-#define PCS 293
-#define DEGS 294
-#define RADS 295
-#define GRADS 296
-#define MSECS 297
-#define SECS 298
-#define HERZ 299
-#define KHERZ 300
-#define DPI 301
-#define DPCM 302
-#define DIMEN 303
-#define PERCENTAGE 304
-#define FLOAT 305
-#define INTEGER 306
-#define URI 307
-#define FUNCTION 308
-#define NOTFUNCTION 309
-#define UNICODERANGE 310
 
 
 
-
 #if ! defined YYSTYPE && ! defined YYSTYPE_IS_DECLARED
 typedef union YYSTYPE
-
 {
+
+
     CSSRuleImpl *rule;
     CSSSelector *selector;
     QList<CSSSelector*> *selectorList;
@@ -179,14 +125,15 @@
     khtml::MediaQueryExp* mediaQueryExp;
     QList<khtml::MediaQueryExp*>* mediaQueryExpList;
     khtml::MediaQuery::Restrictor mediaQueryRestrictor;
-}
-/* Line 1489 of yacc.c.  */
 
-	YYSTYPE;
+
+
+} YYSTYPE;
+# define YYSTYPE_IS_TRIVIAL 1
 # define yystype YYSTYPE /* obsolescent; will be withdrawn */
 # define YYSTYPE_IS_DECLARED 1
-# define YYSTYPE_IS_TRIVIAL 1
 #endif
 
 
 
+
Index: khtml/css/cssparser.cpp
===================================================================
--- khtml/css/cssparser.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/cssparser.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1766,7 +1766,7 @@
         else {
             switch (propId) {
                 case CSS_PROP_BACKGROUND_ATTACHMENT:
-                    if (val->id == CSS_VAL_SCROLL || val->id == CSS_VAL_FIXED) {
+                    if (val->id == CSS_VAL_SCROLL || val->id == CSS_VAL_FIXED || val->id == CSS_VAL_LOCAL) {
                         currValue = new CSSPrimitiveValueImpl(val->id);
                         valueList->next();
                     }
@@ -2817,4 +2817,4 @@
 #define COMMENT 1
 
 #include "tokenizer.cpp"
-// kate: indent-width 4; replace-tabs on; tab-width 4; space-indent on; hl c++;
\ No newline at end of file
+// kate: indent-width 4; replace-tabs on; tab-width 4; space-indent on; hl c++;
Index: khtml/css/parser.y
===================================================================
--- khtml/css/parser.y	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/parser.y	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -91,7 +91,7 @@
 #define YYLTYPE_IS_TRIVIAL 1
 %}
 
-%expect 34
+%expect 38
 
 %pure_parser
 
@@ -151,7 +151,7 @@
 %no-lines
 %verbose
 
-%left UNIMPORTANT_TOK
+%left REDUCE
 
 %token S SGML_CD
 
@@ -347,7 +347,7 @@
 ;
 
 maybe_space:
-    /* empty */ %prec UNIMPORTANT_TOK
+    /* empty */ %prec REDUCE
   | maybe_space S
   ;
 
@@ -413,7 +413,7 @@
   ;
 
 namespace_list:
-    /* empty */ %prec UNIMPORTANT_TOK
+    /* empty */ %prec REDUCE
   | namespace_list namespace maybe_sgml
 ;
 
@@ -633,7 +633,6 @@
     '+' maybe_space { $$ = CSSSelector::DirectAdjacent; }
   | '~' maybe_space { $$ = CSSSelector::IndirectAdjacent; }
   | '>' maybe_space { $$ = CSSSelector::Child; }
-  | /* empty */ { $$ = CSSSelector::Descendant; }
   ;
 
 unary_operator:
@@ -664,7 +663,7 @@
   ;
 
 selector_list:
-    selector %prec UNIMPORTANT_TOK {
+    selector %prec REDUCE {
 	if ( $1 ) {
 	    $$ = new QList<CSSSelector*>;
 #ifdef CSS_DEBUG
@@ -677,7 +676,7 @@
 	    $$ = 0;
 	}
     }
-    | selector_list ',' maybe_space selector %prec UNIMPORTANT_TOK {
+    | selector_list ',' maybe_space selector %prec REDUCE {
 	if ( $1 && $4 ) {
 	    $$ = $1;
 	    $$->append( $4 );
@@ -703,10 +702,28 @@
     }
    ;
 
+
 selector:
     simple_selector {
 	$$ = $1;
     }
+    | selector S {
+        $$ = $1;
+    }
+    | selector S simple_selector {
+        if ( !$1 || !$3 ) {
+	    delete $1;
+	    delete $3;
+	    $$ = 0;
+        } else {
+            $$ = $3;
+            CSSSelector *end = $$;
+            while( end->tagHistory )
+                end = end->tagHistory;
+            end->relation = CSSSelector::Descendant;
+            end->tagHistory = $1;
+        }
+    }
     | selector combinator simple_selector {
 	if ( !$1 || !$3 ) {
 	    delete $1;
@@ -734,26 +751,26 @@
 ;
 
 simple_selector:
-    element_name maybe_space {
+    element_name {
 	$$ = new CSSSelector();
         $$->tagLocalName = LocalName::fromId(localNamePart($1));
         $$->tagNamespace = NamespaceName::fromId(namespacePart($1));
     }
-    | element_name specifier_list maybe_space {
+    | element_name specifier_list {
 	$$ = $2;
         if ( $$ ) {
             $$->tagLocalName = LocalName::fromId(localNamePart($1));
             $$->tagNamespace = NamespaceName::fromId(namespacePart($1));
         }
     }
-    | specifier_list maybe_space {
+    | specifier_list {
 	$$ = $1;
         if ( $$ ) {
             $$->tagLocalName = LocalName::fromId(anyLocalName);
             $$->tagNamespace = NamespaceName::fromId(static_cast<CSSParser*>(parser)->defaultNamespace());
         }
     }
-    | namespace_selector element_name maybe_space {
+    | namespace_selector element_name {
         $$ = new CSSSelector();
         $$->tagLocalName = LocalName::fromId(localNamePart($2));
         $$->tagNamespace = NamespaceName::fromId(namespacePart($2));
@@ -761,7 +778,7 @@
         if (p->styleElement && p->styleElement->isCSSStyleSheet())
             static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace($$->tagNamespace, domString($1));
     }
-    | namespace_selector element_name specifier_list maybe_space {
+    | namespace_selector element_name specifier_list {
         $$ = $3;
         if ($$) {
             $$->tagLocalName = LocalName::fromId(localNamePart($2));
@@ -771,7 +788,7 @@
                 static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace($$->tagNamespace, domString($1));
         }
     }
-    | namespace_selector specifier_list maybe_space {
+    | namespace_selector specifier_list {
         $$ = $2;
         if ($$) {
             $$->tagLocalName = LocalName::fromId(anyLocalName);
@@ -784,19 +801,19 @@
   ;
 
 simple_css3_selector:
-    element_name maybe_space {
+    element_name {
 	$$ = new CSSSelector();
         $$->tagLocalName = LocalName::fromId(localNamePart($1));
         $$->tagNamespace = NamespaceName::fromId(namespacePart($1));
     }
-    | specifier maybe_space {
+    | specifier {
 	$$ = $1;
         if ( $$ ) {
             $$->tagLocalName = LocalName::fromId(anyLocalName);
             $$->tagNamespace = NamespaceName::fromId(static_cast<CSSParser*>(parser)->defaultNamespace());
         }
     }
-    | namespace_selector element_name maybe_space {
+    | namespace_selector element_name {
         $$ = new CSSSelector();
         $$->tagLocalName = LocalName::fromId(localNamePart($2));
         $$->tagNamespace = NamespaceName::fromId(namespacePart($2));
@@ -804,7 +821,7 @@
         if (p->styleElement && p->styleElement->isCSSStyleSheet())
             static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace($$->tagNamespace, domString($1));
     }
-    | namespace_selector specifier maybe_space {
+    | namespace_selector specifier {
         $$ = $2;
         if ($$) {
             $$->tagLocalName = LocalName::fromId(anyLocalName);
@@ -818,20 +835,8 @@
 
 element_name:
     IDENT {
-	CSSParser *p = static_cast<CSSParser *>(parser);
-	DOM::DocumentImpl *doc = p->document();
-	QString tag = qString($1);
-	if ( doc ) {
-	    if (doc->isHTMLDocument())
-		tag = tag.toLower();
-	    const DOMString dtag(tag);
-            $$ = makeId(p->defaultNamespace(), p->getLocalNameId(dtag));
-	} else {
-	    $$ = makeId(p->defaultNamespace(), p->getLocalNameId(tag.toLower()));
-	    // this case should never happen - only when loading
-	    // the default stylesheet - which must not contain unknown tags
-// 	    assert($$ != 0);
-	}
+      CSSParser *p = static_cast<CSSParser *>(parser);
+      $$ = makeId(p->defaultNamespace(), p->getLocalNameId(domString($1)));
     }
     | '*' {
 	$$ = makeId(static_cast<CSSParser*>(parser)->defaultNamespace(), anyLocalName);
@@ -897,25 +902,8 @@
 
 attrib_id:
     IDENT maybe_space {
-	CSSParser *p = static_cast<CSSParser *>(parser);
-	DOM::DocumentImpl *doc = p->document();
-
-	QString attr = qString($1);
-	if ( doc ) {
-	    if (doc->isHTMLDocument())
-		attr = attr.toLower();
-	    const DOMString dattr(attr);
-#ifdef APPLE_CHANGES
-            $$ = doc->attrId(0, dattr.implementation(), false);
-#else
-	    $$ = makeId(emptyNamespace, p->getLocalNameId(dattr));
-#endif
-	} else {
-	    $$ = makeId(emptyNamespace, p->getLocalNameId(attr.toLower()));
-	    // this case should never happen - only when loading
-	    // the default stylesheet - which must not contain unknown attributes
-	    assert($$ != 0);
-	    }
+      CSSParser *p = static_cast<CSSParser *>(parser);
+      $$ = makeId(emptyNamespace, p->getLocalNameId(domString($1)));
     }
     ;
 
@@ -1021,7 +1009,7 @@
         $$->value = domString($2);
     }
     // used only by :not
-    | ':' NOTFUNCTION maybe_space simple_css3_selector ')' {
+    | ':' NOTFUNCTION maybe_space simple_css3_selector maybe_space ')' {
         $$ = new CSSSelector();
         $$->match = CSSSelector::PseudoClass;
         $$->simpleSelector = $4;
Index: khtml/css/parser.cpp
===================================================================
--- khtml/css/parser.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/parser.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1,24 +1,23 @@
-/* A Bison parser, made by GNU Bison 2.3.  */
 
-/* Skeleton implementation for Bison's Yacc-like parsers in C
+/* A Bison parser, made by GNU Bison 2.4.1.  */
 
-   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004, 2005, 2006
+/* Skeleton implementation for Bison's Yacc-like parsers in C
+   
+      Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004, 2005, 2006
    Free Software Foundation, Inc.
-
-   This program is free software; you can redistribute it and/or modify
+   
+   This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2, or (at your option)
-   any later version.
-
+   the Free Software Foundation, either version 3 of the License, or
+   (at your option) any later version.
+   
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
-
+   
    You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 51 Franklin Street, Fifth Floor,
-   Boston, MA 02110-1301, USA.  */
+   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */
 
 /* As a special exception, you may create a larger work that contains
    part or all of the Bison parser skeleton and distribute that work
@@ -29,7 +28,7 @@
    special exception, which will cause the skeleton and the resulting
    Bison output files to be licensed under the GNU General Public
    License without this special exception.
-
+   
    This special exception was added by the Free Software Foundation in
    version 2.2 of Bison.  */
 
@@ -47,7 +46,7 @@
 #define YYBISON 1
 
 /* Bison version.  */
-#define YYBISON_VERSION "2.3"
+#define YYBISON_VERSION "2.4.1"
 
 /* Skeleton name.  */
 #define YYSKELETON_NAME "yacc.c"
@@ -55,138 +54,25 @@
 /* Pure parsers.  */
 #define YYPURE 1
 
+/* Push parsers.  */
+#define YYPUSH 0
+
+/* Pull parsers.  */
+#define YYPULL 1
+
 /* Using locations.  */
 #define YYLSP_NEEDED 0
 
 /* Substitute the variable and function names.  */
-#define yyparse cssyyparse
-#define yylex   cssyylex
-#define yyerror cssyyerror
-#define yylval  cssyylval
-#define yychar  cssyychar
-#define yydebug cssyydebug
-#define yynerrs cssyynerrs
+#define yyparse         cssyyparse
+#define yylex           cssyylex
+#define yyerror         cssyyerror
+#define yylval          cssyylval
+#define yychar          cssyychar
+#define yydebug         cssyydebug
+#define yynerrs         cssyynerrs
 
 
-/* Tokens.  */
-#ifndef YYTOKENTYPE
-# define YYTOKENTYPE
-   /* Put the tokens into the symbol table, so that GDB and other debuggers
-      know about them.  */
-   enum yytokentype {
-     UNIMPORTANT_TOK = 258,
-     S = 259,
-     SGML_CD = 260,
-     INCLUDES = 261,
-     DASHMATCH = 262,
-     BEGINSWITH = 263,
-     ENDSWITH = 264,
-     CONTAINS = 265,
-     STRING = 266,
-     IDENT = 267,
-     NTH = 268,
-     HASH = 269,
-     HEXCOLOR = 270,
-     IMPORT_SYM = 271,
-     PAGE_SYM = 272,
-     MEDIA_SYM = 273,
-     FONT_FACE_SYM = 274,
-     CHARSET_SYM = 275,
-     NAMESPACE_SYM = 276,
-     KHTML_RULE_SYM = 277,
-     KHTML_DECLS_SYM = 278,
-     KHTML_VALUE_SYM = 279,
-     KHTML_MEDIAQUERY_SYM = 280,
-     IMPORTANT_SYM = 281,
-     MEDIA_ONLY = 282,
-     MEDIA_NOT = 283,
-     MEDIA_AND = 284,
-     QEMS = 285,
-     EMS = 286,
-     EXS = 287,
-     PXS = 288,
-     CMS = 289,
-     MMS = 290,
-     INS = 291,
-     PTS = 292,
-     PCS = 293,
-     DEGS = 294,
-     RADS = 295,
-     GRADS = 296,
-     MSECS = 297,
-     SECS = 298,
-     HERZ = 299,
-     KHERZ = 300,
-     DPI = 301,
-     DPCM = 302,
-     DIMEN = 303,
-     PERCENTAGE = 304,
-     FLOAT = 305,
-     INTEGER = 306,
-     URI = 307,
-     FUNCTION = 308,
-     NOTFUNCTION = 309,
-     UNICODERANGE = 310
-   };
-#endif
-/* Tokens.  */
-#define UNIMPORTANT_TOK 258
-#define S 259
-#define SGML_CD 260
-#define INCLUDES 261
-#define DASHMATCH 262
-#define BEGINSWITH 263
-#define ENDSWITH 264
-#define CONTAINS 265
-#define STRING 266
-#define IDENT 267
-#define NTH 268
-#define HASH 269
-#define HEXCOLOR 270
-#define IMPORT_SYM 271
-#define PAGE_SYM 272
-#define MEDIA_SYM 273
-#define FONT_FACE_SYM 274
-#define CHARSET_SYM 275
-#define NAMESPACE_SYM 276
-#define KHTML_RULE_SYM 277
-#define KHTML_DECLS_SYM 278
-#define KHTML_VALUE_SYM 279
-#define KHTML_MEDIAQUERY_SYM 280
-#define IMPORTANT_SYM 281
-#define MEDIA_ONLY 282
-#define MEDIA_NOT 283
-#define MEDIA_AND 284
-#define QEMS 285
-#define EMS 286
-#define EXS 287
-#define PXS 288
-#define CMS 289
-#define MMS 290
-#define INS 291
-#define PTS 292
-#define PCS 293
-#define DEGS 294
-#define RADS 295
-#define GRADS 296
-#define MSECS 297
-#define SECS 298
-#define HERZ 299
-#define KHERZ 300
-#define DPI 301
-#define DPCM 302
-#define DIMEN 303
-#define PERCENTAGE 304
-#define FLOAT 305
-#define INTEGER 306
-#define URI 307
-#define FUNCTION 308
-#define NOTFUNCTION 309
-#define UNICODERANGE 310
-
-
-
-
 /* Copy the first part of user declarations.  */
 
 
@@ -282,6 +168,7 @@
 #define YYLTYPE_IS_TRIVIAL 1
 
 
+
 /* Enabling traces.  */
 #ifndef YYDEBUG
 # define YYDEBUG 0
@@ -300,10 +187,76 @@
 # define YYTOKEN_TABLE 0
 #endif
 
+
+/* Tokens.  */
+#ifndef YYTOKENTYPE
+# define YYTOKENTYPE
+   /* Put the tokens into the symbol table, so that GDB and other debuggers
+      know about them.  */
+   enum yytokentype {
+     REDUCE = 258,
+     S = 259,
+     SGML_CD = 260,
+     INCLUDES = 261,
+     DASHMATCH = 262,
+     BEGINSWITH = 263,
+     ENDSWITH = 264,
+     CONTAINS = 265,
+     STRING = 266,
+     IDENT = 267,
+     NTH = 268,
+     HASH = 269,
+     HEXCOLOR = 270,
+     IMPORT_SYM = 271,
+     PAGE_SYM = 272,
+     MEDIA_SYM = 273,
+     FONT_FACE_SYM = 274,
+     CHARSET_SYM = 275,
+     NAMESPACE_SYM = 276,
+     KHTML_RULE_SYM = 277,
+     KHTML_DECLS_SYM = 278,
+     KHTML_VALUE_SYM = 279,
+     KHTML_MEDIAQUERY_SYM = 280,
+     IMPORTANT_SYM = 281,
+     MEDIA_ONLY = 282,
+     MEDIA_NOT = 283,
+     MEDIA_AND = 284,
+     QEMS = 285,
+     EMS = 286,
+     EXS = 287,
+     PXS = 288,
+     CMS = 289,
+     MMS = 290,
+     INS = 291,
+     PTS = 292,
+     PCS = 293,
+     DEGS = 294,
+     RADS = 295,
+     GRADS = 296,
+     MSECS = 297,
+     SECS = 298,
+     HERZ = 299,
+     KHERZ = 300,
+     DPI = 301,
+     DPCM = 302,
+     DIMEN = 303,
+     PERCENTAGE = 304,
+     FLOAT = 305,
+     INTEGER = 306,
+     URI = 307,
+     FUNCTION = 308,
+     NOTFUNCTION = 309,
+     UNICODERANGE = 310
+   };
+#endif
+
+
+
 #if ! defined YYSTYPE && ! defined YYSTYPE_IS_DECLARED
 typedef union YYSTYPE
-
 {
+
+
     CSSRuleImpl *rule;
     CSSSelector *selector;
     QList<CSSSelector*> *selectorList;
@@ -327,17 +280,16 @@
     khtml::MediaQueryExp* mediaQueryExp;
     QList<khtml::MediaQueryExp*>* mediaQueryExpList;
     khtml::MediaQuery::Restrictor mediaQueryRestrictor;
-}
-/* Line 187 of yacc.c.  */
 
-	YYSTYPE;
+
+
+} YYSTYPE;
+# define YYSTYPE_IS_TRIVIAL 1
 # define yystype YYSTYPE /* obsolescent; will be withdrawn */
 # define YYSTYPE_IS_DECLARED 1
-# define YYSTYPE_IS_TRIVIAL 1
 #endif
 
 
-
 /* Copy the second part of user declarations.  */
 
 
@@ -360,9 +312,7 @@
 
 
 
-/* Line 216 of yacc.c.  */
 
-
 #ifdef short
 # undef short
 #endif
@@ -436,14 +386,14 @@
 #if (defined __STDC__ || defined __C99__FUNC__ \
      || defined __cplusplus || defined _MSC_VER)
 static int
-YYID (int i)
+YYID (int yyi)
 #else
 static int
-YYID (i)
-    int i;
+YYID (yyi)
+    int yyi;
 #endif
 {
-  return i;
+  return yyi;
 }
 #endif
 
@@ -524,9 +474,9 @@
 /* A type that is properly aligned for any stack member.  */
 union yyalloc
 {
-  yytype_int16 yyss;
-  YYSTYPE yyvs;
-  };
+  yytype_int16 yyss_alloc;
+  YYSTYPE yyvs_alloc;
+};
 
 /* The size of the maximum gap between one aligned stack and the next.  */
 # define YYSTACK_GAP_MAXIMUM (sizeof (union yyalloc) - 1)
@@ -560,12 +510,12 @@
    elements in the stack, and YYPTR gives the new location of the
    stack.  Advance YYPTR to a properly aligned location for the next
    stack.  */
-# define YYSTACK_RELOCATE(Stack)					\
+# define YYSTACK_RELOCATE(Stack_alloc, Stack)				\
     do									\
       {									\
 	YYSIZE_T yynewbytes;						\
-	YYCOPY (&yyptr->Stack, Stack, yysize);				\
-	Stack = &yyptr->Stack;						\
+	YYCOPY (&yyptr->Stack_alloc, Stack, yysize);			\
+	Stack = &yyptr->Stack_alloc;					\
 	yynewbytes = yystacksize * sizeof (*Stack) + YYSTACK_GAP_MAXIMUM; \
 	yyptr += yynewbytes / sizeof (*yyptr);				\
       }									\
@@ -576,16 +526,16 @@
 /* YYFINAL -- State number of the termination state.  */
 #define YYFINAL  20
 /* YYLAST -- Last index in YYTABLE.  */
-#define YYLAST   578
+#define YYLAST   576
 
 /* YYNTOKENS -- Number of terminals.  */
 #define YYNTOKENS  75
 /* YYNNTS -- Number of nonterminals.  */
 #define YYNNTS  66
 /* YYNRULES -- Number of rules.  */
-#define YYNRULES  191
+#define YYNRULES  192
 /* YYNRULES -- Number of states.  */
-#define YYNSTATES  365
+#define YYNSTATES  358
 
 /* YYTRANSLATE(YYLEX) -- Bison symbol number corresponding to YYLEX.  */
 #define YYUNDEFTOK  2
@@ -644,18 +594,18 @@
      152,   155,   156,   161,   169,   171,   177,   178,   182,   183,
      185,   187,   189,   194,   195,   197,   199,   204,   207,   215,
      222,   223,   227,   230,   234,   238,   242,   246,   249,   252,
-     255,   256,   258,   260,   263,   265,   270,   273,   275,   279,
-     282,   284,   287,   290,   293,   297,   300,   304,   309,   313,
-     316,   319,   323,   327,   329,   331,   333,   336,   339,   341,
-     343,   345,   347,   350,   353,   358,   367,   373,   383,   385,
-     387,   389,   391,   393,   395,   397,   399,   402,   406,   411,
-     416,   421,   426,   432,   437,   442,   447,   453,   459,   463,
-     467,   472,   477,   483,   486,   489,   492,   493,   495,   499,
-     502,   505,   506,   508,   511,   514,   517,   520,   523,   526,
-     528,   530,   533,   536,   539,   542,   545,   548,   551,   554,
-     557,   560,   563,   566,   569,   572,   575,   578,   581,   584,
-     587,   590,   593,   599,   603,   606,   610,   614,   617,   623,
-     627,   629
+     255,   257,   259,   262,   264,   269,   272,   274,   277,   281,
+     285,   288,   290,   293,   296,   298,   301,   303,   306,   310,
+     313,   315,   317,   320,   323,   325,   327,   329,   332,   335,
+     337,   339,   341,   343,   346,   349,   354,   363,   369,   379,
+     381,   383,   385,   387,   389,   391,   393,   395,   398,   402,
+     407,   412,   417,   422,   429,   434,   439,   444,   450,   456,
+     460,   464,   469,   474,   480,   483,   486,   489,   490,   492,
+     496,   499,   502,   503,   505,   508,   511,   514,   517,   520,
+     523,   525,   527,   530,   533,   536,   539,   542,   545,   548,
+     551,   554,   557,   560,   563,   566,   569,   572,   575,   578,
+     581,   584,   587,   590,   596,   600,   603,   607,   611,   614,
+     620,   624,   626
 };
 
 /* YYRHS -- A `-1'-separated list of the rules' RHS.  */
@@ -686,45 +636,44 @@
       62,    -1,    -1,   105,    93,    82,    -1,    12,    82,    -1,
       22,     1,   139,    -1,    22,     1,    63,    -1,    24,     1,
      139,    -1,    24,     1,    63,    -1,    67,    82,    -1,    68,
-      82,    -1,    69,    82,    -1,    -1,    70,    -1,    67,    -1,
-     112,   126,    -1,   113,    -1,   112,    66,    82,   113,    -1,
-     112,     1,    -1,   115,    -1,   113,   109,   115,    -1,   113,
-       1,    -1,    20,    -1,    19,    20,    -1,    12,    20,    -1,
-     117,    82,    -1,   117,   118,    82,    -1,   118,    82,    -1,
-     114,   117,    82,    -1,   114,   117,   118,    82,    -1,   114,
-     118,    82,    -1,   117,    82,    -1,   119,    82,    -1,   114,
-     117,    82,    -1,   114,   119,    82,    -1,    12,    -1,    19,
-      -1,   119,    -1,   118,   119,    -1,   118,     1,    -1,    14,
-      -1,   120,    -1,   122,    -1,   125,    -1,    17,    12,    -1,
-      12,    82,    -1,    18,    82,   121,    71,    -1,    18,    82,
-     121,   123,    82,   124,    82,    71,    -1,    18,    82,   114,
-     121,    71,    -1,    18,    82,   114,   121,   123,    82,   124,
-      82,    71,    -1,    72,    -1,     6,    -1,     7,    -1,     8,
-      -1,     9,    -1,    10,    -1,    12,    -1,    11,    -1,    16,
-      12,    -1,    16,    16,    12,    -1,    16,    58,    13,    65,
-      -1,    16,    58,    56,    65,    -1,    16,    58,    12,    65,
-      -1,    16,    58,    11,    65,    -1,    16,    59,    82,   116,
-      65,    -1,    61,    82,   128,    62,    -1,    61,    82,     1,
-      62,    -1,    61,    82,   127,    62,    -1,    61,    82,   127,
-     128,    62,    -1,    61,    82,   127,     1,    62,    -1,   128,
-      63,    82,    -1,     1,    63,    82,    -1,   127,   128,    63,
-      82,    -1,   127,     1,    63,    82,    -1,   129,    16,    82,
-     131,   130,    -1,     1,   139,    -1,    12,    82,    -1,    31,
-      82,    -1,    -1,   133,    -1,   131,   132,   133,    -1,    73,
-      82,    -1,    66,    82,    -1,    -1,   134,    -1,   110,   134,
-      -1,    53,    82,    -1,    11,    82,    -1,    12,    82,    -1,
-      57,    82,    -1,    60,    82,    -1,   136,    -1,   135,    -1,
-      56,    82,    -1,    55,    82,    -1,    54,    82,    -1,    38,
-      82,    -1,    39,    82,    -1,    40,    82,    -1,    41,    82,
-      -1,    42,    82,    -1,    43,    82,    -1,    44,    82,    -1,
-      45,    82,    -1,    46,    82,    -1,    47,    82,    -1,    48,
-      82,    -1,    49,    82,    -1,    50,    82,    -1,    36,    82,
-      -1,    35,    82,    -1,    37,    82,    -1,    51,    82,    -1,
-      52,    82,    -1,    58,    82,   131,    65,    82,    -1,    58,
-      82,     1,    -1,    15,    82,    -1,    74,     1,   139,    -1,
-      74,     1,    63,    -1,     1,   139,    -1,    61,     1,   140,
-       1,    62,    -1,    61,     1,    62,    -1,   139,    -1,   140,
-       1,   139,    -1
+      82,    -1,    69,    82,    -1,    70,    -1,    67,    -1,   112,
+     126,    -1,   113,    -1,   112,    66,    82,   113,    -1,   112,
+       1,    -1,   115,    -1,   113,     4,    -1,   113,     4,   115,
+      -1,   113,   109,   115,    -1,   113,     1,    -1,    20,    -1,
+      19,    20,    -1,    12,    20,    -1,   117,    -1,   117,   118,
+      -1,   118,    -1,   114,   117,    -1,   114,   117,   118,    -1,
+     114,   118,    -1,   117,    -1,   119,    -1,   114,   117,    -1,
+     114,   119,    -1,    12,    -1,    19,    -1,   119,    -1,   118,
+     119,    -1,   118,     1,    -1,    14,    -1,   120,    -1,   122,
+      -1,   125,    -1,    17,    12,    -1,    12,    82,    -1,    18,
+      82,   121,    71,    -1,    18,    82,   121,   123,    82,   124,
+      82,    71,    -1,    18,    82,   114,   121,    71,    -1,    18,
+      82,   114,   121,   123,    82,   124,    82,    71,    -1,    72,
+      -1,     6,    -1,     7,    -1,     8,    -1,     9,    -1,    10,
+      -1,    12,    -1,    11,    -1,    16,    12,    -1,    16,    16,
+      12,    -1,    16,    58,    13,    65,    -1,    16,    58,    56,
+      65,    -1,    16,    58,    12,    65,    -1,    16,    58,    11,
+      65,    -1,    16,    59,    82,   116,    82,    65,    -1,    61,
+      82,   128,    62,    -1,    61,    82,     1,    62,    -1,    61,
+      82,   127,    62,    -1,    61,    82,   127,   128,    62,    -1,
+      61,    82,   127,     1,    62,    -1,   128,    63,    82,    -1,
+       1,    63,    82,    -1,   127,   128,    63,    82,    -1,   127,
+       1,    63,    82,    -1,   129,    16,    82,   131,   130,    -1,
+       1,   139,    -1,    12,    82,    -1,    31,    82,    -1,    -1,
+     133,    -1,   131,   132,   133,    -1,    73,    82,    -1,    66,
+      82,    -1,    -1,   134,    -1,   110,   134,    -1,    53,    82,
+      -1,    11,    82,    -1,    12,    82,    -1,    57,    82,    -1,
+      60,    82,    -1,   136,    -1,   135,    -1,    56,    82,    -1,
+      55,    82,    -1,    54,    82,    -1,    38,    82,    -1,    39,
+      82,    -1,    40,    82,    -1,    41,    82,    -1,    42,    82,
+      -1,    43,    82,    -1,    44,    82,    -1,    45,    82,    -1,
+      46,    82,    -1,    47,    82,    -1,    48,    82,    -1,    49,
+      82,    -1,    50,    82,    -1,    36,    82,    -1,    35,    82,
+      -1,    37,    82,    -1,    51,    82,    -1,    52,    82,    -1,
+      58,    82,   131,    65,    82,    -1,    58,    82,     1,    -1,
+      15,    82,    -1,    74,     1,   139,    -1,    74,     1,    63,
+      -1,     1,   139,    -1,    61,     1,   140,     1,    62,    -1,
+      61,     1,    62,    -1,   139,    -1,   140,     1,   139,    -1
 };
 
 /* YYRLINE[YYN] -- source line where rule number YYN was defined.  */
@@ -738,18 +687,18 @@
      473,   479,   482,   488,   494,   498,   505,   508,   514,   517,
      520,   526,   529,   535,   538,   543,   547,   552,   559,   570,
      582,   583,   593,   615,   618,   624,   627,   633,   634,   635,
-     636,   640,   641,   645,   667,   680,   698,   707,   710,   724,
-     731,   732,   733,   737,   742,   749,   756,   764,   774,   787,
-     792,   799,   807,   820,   836,   842,   845,   855,   862,   876,
-     877,   878,   882,   899,   923,   929,   936,   945,   958,   961,
-     964,   967,   970,   973,   979,   980,   984,   990,   996,  1003,
-    1010,  1017,  1024,  1033,  1036,  1039,  1042,  1047,  1053,  1057,
-    1060,  1065,  1071,  1093,  1099,  1106,  1107,  1111,  1115,  1131,
-    1134,  1137,  1143,  1144,  1146,  1147,  1148,  1154,  1155,  1156,
-    1158,  1164,  1165,  1166,  1167,  1168,  1169,  1170,  1171,  1172,
-    1173,  1174,  1175,  1176,  1177,  1178,  1179,  1180,  1181,  1182,
-    1183,  1184,  1189,  1197,  1213,  1220,  1226,  1235,  1261,  1262,
-    1266,  1267
+     639,   640,   644,   666,   679,   697,   707,   710,   713,   727,
+     741,   748,   749,   750,   754,   759,   766,   773,   781,   791,
+     804,   809,   816,   824,   837,   841,   847,   850,   860,   867,
+     881,   882,   883,   887,   904,   911,   917,   924,   933,   946,
+     949,   952,   955,   958,   961,   967,   968,   972,   978,   984,
+     991,   998,  1005,  1012,  1021,  1024,  1027,  1030,  1035,  1041,
+    1045,  1048,  1053,  1059,  1081,  1087,  1094,  1095,  1099,  1103,
+    1119,  1122,  1125,  1131,  1132,  1134,  1135,  1136,  1142,  1143,
+    1144,  1146,  1152,  1153,  1154,  1155,  1156,  1157,  1158,  1159,
+    1160,  1161,  1162,  1163,  1164,  1165,  1166,  1167,  1168,  1169,
+    1170,  1171,  1172,  1177,  1185,  1201,  1208,  1214,  1223,  1249,
+    1250,  1254,  1255
 };
 #endif
 
@@ -758,9 +707,9 @@
    First, the terminals, then, starting at YYNTOKENS, nonterminals.  */
 static const char *const yytname[] =
 {
-  "$end", "error", "$undefined", "UNIMPORTANT_TOK", "S", "SGML_CD",
-  "INCLUDES", "DASHMATCH", "BEGINSWITH", "ENDSWITH", "CONTAINS", "STRING",
-  "IDENT", "NTH", "HASH", "HEXCOLOR", "':'", "'.'", "'['", "'*'", "'|'",
+  "$end", "error", "$undefined", "REDUCE", "S", "SGML_CD", "INCLUDES",
+  "DASHMATCH", "BEGINSWITH", "ENDSWITH", "CONTAINS", "STRING", "IDENT",
+  "NTH", "HASH", "HEXCOLOR", "':'", "'.'", "'['", "'*'", "'|'",
   "IMPORT_SYM", "PAGE_SYM", "MEDIA_SYM", "FONT_FACE_SYM", "CHARSET_SYM",
   "NAMESPACE_SYM", "KHTML_RULE_SYM", "KHTML_DECLS_SYM", "KHTML_VALUE_SYM",
   "KHTML_MEDIAQUERY_SYM", "IMPORTANT_SYM", "MEDIA_ONLY", "MEDIA_NOT",
@@ -814,18 +763,18 @@
       95,    96,    96,    97,    98,    98,    99,    99,   100,   100,
      100,   101,   101,   102,   102,   103,   103,   103,   104,   104,
      105,   105,   106,   107,   107,   108,   108,   109,   109,   109,
-     109,   110,   110,   111,   112,   112,   112,   113,   113,   113,
-     114,   114,   114,   115,   115,   115,   115,   115,   115,   116,
-     116,   116,   116,   117,   117,   118,   118,   118,   119,   119,
-     119,   119,   120,   121,   122,   122,   122,   122,   123,   123,
-     123,   123,   123,   123,   124,   124,   125,   125,   125,   125,
-     125,   125,   125,   126,   126,   126,   126,   126,   127,   127,
-     127,   127,   128,   128,   129,   130,   130,   131,   131,   132,
-     132,   132,   133,   133,   133,   133,   133,   133,   133,   133,
-     133,   134,   134,   134,   134,   134,   134,   134,   134,   134,
+     110,   110,   111,   112,   112,   112,   113,   113,   113,   113,
+     113,   114,   114,   114,   115,   115,   115,   115,   115,   115,
+     116,   116,   116,   116,   117,   117,   118,   118,   118,   119,
+     119,   119,   119,   120,   121,   122,   122,   122,   122,   123,
+     123,   123,   123,   123,   123,   124,   124,   125,   125,   125,
+     125,   125,   125,   125,   126,   126,   126,   126,   126,   127,
+     127,   127,   127,   128,   128,   129,   130,   130,   131,   131,
+     132,   132,   132,   133,   133,   133,   133,   133,   133,   133,
+     133,   133,   134,   134,   134,   134,   134,   134,   134,   134,
      134,   134,   134,   134,   134,   134,   134,   134,   134,   134,
-     134,   134,   135,   135,   136,   137,   137,   138,   139,   139,
-     140,   140
+     134,   134,   134,   135,   135,   136,   137,   137,   138,   139,
+     139,   140,   140
 };
 
 /* YYR2[YYN] -- Number of symbols composing right hand side of rule YYN.  */
@@ -839,18 +788,18 @@
        2,     0,     4,     7,     1,     5,     0,     3,     0,     1,
        1,     1,     4,     0,     1,     1,     4,     2,     7,     6,
        0,     3,     2,     3,     3,     3,     3,     2,     2,     2,
-       0,     1,     1,     2,     1,     4,     2,     1,     3,     2,
-       1,     2,     2,     2,     3,     2,     3,     4,     3,     2,
-       2,     3,     3,     1,     1,     1,     2,     2,     1,     1,
-       1,     1,     2,     2,     4,     8,     5,     9,     1,     1,
-       1,     1,     1,     1,     1,     1,     2,     3,     4,     4,
-       4,     4,     5,     4,     4,     4,     5,     5,     3,     3,
-       4,     4,     5,     2,     2,     2,     0,     1,     3,     2,
-       2,     0,     1,     2,     2,     2,     2,     2,     2,     1,
-       1,     2,     2,     2,     2,     2,     2,     2,     2,     2,
+       1,     1,     2,     1,     4,     2,     1,     2,     3,     3,
+       2,     1,     2,     2,     1,     2,     1,     2,     3,     2,
+       1,     1,     2,     2,     1,     1,     1,     2,     2,     1,
+       1,     1,     1,     2,     2,     4,     8,     5,     9,     1,
+       1,     1,     1,     1,     1,     1,     1,     2,     3,     4,
+       4,     4,     4,     6,     4,     4,     4,     5,     5,     3,
+       3,     4,     4,     5,     2,     2,     2,     0,     1,     3,
+       2,     2,     0,     1,     2,     2,     2,     2,     2,     2,
+       1,     1,     2,     2,     2,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     5,     3,     2,     3,     3,     2,     5,     3,
-       1,     3
+       2,     2,     2,     5,     3,     2,     3,     3,     2,     5,
+       3,     1,     3
 };
 
 /* YYDEFACT[STATE-NAME] -- Default rule to reduce with in state
@@ -862,236 +811,234 @@
       13,    15,    19,     0,     0,    13,    13,    10,    13,    13,
        1,     3,     4,     5,     6,    23,     0,    22,    21,    14,
       13,     0,     0,     0,    58,    17,    16,    28,     0,     0,
-     103,   108,     0,     0,    13,   104,    90,     0,    13,     8,
-       7,     0,     0,     0,    87,    13,     0,   105,   109,   110,
-     111,     0,    13,     0,     0,     0,    13,    13,    13,    13,
+     104,   109,     0,     0,    13,   105,    91,     0,    13,     8,
+       7,     0,     0,     0,    86,    94,     0,   106,   110,   111,
+     112,     0,    13,     0,     0,     0,    13,    13,    13,    13,
       13,    13,    13,    13,    13,    13,    13,    13,    13,    13,
       13,    13,    13,    13,    13,    13,    13,    13,    13,    13,
-      13,    13,    13,    13,    82,    81,     0,   151,   147,   152,
-     160,   159,    59,    60,    13,    54,    61,    13,     0,    15,
-      35,   189,   190,     0,    20,    92,   126,     0,     0,    13,
-     112,     0,    91,     0,     0,     0,    86,    13,    83,    89,
-      13,    13,    13,     0,   103,   104,    13,     0,    93,     0,
-     107,    95,   106,   134,    13,   143,   144,     0,   135,     0,
-     133,    13,    13,   155,   156,   184,   178,   177,   179,   164,
-     165,   166,   167,   168,   169,   170,   171,   172,   173,   174,
-     175,   176,   180,   181,   154,   163,   162,   161,   157,     0,
-     158,   153,    11,    13,    13,     0,     0,     0,     0,    12,
-      24,     0,    15,     0,     0,   127,     0,     0,     0,     0,
-       0,    13,     0,     0,     0,    27,    26,    48,    49,    13,
-       9,     0,    77,    78,    79,    88,    96,     0,    98,    94,
-     139,   137,    13,   136,    13,   138,     0,   183,   151,   150,
-     149,   148,    13,    13,    13,    13,    56,     0,    33,    29,
-       0,     0,    13,     0,     0,     0,    15,    38,    39,    40,
-      37,    42,    41,   188,   191,   131,   130,   128,   129,     0,
-       0,    13,    13,   113,    13,     0,   119,   120,   121,   122,
-     123,   114,   118,    13,    58,     0,    97,   141,   140,   151,
-      13,    50,    51,     0,    72,    13,    62,    32,    31,     0,
-       0,   187,     0,    58,     0,     0,    43,    36,    13,    13,
-     132,    99,   100,   116,    13,     0,    65,     0,     0,    13,
-     142,   182,    13,     0,    55,     0,    34,    13,    74,    73,
-      13,     0,    76,    75,   186,   185,   101,   102,     0,   125,
-     124,    13,    25,    67,    13,   145,     0,    13,    57,     0,
-      70,    13,    13,     0,    58,   151,    53,    30,     0,    70,
-       0,   115,    66,    52,    69,     0,    13,    44,    46,    45,
-       0,   117,    47,    71,    68
+      13,    13,    13,    13,    81,    80,     0,   152,   148,   153,
+     161,   160,    59,    60,    13,    54,    61,    13,     0,    15,
+      35,   190,   191,     0,    20,    93,   127,     0,     0,    13,
+     113,     0,    92,     0,     0,     0,    85,    13,    82,    90,
+      87,    13,    13,    13,     0,   104,   105,    97,     0,     0,
+     108,   107,   135,    13,   144,   145,     0,   136,     0,   134,
+      13,    13,   156,   157,   185,   179,   178,   180,   165,   166,
+     167,   168,   169,   170,   171,   172,   173,   174,   175,   176,
+     177,   181,   182,   155,   164,   163,   162,   158,     0,   159,
+     154,    11,    13,    13,     0,     0,     0,     0,    12,    24,
+       0,    15,     0,     0,   128,     0,     0,     0,     0,     0,
+      13,     0,     0,     0,    27,    26,    48,    49,    13,     9,
+       0,    88,    77,    78,    79,    89,     0,   140,   138,    13,
+     137,    13,   139,     0,   184,   152,   151,   150,   149,    13,
+      13,    13,    13,    56,     0,    33,    29,     0,     0,    13,
+       0,     0,     0,    15,    38,    39,    40,    37,    42,    41,
+     189,   192,   132,   131,   129,   130,     0,    13,   100,   101,
+     114,    13,     0,   120,   121,   122,   123,   124,   115,   119,
+      13,    58,     0,   142,   141,   152,    13,    50,    51,     0,
+      72,    13,    62,    32,    31,     0,     0,   188,     0,    58,
+       0,     0,    43,    36,   102,   103,     0,   117,    13,     0,
+      65,     0,     0,    13,   143,   183,    13,     0,    55,     0,
+      34,    13,    74,    73,    13,     0,    76,    75,   187,   186,
+     133,     0,   126,   125,    13,    25,    67,    13,   146,     0,
+      13,    57,     0,    70,    13,    13,     0,    58,   152,    53,
+      30,     0,    70,     0,   116,    66,    52,    69,     0,    13,
+      44,    46,    45,     0,   118,    47,    71,    68
 };
 
 /* YYDEFGOTO[NTERM-NUM].  */
 static const yytype_int16 yydefgoto[] =
 {
-      -1,     6,    48,     7,     8,     9,    10,   187,    25,    11,
-      12,    37,   355,   110,   192,   290,   193,   246,   356,   209,
-     233,   313,   105,   106,   286,   107,   306,   307,   308,   247,
-     348,   236,   248,   249,   133,    96,   357,    51,    52,    53,
-      54,   260,    55,    56,    57,    58,   204,    59,   273,   331,
-      60,    17,    63,    64,    65,   310,    97,   185,    98,    99,
-     100,   101,   358,   359,   145,   113
+      -1,     6,    48,     7,     8,     9,    10,   186,    25,    11,
+      12,    37,   348,   110,   191,   286,   192,   243,   349,   208,
+     230,   307,   105,   106,   282,   107,   300,   301,   302,   244,
+     341,   233,   245,   246,   134,    96,   350,    51,    52,    53,
+      54,   257,    55,    56,    57,    58,   203,    59,   270,   324,
+      60,    17,    63,    64,    65,   304,    97,   184,    98,    99,
+     100,   101,   351,   352,   144,   113
 };
 
 /* YYPACT[STATE-NUM] -- Index in YYTABLE of the portion describing
    STATE-NUM.  */
-#define YYPACT_NINF -175
+#define YYPACT_NINF -174
 static const yytype_int16 yypact[] =
 {
-     487,    33,   -16,   -10,    55,   123,   163,  -175,  -175,  -175,
-    -175,  -175,  -175,   -35,   226,  -175,  -175,  -175,  -175,  -175,
-    -175,   154,   154,   154,   154,   194,   167,  -175,  -175,  -175,
-    -175,   538,    26,   403,   232,  -175,  -175,   185,   192,    52,
-     190,  -175,   197,   206,  -175,   223,  -175,   272,  -175,  -175,
-    -175,    56,   158,   462,  -175,    46,   358,  -175,  -175,  -175,
-    -175,   219,  -175,   127,   225,   241,  -175,  -175,  -175,  -175,
-    -175,  -175,  -175,  -175,  -175,  -175,  -175,  -175,  -175,  -175,
-    -175,  -175,  -175,  -175,  -175,  -175,  -175,  -175,  -175,  -175,
-    -175,  -175,  -175,  -175,  -175,  -175,   489,    98,  -175,  -175,
-    -175,  -175,  -175,  -175,  -175,  -175,    16,  -175,   117,  -175,
-     213,  -175,  -175,   261,  -175,  -175,  -175,   259,   257,  -175,
-    -175,    20,  -175,    86,   130,   129,  -175,  -175,  -175,  -175,
-    -175,  -175,  -175,   558,  -175,  -175,    46,   358,   154,   358,
-    -175,   154,  -175,  -175,  -175,  -175,   154,   238,  -175,   247,
-    -175,  -175,  -175,   154,   154,   154,   154,   154,   154,   154,
-     154,   154,   154,   154,   154,   154,   154,   154,   154,   154,
-     154,   154,   154,   154,   154,   154,   154,   154,   154,   346,
-     154,  -175,  -175,  -175,  -175,   453,   128,    19,   142,  -175,
-     194,   274,  -175,   228,   233,  -175,   209,   212,   224,   240,
-     549,   190,   223,   279,   187,  -175,  -175,  -175,  -175,  -175,
-    -175,   549,   154,   154,   154,  -175,   154,   358,   154,   154,
-     154,  -175,  -175,  -175,  -175,   154,   403,  -175,   -24,   154,
-     154,  -175,  -175,  -175,  -175,  -175,   287,   159,   157,   194,
-     267,   334,  -175,   336,   337,   338,  -175,  -175,  -175,  -175,
-    -175,  -175,  -175,  -175,  -175,  -175,  -175,  -175,  -175,   462,
-     277,  -175,  -175,   154,  -175,   195,  -175,  -175,  -175,  -175,
-    -175,  -175,  -175,  -175,   148,   416,   154,   154,   154,   283,
-    -175,   154,     9,    44,   154,  -175,  -175,  -175,  -175,   339,
-     131,  -175,   243,   153,   254,   271,  -175,   194,  -175,  -175,
-    -175,   154,   154,  -175,  -175,   133,  -175,   285,    57,  -175,
-    -175,   154,  -175,   286,  -175,    44,  -175,  -175,  -175,  -175,
-    -175,    58,  -175,  -175,  -175,  -175,   154,   154,   133,  -175,
-    -175,  -175,  -175,  -175,  -175,   154,   403,  -175,    16,   121,
-     154,  -175,  -175,    27,   232,    31,   154,  -175,    93,   154,
-      29,  -175,  -175,   154,  -175,   351,  -175,  -175,  -175,  -175,
-     306,  -175,  -175,   154,  -175
+     392,    26,   -39,   -30,   -19,    24,    45,  -174,  -174,  -174,
+    -174,  -174,  -174,    78,   150,  -174,  -174,  -174,  -174,  -174,
+    -174,    44,    44,    44,    44,   124,    62,  -174,  -174,  -174,
+    -174,   471,   258,   412,   170,  -174,  -174,   169,   263,   134,
+     151,  -174,   224,   204,  -174,   213,  -174,   376,  -174,  -174,
+    -174,    43,   335,   381,  -174,   414,   119,  -174,  -174,  -174,
+    -174,   279,  -174,    40,   343,   239,  -174,  -174,  -174,  -174,
+    -174,  -174,  -174,  -174,  -174,  -174,  -174,  -174,  -174,  -174,
+    -174,  -174,  -174,  -174,  -174,  -174,  -174,  -174,  -174,  -174,
+    -174,  -174,  -174,  -174,  -174,  -174,   498,   195,  -174,  -174,
+    -174,  -174,  -174,  -174,  -174,  -174,    30,  -174,   205,  -174,
+     247,  -174,  -174,   286,  -174,  -174,  -174,   288,   166,  -174,
+    -174,    20,  -174,   143,   162,   155,  -174,  -174,  -174,  -174,
+     556,  -174,  -174,  -174,   556,  -174,  -174,   414,   197,   277,
+    -174,  -174,  -174,  -174,  -174,    44,   347,  -174,   363,  -174,
+    -174,  -174,    44,    44,    44,    44,    44,    44,    44,    44,
+      44,    44,    44,    44,    44,    44,    44,    44,    44,    44,
+      44,    44,    44,    44,    44,    44,    44,    44,   316,    44,
+    -174,  -174,  -174,  -174,   462,   148,   123,   171,  -174,   124,
+     273,  -174,   225,   375,  -174,   241,   254,   267,   270,   547,
+     151,   213,   297,   137,  -174,  -174,  -174,  -174,  -174,  -174,
+     547,  -174,    44,    44,    44,  -174,   374,    44,  -174,  -174,
+    -174,  -174,    44,   412,  -174,   206,    44,    44,  -174,  -174,
+    -174,  -174,  -174,   278,   160,   180,   124,   318,   348,  -174,
+     383,   388,   393,  -174,  -174,  -174,  -174,  -174,  -174,  -174,
+    -174,  -174,  -174,  -174,  -174,  -174,   381,  -174,  -174,  -174,
+      44,  -174,   244,  -174,  -174,  -174,  -174,  -174,  -174,  -174,
+    -174,   130,   346,    44,    44,   245,  -174,    44,     9,   136,
+      44,  -174,  -174,  -174,  -174,   378,     5,  -174,   229,   163,
+     235,   240,  -174,   124,  -174,  -174,    31,  -174,  -174,   310,
+    -174,   355,    59,  -174,  -174,    44,  -174,   364,  -174,   136,
+    -174,  -174,  -174,  -174,  -174,    58,  -174,  -174,  -174,  -174,
+    -174,   310,  -174,  -174,  -174,  -174,  -174,  -174,    44,   412,
+    -174,    30,   147,    44,  -174,  -174,    22,   170,   103,    44,
+    -174,    37,    44,    29,  -174,  -174,    44,  -174,   410,  -174,
+    -174,  -174,  -174,    96,  -174,  -174,    44,  -174
 };
 
 /* YYPGOTO[NTERM-NUM].  */
 static const yytype_int16 yypgoto[] =
 {
-    -175,  -175,  -175,  -175,  -175,  -175,  -175,    -1,   -93,  -175,
-    -175,  -175,   -27,  -175,  -175,  -175,  -175,  -175,  -175,    63,
-    -175,  -175,    71,    45,  -175,  -175,   -32,  -175,    70,  -175,
-      15,  -175,  -175,  -175,  -175,  -175,   -28,  -175,   155,   -99,
-     234,  -175,   -52,   -34,   -44,  -175,   162,  -175,   104,    43,
-    -175,   322,  -175,   316,  -175,  -175,  -174,  -175,   220,   312,
-    -175,  -175,   216,   217,    -2,  -175
+    -174,  -174,  -174,  -174,  -174,  -174,  -174,    -1,   -90,  -174,
+    -174,  -174,   -27,  -174,  -174,  -174,  -174,  -174,  -174,   152,
+    -174,  -174,   165,   125,  -174,  -174,   -33,  -174,   156,  -174,
+      97,  -174,  -174,  -174,  -174,  -174,   -28,  -174,   236,  -101,
+     251,  -174,   -51,   -32,   -44,  -174,   269,  -174,   214,   157,
+    -174,   429,  -174,   418,  -174,  -174,  -173,  -174,   300,   390,
+    -174,  -174,   301,   302,    -2,  -174
 };
 
 /* YYTABLE[YYPACT[STATE-NUM]].  What to do in state STATE-NUM.  If
    positive, shift that token.  If negative, reduce the rule which
    number is the opposite.  If zero, do what YYDEFACT says.
    If YYTABLE_NINF, syntax error.  */
-#define YYTABLE_NINF -147
+#define YYTABLE_NINF -148
 static const yytype_int16 yytable[] =
 {
-      14,   136,   108,    50,    49,   228,    21,    22,    23,    24,
-     109,    28,   142,    29,    31,    32,   190,    33,    34,   137,
-     -13,   139,   203,    29,    29,   312,    26,    61,    27,    39,
-      29,    29,   201,    29,    13,   -13,   112,   -13,    62,   202,
-      46,   280,   183,   121,   -13,    15,   124,   125,    29,   184,
-     -13,    16,   279,   234,   138,   141,    29,   126,   333,   333,
-      41,   146,    42,    43,    44,   153,   154,   155,   156,   157,
-     158,   159,   160,   161,   162,   163,   164,   165,   166,   167,
-     168,   169,   170,   171,   172,   173,   174,   175,   176,   177,
-     178,   179,   180,   142,   240,   142,   -13,   183,   351,   239,
-     361,   259,   217,   186,   184,    40,   188,    41,   104,    42,
-      43,    44,    45,    46,    47,   114,    18,    16,   200,   341,
-     -64,   206,   127,   334,   334,    29,   211,    19,   147,   212,
-     213,   214,    29,    29,    29,   216,   218,    29,   219,    62,
-     232,   207,   207,   220,   329,   330,    29,    26,   261,   205,
-     225,   226,    29,   297,   235,   354,   262,    29,    29,   129,
-     182,    29,   345,    20,   183,   250,   245,   244,    38,   289,
-     -80,   184,   -80,   142,   -80,   -80,   -80,   -80,   -80,   189,
-     102,   103,   229,   230,   347,   102,   103,   208,   208,   148,
-     238,   210,   254,   266,   267,   268,   269,   270,    35,    36,
-     263,   266,   267,   268,   269,   270,    47,   298,   274,   116,
-     115,   -63,   104,   117,   320,   299,   276,   104,   120,   -84,
-      26,   277,   287,   278,   -84,   130,   131,   132,    -2,   240,
-      29,   281,   282,   283,   284,   288,    29,    30,   291,   191,
-      40,   293,    41,   122,    42,    43,    44,    45,    46,    47,
-     241,   242,   243,    26,   111,   118,   119,   152,   271,   272,
-     301,   302,   194,   263,   102,   103,   303,   272,   196,   197,
-     198,   195,   305,   123,   255,   237,   -13,   256,   -13,   311,
-      26,   143,   144,   -13,   315,   -13,   -13,   150,   151,   257,
-     319,   264,   323,   325,    26,   253,   104,   326,   327,    26,
-     221,   222,   244,   328,    26,   258,   318,   240,   335,   223,
-     224,   336,   352,   199,   309,    26,   339,   322,    40,   340,
-      41,   285,    42,    43,    44,    45,    46,    47,    26,   -13,
-     343,   -13,    26,   344,   324,   292,   346,   294,   295,   296,
-     349,   350,   300,   316,   353,  -146,  -146,   227,   332,   183,
-      29,   337,   362,   317,   314,   363,   184,    66,    67,   140,
-     338,    68,   -13,   321,   360,   265,   275,   215,   364,   304,
-     -13,   342,    41,   128,    42,    43,    44,   -13,   -13,   149,
-     244,    69,    70,    71,    72,    73,    74,    75,    76,    77,
+      14,   108,   137,    50,    49,   225,    21,    22,    23,    24,
+     109,    28,   141,    29,    31,    32,   206,    33,    34,   189,
+     202,   138,    15,   139,    29,   306,    29,    13,    19,    39,
+     -13,    16,   200,    29,   -13,    29,   112,   -13,   237,   201,
+      46,   146,    18,   121,   126,    20,   124,   125,    29,    40,
+     275,    41,    62,    42,    43,    44,    45,    46,    47,   326,
+     326,   145,   207,    38,   -13,   152,   153,   154,   155,   156,
+     157,   158,   159,   160,   161,   162,   163,   164,   165,   166,
+     167,   168,   169,   170,   171,   172,   173,   174,   175,   176,
+     177,   178,   179,   344,   141,   141,   320,   237,   256,   347,
+     354,   236,   147,   185,    16,   216,   187,   -13,    40,   127,
+      41,   241,    42,    43,    44,    45,    46,    47,   199,   334,
+     140,   205,   -64,   -96,   327,   327,   210,    29,    35,    36,
+     212,   213,   214,    41,    29,    42,    43,    44,    29,    26,
+      29,    27,   217,   263,   264,   265,   266,   267,   258,   222,
+     223,    29,    29,   293,    29,   259,   338,   231,   357,    29,
+     229,    30,   102,   103,   247,   242,    29,    29,   -13,   182,
+     241,   115,   141,   206,    29,    29,   183,   195,   196,   197,
+     -96,   226,   227,   232,    29,   -96,   -96,   -96,   -96,   235,
+      47,   251,   285,   -63,   104,   102,   103,   114,   140,   260,
+     104,   -99,   102,   103,    26,   294,   204,   271,   268,   269,
+     340,    41,   295,    42,    43,    44,   120,   209,   273,   207,
+     274,    26,   198,   283,   314,    -2,   237,   104,   277,   278,
+     279,   280,   284,   122,   104,   287,   116,    40,   289,    41,
+     117,    42,    43,    44,    45,    46,    47,   238,   239,   240,
+     263,   264,   265,   266,   267,   151,   296,   181,   -99,    61,
+     260,   182,    29,   -99,   -99,   -99,   -99,   188,   183,   299,
+      62,   276,   182,   190,   234,   305,   303,   -13,   140,   183,
+     309,   -95,   118,   119,   -13,   -13,   313,   193,   317,   319,
+      26,    41,   312,    42,    43,    44,    26,   321,   316,   241,
+     194,    26,   328,   318,   345,   329,   252,  -147,  -147,   261,
+     332,   182,   281,   333,    29,   297,   269,   224,   183,   253,
+      29,   322,   323,   336,    26,   111,   337,    66,    67,   339,
+     -13,    68,   254,   342,   343,   255,   129,   346,   -95,   130,
+      26,   142,   143,   -95,   -95,   -95,   -95,   129,   356,   288,
+     130,    69,    70,    71,    72,    73,    74,    75,    76,    77,
       78,    79,    80,    81,    82,    83,    84,    85,    86,    87,
-      88,    89,    90,    91,    92,   231,    93,    29,   181,   251,
-     252,     0,     0,    94,    66,    67,    95,   129,    68,   -13,
-       0,     0,     0,     0,   -13,   -13,   -13,   -13,   -80,     0,
-     -80,     0,   -80,   -80,   -80,   -80,   -80,     0,    69,    70,
-      71,    72,    73,    74,    75,    76,    77,    78,    79,    80,
-      81,    82,    83,    84,    85,    86,    87,    88,    89,    90,
-      91,    92,     0,    93,    66,    67,     0,     0,    68,     0,
-      94,     0,     0,    95,   134,     0,    41,   -85,    42,    43,
-      44,   135,   -85,   130,   131,   132,     0,     0,    69,    70,
-      71,    72,    73,    74,    75,    76,    77,    78,    79,    80,
-      81,    82,    83,    84,    85,    86,    87,    88,    89,    90,
-      91,    92,     1,    93,     2,     3,     4,     5,     0,     0,
-      94,     0,     0,    95,    69,    70,    71,    72,    73,    74,
-      75,    76,    77,    78,    79,    80,    81,    82,    83,    84,
-      85,    86,    29,    88,    89,    90,     0,     0,     0,     0,
-      40,     0,    41,    29,    42,    43,    44,    45,    46,    47,
-       0,    40,     0,    41,     0,    42,    43,    44,    45,    46,
-      40,     0,    41,     0,    42,    43,    44,    45,    46
+      88,    89,    90,    91,    92,   140,    93,   123,   -98,    26,
+     -13,   211,   310,    94,   290,   215,    95,   -13,    41,   291,
+      42,    43,    44,   135,   292,    41,   -83,    42,    43,    44,
+     136,   -83,   131,   132,   133,   149,   150,   -84,    26,   218,
+     219,   355,   -84,   131,   132,   133,    29,     1,   325,     2,
+       3,     4,     5,    66,    67,   220,   221,    68,    41,   330,
+      42,    43,    44,   -13,   331,   -98,    26,   250,   311,   353,
+     -98,   -98,   -98,   -98,   308,   315,   272,    69,    70,    71,
+      72,    73,    74,    75,    76,    77,    78,    79,    80,    81,
+      82,    83,    84,    85,    86,    87,    88,    89,    90,    91,
+      92,   262,    93,    66,    67,    29,   298,    68,   335,    94,
+     128,   148,    95,    40,   228,    41,   180,    42,    43,    44,
+      45,    46,    47,   248,   249,     0,     0,    69,    70,    71,
+      72,    73,    74,    75,    76,    77,    78,    79,    80,    81,
+      82,    83,    84,    85,    86,    87,    88,    89,    90,    91,
+      92,     0,    93,     0,     0,     0,     0,     0,     0,    94,
+       0,     0,    95,    69,    70,    71,    72,    73,    74,    75,
+      76,    77,    78,    79,    80,    81,    82,    83,    84,    85,
+      86,    29,    88,    89,    90,     0,     0,     0,     0,    40,
+       0,    41,     0,    42,    43,    44,    45,    46,    40,     0,
+      41,     0,    42,    43,    44,    45,    46
 };
 
 static const yytype_int16 yycheck[] =
 {
-       1,    53,    34,    31,    31,   179,     7,     8,     9,    10,
-      37,    13,    56,     4,    15,    16,   109,    18,    19,    53,
-       4,    55,   121,     4,     4,    16,    61,     1,    63,    30,
-       4,     4,    12,     4,     1,     4,    38,     4,    12,    19,
-      20,    65,    66,    44,    11,    61,    47,    48,     4,    73,
-      34,    61,   226,    34,    55,    56,     4,     1,     1,     1,
-      14,    62,    16,    17,    18,    66,    67,    68,    69,    70,
+       1,    34,    53,    31,    31,   178,     7,     8,     9,    10,
+      37,    13,    56,     4,    15,    16,    11,    18,    19,   109,
+     121,    53,    61,    55,     4,    16,     4,     1,     4,    30,
+       4,    61,    12,     4,     4,     4,    38,    11,     1,    19,
+      20,     1,    61,    44,     1,     0,    47,    48,     4,    12,
+     223,    14,    12,    16,    17,    18,    19,    20,    21,     1,
+       1,    62,    57,     1,    34,    66,    67,    68,    69,    70,
       71,    72,    73,    74,    75,    76,    77,    78,    79,    80,
       81,    82,    83,    84,    85,    86,    87,    88,    89,    90,
-      91,    92,    93,   137,     1,   139,    65,    66,    71,   192,
-      71,   200,   136,   104,    73,    12,   107,    14,    64,    16,
-      17,    18,    19,    20,    21,    63,    61,    61,   119,    61,
-      63,   123,    66,    66,    66,     4,   127,     4,     1,   130,
-     131,   132,     4,     4,     4,   136,   137,     4,   139,    12,
-      12,    11,    11,   144,    11,    12,     4,    61,   200,    63,
-     151,   152,     4,   246,    12,    62,   200,     4,     4,     1,
-      62,     4,   336,     0,    66,   193,   193,    74,     1,    12,
-      12,    73,    14,   217,    16,    17,    18,    19,    20,    62,
-      32,    33,   183,   184,    63,    32,    33,    57,    57,    62,
-     191,    62,   194,     6,     7,     8,     9,    10,     4,     5,
-     201,     6,     7,     8,     9,    10,    21,   259,   209,    12,
-      20,    63,    64,    16,    61,   259,   217,    64,    12,    61,
-      61,   222,    63,   224,    66,    67,    68,    69,     0,     1,
-       4,   232,   233,   234,   235,   237,     4,    11,   240,    26,
-      12,   242,    14,    20,    16,    17,    18,    19,    20,    21,
-      22,    23,    24,    61,    62,    58,    59,    16,    71,    72,
-     261,   262,     1,   264,    32,    33,    71,    72,    11,    12,
-      13,    12,   273,     1,    65,     1,     4,    65,     4,   280,
-      61,    62,    63,    11,   285,    11,    12,    62,    63,    65,
-     292,    12,   294,   295,    61,    62,    64,   298,   299,    61,
-      62,    63,    74,   304,    61,    65,    63,     1,   309,    62,
-      63,   312,   344,    56,    31,    61,   317,    63,    12,   320,
-      14,    34,    16,    17,    18,    19,    20,    21,    61,    57,
-     331,    57,    61,   334,    63,     1,   337,     1,     1,     1,
-     341,   342,    65,     4,   345,    62,    63,     1,    63,    66,
-       4,    65,     1,   290,   283,   356,    73,    11,    12,     1,
-     315,    15,     4,   293,   349,   203,   211,   133,    62,   265,
-      12,   328,    14,    51,    16,    17,    18,    19,    20,    63,
-      74,    35,    36,    37,    38,    39,    40,    41,    42,    43,
+      91,    92,    93,    71,   138,   139,    65,     1,   199,    62,
+      71,   191,    62,   104,    61,   137,   107,     4,    12,    66,
+      14,    74,    16,    17,    18,    19,    20,    21,   119,    61,
+       1,   123,    63,     4,    66,    66,   127,     4,     4,     5,
+     131,   132,   133,    14,     4,    16,    17,    18,     4,    61,
+       4,    63,   143,     6,     7,     8,     9,    10,   199,   150,
+     151,     4,     4,   243,     4,   199,   329,    34,    62,     4,
+      12,    11,    32,    33,   192,   192,     4,     4,    65,    66,
+      74,    20,   216,    11,     4,     4,    73,    11,    12,    13,
+      61,   182,   183,    12,     4,    66,    67,    68,    69,   190,
+      21,   193,    12,    63,    64,    32,    33,    63,     1,   200,
+      64,     4,    32,    33,    61,   256,    63,   208,    71,    72,
+      63,    14,   256,    16,    17,    18,    12,    62,   219,    57,
+     221,    61,    56,    63,    61,     0,     1,    64,   229,   230,
+     231,   232,   234,    20,    64,   237,    12,    12,   239,    14,
+      16,    16,    17,    18,    19,    20,    21,    22,    23,    24,
+       6,     7,     8,     9,    10,    16,   257,    62,    61,     1,
+     261,    66,     4,    66,    67,    68,    69,    62,    73,   270,
+      12,    65,    66,    26,     1,   276,    31,     4,     1,    73,
+     281,     4,    58,    59,    11,    12,   288,     1,   290,   291,
+      61,    14,    63,    16,    17,    18,    61,   298,    63,    74,
+      12,    61,   303,    63,   337,   306,    65,    62,    63,    12,
+     311,    66,    34,   314,     4,    71,    72,     1,    73,    65,
+       4,    11,    12,   324,    61,    62,   327,    11,    12,   330,
+      57,    15,    65,   334,   335,    65,     1,   338,    61,     4,
+      61,    62,    63,    66,    67,    68,    69,     1,   349,     1,
+       4,    35,    36,    37,    38,    39,    40,    41,    42,    43,
       44,    45,    46,    47,    48,    49,    50,    51,    52,    53,
-      54,    55,    56,    57,    58,   185,    60,     4,    96,   193,
-     193,    -1,    -1,    67,    11,    12,    70,     1,    15,    61,
-      -1,    -1,    -1,    -1,    66,    67,    68,    69,    12,    -1,
-      14,    -1,    16,    17,    18,    19,    20,    -1,    35,    36,
-      37,    38,    39,    40,    41,    42,    43,    44,    45,    46,
-      47,    48,    49,    50,    51,    52,    53,    54,    55,    56,
-      57,    58,    -1,    60,    11,    12,    -1,    -1,    15,    -1,
-      67,    -1,    -1,    70,    12,    -1,    14,    61,    16,    17,
-      18,    19,    66,    67,    68,    69,    -1,    -1,    35,    36,
-      37,    38,    39,    40,    41,    42,    43,    44,    45,    46,
-      47,    48,    49,    50,    51,    52,    53,    54,    55,    56,
-      57,    58,    25,    60,    27,    28,    29,    30,    -1,    -1,
-      67,    -1,    -1,    70,    35,    36,    37,    38,    39,    40,
-      41,    42,    43,    44,    45,    46,    47,    48,    49,    50,
-      51,    52,     4,    54,    55,    56,    -1,    -1,    -1,    -1,
-      12,    -1,    14,     4,    16,    17,    18,    19,    20,    21,
-      -1,    12,    -1,    14,    -1,    16,    17,    18,    19,    20,
-      12,    -1,    14,    -1,    16,    17,    18,    19,    20
+      54,    55,    56,    57,    58,     1,    60,     1,     4,    61,
+       4,   130,     4,    67,     1,   134,    70,    11,    14,     1,
+      16,    17,    18,    12,     1,    14,    61,    16,    17,    18,
+      19,    66,    67,    68,    69,    62,    63,    61,    61,    62,
+      63,     1,    66,    67,    68,    69,     4,    25,    63,    27,
+      28,    29,    30,    11,    12,    62,    63,    15,    14,    65,
+      16,    17,    18,    57,   309,    61,    61,    62,   286,   342,
+      66,    67,    68,    69,   279,   289,   210,    35,    36,    37,
+      38,    39,    40,    41,    42,    43,    44,    45,    46,    47,
+      48,    49,    50,    51,    52,    53,    54,    55,    56,    57,
+      58,   202,    60,    11,    12,     4,   262,    15,   321,    67,
+      51,    63,    70,    12,   184,    14,    96,    16,    17,    18,
+      19,    20,    21,   192,   192,    -1,    -1,    35,    36,    37,
+      38,    39,    40,    41,    42,    43,    44,    45,    46,    47,
+      48,    49,    50,    51,    52,    53,    54,    55,    56,    57,
+      58,    -1,    60,    -1,    -1,    -1,    -1,    -1,    -1,    67,
+      -1,    -1,    70,    35,    36,    37,    38,    39,    40,    41,
+      42,    43,    44,    45,    46,    47,    48,    49,    50,    51,
+      52,     4,    54,    55,    56,    -1,    -1,    -1,    -1,    12,
+      -1,    14,    -1,    16,    17,    18,    19,    20,    12,    -1,
+      14,    -1,    16,    17,    18,    19,    20
 };
 
 /* YYSTOS[STATE-NUM] -- The (internal number of the) accessing
@@ -1111,30 +1058,29 @@
      135,   136,    32,    33,    64,    97,    98,   100,   101,    87,
       88,    62,   139,   140,    63,    20,    12,    16,    58,    59,
       12,    82,    20,     1,    82,    82,     1,    66,   126,     1,
-      67,    68,    69,   109,    12,    19,   117,   118,    82,   118,
-       1,    82,   119,    62,    63,   139,    82,     1,    62,   128,
-      62,    63,    16,    82,    82,    82,    82,    82,    82,    82,
+       4,    67,    68,    69,   109,    12,    19,   117,   118,   118,
+       1,   119,    62,    63,   139,    82,     1,    62,   128,    62,
+      63,    16,    82,    82,    82,    82,    82,    82,    82,    82,
       82,    82,    82,    82,    82,    82,    82,    82,    82,    82,
       82,    82,    82,    82,    82,    82,    82,    82,    82,    82,
-      82,   134,    62,    66,    73,   132,    82,    82,    82,    62,
-      83,    26,    89,    91,     1,    12,    11,    12,    13,    56,
-      82,    12,    19,   114,   121,    63,   139,    11,    57,    94,
-      62,    82,    82,    82,    82,   115,    82,   118,    82,    82,
-      82,    62,    63,    62,    63,    82,    82,     1,   131,    82,
-      82,   133,    12,    95,    34,    12,   106,     1,    82,    83,
-       1,    22,    23,    24,    74,    87,    92,   104,   107,   108,
-     111,   137,   138,    62,   139,    65,    65,    65,    65,   114,
-     116,   117,   119,    82,    12,   121,     6,     7,     8,     9,
-      10,    71,    72,   123,    82,   113,    82,    82,    82,   131,
-      65,    82,    82,    82,    82,    34,    99,    63,   139,    12,
-      90,   139,     1,    82,     1,     1,     1,    83,   117,   119,
-      65,    82,    82,    71,   123,    82,   101,   102,   103,    31,
-     130,    82,    16,    96,    97,    82,     4,    94,    63,   139,
-      61,   103,    63,   139,    63,   139,    82,    82,    82,    11,
-      12,   124,    63,     1,    66,    82,    82,    65,    98,    82,
-      82,    61,   124,    82,    82,   131,    82,    63,   105,    82,
-      82,    71,   101,    82,    62,    87,    93,   111,   137,   138,
-     105,    71,     1,    82,    62
+     134,    62,    66,    73,   132,    82,    82,    82,    62,    83,
+      26,    89,    91,     1,    12,    11,    12,    13,    56,    82,
+      12,    19,   114,   121,    63,   139,    11,    57,    94,    62,
+      82,   115,    82,    82,    82,   115,   118,    82,    62,    63,
+      62,    63,    82,    82,     1,   131,    82,    82,   133,    12,
+      95,    34,    12,   106,     1,    82,    83,     1,    22,    23,
+      24,    74,    87,    92,   104,   107,   108,   111,   137,   138,
+      62,   139,    65,    65,    65,    65,   114,   116,   117,   119,
+      82,    12,   121,     6,     7,     8,     9,    10,    71,    72,
+     123,    82,   113,    82,    82,   131,    65,    82,    82,    82,
+      82,    34,    99,    63,   139,    12,    90,   139,     1,    82,
+       1,     1,     1,    83,   117,   119,    82,    71,   123,    82,
+     101,   102,   103,    31,   130,    82,    16,    96,    97,    82,
+       4,    94,    63,   139,    61,   103,    63,   139,    63,   139,
+      65,    82,    11,    12,   124,    63,     1,    66,    82,    82,
+      65,    98,    82,    82,    61,   124,    82,    82,   131,    82,
+      63,   105,    82,    82,    71,   101,    82,    62,    87,    93,
+     111,   137,   138,   105,    71,     1,    82,    62
 };
 
 #define yyerrok		(yyerrstatus = 0)
@@ -1319,17 +1265,20 @@
 #if (defined __STDC__ || defined __C99__FUNC__ \
      || defined __cplusplus || defined _MSC_VER)
 static void
-yy_stack_print (yytype_int16 *bottom, yytype_int16 *top)
+yy_stack_print (yytype_int16 *yybottom, yytype_int16 *yytop)
 #else
 static void
-yy_stack_print (bottom, top)
-    yytype_int16 *bottom;
-    yytype_int16 *top;
+yy_stack_print (yybottom, yytop)
+    yytype_int16 *yybottom;
+    yytype_int16 *yytop;
 #endif
 {
   YYFPRINTF (stderr, "Stack now");
-  for (; bottom <= top; ++bottom)
-    YYFPRINTF (stderr, " %d", *bottom);
+  for (; yybottom <= yytop; yybottom++)
+    {
+      int yybot = *yybottom;
+      YYFPRINTF (stderr, " %d", yybot);
+    }
   YYFPRINTF (stderr, "\n");
 }
 
@@ -1363,11 +1312,11 @@
   /* The symbols being reduced.  */
   for (yyi = 0; yyi < yynrhs; yyi++)
     {
-      fprintf (stderr, "   $%d = ", yyi + 1);
+      YYFPRINTF (stderr, "   $%d = ", yyi + 1);
       yy_symbol_print (stderr, yyrhs[yyprhs[yyrule] + yyi],
 		       &(yyvsp[(yyi + 1) - (yynrhs)])
 		       		       );
-      fprintf (stderr, "\n");
+      YYFPRINTF (stderr, "\n");
     }
 }
 
@@ -1722,10 +1671,8 @@
 	break;
     }
 }
-
 
 /* Prevent warnings from -Wmissing-prototypes.  */
-
 #ifdef YYPARSE_PARAM
 #if defined __STDC__ || defined __cplusplus
 int yyparse (void *YYPARSE_PARAM);
@@ -1744,11 +1691,10 @@
 
 
 
+/*-------------------------.
+| yyparse or yypush_parse.  |
+`-------------------------*/
 
-/*----------.
-| yyparse.  |
-`----------*/
-
 #ifdef YYPARSE_PARAM
 #if (defined __STDC__ || defined __C99__FUNC__ \
      || defined __cplusplus || defined _MSC_VER)
@@ -1771,74 +1717,75 @@
 #endif
 #endif
 {
-  /* The look-ahead symbol.  */
+/* The lookahead symbol.  */
 int yychar;
 
-/* The semantic value of the look-ahead symbol.  */
+/* The semantic value of the lookahead symbol.  */
 YYSTYPE yylval;
 
-/* Number of syntax errors so far.  */
-int yynerrs;
+    /* Number of syntax errors so far.  */
+    int yynerrs;
 
-  int yystate;
-  int yyn;
-  int yyresult;
-  /* Number of tokens to shift before error messages enabled.  */
-  int yyerrstatus;
-  /* Look-ahead token as an internal (translated) token number.  */
-  int yytoken = 0;
-#if YYERROR_VERBOSE
-  /* Buffer for error messages, and its allocated size.  */
-  char yymsgbuf[128];
-  char *yymsg = yymsgbuf;
-  YYSIZE_T yymsg_alloc = sizeof yymsgbuf;
-#endif
+    int yystate;
+    /* Number of tokens to shift before error messages enabled.  */
+    int yyerrstatus;
 
-  /* Three stacks and their tools:
-     `yyss': related to states,
-     `yyvs': related to semantic values,
-     `yyls': related to locations.
+    /* The stacks and their tools:
+       `yyss': related to states.
+       `yyvs': related to semantic values.
 
-     Refer to the stacks thru separate pointers, to allow yyoverflow
-     to reallocate them elsewhere.  */
+       Refer to the stacks thru separate pointers, to allow yyoverflow
+       to reallocate them elsewhere.  */
 
-  /* The state stack.  */
-  yytype_int16 yyssa[YYINITDEPTH];
-  yytype_int16 *yyss = yyssa;
-  yytype_int16 *yyssp;
+    /* The state stack.  */
+    yytype_int16 yyssa[YYINITDEPTH];
+    yytype_int16 *yyss;
+    yytype_int16 *yyssp;
 
-  /* The semantic value stack.  */
-  YYSTYPE yyvsa[YYINITDEPTH];
-  YYSTYPE *yyvs = yyvsa;
-  YYSTYPE *yyvsp;
+    /* The semantic value stack.  */
+    YYSTYPE yyvsa[YYINITDEPTH];
+    YYSTYPE *yyvs;
+    YYSTYPE *yyvsp;
 
+    YYSIZE_T yystacksize;
 
-
-#define YYPOPSTACK(N)   (yyvsp -= (N), yyssp -= (N))
-
-  YYSIZE_T yystacksize = YYINITDEPTH;
-
+  int yyn;
+  int yyresult;
+  /* Lookahead token as an internal (translated) token number.  */
+  int yytoken;
   /* The variables used to return semantic value and location from the
      action routines.  */
   YYSTYPE yyval;
 
+#if YYERROR_VERBOSE
+  /* Buffer for error messages, and its allocated size.  */
+  char yymsgbuf[128];
+  char *yymsg = yymsgbuf;
+  YYSIZE_T yymsg_alloc = sizeof yymsgbuf;
+#endif
 
+#define YYPOPSTACK(N)   (yyvsp -= (N), yyssp -= (N))
+
   /* The number of symbols on the RHS of the reduced rule.
      Keep to zero when no symbol should be popped.  */
   int yylen = 0;
 
+  yytoken = 0;
+  yyss = yyssa;
+  yyvs = yyvsa;
+  yystacksize = YYINITDEPTH;
+
   YYDPRINTF ((stderr, "Starting parse\n"));
 
   yystate = 0;
   yyerrstatus = 0;
   yynerrs = 0;
-  yychar = YYEMPTY;		/* Cause a token to be read.  */
+  yychar = YYEMPTY; /* Cause a token to be read.  */
 
   /* Initialize stack pointers.
      Waste one element of value and location stack
      so that they stay on the same level as the state stack.
      The wasted elements are never initialized.  */
-
   yyssp = yyss;
   yyvsp = yyvs;
 
@@ -1868,7 +1815,6 @@
 	YYSTYPE *yyvs1 = yyvs;
 	yytype_int16 *yyss1 = yyss;
 
-
 	/* Each stack pointer address is followed by the size of the
 	   data in use in that stack, in bytes.  This used to be a
 	   conditional around just the two extra args, but that might
@@ -1876,7 +1822,6 @@
 	yyoverflow (YY_("memory exhausted"),
 		    &yyss1, yysize * sizeof (*yyssp),
 		    &yyvs1, yysize * sizeof (*yyvsp),
-
 		    &yystacksize);
 
 	yyss = yyss1;
@@ -1899,9 +1844,8 @@
 	  (union yyalloc *) YYSTACK_ALLOC (YYSTACK_BYTES (yystacksize));
 	if (! yyptr)
 	  goto yyexhaustedlab;
-	YYSTACK_RELOCATE (yyss);
-	YYSTACK_RELOCATE (yyvs);
-
+	YYSTACK_RELOCATE (yyss_alloc, yyss);
+	YYSTACK_RELOCATE (yyvs_alloc, yyvs);
 #  undef YYSTACK_RELOCATE
 	if (yyss1 != yyssa)
 	  YYSTACK_FREE (yyss1);
@@ -1912,7 +1856,6 @@
       yyssp = yyss + yysize - 1;
       yyvsp = yyvs + yysize - 1;
 
-
       YYDPRINTF ((stderr, "Stack size increased to %lu\n",
 		  (unsigned long int) yystacksize));
 
@@ -1922,6 +1865,9 @@
 
   YYDPRINTF ((stderr, "Entering state %d\n", yystate));
 
+  if (yystate == YYFINAL)
+    YYACCEPT;
+
   goto yybackup;
 
 /*-----------.
@@ -1930,16 +1876,16 @@
 yybackup:
 
   /* Do appropriate processing given the current state.  Read a
-     look-ahead token if we need one and don't already have one.  */
+     lookahead token if we need one and don't already have one.  */
 
-  /* First try to decide what to do without reference to look-ahead token.  */
+  /* First try to decide what to do without reference to lookahead token.  */
   yyn = yypact[yystate];
   if (yyn == YYPACT_NINF)
     goto yydefault;
 
-  /* Not known => get a look-ahead token if don't already have one.  */
+  /* Not known => get a lookahead token if don't already have one.  */
 
-  /* YYCHAR is either YYEMPTY or YYEOF or a valid look-ahead symbol.  */
+  /* YYCHAR is either YYEMPTY or YYEOF or a valid lookahead symbol.  */
   if (yychar == YYEMPTY)
     {
       YYDPRINTF ((stderr, "Reading a token: "));
@@ -1971,20 +1917,16 @@
       goto yyreduce;
     }
 
-  if (yyn == YYFINAL)
-    YYACCEPT;
-
   /* Count tokens shifted since error; after three, turn off error
      status.  */
   if (yyerrstatus)
     yyerrstatus--;
 
-  /* Shift the look-ahead token.  */
+  /* Shift the lookahead token.  */
   YY_SYMBOL_PRINT ("Shifting", yytoken, &yylval, &yylloc);
 
-  /* Discard the shifted token unless it is eof.  */
-  if (yychar != YYEOF)
-    yychar = YYEMPTY;
+  /* Discard the shifted token.  */
+  yychar = YYEMPTY;
 
   yystate = yyn;
   *++yyvsp = yylval;
@@ -2406,21 +2348,16 @@
 
   case 80:
 
-    { (yyval.relation) = CSSSelector::Descendant; ;}
+    { (yyval.val) = -1; ;}
     break;
 
   case 81:
 
-    { (yyval.val) = -1; ;}
+    { (yyval.val) = 1; ;}
     break;
 
   case 82:
 
-    { (yyval.val) = 1; ;}
-    break;
-
-  case 83:
-
     {
 #ifdef CSS_DEBUG
 	kDebug( 6080 ) << "got ruleset" << endl << "  selector:";
@@ -2442,7 +2379,7 @@
     ;}
     break;
 
-  case 84:
+  case 83:
 
     {
 	if ( (yyvsp[(1) - (1)].selector) ) {
@@ -2459,7 +2396,7 @@
     ;}
     break;
 
-  case 85:
+  case 84:
 
     {
 	if ( (yyvsp[(1) - (4)].selectorList) && (yyvsp[(4) - (4)].selector) ) {
@@ -2481,7 +2418,7 @@
     ;}
     break;
 
-  case 86:
+  case 85:
 
     {
         if ((yyvsp[(1) - (2)].selectorList)) qDeleteAll(*(yyvsp[(1) - (2)].selectorList));
@@ -2491,16 +2428,41 @@
     ;}
     break;
 
-  case 87:
+  case 86:
 
     {
 	(yyval.selector) = (yyvsp[(1) - (1)].selector);
     ;}
     break;
 
+  case 87:
+
+    {
+        (yyval.selector) = (yyvsp[(1) - (2)].selector);
+    ;}
+    break;
+
   case 88:
 
     {
+        if ( !(yyvsp[(1) - (3)].selector) || !(yyvsp[(3) - (3)].selector) ) {
+	    delete (yyvsp[(1) - (3)].selector);
+	    delete (yyvsp[(3) - (3)].selector);
+	    (yyval.selector) = 0;
+        } else {
+            (yyval.selector) = (yyvsp[(3) - (3)].selector);
+            CSSSelector *end = (yyval.selector);
+            while( end->tagHistory )
+                end = end->tagHistory;
+            end->relation = CSSSelector::Descendant;
+            end->tagHistory = (yyvsp[(1) - (3)].selector);
+        }
+    ;}
+    break;
+
+  case 89:
+
+    {
 	if ( !(yyvsp[(1) - (3)].selector) || !(yyvsp[(3) - (3)].selector) ) {
 	    delete (yyvsp[(1) - (3)].selector);
 	    delete (yyvsp[(3) - (3)].selector);
@@ -2516,7 +2478,7 @@
     ;}
     break;
 
-  case 89:
+  case 90:
 
     {
 	delete (yyvsp[(1) - (2)].selector);
@@ -2524,45 +2486,45 @@
     ;}
     break;
 
-  case 90:
+  case 91:
 
     { (yyval.string).string = 0; (yyval.string).length = 0; ;}
     break;
 
-  case 91:
+  case 92:
 
     { static unsigned short star = '*'; (yyval.string).string = &star; (yyval.string).length = 1; ;}
     break;
 
-  case 92:
+  case 93:
 
     { (yyval.string) = (yyvsp[(1) - (2)].string); ;}
     break;
 
-  case 93:
+  case 94:
 
     {
 	(yyval.selector) = new CSSSelector();
-        (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(1) - (2)].element)));
-        (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(1) - (2)].element)));
+        (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(1) - (1)].element)));
+        (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(1) - (1)].element)));
     ;}
     break;
 
-  case 94:
+  case 95:
 
     {
-	(yyval.selector) = (yyvsp[(2) - (3)].selector);
+	(yyval.selector) = (yyvsp[(2) - (2)].selector);
         if ( (yyval.selector) ) {
-            (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(1) - (3)].element)));
-            (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(1) - (3)].element)));
+            (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(1) - (2)].element)));
+            (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(1) - (2)].element)));
         }
     ;}
     break;
 
-  case 95:
+  case 96:
 
     {
-	(yyval.selector) = (yyvsp[(1) - (2)].selector);
+	(yyval.selector) = (yyvsp[(1) - (1)].selector);
         if ( (yyval.selector) ) {
             (yyval.selector)->tagLocalName = LocalName::fromId(anyLocalName);
             (yyval.selector)->tagNamespace = NamespaceName::fromId(static_cast<CSSParser*>(parser)->defaultNamespace());
@@ -2570,59 +2532,59 @@
     ;}
     break;
 
-  case 96:
+  case 97:
 
     {
         (yyval.selector) = new CSSSelector();
-        (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(2) - (3)].element)));
-        (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(2) - (3)].element)));
+        (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(2) - (2)].element)));
+        (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(2) - (2)].element)));
 	CSSParser *p = static_cast<CSSParser *>(parser);
         if (p->styleElement && p->styleElement->isCSSStyleSheet())
-            static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (3)].string)));
+            static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (2)].string)));
     ;}
     break;
 
-  case 97:
+  case 98:
 
     {
-        (yyval.selector) = (yyvsp[(3) - (4)].selector);
+        (yyval.selector) = (yyvsp[(3) - (3)].selector);
         if ((yyval.selector)) {
-            (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(2) - (4)].element)));
-            (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(2) - (4)].element)));
+            (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(2) - (3)].element)));
+            (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(2) - (3)].element)));
             CSSParser *p = static_cast<CSSParser *>(parser);
             if (p->styleElement && p->styleElement->isCSSStyleSheet())
-                static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (4)].string)));
+                static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (3)].string)));
         }
     ;}
     break;
 
-  case 98:
+  case 99:
 
     {
-        (yyval.selector) = (yyvsp[(2) - (3)].selector);
+        (yyval.selector) = (yyvsp[(2) - (2)].selector);
         if ((yyval.selector)) {
             (yyval.selector)->tagLocalName = LocalName::fromId(anyLocalName);
             (yyval.selector)->tagNamespace = NamespaceName::fromId(anyNamespace);
             CSSParser *p = static_cast<CSSParser *>(parser);
             if (p->styleElement && p->styleElement->isCSSStyleSheet())
-                static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (3)].string)));
+                static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (2)].string)));
         }
     ;}
     break;
 
-  case 99:
+  case 100:
 
     {
 	(yyval.selector) = new CSSSelector();
-        (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(1) - (2)].element)));
-        (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(1) - (2)].element)));
+        (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(1) - (1)].element)));
+        (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(1) - (1)].element)));
     ;}
     break;
 
-  case 100:
+  case 101:
 
     {
-	(yyval.selector) = (yyvsp[(1) - (2)].selector);
+	(yyval.selector) = (yyvsp[(1) - (1)].selector);
         if ( (yyval.selector) ) {
             (yyval.selector)->tagLocalName = LocalName::fromId(anyLocalName);
             (yyval.selector)->tagNamespace = NamespaceName::fromId(static_cast<CSSParser*>(parser)->defaultNamespace());
@@ -2630,67 +2592,55 @@
     ;}
     break;
 
-  case 101:
+  case 102:
 
     {
         (yyval.selector) = new CSSSelector();
-        (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(2) - (3)].element)));
-        (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(2) - (3)].element)));
+        (yyval.selector)->tagLocalName = LocalName::fromId(localNamePart((yyvsp[(2) - (2)].element)));
+        (yyval.selector)->tagNamespace = NamespaceName::fromId(namespacePart((yyvsp[(2) - (2)].element)));
 	CSSParser *p = static_cast<CSSParser *>(parser);
         if (p->styleElement && p->styleElement->isCSSStyleSheet())
-            static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (3)].string)));
+            static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (2)].string)));
     ;}
     break;
 
-  case 102:
+  case 103:
 
     {
-        (yyval.selector) = (yyvsp[(2) - (3)].selector);
+        (yyval.selector) = (yyvsp[(2) - (2)].selector);
         if ((yyval.selector)) {
             (yyval.selector)->tagLocalName = LocalName::fromId(anyLocalName);
             (yyval.selector)->tagNamespace = NamespaceName::fromId(anyNamespace);
             CSSParser *p = static_cast<CSSParser *>(parser);
             if (p->styleElement && p->styleElement->isCSSStyleSheet())
-                static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (3)].string)));
+                static_cast<CSSStyleSheetImpl*>(p->styleElement)->determineNamespace((yyval.selector)->tagNamespace, domString((yyvsp[(1) - (2)].string)));
         }
     ;}
     break;
 
-  case 103:
+  case 104:
 
     {
-	CSSParser *p = static_cast<CSSParser *>(parser);
-	DOM::DocumentImpl *doc = p->document();
-	QString tag = qString((yyvsp[(1) - (1)].string));
-	if ( doc ) {
-	    if (doc->isHTMLDocument())
-		tag = tag.toLower();
-	    const DOMString dtag(tag);
-            (yyval.element) = makeId(p->defaultNamespace(), p->getLocalNameId(dtag));
-	} else {
-	    (yyval.element) = makeId(p->defaultNamespace(), p->getLocalNameId(tag.toLower()));
-	    // this case should never happen - only when loading
-	    // the default stylesheet - which must not contain unknown tags
-// 	    assert($$ != 0);
-	}
+      CSSParser *p = static_cast<CSSParser *>(parser);
+      (yyval.element) = makeId(p->defaultNamespace(), p->getLocalNameId(domString((yyvsp[(1) - (1)].string))));
     ;}
     break;
 
-  case 104:
+  case 105:
 
     {
 	(yyval.element) = makeId(static_cast<CSSParser*>(parser)->defaultNamespace(), anyLocalName);
     ;}
     break;
 
-  case 105:
+  case 106:
 
     {
 	(yyval.selector) = (yyvsp[(1) - (1)].selector);
     ;}
     break;
 
-  case 106:
+  case 107:
 
     {
 	(yyval.selector) = (yyvsp[(1) - (2)].selector);
@@ -2704,7 +2654,7 @@
     ;}
     break;
 
-  case 107:
+  case 108:
 
     {
 	delete (yyvsp[(1) - (2)].selector);
@@ -2712,7 +2662,7 @@
     ;}
     break;
 
-  case 108:
+  case 109:
 
     {
         CSSParser *p = static_cast<CSSParser *>(parser);
@@ -2730,7 +2680,7 @@
     ;}
     break;
 
-  case 112:
+  case 113:
 
     {
         CSSParser *p = static_cast<CSSParser *>(parser);
@@ -2748,32 +2698,15 @@
     ;}
     break;
 
-  case 113:
+  case 114:
 
     {
-	CSSParser *p = static_cast<CSSParser *>(parser);
-	DOM::DocumentImpl *doc = p->document();
-
-	QString attr = qString((yyvsp[(1) - (2)].string));
-	if ( doc ) {
-	    if (doc->isHTMLDocument())
-		attr = attr.toLower();
-	    const DOMString dattr(attr);
-#ifdef APPLE_CHANGES
-            (yyval.attribute) = doc->attrId(0, dattr.implementation(), false);
-#else
-	    (yyval.attribute) = makeId(emptyNamespace, p->getLocalNameId(dattr));
-#endif
-	} else {
-	    (yyval.attribute) = makeId(emptyNamespace, p->getLocalNameId(attr.toLower()));
-	    // this case should never happen - only when loading
-	    // the default stylesheet - which must not contain unknown attributes
-	    assert((yyval.attribute) != 0);
-	    }
+      CSSParser *p = static_cast<CSSParser *>(parser);
+      (yyval.attribute) = makeId(emptyNamespace, p->getLocalNameId(domString((yyvsp[(1) - (2)].string))));
     ;}
     break;
 
-  case 114:
+  case 115:
 
     {
 	(yyval.selector) = new CSSSelector();
@@ -2783,7 +2716,7 @@
     ;}
     break;
 
-  case 115:
+  case 116:
 
     {
 	(yyval.selector) = new CSSSelector();
@@ -2794,7 +2727,7 @@
     ;}
     break;
 
-  case 116:
+  case 117:
 
     {
         (yyval.selector) = new CSSSelector();
@@ -2807,7 +2740,7 @@
     ;}
     break;
 
-  case 117:
+  case 118:
 
     {
         (yyval.selector) = new CSSSelector();
@@ -2821,49 +2754,49 @@
    ;}
     break;
 
-  case 118:
+  case 119:
 
     {
 	(yyval.match) = CSSSelector::Exact;
     ;}
     break;
 
-  case 119:
+  case 120:
 
     {
 	(yyval.match) = CSSSelector::List;
     ;}
     break;
 
-  case 120:
+  case 121:
 
     {
 	(yyval.match) = CSSSelector::Hyphen;
     ;}
     break;
 
-  case 121:
+  case 122:
 
     {
 	(yyval.match) = CSSSelector::Begin;
     ;}
     break;
 
-  case 122:
+  case 123:
 
     {
 	(yyval.match) = CSSSelector::End;
     ;}
     break;
 
-  case 123:
+  case 124:
 
     {
 	(yyval.match) = CSSSelector::Contain;
     ;}
     break;
 
-  case 126:
+  case 127:
 
     {
 	(yyval.selector) = new CSSSelector();
@@ -2872,7 +2805,7 @@
     ;}
     break;
 
-  case 127:
+  case 128:
 
     {
 	(yyval.selector) = new CSSSelector();
@@ -2881,7 +2814,7 @@
     ;}
     break;
 
-  case 128:
+  case 129:
 
     {
         (yyval.selector) = new CSSSelector();
@@ -2891,7 +2824,7 @@
     ;}
     break;
 
-  case 129:
+  case 130:
 
     {
         (yyval.selector) = new CSSSelector();
@@ -2901,7 +2834,7 @@
     ;}
     break;
 
-  case 130:
+  case 131:
 
     {
         (yyval.selector) = new CSSSelector();
@@ -2911,7 +2844,7 @@
     ;}
     break;
 
-  case 131:
+  case 132:
 
     {
         (yyval.selector) = new CSSSelector();
@@ -2921,38 +2854,38 @@
     ;}
     break;
 
-  case 132:
+  case 133:
 
     {
         (yyval.selector) = new CSSSelector();
         (yyval.selector)->match = CSSSelector::PseudoClass;
-        (yyval.selector)->simpleSelector = (yyvsp[(4) - (5)].selector);
-        (yyval.selector)->value = domString((yyvsp[(2) - (5)].string));
+        (yyval.selector)->simpleSelector = (yyvsp[(4) - (6)].selector);
+        (yyval.selector)->value = domString((yyvsp[(2) - (6)].string));
     ;}
     break;
 
-  case 133:
+  case 134:
 
     {
 	(yyval.ok) = (yyvsp[(3) - (4)].ok);
     ;}
     break;
 
-  case 134:
+  case 135:
 
     {
 	(yyval.ok) = false;
     ;}
     break;
 
-  case 135:
+  case 136:
 
     {
 	(yyval.ok) = (yyvsp[(3) - (4)].ok);
     ;}
     break;
 
-  case 136:
+  case 137:
 
     {
 	(yyval.ok) = (yyvsp[(3) - (5)].ok);
@@ -2961,28 +2894,28 @@
     ;}
     break;
 
-  case 137:
+  case 138:
 
     {
 	(yyval.ok) = (yyvsp[(3) - (5)].ok);
     ;}
     break;
 
-  case 138:
+  case 139:
 
     {
 	(yyval.ok) = (yyvsp[(1) - (3)].ok);
     ;}
     break;
 
-  case 139:
+  case 140:
 
     {
         (yyval.ok) = false;
     ;}
     break;
 
-  case 140:
+  case 141:
 
     {
 	(yyval.ok) = (yyvsp[(1) - (4)].ok);
@@ -2991,14 +2924,14 @@
     ;}
     break;
 
-  case 141:
+  case 142:
 
     {
         (yyval.ok) = (yyvsp[(1) - (4)].ok);
     ;}
     break;
 
-  case 142:
+  case 143:
 
     {
 	(yyval.ok) = false;
@@ -3024,14 +2957,14 @@
     ;}
     break;
 
-  case 143:
+  case 144:
 
     {
         (yyval.ok) = false;
     ;}
     break;
 
-  case 144:
+  case 145:
 
     {
 	QString str = qString((yyvsp[(1) - (2)].string));
@@ -3039,17 +2972,17 @@
     ;}
     break;
 
-  case 145:
+  case 146:
 
     { (yyval.b) = true; ;}
     break;
 
-  case 146:
+  case 147:
 
     { (yyval.b) = false; ;}
     break;
 
-  case 147:
+  case 148:
 
     {
 	(yyval.valueList) = new ValueList;
@@ -3057,7 +2990,7 @@
     ;}
     break;
 
-  case 148:
+  case 149:
 
     {
 	(yyval.valueList) = (yyvsp[(1) - (3)].valueList);
@@ -3074,48 +3007,48 @@
     ;}
     break;
 
-  case 149:
+  case 150:
 
     {
 	(yyval.tok) = '/';
     ;}
     break;
 
-  case 150:
+  case 151:
 
     {
 	(yyval.tok) = ',';
     ;}
     break;
 
-  case 151:
+  case 152:
 
     {
         (yyval.tok) = 0;
   ;}
     break;
 
-  case 152:
+  case 153:
 
     { (yyval.value) = (yyvsp[(1) - (1)].value); ;}
     break;
 
-  case 153:
+  case 154:
 
     { (yyval.value) = (yyvsp[(2) - (2)].value); (yyval.value).fValue *= (yyvsp[(1) - (2)].val); ;}
     break;
 
-  case 154:
+  case 155:
 
     { (yyval.value).id = 0; (yyval.value).string = (yyvsp[(1) - (2)].string); (yyval.value).unit = CSSPrimitiveValue::CSS_DIMENSION; ;}
     break;
 
-  case 155:
+  case 156:
 
     { (yyval.value).id = 0; (yyval.value).string = (yyvsp[(1) - (2)].string); (yyval.value).unit = CSSPrimitiveValue::CSS_STRING; ;}
     break;
 
-  case 156:
+  case 157:
 
     {
       QString str = qString( (yyvsp[(1) - (2)].string) );
@@ -3125,134 +3058,134 @@
   ;}
     break;
 
-  case 157:
+  case 158:
 
     { (yyval.value).id = 0; (yyval.value).string = (yyvsp[(1) - (2)].string); (yyval.value).unit = CSSPrimitiveValue::CSS_URI; ;}
     break;
 
-  case 158:
+  case 159:
 
     { (yyval.value).id = 0; (yyval.value).iValue = 0; (yyval.value).unit = CSSPrimitiveValue::CSS_UNKNOWN;/* ### */ ;}
     break;
 
-  case 159:
+  case 160:
 
     { (yyval.value).id = 0; (yyval.value).string = (yyvsp[(1) - (1)].string); (yyval.value).unit = CSSPrimitiveValue::CSS_RGBCOLOR; ;}
     break;
 
-  case 160:
+  case 161:
 
     {
       (yyval.value) = (yyvsp[(1) - (1)].value);
   ;}
     break;
 
-  case 161:
+  case 162:
 
     { (yyval.value).id = 0; (yyval.value).isInt = true; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_NUMBER; ;}
     break;
 
-  case 162:
+  case 163:
 
     { (yyval.value).id = 0; (yyval.value).isInt = false; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_NUMBER; ;}
     break;
 
-  case 163:
+  case 164:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_PERCENTAGE; ;}
     break;
 
-  case 164:
+  case 165:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_PX; ;}
     break;
 
-  case 165:
+  case 166:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_CM; ;}
     break;
 
-  case 166:
+  case 167:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_MM; ;}
     break;
 
-  case 167:
+  case 168:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_IN; ;}
     break;
 
-  case 168:
+  case 169:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_PT; ;}
     break;
 
-  case 169:
+  case 170:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_PC; ;}
     break;
 
-  case 170:
+  case 171:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_DEG; ;}
     break;
 
-  case 171:
+  case 172:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_RAD; ;}
     break;
 
-  case 172:
+  case 173:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_GRAD; ;}
     break;
 
-  case 173:
+  case 174:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_MS; ;}
     break;
 
-  case 174:
+  case 175:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_S; ;}
     break;
 
-  case 175:
+  case 176:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_HZ; ;}
     break;
 
-  case 176:
+  case 177:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_KHZ; ;}
     break;
 
-  case 177:
+  case 178:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_EMS; ;}
     break;
 
-  case 178:
+  case 179:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = Value::Q_EMS; ;}
     break;
 
-  case 179:
+  case 180:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_EXS; ;}
     break;
 
-  case 180:
+  case 181:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_DPI; ;}
     break;
 
-  case 181:
+  case 182:
 
     { (yyval.value).id = 0; (yyval.value).fValue = (yyvsp[(1) - (2)].val); (yyval.value).unit = CSSPrimitiveValue::CSS_DPCM; ;}
     break;
 
-  case 182:
+  case 183:
 
     {
       Function *f = new Function;
@@ -3264,7 +3197,7 @@
   ;}
     break;
 
-  case 183:
+  case 184:
 
     {
       Function *f = new Function;
@@ -3276,12 +3209,12 @@
   ;}
     break;
 
-  case 184:
+  case 185:
 
     { (yyval.string) = (yyvsp[(1) - (2)].string); ;}
     break;
 
-  case 185:
+  case 186:
 
     {
 	(yyval.rule) = 0;
@@ -3291,7 +3224,7 @@
     ;}
     break;
 
-  case 186:
+  case 187:
 
     {
 	(yyval.rule) = 0;
@@ -3301,7 +3234,7 @@
     ;}
     break;
 
-  case 187:
+  case 188:
 
     {
 	(yyval.rule) = 0;
@@ -3312,7 +3245,6 @@
     break;
 
 
-/* Line 1267 of yacc.c.  */
 
       default: break;
     }
@@ -3324,7 +3256,6 @@
 
   *++yyvsp = yyval;
 
-
   /* Now `shift' the result of the reduction.  Determine what state
      that goes to, based on the state we popped back to and the rule
      number reduced by.  */
@@ -3389,7 +3320,7 @@
 
   if (yyerrstatus == 3)
     {
-      /* If just tried and failed to reuse look-ahead token after an
+      /* If just tried and failed to reuse lookahead token after an
 	 error, discard it.  */
 
       if (yychar <= YYEOF)
@@ -3406,7 +3337,7 @@
 	}
     }
 
-  /* Else will try to reuse look-ahead token after shifting the error
+  /* Else will try to reuse lookahead token after shifting the error
      token.  */
   goto yyerrlab1;
 
@@ -3463,9 +3394,6 @@
       YY_STACK_PRINT (yyss, yyssp);
     }
 
-  if (yyn == YYFINAL)
-    YYACCEPT;
-
   *++yyvsp = yylval;
 
 
@@ -3490,7 +3418,7 @@
   yyresult = 1;
   goto yyreturn;
 
-#ifndef yyoverflow
+#if !defined(yyoverflow) || YYERROR_VERBOSE
 /*-------------------------------------------------.
 | yyexhaustedlab -- memory exhaustion comes here.  |
 `-------------------------------------------------*/
@@ -3501,7 +3429,7 @@
 #endif
 
 yyreturn:
-  if (yychar != YYEOF && yychar != YYEMPTY)
+  if (yychar != YYEMPTY)
      yydestruct ("Cleanup: discarding lookahead",
 		 yytoken, &yylval);
   /* Do not reclaim the symbols of the rule which action triggered
Index: khtml/css/cssvalues.in
===================================================================
--- khtml/css/cssvalues.in	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/cssvalues.in	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -99,7 +99,12 @@
 fantasy
 monospace
 #
+# CSS_PROP_BACKGROUND_ATTACHMENT:
 #
+scroll
+fixed
+local
+#
 # CSS_PROP_BACKGROUND_COLOR:
 #
 transparent
@@ -337,7 +342,6 @@
 crop
 cross
 embed
-fixed
 hand
 hide
 higher
@@ -352,7 +356,6 @@
 overline
 portrait
 relative
-scroll
 separate
 show
 static
Index: khtml/css/css_renderstyledeclarationimpl.cpp
===================================================================
--- khtml/css/css_renderstyledeclarationimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/css_renderstyledeclarationimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -430,10 +430,16 @@
             Q_ASSERT( 0 );
         }
     case CSS_PROP_BACKGROUND_ATTACHMENT:
-        if (style->backgroundAttachment())
+        switch (style->backgroundAttachment()) {
+        case khtml::BGASCROLL:
             return new CSSPrimitiveValueImpl(CSS_VAL_SCROLL);
-        else
+        case khtml::BGAFIXED:
             return new CSSPrimitiveValueImpl(CSS_VAL_FIXED);
+        case khtml::BGALOCAL:
+            return new CSSPrimitiveValueImpl(CSS_VAL_LOCAL);
+        default:
+            Q_ASSERT( 0 );
+        }                    
     case CSS_PROP_BACKGROUND_POSITION:
     {
         RETURN_NULL_ON_NULL(renderer);
Index: khtml/css/cssvalues.c
===================================================================
--- khtml/css/cssvalues.c	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/cssvalues.c	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -184,7 +184,7 @@
 {
   enum
     {
-      TOTAL_KEYWORDS = 291,
+      TOTAL_KEYWORDS = 292,
       MIN_WORD_LENGTH = 2,
       MAX_WORD_LENGTH = 28,
       MIN_HASH_VALUE = 0,
@@ -199,35 +199,35 @@
       {"900", CSS_VAL_900},
 #line 53 "cssvalues.gperf"
       {"large", CSS_VAL_LARGE},
-#line 273 "cssvalues.gperf"
+#line 74 "cssvalues.gperf"
       {"scroll", CSS_VAL_SCROLL},
 #line 58 "cssvalues.gperf"
       {"larger", CSS_VAL_LARGER},
-#line 89 "cssvalues.gperf"
+#line 92 "cssvalues.gperf"
       {"red", CSS_VAL_RED},
-#line 205 "cssvalues.gperf"
+#line 208 "cssvalues.gperf"
       {"progress", CSS_VAL_PROGRESS},
 #line 47 "cssvalues.gperf"
       {"800", CSS_VAL_800},
-#line 292 "cssvalues.gperf"
+#line 293 "cssvalues.gperf"
       {"slow", CSS_VAL_SLOW},
-#line 207 "cssvalues.gperf"
+#line 210 "cssvalues.gperf"
       {"cell", CSS_VAL_CELL},
-#line 275 "cssvalues.gperf"
+#line 276 "cssvalues.gperf"
       {"show", CSS_VAL_SHOW},
-#line 259 "cssvalues.gperf"
+#line 261 "cssvalues.gperf"
       {"hand", CSS_VAL_HAND},
-#line 203 "cssvalues.gperf"
+#line 206 "cssvalues.gperf"
       {"help", CSS_VAL_HELP},
 #line 46 "cssvalues.gperf"
       {"700", CSS_VAL_700},
-#line 255 "cssvalues.gperf"
+#line 258 "cssvalues.gperf"
       {"crop", CSS_VAL_CROP},
 #line 45 "cssvalues.gperf"
       {"600", CSS_VAL_600},
-#line 263 "cssvalues.gperf"
+#line 265 "cssvalues.gperf"
       {"landscape", CSS_VAL_LANDSCAPE},
-#line 237 "cssvalues.gperf"
+#line 240 "cssvalues.gperf"
       {"collapse", CSS_VAL_COLLAPSE},
 #line 44 "cssvalues.gperf"
       {"500", CSS_VAL_500},
@@ -237,7 +237,7 @@
       {"monospace", CSS_VAL_MONOSPACE},
 #line 51 "cssvalues.gperf"
       {"small", CSS_VAL_SMALL},
-#line 112 "cssvalues.gperf"
+#line 115 "cssvalues.gperf"
       {"scrollbar", CSS_VAL_SCROLLBAR},
 #line 57 "cssvalues.gperf"
       {"smaller", CSS_VAL_SMALLER},
@@ -245,129 +245,131 @@
       {"300", CSS_VAL_300},
 #line 37 "cssvalues.gperf"
       {"bold", CSS_VAL_BOLD},
-#line 300 "cssvalues.gperf"
+#line 301 "cssvalues.gperf"
       {"border", CSS_VAL_BORDER},
 #line 38 "cssvalues.gperf"
       {"bolder", CSS_VAL_BOLDER},
 #line 21 "cssvalues.gperf"
       {"ridge", CSS_VAL_RIDGE},
-#line 129 "cssvalues.gperf"
+#line 132 "cssvalues.gperf"
       {"middle", CSS_VAL_MIDDLE},
-#line 290 "cssvalues.gperf"
+#line 291 "cssvalues.gperf"
       {"up", CSS_VAL_UP},
 #line 28 "cssvalues.gperf"
       {"icon", CSS_VAL_ICON},
-#line 130 "cssvalues.gperf"
+#line 133 "cssvalues.gperf"
       {"sub", CSS_VAL_SUB},
-#line 231 "cssvalues.gperf"
+#line 234 "cssvalues.gperf"
       {"ltr", CSS_VAL_LTR},
-#line 268 "cssvalues.gperf"
+#line 270 "cssvalues.gperf"
       {"marquee", CSS_VAL_MARQUEE},
-#line 88 "cssvalues.gperf"
+#line 91 "cssvalues.gperf"
       {"purple", CSS_VAL_PURPLE},
-#line 232 "cssvalues.gperf"
+#line 235 "cssvalues.gperf"
       {"rtl", CSS_VAL_RTL},
-#line 256 "cssvalues.gperf"
+#line 259 "cssvalues.gperf"
       {"cross", CSS_VAL_CROSS},
-#line 190 "cssvalues.gperf"
+#line 193 "cssvalues.gperf"
       {"table", CSS_VAL_TABLE},
-#line 266 "cssvalues.gperf"
+#line 268 "cssvalues.gperf"
       {"loud", CSS_VAL_LOUD},
 #line 41 "cssvalues.gperf"
       {"200", CSS_VAL_200},
 #line 29 "cssvalues.gperf"
       {"menu", CSS_VAL_MENU},
-#line 140 "cssvalues.gperf"
+#line 143 "cssvalues.gperf"
       {"center", CSS_VAL_CENTER},
-#line 84 "cssvalues.gperf"
+#line 87 "cssvalues.gperf"
       {"maroon", CSS_VAL_MAROON},
-#line 134 "cssvalues.gperf"
+#line 137 "cssvalues.gperf"
       {"top", CSS_VAL_TOP},
-#line 150 "cssvalues.gperf"
+#line 153 "cssvalues.gperf"
       {"box", CSS_VAL_BOX},
 #line 35 "cssvalues.gperf"
       {"small-caps", CSS_VAL_SMALL_CAPS},
-#line 249 "cssvalues.gperf"
+#line 252 "cssvalues.gperf"
       {"always", CSS_VAL_ALWAYS},
-#line 269 "cssvalues.gperf"
+#line 271 "cssvalues.gperf"
       {"mix", CSS_VAL_MIX},
-#line 242 "cssvalues.gperf"
+#line 245 "cssvalues.gperf"
       {"nowrap", CSS_VAL_NOWRAP},
-#line 261 "cssvalues.gperf"
+#line 263 "cssvalues.gperf"
       {"higher", CSS_VAL_HIGHER},
-#line 91 "cssvalues.gperf"
+#line 94 "cssvalues.gperf"
       {"teal", CSS_VAL_TEAL},
-#line 295 "cssvalues.gperf"
+#line 296 "cssvalues.gperf"
       {"slide", CSS_VAL_SLIDE},
-#line 75 "cssvalues.gperf"
+#line 78 "cssvalues.gperf"
       {"aqua", CSS_VAL_AQUA},
-#line 243 "cssvalues.gperf"
+#line 246 "cssvalues.gperf"
       {"pre", CSS_VAL_PRE},
-#line 149 "cssvalues.gperf"
+#line 152 "cssvalues.gperf"
       {"square", CSS_VAL_SQUARE},
-#line 304 "cssvalues.gperf"
+#line 305 "cssvalues.gperf"
       {"nonzero", CSS_VAL_NONZERO},
-#line 298 "cssvalues.gperf"
+#line 299 "cssvalues.gperf"
       {"clip", CSS_VAL_CLIP},
-#line 274 "cssvalues.gperf"
+#line 275 "cssvalues.gperf"
       {"separate", CSS_VAL_SEPARATE},
-#line 200 "cssvalues.gperf"
+#line 203 "cssvalues.gperf"
       {"auto", CSS_VAL_AUTO},
-#line 208 "cssvalues.gperf"
+#line 211 "cssvalues.gperf"
       {"crosshair", CSS_VAL_CROSSHAIR},
 #line 18 "cssvalues.gperf"
       {"hidden", CSS_VAL_HIDDEN},
-#line 211 "cssvalues.gperf"
+#line 214 "cssvalues.gperf"
       {"alias", CSS_VAL_ALIAS},
-#line 267 "cssvalues.gperf"
+#line 269 "cssvalues.gperf"
       {"lower", CSS_VAL_LOWER},
-#line 198 "cssvalues.gperf"
+#line 201 "cssvalues.gperf"
       {"table-cell", CSS_VAL_TABLE_CELL},
-#line 291 "cssvalues.gperf"
+#line 292 "cssvalues.gperf"
       {"down", CSS_VAL_DOWN},
-#line 235 "cssvalues.gperf"
+#line 238 "cssvalues.gperf"
       {"lowercase", CSS_VAL_LOWERCASE},
-#line 254 "cssvalues.gperf"
+#line 76 "cssvalues.gperf"
+      {"local", CSS_VAL_LOCAL},
+#line 257 "cssvalues.gperf"
       {"both", CSS_VAL_BOTH},
-#line 299 "cssvalues.gperf"
+#line 300 "cssvalues.gperf"
       {"ellipsis", CSS_VAL_ELLIPSIS},
-#line 282 "cssvalues.gperf"
+#line 283 "cssvalues.gperf"
       {"border-box", CSS_VAL_BORDER_BOX},
-#line 96 "cssvalues.gperf"
+#line 99 "cssvalues.gperf"
       {"appworkspace", CSS_VAL_APPWORKSPACE},
-#line 148 "cssvalues.gperf"
+#line 151 "cssvalues.gperf"
       {"circle", CSS_VAL_CIRCLE},
-#line 260 "cssvalues.gperf"
+#line 262 "cssvalues.gperf"
       {"hide", CSS_VAL_HIDE},
 #line 36 "cssvalues.gperf"
       {"normal", CSS_VAL_NORMAL},
-#line 139 "cssvalues.gperf"
+#line 142 "cssvalues.gperf"
       {"right", CSS_VAL_RIGHT},
 #line 39 "cssvalues.gperf"
       {"lighter", CSS_VAL_LIGHTER},
 #line 52 "cssvalues.gperf"
       {"medium", CSS_VAL_MEDIUM},
-#line 188 "cssvalues.gperf"
+#line 191 "cssvalues.gperf"
       {"compact", CSS_VAL_COMPACT},
-#line 135 "cssvalues.gperf"
+#line 138 "cssvalues.gperf"
       {"bottom", CSS_VAL_BOTTOM},
-#line 209 "cssvalues.gperf"
+#line 212 "cssvalues.gperf"
       {"text", CSS_VAL_TEXT},
-#line 131 "cssvalues.gperf"
+#line 134 "cssvalues.gperf"
       {"super", CSS_VAL_SUPER},
-#line 278 "cssvalues.gperf"
+#line 279 "cssvalues.gperf"
       {"thin", CSS_VAL_THIN},
-#line 174 "cssvalues.gperf"
+#line 177 "cssvalues.gperf"
       {"lower-alpha", CSS_VAL_LOWER_ALPHA},
-#line 271 "cssvalues.gperf"
+#line 273 "cssvalues.gperf"
       {"portrait", CSS_VAL_PORTRAIT},
-#line 234 "cssvalues.gperf"
+#line 237 "cssvalues.gperf"
       {"uppercase", CSS_VAL_UPPERCASE},
 #line 26 "cssvalues.gperf"
       {"double", CSS_VAL_DOUBLE},
-#line 124 "cssvalues.gperf"
+#line 127 "cssvalues.gperf"
       {"repeat", CSS_VAL_REPEAT},
-#line 204 "cssvalues.gperf"
+#line 207 "cssvalues.gperf"
       {"pointer", CSS_VAL_POINTER},
 #line 33 "cssvalues.gperf"
       {"italic", CSS_VAL_ITALIC},
@@ -377,9 +379,9 @@
       {"none", CSS_VAL_NONE},
 #line 27 "cssvalues.gperf"
       {"caption", CSS_VAL_CAPTION},
-#line 77 "cssvalues.gperf"
+#line 80 "cssvalues.gperf"
       {"blue", CSS_VAL_BLUE},
-#line 276 "cssvalues.gperf"
+#line 277 "cssvalues.gperf"
       {"static", CSS_VAL_STATIC},
 #line 69 "cssvalues.gperf"
       {"serif", CSS_VAL_SERIF},
@@ -389,71 +391,71 @@
       {"solid", CSS_VAL_SOLID},
 #line 34 "cssvalues.gperf"
       {"oblique", CSS_VAL_OBLIQUE},
-#line 284 "cssvalues.gperf"
+#line 285 "cssvalues.gperf"
       {"enabled", CSS_VAL_ENABLED},
-#line 257 "cssvalues.gperf"
+#line 260 "cssvalues.gperf"
       {"embed", CSS_VAL_EMBED},
-#line 272 "cssvalues.gperf"
+#line 274 "cssvalues.gperf"
       {"relative", CSS_VAL_RELATIVE},
 #line 72 "cssvalues.gperf"
       {"fantasy", CSS_VAL_FANTASY},
-#line 83 "cssvalues.gperf"
+#line 86 "cssvalues.gperf"
       {"lime", CSS_VAL_LIME},
-#line 176 "cssvalues.gperf"
+#line 179 "cssvalues.gperf"
       {"upper-alpha", CSS_VAL_UPPER_ALPHA},
-#line 248 "cssvalues.gperf"
+#line 251 "cssvalues.gperf"
       {"absolute", CSS_VAL_ABSOLUTE},
-#line 301 "cssvalues.gperf"
+#line 302 "cssvalues.gperf"
       {"content", CSS_VAL_CONTENT},
-#line 293 "cssvalues.gperf"
+#line 294 "cssvalues.gperf"
       {"fast", CSS_VAL_FAST},
-#line 111 "cssvalues.gperf"
+#line 114 "cssvalues.gperf"
       {"menutext", CSS_VAL_MENUTEXT},
-#line 286 "cssvalues.gperf"
+#line 287 "cssvalues.gperf"
       {"forwards", CSS_VAL_FORWARDS},
-#line 212 "cssvalues.gperf"
+#line 215 "cssvalues.gperf"
       {"copy", CSS_VAL_COPY},
-#line 121 "cssvalues.gperf"
+#line 124 "cssvalues.gperf"
       {"currentcolor", CSS_VAL_CURRENTCOLOR},
-#line 288 "cssvalues.gperf"
+#line 289 "cssvalues.gperf"
       {"ahead", CSS_VAL_AHEAD},
-#line 185 "cssvalues.gperf"
+#line 188 "cssvalues.gperf"
       {"block", CSS_VAL_BLOCK},
-#line 87 "cssvalues.gperf"
+#line 90 "cssvalues.gperf"
       {"orange", CSS_VAL_ORANGE},
 #line 71 "cssvalues.gperf"
       {"cursive", CSS_VAL_CURSIVE},
-#line 138 "cssvalues.gperf"
+#line 141 "cssvalues.gperf"
       {"left", CSS_VAL_LEFT},
-#line 125 "cssvalues.gperf"
+#line 128 "cssvalues.gperf"
       {"repeat-x", CSS_VAL_REPEAT_X},
-#line 253 "cssvalues.gperf"
+#line 256 "cssvalues.gperf"
       {"blink", CSS_VAL_BLINK},
-#line 162 "cssvalues.gperf"
+#line 165 "cssvalues.gperf"
       {"hebrew", CSS_VAL_HEBREW},
 #line 20 "cssvalues.gperf"
       {"groove", CSS_VAL_GROOVE},
-#line 74 "cssvalues.gperf"
+#line 77 "cssvalues.gperf"
       {"transparent", CSS_VAL_TRANSPARENT},
-#line 78 "cssvalues.gperf"
+#line 81 "cssvalues.gperf"
       {"crimson", CSS_VAL_CRIMSON},
 #line 22 "cssvalues.gperf"
       {"outset", CSS_VAL_OUTSET},
-#line 250 "cssvalues.gperf"
+#line 253 "cssvalues.gperf"
       {"avoid", CSS_VAL_AVOID},
-#line 160 "cssvalues.gperf"
+#line 163 "cssvalues.gperf"
       {"lower-roman", CSS_VAL_LOWER_ROMAN},
-#line 76 "cssvalues.gperf"
+#line 79 "cssvalues.gperf"
       {"black", CSS_VAL_BLACK},
-#line 238 "cssvalues.gperf"
+#line 241 "cssvalues.gperf"
       {"close-quote", CSS_VAL_CLOSE_QUOTE},
-#line 247 "cssvalues.gperf"
+#line 250 "cssvalues.gperf"
       {"above", CSS_VAL_ABOVE},
-#line 251 "cssvalues.gperf"
+#line 254 "cssvalues.gperf"
       {"below", CSS_VAL_BELOW},
-#line 197 "cssvalues.gperf"
+#line 200 "cssvalues.gperf"
       {"table-column", CSS_VAL_TABLE_COLUMN},
-#line 126 "cssvalues.gperf"
+#line 129 "cssvalues.gperf"
       {"repeat-y", CSS_VAL_REPEAT_Y},
 #line 70 "cssvalues.gperf"
       {"sans-serif", CSS_VAL_SANS_SERIF},
@@ -461,319 +463,319 @@
       {"x-large", CSS_VAL_X_LARGE},
 #line 31 "cssvalues.gperf"
       {"small-caption", CSS_VAL_SMALL_CAPTION},
-#line 230 "cssvalues.gperf"
+#line 233 "cssvalues.gperf"
       {"all-scroll", CSS_VAL_ALL_SCROLL},
-#line 90 "cssvalues.gperf"
+#line 93 "cssvalues.gperf"
       {"silver", CSS_VAL_SILVER},
-#line 184 "cssvalues.gperf"
+#line 187 "cssvalues.gperf"
       {"inline", CSS_VAL_INLINE},
 #line 32 "cssvalues.gperf"
       {"status-bar", CSS_VAL_STATUS_BAR},
-#line 132 "cssvalues.gperf"
+#line 135 "cssvalues.gperf"
       {"text-top", CSS_VAL_TEXT_TOP},
-#line 270 "cssvalues.gperf"
+#line 272 "cssvalues.gperf"
       {"overline", CSS_VAL_OVERLINE},
-#line 93 "cssvalues.gperf"
+#line 96 "cssvalues.gperf"
       {"yellow", CSS_VAL_YELLOW},
-#line 152 "cssvalues.gperf"
+#line 155 "cssvalues.gperf"
       {"decimal", CSS_VAL_DECIMAL},
-#line 302 "cssvalues.gperf"
+#line 303 "cssvalues.gperf"
       {"padding", CSS_VAL_PADDING},
-#line 296 "cssvalues.gperf"
+#line 297 "cssvalues.gperf"
       {"alternate", CSS_VAL_ALTERNATE},
-#line 236 "cssvalues.gperf"
+#line 239 "cssvalues.gperf"
       {"visible", CSS_VAL_VISIBLE},
-#line 147 "cssvalues.gperf"
+#line 150 "cssvalues.gperf"
       {"disc", CSS_VAL_DISC},
-#line 161 "cssvalues.gperf"
+#line 164 "cssvalues.gperf"
       {"upper-roman", CSS_VAL_UPPER_ROMAN},
 #line 24 "cssvalues.gperf"
       {"dashed", CSS_VAL_DASHED},
 #line 15 "cssvalues.gperf"
       {"initial", CSS_VAL_INITIAL},
-#line 155 "cssvalues.gperf"
+#line 158 "cssvalues.gperf"
       {"-khtml-lao", CSS_VAL__KHTML_LAO},
-#line 128 "cssvalues.gperf"
+#line 131 "cssvalues.gperf"
       {"baseline", CSS_VAL_BASELINE},
-#line 241 "cssvalues.gperf"
+#line 244 "cssvalues.gperf"
       {"open-quote", CSS_VAL_OPEN_QUOTE},
-#line 199 "cssvalues.gperf"
+#line 202 "cssvalues.gperf"
       {"table-caption", CSS_VAL_TABLE_CAPTION},
 #line 60 "cssvalues.gperf"
       {"narrower", CSS_VAL_NARROWER},
-#line 283 "cssvalues.gperf"
+#line 284 "cssvalues.gperf"
       {"content-box", CSS_VAL_CONTENT_BOX},
 #line 66 "cssvalues.gperf"
       {"expanded", CSS_VAL_EXPANDED},
 #line 23 "cssvalues.gperf"
       {"dotted", CSS_VAL_DOTTED},
-#line 178 "cssvalues.gperf"
+#line 181 "cssvalues.gperf"
       {"hiragana", CSS_VAL_HIRAGANA},
-#line 186 "cssvalues.gperf"
+#line 189 "cssvalues.gperf"
       {"list-item", CSS_VAL_LIST_ITEM},
-#line 145 "cssvalues.gperf"
+#line 148 "cssvalues.gperf"
       {"outside", CSS_VAL_OUTSIDE},
-#line 264 "cssvalues.gperf"
+#line 266 "cssvalues.gperf"
       {"level", CSS_VAL_LEVEL},
-#line 102 "cssvalues.gperf"
+#line 105 "cssvalues.gperf"
       {"captiontext", CSS_VAL_CAPTIONTEXT},
-#line 86 "cssvalues.gperf"
+#line 89 "cssvalues.gperf"
       {"olive", CSS_VAL_OLIVE},
-#line 202 "cssvalues.gperf"
+#line 205 "cssvalues.gperf"
       {"context-menu", CSS_VAL_CONTEXT_MENU},
-#line 79 "cssvalues.gperf"
+#line 82 "cssvalues.gperf"
       {"fuchsia", CSS_VAL_FUCHSIA},
-#line 289 "cssvalues.gperf"
+#line 290 "cssvalues.gperf"
       {"reverse", CSS_VAL_REVERSE},
 #line 19 "cssvalues.gperf"
       {"inset", CSS_VAL_INSET},
-#line 213 "cssvalues.gperf"
+#line 216 "cssvalues.gperf"
       {"move", CSS_VAL_MOVE},
 #line 49 "cssvalues.gperf"
       {"xx-small", CSS_VAL_XX_SMALL},
-#line 279 "cssvalues.gperf"
+#line 280 "cssvalues.gperf"
       {"underline", CSS_VAL_UNDERLINE},
-#line 175 "cssvalues.gperf"
+#line 178 "cssvalues.gperf"
       {"lower-latin", CSS_VAL_LOWER_LATIN},
-#line 214 "cssvalues.gperf"
+#line 217 "cssvalues.gperf"
       {"no-drop", CSS_VAL_NO_DROP},
-#line 163 "cssvalues.gperf"
+#line 166 "cssvalues.gperf"
       {"armenian", CSS_VAL_ARMENIAN},
-#line 210 "cssvalues.gperf"
+#line 213 "cssvalues.gperf"
       {"vertical-text", CSS_VAL_VERTICAL_TEXT},
-#line 285 "cssvalues.gperf"
+#line 286 "cssvalues.gperf"
       {"disabled", CSS_VAL_DISABLED},
-#line 277 "cssvalues.gperf"
+#line 278 "cssvalues.gperf"
       {"thick", CSS_VAL_THICK},
-#line 195 "cssvalues.gperf"
+#line 198 "cssvalues.gperf"
       {"table-row", CSS_VAL_TABLE_ROW},
-#line 179 "cssvalues.gperf"
+#line 182 "cssvalues.gperf"
       {"katakana", CSS_VAL_KATAKANA},
 #line 14 "cssvalues.gperf"
       {"inherit", CSS_VAL_INHERIT},
-#line 94 "cssvalues.gperf"
+#line 97 "cssvalues.gperf"
       {"activeborder", CSS_VAL_ACTIVEBORDER},
-#line 297 "cssvalues.gperf"
+#line 298 "cssvalues.gperf"
       {"unfurl", CSS_VAL_UNFURL},
-#line 146 "cssvalues.gperf"
+#line 149 "cssvalues.gperf"
       {"inside", CSS_VAL_INSIDE},
-#line 104 "cssvalues.gperf"
+#line 107 "cssvalues.gperf"
       {"highlight", CSS_VAL_HIGHLIGHT},
-#line 114 "cssvalues.gperf"
+#line 117 "cssvalues.gperf"
       {"threedface", CSS_VAL_THREEDFACE},
 #line 59 "cssvalues.gperf"
       {"wider", CSS_VAL_WIDER},
-#line 206 "cssvalues.gperf"
+#line 209 "cssvalues.gperf"
       {"wait", CSS_VAL_WAIT},
-#line 303 "cssvalues.gperf"
+#line 304 "cssvalues.gperf"
       {"evenodd", CSS_VAL_EVENODD},
-#line 280 "cssvalues.gperf"
+#line 281 "cssvalues.gperf"
       {"-khtml-normal", CSS_VAL__KHTML_NORMAL},
-#line 92 "cssvalues.gperf"
+#line 95 "cssvalues.gperf"
       {"white", CSS_VAL_WHITE},
-#line 258 "cssvalues.gperf"
+#line 75 "cssvalues.gperf"
       {"fixed", CSS_VAL_FIXED},
-#line 98 "cssvalues.gperf"
+#line 101 "cssvalues.gperf"
       {"buttonface", CSS_VAL_BUTTONFACE},
-#line 177 "cssvalues.gperf"
+#line 180 "cssvalues.gperf"
       {"upper-latin", CSS_VAL_UPPER_LATIN},
-#line 220 "cssvalues.gperf"
+#line 223 "cssvalues.gperf"
       {"s-resize", CSS_VAL_S_RESIZE},
-#line 133 "cssvalues.gperf"
+#line 136 "cssvalues.gperf"
       {"text-bottom", CSS_VAL_TEXT_BOTTOM},
-#line 216 "cssvalues.gperf"
+#line 219 "cssvalues.gperf"
       {"e-resize", CSS_VAL_E_RESIZE},
 #line 67 "cssvalues.gperf"
       {"extra-expanded", CSS_VAL_EXTRA_EXPANDED},
-#line 82 "cssvalues.gperf"
+#line 85 "cssvalues.gperf"
       {"indigo", CSS_VAL_INDIGO},
-#line 127 "cssvalues.gperf"
+#line 130 "cssvalues.gperf"
       {"no-repeat", CSS_VAL_NO_REPEAT},
-#line 158 "cssvalues.gperf"
+#line 161 "cssvalues.gperf"
       {"-khtml-thai", CSS_VAL__KHTML_THAI},
-#line 80 "cssvalues.gperf"
+#line 83 "cssvalues.gperf"
       {"gray", CSS_VAL_GRAY},
 #line 30 "cssvalues.gperf"
       {"message-box", CSS_VAL_MESSAGE_BOX},
-#line 156 "cssvalues.gperf"
+#line 159 "cssvalues.gperf"
       {"-khtml-persian", CSS_VAL__KHTML_PERSIAN},
-#line 95 "cssvalues.gperf"
+#line 98 "cssvalues.gperf"
       {"activecaption", CSS_VAL_ACTIVECAPTION},
-#line 233 "cssvalues.gperf"
+#line 236 "cssvalues.gperf"
       {"capitalize", CSS_VAL_CAPITALIZE},
-#line 101 "cssvalues.gperf"
+#line 104 "cssvalues.gperf"
       {"buttontext", CSS_VAL_BUTTONTEXT},
-#line 180 "cssvalues.gperf"
+#line 183 "cssvalues.gperf"
       {"hiragana-iroha", CSS_VAL_HIRAGANA_IROHA},
-#line 191 "cssvalues.gperf"
+#line 194 "cssvalues.gperf"
       {"inline-table", CSS_VAL_INLINE_TABLE},
-#line 201 "cssvalues.gperf"
+#line 204 "cssvalues.gperf"
       {"default", CSS_VAL_DEFAULT},
-#line 137 "cssvalues.gperf"
+#line 140 "cssvalues.gperf"
       {"-khtml-auto", CSS_VAL__KHTML_AUTO},
-#line 110 "cssvalues.gperf"
+#line 113 "cssvalues.gperf"
       {"infotext", CSS_VAL_INFOTEXT},
-#line 187 "cssvalues.gperf"
+#line 190 "cssvalues.gperf"
       {"run-in", CSS_VAL_RUN_IN},
 #line 68 "cssvalues.gperf"
       {"ultra-expanded", CSS_VAL_ULTRA_EXPANDED},
-#line 252 "cssvalues.gperf"
+#line 255 "cssvalues.gperf"
       {"bidi-override", CSS_VAL_BIDI_OVERRIDE},
-#line 123 "cssvalues.gperf"
+#line 126 "cssvalues.gperf"
       {"-khtml-text", CSS_VAL__KHTML_TEXT},
-#line 144 "cssvalues.gperf"
+#line 147 "cssvalues.gperf"
       {"-khtml-center", CSS_VAL__KHTML_CENTER},
-#line 226 "cssvalues.gperf"
+#line 229 "cssvalues.gperf"
       {"nesw-resize", CSS_VAL_NESW_RESIZE},
-#line 81 "cssvalues.gperf"
+#line 84 "cssvalues.gperf"
       {"green", CSS_VAL_GREEN},
-#line 287 "cssvalues.gperf"
+#line 288 "cssvalues.gperf"
       {"backwards", CSS_VAL_BACKWARDS},
-#line 141 "cssvalues.gperf"
+#line 144 "cssvalues.gperf"
       {"justify", CSS_VAL_JUSTIFY},
-#line 172 "cssvalues.gperf"
+#line 175 "cssvalues.gperf"
       {"lower-greek", CSS_VAL_LOWER_GREEK},
-#line 217 "cssvalues.gperf"
+#line 220 "cssvalues.gperf"
       {"n-resize", CSS_VAL_N_RESIZE},
 #line 55 "cssvalues.gperf"
       {"xx-large", CSS_VAL_XX_LARGE},
-#line 142 "cssvalues.gperf"
+#line 145 "cssvalues.gperf"
       {"-khtml-left", CSS_VAL__KHTML_LEFT},
-#line 181 "cssvalues.gperf"
+#line 184 "cssvalues.gperf"
       {"katakana-iroha", CSS_VAL_KATAKANA_IROHA},
-#line 164 "cssvalues.gperf"
+#line 167 "cssvalues.gperf"
       {"georgian", CSS_VAL_GEORGIAN},
 #line 62 "cssvalues.gperf"
       {"extra-condensed", CSS_VAL_EXTRA_CONDENSED},
-#line 245 "cssvalues.gperf"
+#line 248 "cssvalues.gperf"
       {"pre-line", CSS_VAL_PRE_LINE},
-#line 189 "cssvalues.gperf"
+#line 192 "cssvalues.gperf"
       {"inline-block", CSS_VAL_INLINE_BLOCK},
-#line 122 "cssvalues.gperf"
+#line 125 "cssvalues.gperf"
       {"grey", CSS_VAL_GREY},
 #line 65 "cssvalues.gperf"
       {"semi-expanded", CSS_VAL_SEMI_EXPANDED},
-#line 85 "cssvalues.gperf"
+#line 88 "cssvalues.gperf"
       {"navy", CSS_VAL_NAVY},
-#line 183 "cssvalues.gperf"
+#line 186 "cssvalues.gperf"
       {"-khtml-close-quote", CSS_VAL__KHTML_CLOSE_QUOTE},
-#line 221 "cssvalues.gperf"
+#line 224 "cssvalues.gperf"
       {"se-resize", CSS_VAL_SE_RESIZE},
-#line 157 "cssvalues.gperf"
+#line 160 "cssvalues.gperf"
       {"-khtml-urdu", CSS_VAL__KHTML_URDU},
-#line 262 "cssvalues.gperf"
+#line 264 "cssvalues.gperf"
       {"invert", CSS_VAL_INVERT},
 #line 61 "cssvalues.gperf"
       {"ultra-condensed", CSS_VAL_ULTRA_CONDENSED},
-#line 265 "cssvalues.gperf"
+#line 267 "cssvalues.gperf"
       {"line-through", CSS_VAL_LINE_THROUGH},
-#line 105 "cssvalues.gperf"
+#line 108 "cssvalues.gperf"
       {"highlighttext", CSS_VAL_HIGHLIGHTTEXT},
-#line 193 "cssvalues.gperf"
+#line 196 "cssvalues.gperf"
       {"table-header-group", CSS_VAL_TABLE_HEADER_GROUP},
-#line 228 "cssvalues.gperf"
+#line 231 "cssvalues.gperf"
       {"col-resize", CSS_VAL_COL_RESIZE},
-#line 118 "cssvalues.gperf"
+#line 121 "cssvalues.gperf"
       {"window", CSS_VAL_WINDOW},
-#line 229 "cssvalues.gperf"
+#line 232 "cssvalues.gperf"
       {"row-resize", CSS_VAL_ROW_RESIZE},
-#line 97 "cssvalues.gperf"
+#line 100 "cssvalues.gperf"
       {"background", CSS_VAL_BACKGROUND},
 #line 16 "cssvalues.gperf"
       {"-khtml-native", CSS_VAL__KHTML_NATIVE},
-#line 103 "cssvalues.gperf"
+#line 106 "cssvalues.gperf"
       {"graytext", CSS_VAL_GRAYTEXT},
-#line 106 "cssvalues.gperf"
+#line 109 "cssvalues.gperf"
       {"inactiveborder", CSS_VAL_INACTIVEBORDER},
-#line 196 "cssvalues.gperf"
+#line 199 "cssvalues.gperf"
       {"table-column-group", CSS_VAL_TABLE_COLUMN_GROUP},
 #line 56 "cssvalues.gperf"
       {"-khtml-xxx-large", CSS_VAL__KHTML_XXX_LARGE},
-#line 294 "cssvalues.gperf"
+#line 295 "cssvalues.gperf"
       {"infinite", CSS_VAL_INFINITE},
 #line 64 "cssvalues.gperf"
       {"semi-condensed", CSS_VAL_SEMI_CONDENSED},
-#line 182 "cssvalues.gperf"
+#line 185 "cssvalues.gperf"
       {"-khtml-open-quote", CSS_VAL__KHTML_OPEN_QUOTE},
-#line 159 "cssvalues.gperf"
+#line 162 "cssvalues.gperf"
       {"-khtml-tibetan", CSS_VAL__KHTML_TIBETAN},
-#line 225 "cssvalues.gperf"
+#line 228 "cssvalues.gperf"
       {"ns-resize", CSS_VAL_NS_RESIZE},
-#line 218 "cssvalues.gperf"
+#line 221 "cssvalues.gperf"
       {"ne-resize", CSS_VAL_NE_RESIZE},
-#line 143 "cssvalues.gperf"
+#line 146 "cssvalues.gperf"
       {"-khtml-right", CSS_VAL__KHTML_RIGHT},
-#line 244 "cssvalues.gperf"
+#line 247 "cssvalues.gperf"
       {"pre-wrap", CSS_VAL_PRE_WRAP},
-#line 240 "cssvalues.gperf"
+#line 243 "cssvalues.gperf"
       {"no-open-quote", CSS_VAL_NO_OPEN_QUOTE},
-#line 107 "cssvalues.gperf"
+#line 110 "cssvalues.gperf"
       {"inactivecaption", CSS_VAL_INACTIVECAPTION},
-#line 117 "cssvalues.gperf"
+#line 120 "cssvalues.gperf"
       {"threedshadow", CSS_VAL_THREEDSHADOW},
-#line 194 "cssvalues.gperf"
+#line 197 "cssvalues.gperf"
       {"table-footer-group", CSS_VAL_TABLE_FOOTER_GROUP},
-#line 246 "cssvalues.gperf"
+#line 249 "cssvalues.gperf"
       {"-khtml-nowrap", CSS_VAL__KHTML_NOWRAP},
-#line 151 "cssvalues.gperf"
+#line 154 "cssvalues.gperf"
       {"-khtml-diamond", CSS_VAL__KHTML_DIAMOND},
-#line 100 "cssvalues.gperf"
+#line 103 "cssvalues.gperf"
       {"buttonshadow", CSS_VAL_BUTTONSHADOW},
-#line 223 "cssvalues.gperf"
+#line 226 "cssvalues.gperf"
       {"w-resize", CSS_VAL_W_RESIZE},
-#line 166 "cssvalues.gperf"
+#line 169 "cssvalues.gperf"
       {"-khtml-japanese-formal", CSS_VAL__KHTML_JAPANESE_FORMAL},
-#line 239 "cssvalues.gperf"
+#line 242 "cssvalues.gperf"
       {"no-close-quote", CSS_VAL_NO_CLOSE_QUOTE},
-#line 119 "cssvalues.gperf"
+#line 122 "cssvalues.gperf"
       {"windowframe", CSS_VAL_WINDOWFRAME},
-#line 192 "cssvalues.gperf"
+#line 195 "cssvalues.gperf"
       {"table-row-group", CSS_VAL_TABLE_ROW_GROUP},
-#line 120 "cssvalues.gperf"
+#line 123 "cssvalues.gperf"
       {"windowtext", CSS_VAL_WINDOWTEXT},
-#line 168 "cssvalues.gperf"
+#line 171 "cssvalues.gperf"
       {"-khtml-simp-chinese-formal", CSS_VAL__KHTML_SIMP_CHINESE_FORMAL},
-#line 154 "cssvalues.gperf"
+#line 157 "cssvalues.gperf"
       {"-khtml-arabic-indic", CSS_VAL__KHTML_ARABIC_INDIC},
-#line 173 "cssvalues.gperf"
+#line 176 "cssvalues.gperf"
       {"-khtml-upper-greek", CSS_VAL__KHTML_UPPER_GREEK},
-#line 215 "cssvalues.gperf"
+#line 218 "cssvalues.gperf"
       {"not-allowed", CSS_VAL_NOT_ALLOWED},
-#line 136 "cssvalues.gperf"
+#line 139 "cssvalues.gperf"
       {"-khtml-baseline-middle", CSS_VAL__KHTML_BASELINE_MIDDLE},
-#line 222 "cssvalues.gperf"
+#line 225 "cssvalues.gperf"
       {"sw-resize", CSS_VAL_SW_RESIZE},
-#line 224 "cssvalues.gperf"
+#line 227 "cssvalues.gperf"
       {"ew-resize", CSS_VAL_EW_RESIZE},
-#line 165 "cssvalues.gperf"
+#line 168 "cssvalues.gperf"
       {"cjk-ideographic", CSS_VAL_CJK_IDEOGRAPHIC},
-#line 167 "cssvalues.gperf"
+#line 170 "cssvalues.gperf"
       {"-khtml-japanese-informal", CSS_VAL__KHTML_JAPANESE_INFORMAL},
-#line 108 "cssvalues.gperf"
+#line 111 "cssvalues.gperf"
       {"inactivecaptiontext", CSS_VAL_INACTIVECAPTIONTEXT},
-#line 281 "cssvalues.gperf"
+#line 282 "cssvalues.gperf"
       {"-khtml-around-floats", CSS_VAL__KHTML_AROUND_FLOATS},
-#line 227 "cssvalues.gperf"
+#line 230 "cssvalues.gperf"
       {"nwse-resize", CSS_VAL_NWSE_RESIZE},
-#line 115 "cssvalues.gperf"
+#line 118 "cssvalues.gperf"
       {"threedhighlight", CSS_VAL_THREEDHIGHLIGHT},
-#line 99 "cssvalues.gperf"
+#line 102 "cssvalues.gperf"
       {"buttonhighlight", CSS_VAL_BUTTONHIGHLIGHT},
-#line 169 "cssvalues.gperf"
+#line 172 "cssvalues.gperf"
       {"-khtml-simp-chinese-informal", CSS_VAL__KHTML_SIMP_CHINESE_INFORMAL},
-#line 170 "cssvalues.gperf"
+#line 173 "cssvalues.gperf"
       {"-khtml-trad-chinese-formal", CSS_VAL__KHTML_TRAD_CHINESE_FORMAL},
-#line 219 "cssvalues.gperf"
+#line 222 "cssvalues.gperf"
       {"nw-resize", CSS_VAL_NW_RESIZE},
-#line 113 "cssvalues.gperf"
+#line 116 "cssvalues.gperf"
       {"threeddarkshadow", CSS_VAL_THREEDDARKSHADOW},
-#line 109 "cssvalues.gperf"
+#line 112 "cssvalues.gperf"
       {"infobackground", CSS_VAL_INFOBACKGROUND},
-#line 116 "cssvalues.gperf"
+#line 119 "cssvalues.gperf"
       {"threedlightshadow", CSS_VAL_THREEDLIGHTSHADOW},
-#line 171 "cssvalues.gperf"
+#line 174 "cssvalues.gperf"
       {"-khtml-trad-chinese-informal", CSS_VAL__KHTML_TRAD_CHINESE_INFORMAL},
-#line 153 "cssvalues.gperf"
+#line 156 "cssvalues.gperf"
       {"decimal-leading-zero", CSS_VAL_DECIMAL_LEADING_ZERO}
     };
 
@@ -804,139 +806,139 @@
        -1,  -1,  -1,  60,  -1,  -1,  -1,  -1,  61,  -1,
        -1,  -1,  -1,  62,  -1,  -1,  -1,  -1,  63,  -1,
        64,  -1,  -1,  65,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  66,  -1,  -1,  -1,  -1,  -1,  -1,
-       67,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  68,  -1,
-       -1,  -1,  -1,  69,  70,  71,  -1,  -1,  72,  -1,
-       73,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  74,  -1,
-       -1,  -1,  -1,  75,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  76,  -1,  -1,  77,  -1,  -1,  -1,
-       78,  -1,  -1,  79,  -1,  -1,  80,  -1,  -1,  -1,
-       -1,  81,  -1,  -1,  -1,  -1,  82,  -1,  -1,  -1,
-       83,  84,  -1,  85,  -1,  -1,  86,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  87,  -1,
-       88,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  89,  -1,
-       90,  91,  -1,  92,  -1,  -1,  -1,  -1,  -1,  -1,
-       93,  -1,  -1,  94,  -1,  95,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  96,  97,  98,  -1,  -1,  -1,  -1,
-       99,  -1,  -1, 100,  -1,  -1,  -1,  -1, 101,  -1,
-      102,  -1,  -1,  -1, 103, 104,  -1,  -1,  -1,  -1,
-      105,  -1,  -1,  -1,  -1, 106, 107,  -1, 108,  -1,
-       -1, 109,  -1,  -1,  -1, 110,  -1,  -1, 111,  -1,
-      112,  -1,  -1,  -1,  -1, 113,  -1,  -1, 114,  -1,
-      115,  -1,  -1,  -1, 116,  -1,  -1,  -1, 117,  -1,
-       -1, 118,  -1,  -1,  -1,  -1,  -1,  -1, 119,  -1,
-      120,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 121,  -1, 122, 123,  -1,  -1,  -1,
-       -1,  -1,  -1, 124,  -1, 125, 126,  -1, 127,  -1,
-       -1,  -1,  -1, 128,  -1, 129,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 130, 131,  -1,  -1, 132,  -1,
-      133,  -1,  -1,  -1,  -1, 134,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 135,  -1,  -1,  -1,  -1, 136,  -1,
-      137,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 138,  -1,
-       -1,  -1,  -1, 139,  -1,  -1, 140,  -1, 141,  -1,
-      142,  -1,  -1,  -1,  -1, 143, 144,  -1,  -1,  -1,
-      145, 146,  -1,  -1,  -1, 147,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 148,  -1, 149,  -1,  -1,  -1,  -1,
-      150, 151,  -1,  -1,  -1, 152,  -1,  -1, 153,  -1,
-       -1,  -1,  -1, 154, 155, 156,  -1,  -1, 157,  -1,
-      158,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 159,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 160,  -1,  -1,  -1,  -1,  -1, 161,
-       -1, 162,  -1, 163,  -1, 164,  -1,  -1, 165,  -1,
-      166,  -1,  -1, 167,  -1,  -1, 168,  -1,  -1,  -1,
-      169,  -1,  -1, 170,  -1, 171,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 172,  -1,  -1,  -1,  -1,
-       -1, 173,  -1,  -1,  -1, 174, 175,  -1, 176,  -1,
-      177,  -1,  -1,  -1,  -1, 178, 179,  -1, 180,  -1,
-       -1,  -1,  -1, 181,  -1,  -1,  -1,  -1,  -1, 182,
-       -1,  -1,  -1, 183,  -1,  -1,  -1,  -1, 184,  -1,
-       -1, 185,  -1, 186,  -1, 187,  -1,  -1,  -1, 188,
-       -1,  -1,  -1, 189,  -1, 190,  -1,  -1,  -1,  -1,
-       -1, 191,  -1,  -1,  -1, 192,  -1,  -1, 193,  -1,
-      194, 195,  -1, 196,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 197,  -1,  -1, 198,  -1,
-       -1,  -1,  -1,  -1,  -1, 199,  -1,  -1, 200,  -1,
-       -1,  -1,  -1,  -1,  -1, 201, 202,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 203,  -1,  -1,  -1, 204,  -1,
-       -1, 205,  -1, 206,  -1, 207,  -1,  -1,  -1,  -1,
-      208,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 209,  -1,
-       -1,  -1,  -1,  -1,  -1, 210,  -1,  -1, 211,  -1,
-       -1, 212,  -1, 213,  -1,  -1,  -1,  -1,  -1,  -1,
-      214,  -1,  -1, 215,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 216,  -1,  -1, 217,  -1,
+       -1,  -1,  -1,  66,  -1,  67,  -1,  -1,  -1,  -1,
+       68,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  69,  -1,
+       -1,  -1,  -1,  70,  71,  72,  -1,  -1,  73,  -1,
+       74,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  75,  -1,
+       -1,  -1,  -1,  76,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  77,  -1,  -1,  78,  -1,  -1,  -1,
+       79,  -1,  -1,  80,  -1,  -1,  81,  -1,  -1,  -1,
+       -1,  82,  -1,  -1,  -1,  -1,  83,  -1,  -1,  -1,
+       84,  85,  -1,  86,  -1,  -1,  87,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  88,  -1,
+       89,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  90,  -1,
+       91,  92,  -1,  93,  -1,  -1,  -1,  -1,  -1,  -1,
+       94,  -1,  -1,  95,  -1,  96,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  97,  98,  99,  -1,  -1,  -1,  -1,
+      100,  -1,  -1, 101,  -1,  -1,  -1,  -1, 102,  -1,
+      103,  -1,  -1,  -1, 104, 105,  -1,  -1,  -1,  -1,
+      106,  -1,  -1,  -1,  -1, 107, 108,  -1, 109,  -1,
+       -1, 110,  -1,  -1,  -1, 111,  -1,  -1, 112,  -1,
+      113,  -1,  -1,  -1,  -1, 114,  -1,  -1, 115,  -1,
+      116,  -1,  -1,  -1, 117,  -1,  -1,  -1, 118,  -1,
+       -1, 119,  -1,  -1,  -1,  -1,  -1,  -1, 120,  -1,
+      121,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 122,  -1, 123, 124,  -1,  -1,  -1,
+       -1,  -1,  -1, 125,  -1, 126, 127,  -1, 128,  -1,
+       -1,  -1,  -1, 129,  -1, 130,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 131, 132,  -1,  -1, 133,  -1,
+      134,  -1,  -1,  -1,  -1, 135,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 136,  -1,  -1,  -1,  -1, 137,  -1,
+      138,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 139,  -1,
+       -1,  -1,  -1, 140,  -1,  -1, 141,  -1, 142,  -1,
+      143,  -1,  -1,  -1,  -1, 144, 145,  -1,  -1,  -1,
+      146, 147,  -1,  -1,  -1, 148,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 149,  -1, 150,  -1,  -1,  -1,  -1,
+      151, 152,  -1,  -1,  -1, 153,  -1,  -1, 154,  -1,
+       -1,  -1,  -1, 155, 156, 157,  -1,  -1, 158,  -1,
+      159,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 160,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 161,  -1,  -1,  -1,  -1,  -1, 162,
+       -1, 163,  -1, 164,  -1, 165,  -1,  -1, 166,  -1,
+      167,  -1,  -1, 168,  -1,  -1, 169,  -1,  -1,  -1,
+      170,  -1,  -1, 171,  -1, 172,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 173,  -1,  -1,  -1,  -1,
+       -1, 174,  -1,  -1,  -1, 175, 176,  -1, 177,  -1,
+      178,  -1,  -1,  -1,  -1, 179, 180,  -1, 181,  -1,
+       -1,  -1,  -1, 182,  -1,  -1,  -1,  -1,  -1, 183,
+       -1,  -1,  -1, 184,  -1,  -1,  -1,  -1, 185,  -1,
+       -1, 186,  -1, 187,  -1, 188,  -1,  -1,  -1, 189,
+       -1,  -1,  -1, 190,  -1, 191,  -1,  -1,  -1,  -1,
+       -1, 192,  -1,  -1,  -1, 193,  -1,  -1, 194,  -1,
+      195, 196,  -1, 197,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 198,  -1,  -1, 199,  -1,
+       -1,  -1,  -1,  -1,  -1, 200,  -1,  -1, 201,  -1,
+       -1,  -1,  -1,  -1,  -1, 202, 203,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 204,  -1,  -1,  -1, 205,  -1,
+       -1, 206,  -1, 207,  -1, 208,  -1,  -1,  -1,  -1,
+      209,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 210,  -1,
+       -1,  -1,  -1,  -1,  -1, 211,  -1,  -1, 212,  -1,
+       -1, 213,  -1, 214,  -1,  -1,  -1,  -1,  -1,  -1,
+      215,  -1,  -1, 216,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 217,  -1,  -1, 218,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1, 218,  -1, 219,  -1, 220, 221,  -1,  -1,  -1,
-      222,  -1,  -1, 223,  -1, 224,  -1,  -1, 225,  -1,
-       -1,  -1,  -1,  -1,  -1, 226,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 227,  -1,  -1,  -1,  -1,  -1,  -1,
-      228,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1, 219,  -1, 220,  -1, 221, 222,  -1,  -1,  -1,
+      223,  -1,  -1, 224,  -1, 225,  -1,  -1, 226,  -1,
+       -1,  -1,  -1,  -1,  -1, 227,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 228,  -1,  -1,  -1,  -1,  -1,  -1,
+      229,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1, 229,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 230,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1, 231,  -1,  -1,  -1, 232,  -1,  -1,  -1,  -1,
-      233,  -1,  -1, 234,  -1, 235,  -1,  -1,  -1,  -1,
-       -1, 236,  -1,  -1,  -1,  -1,  -1, 237, 238,  -1,
+       -1, 230,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 231,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1, 232,  -1,  -1,  -1, 233,  -1,  -1,  -1,  -1,
+      234,  -1,  -1, 235,  -1, 236,  -1,  -1,  -1,  -1,
+       -1, 237,  -1,  -1,  -1,  -1,  -1, 238, 239,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      239, 240,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 241,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 242,  -1,  -1, 243,  -1,
+      240, 241,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 242,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 243,  -1,  -1, 244,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 244,  -1,  -1,  -1,  -1, 245,  -1,
-      246,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 247,
-       -1,  -1,  -1, 248,  -1,  -1,  -1,  -1, 249,  -1,
-       -1, 250,  -1,  -1,  -1, 251,  -1,  -1,  -1,  -1,
-      252,  -1,  -1,  -1,  -1, 253,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 245,  -1,  -1,  -1,  -1, 246,  -1,
+      247,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 248,
+       -1,  -1,  -1, 249,  -1,  -1,  -1,  -1, 250,  -1,
+       -1, 251,  -1,  -1,  -1, 252,  -1,  -1,  -1,  -1,
+      253,  -1,  -1,  -1,  -1, 254,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 254,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1, 255,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1, 256,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 257, 258,
-      259,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 260,  -1,
+       -1,  -1,  -1, 256,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1, 257,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 258, 259,
+      260,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 261,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      261, 262,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 263,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 264,  -1,
-       -1, 265,  -1,  -1,  -1,  -1, 266,  -1,  -1,  -1,
+      262, 263,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 264,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 265,  -1,
+       -1, 266,  -1,  -1,  -1,  -1, 267,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 267,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 268,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 268,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 269,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 269,  -1,  -1,  -1,  -1,  -1,  -1,
-      270,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 270,  -1,  -1,  -1,  -1,  -1,  -1,
+      271,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 271,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 272,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 272,  -1, 273,  -1,  -1, 274,  -1,
-       -1,  -1,  -1, 275,  -1,  -1, 276,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 277,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1, 278,  -1,  -1,  -1,
+       -1,  -1,  -1, 273,  -1, 274,  -1,  -1, 275,  -1,
+       -1,  -1,  -1, 276,  -1,  -1, 277,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 278,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1, 279,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      279,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 280,  -1,  -1,  -1,  -1,  -1,  -1,
+      280,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 281,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1, 281,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1, 282,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 282,
-       -1,  -1,  -1, 283,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 283,
        -1,  -1,  -1, 284,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 285,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 286,
+       -1,  -1,  -1, 285,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 286,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 287,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      287,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      288,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
@@ -945,10 +947,10 @@
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1, 288,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1, 289,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 289,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 290,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
@@ -963,7 +965,7 @@
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 290
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 291
     };
 
   if (len <= MAX_WORD_LENGTH && len >= MIN_WORD_LENGTH)
@@ -985,7 +987,7 @@
     }
   return 0;
 }
-#line 305 "cssvalues.gperf"
+#line 306 "cssvalues.gperf"
 
 static const char * const valueList[] = {
 "",
@@ -1049,6 +1051,9 @@
 "cursive", 
 "fantasy", 
 "monospace", 
+"scroll", 
+"fixed", 
+"local", 
 "transparent", 
 "aqua", 
 "black", 
@@ -1233,7 +1238,6 @@
 "crop", 
 "cross", 
 "embed", 
-"fixed", 
 "hand", 
 "hide", 
 "higher", 
@@ -1248,7 +1252,6 @@
 "overline", 
 "portrait", 
 "relative", 
-"scroll", 
 "separate", 
 "show", 
 "static", 
Index: khtml/css/cssparser.h
===================================================================
--- khtml/css/cssparser.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/cssparser.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -28,6 +28,7 @@
 #include <dom/dom_string.h>
 #include <misc/htmlnames.h>
 #include <wtf/Vector.h>
+#include <xml/dom_docimpl.h>
 
 namespace khtml {
     class MediaQuery;
@@ -113,11 +114,16 @@
 
 	static CSSParser *current() { return currentParser; }
 
-        unsigned int getLocalNameId(const DOMString& str) {
-            LocalName localname = LocalName::fromString(str);
-            boundLocalNames.append(localname);
-            return localname.id();
-        }
+    unsigned int getLocalNameId(const DOMString& str) {
+        LocalName localname;
+        DOM::DocumentImpl *doc = document();
+        if (doc && doc->isHTMLDocument())
+            localname = LocalName::fromString(str, khtml::IDS_NormalizeLower);
+        else
+            localname = LocalName::fromString(str);
+        boundLocalNames.append(localname);
+        return localname.id();
+    }
 
 	DOM::DocumentImpl *document() const;
 
Index: khtml/css/cssstyleselector.cpp
===================================================================
--- khtml/css/cssstyleselector.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/cssstyleselector.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1689,7 +1689,7 @@
                 addDependency(OtherStateDependency, e);
                 HTMLGenericFormElementImpl *form;
                 form = static_cast<HTMLGenericFormElementImpl*>(e);
-                return !form->disabled();
+                return !form->disabled() && !form->isHiddenInput();
             }
             break;
         }
@@ -1698,7 +1698,7 @@
                 addDependency(OtherStateDependency, e);
                 HTMLGenericFormElementImpl *form;
                 form = static_cast<HTMLGenericFormElementImpl*>(e);
-                return form->disabled();
+                return form->disabled() && !form->isHiddenInput();
             }
             break;
         }
@@ -4154,11 +4154,14 @@
     if (!value->isPrimitiveValue()) return;
     CSSPrimitiveValueImpl* primitiveValue = static_cast<CSSPrimitiveValueImpl*>(value);
     switch (primitiveValue->getIdent()) {
+        case CSS_VAL_SCROLL:
+            layer->setBackgroundAttachment(BGASCROLL);
+            break;
         case CSS_VAL_FIXED:
-            layer->setBackgroundAttachment(false);
+            layer->setBackgroundAttachment(BGAFIXED);
             break;
-        case CSS_VAL_SCROLL:
-            layer->setBackgroundAttachment(true);
+        case CSS_VAL_LOCAL:
+            layer->setBackgroundAttachment(BGALOCAL);
             break;
         default:
             return;
Index: khtml/css/cssvalues.h
===================================================================
--- khtml/css/cssvalues.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/css/cssvalues.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -68,238 +68,239 @@
 #define CSS_VAL_CURSIVE 58
 #define CSS_VAL_FANTASY 59
 #define CSS_VAL_MONOSPACE 60
-#define CSS_VAL_TRANSPARENT 61
-#define CSS_VAL_AQUA 62
-#define CSS_VAL_BLACK 63
-#define CSS_VAL_BLUE 64
-#define CSS_VAL_CRIMSON 65
-#define CSS_VAL_FUCHSIA 66
-#define CSS_VAL_GRAY 67
-#define CSS_VAL_GREEN 68
-#define CSS_VAL_INDIGO 69
-#define CSS_VAL_LIME 70
-#define CSS_VAL_MAROON 71
-#define CSS_VAL_NAVY 72
-#define CSS_VAL_OLIVE 73
-#define CSS_VAL_ORANGE 74
-#define CSS_VAL_PURPLE 75
-#define CSS_VAL_RED 76
-#define CSS_VAL_SILVER 77
-#define CSS_VAL_TEAL 78
-#define CSS_VAL_WHITE 79
-#define CSS_VAL_YELLOW 80
-#define CSS_VAL_ACTIVEBORDER 81
-#define CSS_VAL_ACTIVECAPTION 82
-#define CSS_VAL_APPWORKSPACE 83
-#define CSS_VAL_BACKGROUND 84
-#define CSS_VAL_BUTTONFACE 85
-#define CSS_VAL_BUTTONHIGHLIGHT 86
-#define CSS_VAL_BUTTONSHADOW 87
-#define CSS_VAL_BUTTONTEXT 88
-#define CSS_VAL_CAPTIONTEXT 89
-#define CSS_VAL_GRAYTEXT 90
-#define CSS_VAL_HIGHLIGHT 91
-#define CSS_VAL_HIGHLIGHTTEXT 92
-#define CSS_VAL_INACTIVEBORDER 93
-#define CSS_VAL_INACTIVECAPTION 94
-#define CSS_VAL_INACTIVECAPTIONTEXT 95
-#define CSS_VAL_INFOBACKGROUND 96
-#define CSS_VAL_INFOTEXT 97
-#define CSS_VAL_MENUTEXT 98
-#define CSS_VAL_SCROLLBAR 99
-#define CSS_VAL_THREEDDARKSHADOW 100
-#define CSS_VAL_THREEDFACE 101
-#define CSS_VAL_THREEDHIGHLIGHT 102
-#define CSS_VAL_THREEDLIGHTSHADOW 103
-#define CSS_VAL_THREEDSHADOW 104
-#define CSS_VAL_WINDOW 105
-#define CSS_VAL_WINDOWFRAME 106
-#define CSS_VAL_WINDOWTEXT 107
-#define CSS_VAL_CURRENTCOLOR 108
-#define CSS_VAL_GREY 109
-#define CSS_VAL__KHTML_TEXT 110
-#define CSS_VAL_REPEAT 111
-#define CSS_VAL_REPEAT_X 112
-#define CSS_VAL_REPEAT_Y 113
-#define CSS_VAL_NO_REPEAT 114
-#define CSS_VAL_BASELINE 115
-#define CSS_VAL_MIDDLE 116
-#define CSS_VAL_SUB 117
-#define CSS_VAL_SUPER 118
-#define CSS_VAL_TEXT_TOP 119
-#define CSS_VAL_TEXT_BOTTOM 120
-#define CSS_VAL_TOP 121
-#define CSS_VAL_BOTTOM 122
-#define CSS_VAL__KHTML_BASELINE_MIDDLE 123
-#define CSS_VAL__KHTML_AUTO 124
-#define CSS_VAL_LEFT 125
-#define CSS_VAL_RIGHT 126
-#define CSS_VAL_CENTER 127
-#define CSS_VAL_JUSTIFY 128
-#define CSS_VAL__KHTML_LEFT 129
-#define CSS_VAL__KHTML_RIGHT 130
-#define CSS_VAL__KHTML_CENTER 131
-#define CSS_VAL_OUTSIDE 132
-#define CSS_VAL_INSIDE 133
-#define CSS_VAL_DISC 134
-#define CSS_VAL_CIRCLE 135
-#define CSS_VAL_SQUARE 136
-#define CSS_VAL_BOX 137
-#define CSS_VAL__KHTML_DIAMOND 138
-#define CSS_VAL_DECIMAL 139
-#define CSS_VAL_DECIMAL_LEADING_ZERO 140
-#define CSS_VAL__KHTML_ARABIC_INDIC 141
-#define CSS_VAL__KHTML_LAO 142
-#define CSS_VAL__KHTML_PERSIAN 143
-#define CSS_VAL__KHTML_URDU 144
-#define CSS_VAL__KHTML_THAI 145
-#define CSS_VAL__KHTML_TIBETAN 146
-#define CSS_VAL_LOWER_ROMAN 147
-#define CSS_VAL_UPPER_ROMAN 148
-#define CSS_VAL_HEBREW 149
-#define CSS_VAL_ARMENIAN 150
-#define CSS_VAL_GEORGIAN 151
-#define CSS_VAL_CJK_IDEOGRAPHIC 152
-#define CSS_VAL__KHTML_JAPANESE_FORMAL 153
-#define CSS_VAL__KHTML_JAPANESE_INFORMAL 154
-#define CSS_VAL__KHTML_SIMP_CHINESE_FORMAL 155
-#define CSS_VAL__KHTML_SIMP_CHINESE_INFORMAL 156
-#define CSS_VAL__KHTML_TRAD_CHINESE_FORMAL 157
-#define CSS_VAL__KHTML_TRAD_CHINESE_INFORMAL 158
-#define CSS_VAL_LOWER_GREEK 159
-#define CSS_VAL__KHTML_UPPER_GREEK 160
-#define CSS_VAL_LOWER_ALPHA 161
-#define CSS_VAL_LOWER_LATIN 162
-#define CSS_VAL_UPPER_ALPHA 163
-#define CSS_VAL_UPPER_LATIN 164
-#define CSS_VAL_HIRAGANA 165
-#define CSS_VAL_KATAKANA 166
-#define CSS_VAL_HIRAGANA_IROHA 167
-#define CSS_VAL_KATAKANA_IROHA 168
-#define CSS_VAL__KHTML_OPEN_QUOTE 169
-#define CSS_VAL__KHTML_CLOSE_QUOTE 170
-#define CSS_VAL_INLINE 171
-#define CSS_VAL_BLOCK 172
-#define CSS_VAL_LIST_ITEM 173
-#define CSS_VAL_RUN_IN 174
-#define CSS_VAL_COMPACT 175
-#define CSS_VAL_INLINE_BLOCK 176
-#define CSS_VAL_TABLE 177
-#define CSS_VAL_INLINE_TABLE 178
-#define CSS_VAL_TABLE_ROW_GROUP 179
-#define CSS_VAL_TABLE_HEADER_GROUP 180
-#define CSS_VAL_TABLE_FOOTER_GROUP 181
-#define CSS_VAL_TABLE_ROW 182
-#define CSS_VAL_TABLE_COLUMN_GROUP 183
-#define CSS_VAL_TABLE_COLUMN 184
-#define CSS_VAL_TABLE_CELL 185
-#define CSS_VAL_TABLE_CAPTION 186
-#define CSS_VAL_AUTO 187
-#define CSS_VAL_DEFAULT 188
-#define CSS_VAL_CONTEXT_MENU 189
-#define CSS_VAL_HELP 190
-#define CSS_VAL_POINTER 191
-#define CSS_VAL_PROGRESS 192
-#define CSS_VAL_WAIT 193
-#define CSS_VAL_CELL 194
-#define CSS_VAL_CROSSHAIR 195
-#define CSS_VAL_TEXT 196
-#define CSS_VAL_VERTICAL_TEXT 197
-#define CSS_VAL_ALIAS 198
-#define CSS_VAL_COPY 199
-#define CSS_VAL_MOVE 200
-#define CSS_VAL_NO_DROP 201
-#define CSS_VAL_NOT_ALLOWED 202
-#define CSS_VAL_E_RESIZE 203
-#define CSS_VAL_N_RESIZE 204
-#define CSS_VAL_NE_RESIZE 205
-#define CSS_VAL_NW_RESIZE 206
-#define CSS_VAL_S_RESIZE 207
-#define CSS_VAL_SE_RESIZE 208
-#define CSS_VAL_SW_RESIZE 209
-#define CSS_VAL_W_RESIZE 210
-#define CSS_VAL_EW_RESIZE 211
-#define CSS_VAL_NS_RESIZE 212
-#define CSS_VAL_NESW_RESIZE 213
-#define CSS_VAL_NWSE_RESIZE 214
-#define CSS_VAL_COL_RESIZE 215
-#define CSS_VAL_ROW_RESIZE 216
-#define CSS_VAL_ALL_SCROLL 217
-#define CSS_VAL_LTR 218
-#define CSS_VAL_RTL 219
-#define CSS_VAL_CAPITALIZE 220
-#define CSS_VAL_UPPERCASE 221
-#define CSS_VAL_LOWERCASE 222
-#define CSS_VAL_VISIBLE 223
-#define CSS_VAL_COLLAPSE 224
-#define CSS_VAL_CLOSE_QUOTE 225
-#define CSS_VAL_NO_CLOSE_QUOTE 226
-#define CSS_VAL_NO_OPEN_QUOTE 227
-#define CSS_VAL_OPEN_QUOTE 228
-#define CSS_VAL_NOWRAP 229
-#define CSS_VAL_PRE 230
-#define CSS_VAL_PRE_WRAP 231
-#define CSS_VAL_PRE_LINE 232
-#define CSS_VAL__KHTML_NOWRAP 233
-#define CSS_VAL_ABOVE 234
-#define CSS_VAL_ABSOLUTE 235
-#define CSS_VAL_ALWAYS 236
-#define CSS_VAL_AVOID 237
-#define CSS_VAL_BELOW 238
-#define CSS_VAL_BIDI_OVERRIDE 239
-#define CSS_VAL_BLINK 240
-#define CSS_VAL_BOTH 241
-#define CSS_VAL_CROP 242
-#define CSS_VAL_CROSS 243
-#define CSS_VAL_EMBED 244
-#define CSS_VAL_FIXED 245
-#define CSS_VAL_HAND 246
-#define CSS_VAL_HIDE 247
-#define CSS_VAL_HIGHER 248
-#define CSS_VAL_INVERT 249
-#define CSS_VAL_LANDSCAPE 250
-#define CSS_VAL_LEVEL 251
-#define CSS_VAL_LINE_THROUGH 252
-#define CSS_VAL_LOUD 253
-#define CSS_VAL_LOWER 254
-#define CSS_VAL_MARQUEE 255
-#define CSS_VAL_MIX 256
-#define CSS_VAL_OVERLINE 257
-#define CSS_VAL_PORTRAIT 258
-#define CSS_VAL_RELATIVE 259
-#define CSS_VAL_SCROLL 260
-#define CSS_VAL_SEPARATE 261
-#define CSS_VAL_SHOW 262
-#define CSS_VAL_STATIC 263
-#define CSS_VAL_THICK 264
-#define CSS_VAL_THIN 265
-#define CSS_VAL_UNDERLINE 266
-#define CSS_VAL__KHTML_NORMAL 267
-#define CSS_VAL__KHTML_AROUND_FLOATS 268
-#define CSS_VAL_BORDER_BOX 269
-#define CSS_VAL_CONTENT_BOX 270
-#define CSS_VAL_ENABLED 271
-#define CSS_VAL_DISABLED 272
-#define CSS_VAL_FORWARDS 273
-#define CSS_VAL_BACKWARDS 274
-#define CSS_VAL_AHEAD 275
-#define CSS_VAL_REVERSE 276
-#define CSS_VAL_UP 277
-#define CSS_VAL_DOWN 278
-#define CSS_VAL_SLOW 279
-#define CSS_VAL_FAST 280
-#define CSS_VAL_INFINITE 281
-#define CSS_VAL_SLIDE 282
-#define CSS_VAL_ALTERNATE 283
-#define CSS_VAL_UNFURL 284
-#define CSS_VAL_CLIP 285
-#define CSS_VAL_ELLIPSIS 286
-#define CSS_VAL_BORDER 287
-#define CSS_VAL_CONTENT 288
-#define CSS_VAL_PADDING 289
-#define CSS_VAL_EVENODD 290
-#define CSS_VAL_NONZERO 291
+#define CSS_VAL_SCROLL 61
+#define CSS_VAL_FIXED 62
+#define CSS_VAL_LOCAL 63
+#define CSS_VAL_TRANSPARENT 64
+#define CSS_VAL_AQUA 65
+#define CSS_VAL_BLACK 66
+#define CSS_VAL_BLUE 67
+#define CSS_VAL_CRIMSON 68
+#define CSS_VAL_FUCHSIA 69
+#define CSS_VAL_GRAY 70
+#define CSS_VAL_GREEN 71
+#define CSS_VAL_INDIGO 72
+#define CSS_VAL_LIME 73
+#define CSS_VAL_MAROON 74
+#define CSS_VAL_NAVY 75
+#define CSS_VAL_OLIVE 76
+#define CSS_VAL_ORANGE 77
+#define CSS_VAL_PURPLE 78
+#define CSS_VAL_RED 79
+#define CSS_VAL_SILVER 80
+#define CSS_VAL_TEAL 81
+#define CSS_VAL_WHITE 82
+#define CSS_VAL_YELLOW 83
+#define CSS_VAL_ACTIVEBORDER 84
+#define CSS_VAL_ACTIVECAPTION 85
+#define CSS_VAL_APPWORKSPACE 86
+#define CSS_VAL_BACKGROUND 87
+#define CSS_VAL_BUTTONFACE 88
+#define CSS_VAL_BUTTONHIGHLIGHT 89
+#define CSS_VAL_BUTTONSHADOW 90
+#define CSS_VAL_BUTTONTEXT 91
+#define CSS_VAL_CAPTIONTEXT 92
+#define CSS_VAL_GRAYTEXT 93
+#define CSS_VAL_HIGHLIGHT 94
+#define CSS_VAL_HIGHLIGHTTEXT 95
+#define CSS_VAL_INACTIVEBORDER 96
+#define CSS_VAL_INACTIVECAPTION 97
+#define CSS_VAL_INACTIVECAPTIONTEXT 98
+#define CSS_VAL_INFOBACKGROUND 99
+#define CSS_VAL_INFOTEXT 100
+#define CSS_VAL_MENUTEXT 101
+#define CSS_VAL_SCROLLBAR 102
+#define CSS_VAL_THREEDDARKSHADOW 103
+#define CSS_VAL_THREEDFACE 104
+#define CSS_VAL_THREEDHIGHLIGHT 105
+#define CSS_VAL_THREEDLIGHTSHADOW 106
+#define CSS_VAL_THREEDSHADOW 107
+#define CSS_VAL_WINDOW 108
+#define CSS_VAL_WINDOWFRAME 109
+#define CSS_VAL_WINDOWTEXT 110
+#define CSS_VAL_CURRENTCOLOR 111
+#define CSS_VAL_GREY 112
+#define CSS_VAL__KHTML_TEXT 113
+#define CSS_VAL_REPEAT 114
+#define CSS_VAL_REPEAT_X 115
+#define CSS_VAL_REPEAT_Y 116
+#define CSS_VAL_NO_REPEAT 117
+#define CSS_VAL_BASELINE 118
+#define CSS_VAL_MIDDLE 119
+#define CSS_VAL_SUB 120
+#define CSS_VAL_SUPER 121
+#define CSS_VAL_TEXT_TOP 122
+#define CSS_VAL_TEXT_BOTTOM 123
+#define CSS_VAL_TOP 124
+#define CSS_VAL_BOTTOM 125
+#define CSS_VAL__KHTML_BASELINE_MIDDLE 126
+#define CSS_VAL__KHTML_AUTO 127
+#define CSS_VAL_LEFT 128
+#define CSS_VAL_RIGHT 129
+#define CSS_VAL_CENTER 130
+#define CSS_VAL_JUSTIFY 131
+#define CSS_VAL__KHTML_LEFT 132
+#define CSS_VAL__KHTML_RIGHT 133
+#define CSS_VAL__KHTML_CENTER 134
+#define CSS_VAL_OUTSIDE 135
+#define CSS_VAL_INSIDE 136
+#define CSS_VAL_DISC 137
+#define CSS_VAL_CIRCLE 138
+#define CSS_VAL_SQUARE 139
+#define CSS_VAL_BOX 140
+#define CSS_VAL__KHTML_DIAMOND 141
+#define CSS_VAL_DECIMAL 142
+#define CSS_VAL_DECIMAL_LEADING_ZERO 143
+#define CSS_VAL__KHTML_ARABIC_INDIC 144
+#define CSS_VAL__KHTML_LAO 145
+#define CSS_VAL__KHTML_PERSIAN 146
+#define CSS_VAL__KHTML_URDU 147
+#define CSS_VAL__KHTML_THAI 148
+#define CSS_VAL__KHTML_TIBETAN 149
+#define CSS_VAL_LOWER_ROMAN 150
+#define CSS_VAL_UPPER_ROMAN 151
+#define CSS_VAL_HEBREW 152
+#define CSS_VAL_ARMENIAN 153
+#define CSS_VAL_GEORGIAN 154
+#define CSS_VAL_CJK_IDEOGRAPHIC 155
+#define CSS_VAL__KHTML_JAPANESE_FORMAL 156
+#define CSS_VAL__KHTML_JAPANESE_INFORMAL 157
+#define CSS_VAL__KHTML_SIMP_CHINESE_FORMAL 158
+#define CSS_VAL__KHTML_SIMP_CHINESE_INFORMAL 159
+#define CSS_VAL__KHTML_TRAD_CHINESE_FORMAL 160
+#define CSS_VAL__KHTML_TRAD_CHINESE_INFORMAL 161
+#define CSS_VAL_LOWER_GREEK 162
+#define CSS_VAL__KHTML_UPPER_GREEK 163
+#define CSS_VAL_LOWER_ALPHA 164
+#define CSS_VAL_LOWER_LATIN 165
+#define CSS_VAL_UPPER_ALPHA 166
+#define CSS_VAL_UPPER_LATIN 167
+#define CSS_VAL_HIRAGANA 168
+#define CSS_VAL_KATAKANA 169
+#define CSS_VAL_HIRAGANA_IROHA 170
+#define CSS_VAL_KATAKANA_IROHA 171
+#define CSS_VAL__KHTML_OPEN_QUOTE 172
+#define CSS_VAL__KHTML_CLOSE_QUOTE 173
+#define CSS_VAL_INLINE 174
+#define CSS_VAL_BLOCK 175
+#define CSS_VAL_LIST_ITEM 176
+#define CSS_VAL_RUN_IN 177
+#define CSS_VAL_COMPACT 178
+#define CSS_VAL_INLINE_BLOCK 179
+#define CSS_VAL_TABLE 180
+#define CSS_VAL_INLINE_TABLE 181
+#define CSS_VAL_TABLE_ROW_GROUP 182
+#define CSS_VAL_TABLE_HEADER_GROUP 183
+#define CSS_VAL_TABLE_FOOTER_GROUP 184
+#define CSS_VAL_TABLE_ROW 185
+#define CSS_VAL_TABLE_COLUMN_GROUP 186
+#define CSS_VAL_TABLE_COLUMN 187
+#define CSS_VAL_TABLE_CELL 188
+#define CSS_VAL_TABLE_CAPTION 189
+#define CSS_VAL_AUTO 190
+#define CSS_VAL_DEFAULT 191
+#define CSS_VAL_CONTEXT_MENU 192
+#define CSS_VAL_HELP 193
+#define CSS_VAL_POINTER 194
+#define CSS_VAL_PROGRESS 195
+#define CSS_VAL_WAIT 196
+#define CSS_VAL_CELL 197
+#define CSS_VAL_CROSSHAIR 198
+#define CSS_VAL_TEXT 199
+#define CSS_VAL_VERTICAL_TEXT 200
+#define CSS_VAL_ALIAS 201
+#define CSS_VAL_COPY 202
+#define CSS_VAL_MOVE 203
+#define CSS_VAL_NO_DROP 204
+#define CSS_VAL_NOT_ALLOWED 205
+#define CSS_VAL_E_RESIZE 206
+#define CSS_VAL_N_RESIZE 207
+#define CSS_VAL_NE_RESIZE 208
+#define CSS_VAL_NW_RESIZE 209
+#define CSS_VAL_S_RESIZE 210
+#define CSS_VAL_SE_RESIZE 211
+#define CSS_VAL_SW_RESIZE 212
+#define CSS_VAL_W_RESIZE 213
+#define CSS_VAL_EW_RESIZE 214
+#define CSS_VAL_NS_RESIZE 215
+#define CSS_VAL_NESW_RESIZE 216
+#define CSS_VAL_NWSE_RESIZE 217
+#define CSS_VAL_COL_RESIZE 218
+#define CSS_VAL_ROW_RESIZE 219
+#define CSS_VAL_ALL_SCROLL 220
+#define CSS_VAL_LTR 221
+#define CSS_VAL_RTL 222
+#define CSS_VAL_CAPITALIZE 223
+#define CSS_VAL_UPPERCASE 224
+#define CSS_VAL_LOWERCASE 225
+#define CSS_VAL_VISIBLE 226
+#define CSS_VAL_COLLAPSE 227
+#define CSS_VAL_CLOSE_QUOTE 228
+#define CSS_VAL_NO_CLOSE_QUOTE 229
+#define CSS_VAL_NO_OPEN_QUOTE 230
+#define CSS_VAL_OPEN_QUOTE 231
+#define CSS_VAL_NOWRAP 232
+#define CSS_VAL_PRE 233
+#define CSS_VAL_PRE_WRAP 234
+#define CSS_VAL_PRE_LINE 235
+#define CSS_VAL__KHTML_NOWRAP 236
+#define CSS_VAL_ABOVE 237
+#define CSS_VAL_ABSOLUTE 238
+#define CSS_VAL_ALWAYS 239
+#define CSS_VAL_AVOID 240
+#define CSS_VAL_BELOW 241
+#define CSS_VAL_BIDI_OVERRIDE 242
+#define CSS_VAL_BLINK 243
+#define CSS_VAL_BOTH 244
+#define CSS_VAL_CROP 245
+#define CSS_VAL_CROSS 246
+#define CSS_VAL_EMBED 247
+#define CSS_VAL_HAND 248
+#define CSS_VAL_HIDE 249
+#define CSS_VAL_HIGHER 250
+#define CSS_VAL_INVERT 251
+#define CSS_VAL_LANDSCAPE 252
+#define CSS_VAL_LEVEL 253
+#define CSS_VAL_LINE_THROUGH 254
+#define CSS_VAL_LOUD 255
+#define CSS_VAL_LOWER 256
+#define CSS_VAL_MARQUEE 257
+#define CSS_VAL_MIX 258
+#define CSS_VAL_OVERLINE 259
+#define CSS_VAL_PORTRAIT 260
+#define CSS_VAL_RELATIVE 261
+#define CSS_VAL_SEPARATE 262
+#define CSS_VAL_SHOW 263
+#define CSS_VAL_STATIC 264
+#define CSS_VAL_THICK 265
+#define CSS_VAL_THIN 266
+#define CSS_VAL_UNDERLINE 267
+#define CSS_VAL__KHTML_NORMAL 268
+#define CSS_VAL__KHTML_AROUND_FLOATS 269
+#define CSS_VAL_BORDER_BOX 270
+#define CSS_VAL_CONTENT_BOX 271
+#define CSS_VAL_ENABLED 272
+#define CSS_VAL_DISABLED 273
+#define CSS_VAL_FORWARDS 274
+#define CSS_VAL_BACKWARDS 275
+#define CSS_VAL_AHEAD 276
+#define CSS_VAL_REVERSE 277
+#define CSS_VAL_UP 278
+#define CSS_VAL_DOWN 279
+#define CSS_VAL_SLOW 280
+#define CSS_VAL_FAST 281
+#define CSS_VAL_INFINITE 282
+#define CSS_VAL_SLIDE 283
+#define CSS_VAL_ALTERNATE 284
+#define CSS_VAL_UNFURL 285
+#define CSS_VAL_CLIP 286
+#define CSS_VAL_ELLIPSIS 287
+#define CSS_VAL_BORDER 288
+#define CSS_VAL_CONTENT 289
+#define CSS_VAL_PADDING 290
+#define CSS_VAL_EVENODD 291
+#define CSS_VAL_NONZERO 292
 
-#define CSS_VAL_TOTAL 292
+#define CSS_VAL_TOTAL 293
 #endif
 
Index: khtml/xml/dom_nodeimpl.h
===================================================================
--- khtml/xml/dom_nodeimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/dom_nodeimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -545,7 +545,7 @@
     virtual bool hasChildNodes (  ) const;
 
     // Other methods (not part of DOM)
-    void removeChildren();
+    virtual void removeChildren();
     void cloneChildNodes(NodeImpl *clone);
 
     virtual void setFirstChild(NodeImpl *child);
Index: khtml/xml/dom_elementimpl.h
===================================================================
--- khtml/xml/dom_elementimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/dom_elementimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -340,9 +340,9 @@
     
     void updateId(DOMStringImpl* oldId, DOMStringImpl* newId);
     //Called when mapping from id to this node in document should be removed
-    virtual void removeId(const QString& id);
+    virtual void removeId(const DOMString& id);
     //Called when mapping from id to this node in document should be added
-    virtual void addId   (const QString& id);
+    virtual void addId   (const DOMString& id);
 
 protected:
     void createAttributeMap() const;
@@ -515,7 +515,7 @@
         localName = prefix.split(colonPos+1);
         prefix.implementation()->truncate(colonPos);
     } else
-        localName = qualifiedName->copy();
+        localName = qualifiedName;
 }
 
 inline void splitPrefixLocalName(const DOMString& qualifiedName, PrefixName& prefix, LocalName& localName, bool htmlCompat = false, int colonPos = -2)
@@ -523,11 +523,12 @@
     DOMString localname, prefixname;
     splitPrefixLocalName(qualifiedName.implementation(), prefixname, localname, colonPos);
     if (htmlCompat) {
-        localname = localname.lower();
-        prefixname = prefixname.lower();
+        prefix = PrefixName::fromString(prefixname, khtml::IDS_NormalizeLower);
+        localName = LocalName::fromString(localname, khtml::IDS_NormalizeLower);
+    } else {
+        prefix = PrefixName::fromString(prefixname);
+        localName = LocalName::fromString(localname);
     }
-    prefix = PrefixName::fromString(prefixname);
-    localName = LocalName::fromString(localname);
 }
 
 // methods that could be very hot they are need to be inlined
Index: khtml/xml/dom_docimpl.h
===================================================================
--- khtml/xml/dom_docimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/dom_docimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -164,29 +164,29 @@
     /**
      Add a pointer as just one of candidates, not neccesserily the proper one
     */
-    void add(const QString& id, ElementImpl* nd);
+    void add(const DOMString& id, ElementImpl* nd);
 
     /**
      Set the pointer as the definite mapping; it must have already been added
     */
-    void set(const QString& id, ElementImpl* nd);
+    void set(const DOMString& id, ElementImpl* nd);
 
     /**
      Remove the item; it must have already been added.
     */
-    void remove(const QString& id, ElementImpl* nd);
+    void remove(const DOMString& id, ElementImpl* nd);
 
     /**
      Returns true if the item exists
     */
-    bool contains(const QString& id);
+    bool contains(const DOMString& id);
 
     /**
      Returns the information for the given ID
     */
-    ItemInfo* get(const QString& id);
+    ItemInfo* get(const DOMString& id);
 private:
-    QHash<QString,ItemInfo*> m_dict;
+    QHash<DOMString,ItemInfo*> m_dict;
 };
 
 
Index: khtml/xml/dom_stringimpl.h
===================================================================
--- khtml/xml/dom_stringimpl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/dom_stringimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -43,9 +43,9 @@
     DOMStringImpl(const DOMStringImpl&);
     //DOMStringImpl& operator=(const DOMStringImpl&);
 protected:
-    DOMStringImpl() { s = 0, l = 0; m_hash = 0; m_inTable = 0; }
+    DOMStringImpl() { s = 0, l = 0; m_hash = 0; m_inTable = 0; m_shallowCopy = 0; }
 public:
-    DOMStringImpl(const QChar *str, unsigned int len) : m_hash(0), m_inTable(0) {
+    DOMStringImpl(const QChar *str, unsigned int len) : m_hash(0), m_inTable(0), m_shallowCopy(0) {
 	bool havestr = str && len;
 	s = QT_ALLOC_QCHAR_VEC( havestr ? len : 1 );
 	if(str && len) {
@@ -60,13 +60,13 @@
 
     explicit DOMStringImpl(const char *str);
     explicit DOMStringImpl(const char *str, uint len);
-    explicit DOMStringImpl(const QChar &ch) : m_hash(0), m_inTable(0) {
+    explicit DOMStringImpl(const QChar &ch) : m_hash(0), m_inTable(0), m_shallowCopy(0) {
 	s = QT_ALLOC_QCHAR_VEC( 1 );
 	s[0] = ch;
 	l = 1;
     }
 
-    DOMStringImpl(const QChar* str, unsigned length, unsigned hash) : m_hash(hash), m_inTable(true) {
+    DOMStringImpl(const QChar* str, unsigned length, unsigned hash) : m_hash(hash), m_inTable(true), m_shallowCopy(0) {
 	bool havestr = str && length;
 	s = QT_ALLOC_QCHAR_VEC( havestr ? length : 1 );
 	if(str && length) {
@@ -81,6 +81,15 @@
 
     DOMStringImpl(const char* str, unsigned length, unsigned hash);
 
+    enum ShallowCopyTag { ShallowCopy };
+    // create DOMStringImpl without copying the data, it's really dangerous!
+    // think a lot, before using it
+    DOMStringImpl(ShallowCopyTag, QChar* str, unsigned length) : m_hash(0), m_inTable(0), m_shallowCopy(1) {
+        s = str;
+        l = length;
+        ref(); // guard from automatic deletion
+    }
+
     ~DOMStringImpl();
 
     void append(DOMStringImpl *str);
@@ -122,9 +131,14 @@
 
     // Note: this actually computes the hash, so shouldn't be used lightly
     unsigned hash() const;
+    
+    // Unlike the above, these don't even cache the hash;
+    // they return hashes for lowercase, and upper-case versions
+    unsigned lowerHash() const;
+    unsigned upperHash() const;
 
     // for WebCore API compatibility;
-    static unsigned computeHash(const QChar* str, unsigned int length) { return DOMStringImpl(str, length).hash(); }
+    static unsigned computeHash(const QChar* str, unsigned int length);
     static unsigned computeHash(const char* str) { return DOMStringImpl(str).hash(); }
 
     static DOMStringImpl* empty();
@@ -132,7 +146,8 @@
     QChar *s;
     unsigned int l;
     mutable unsigned m_hash;
-    bool m_inTable;
+    bool m_inTable : 1;
+    bool m_shallowCopy : 1;
 };
 
 inline unsigned int qHash(const DOMString& key) {
Index: khtml/xml/dom_nodeimpl.cpp
===================================================================
--- khtml/xml/dom_nodeimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/dom_nodeimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1240,7 +1240,6 @@
 
 NodeListImpl* NodeImpl::getElementsByTagName(const DOMString &tagName)
 {
-        //FIXME: split into prefix and localName
     LocalName localname;
     PrefixName prefixname;
     if (tagName == "*") {
@@ -2186,14 +2185,11 @@
 
 NodeImpl* NamedNodeMapImpl::getNamedItem( const DOMString &name )
 {
-    DOMString prefix, localName;
-    splitPrefixLocalName(name.implementation(), prefix, localName);
-    if (htmlCompat()) {
-        prefix = prefix.lower();
-        localName = localName.lower();
-    }
-    LocalName localname = LocalName::fromString(localName);
-    return getNamedItem(localname.id(), PrefixName::fromString(prefix), false);
+    PrefixName prefix;
+    LocalName  localName;
+    splitPrefixLocalName(name, prefix, localName, htmlCompat());
+
+    return getNamedItem(localName.id(), prefix, false);
 }
 
 Node NamedNodeMapImpl::setNamedItem( const Node &arg, int& exceptioncode )
@@ -2209,14 +2205,11 @@
 
 Node NamedNodeMapImpl::removeNamedItem( const DOMString &name, int& exceptioncode )
 {
-    DOMString prefix, localName;
-    splitPrefixLocalName(name.implementation(), prefix, localName);
-    if (htmlCompat()) {
-        prefix = prefix.lower();
-        localName = localName.lower();
-    }
-    LocalName localname = LocalName::fromString(localName);
-    Node r = removeNamedItem(localname.id(), PrefixName::fromString(prefix), false, exceptioncode);
+    PrefixName prefix;
+    LocalName  localName;
+    splitPrefixLocalName(name, prefix, localName, htmlCompat());
+    
+    Node r = removeNamedItem(localName.id(), prefix, false, exceptioncode);
     return r;
 }
 
Index: khtml/xml/dom_elementimpl.cpp
===================================================================
--- khtml/xml/dom_elementimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/dom_elementimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -598,11 +598,8 @@
 bool ElementImpl::hasAttributeNS( const DOMString &namespaceURI,
                                   const DOMString &localName ) const
 {
-    DOMString local = localName;
-    if (m_htmlCompat)
-        local = local.lower();
     NamespaceName namespacename = NamespaceName::fromString(namespaceURI);
-    LocalName localname = LocalName::fromString(local);
+    LocalName localname = LocalName::fromString(localName, m_htmlCompat ? IDS_NormalizeLower : IDS_CaseSensitive);
     NodeImpl::Id id = makeId(namespacename.id(), localname.id());
     if (!id) return false;
     if (!namedAttrMap) return false;
@@ -696,11 +693,10 @@
       exceptioncode = DOMException::NOT_FOUND_ERR;
       return DOMString();
     }
-    DOMString local = localName;
-    if (m_htmlCompat)
-        local = local.lower();
+
+    LocalName localname = LocalName::fromString(localName, m_htmlCompat ? IDS_NormalizeLower : IDS_CaseSensitive);
     NamespaceName namespacename = NamespaceName::fromString(namespaceURI);
-    LocalName localname = LocalName::fromString(local);
+
     NodeImpl::Id id = makeId(namespacename.id(), localname.id());
     return getAttribute(id, emptyPrefixName, true);
 }
@@ -713,11 +709,10 @@
         exceptioncode = DOMException::NOT_FOUND_ERR;
         return;
     }
-    DOMString local = localName;
-    if (m_htmlCompat)
-        local = local.lower();
+
     NamespaceName namespacename = NamespaceName::fromString(namespaceURI);
-    LocalName localname = LocalName::fromString(local);
+    LocalName localname = LocalName::fromString(localName, m_htmlCompat ? IDS_NormalizeLower : IDS_CaseSensitive);
+
     NodeImpl::Id id = makeId(namespacename.id(), localname.id());
     attributes(false)->removeNamedItem(id, emptyPrefixName, true, exceptioncode);
 }
@@ -730,11 +725,10 @@
       exceptioncode = DOMException::NOT_FOUND_ERR;
       return 0;
     }
-    DOMString local = localName;
-    if (m_htmlCompat)
-        local = local.lower();
+
     NamespaceName namespacename = NamespaceName::fromString(namespaceURI);
-    LocalName localname = LocalName::fromString(local);
+    LocalName localname = LocalName::fromString(localName, m_htmlCompat ? IDS_NormalizeLower : IDS_CaseSensitive);    
+    
     NodeImpl::Id id = makeId(namespacename.id(), localname.id());
     if (!attributes(true)) return 0;
     return static_cast<AttrImpl*>(attributes()->getNamedItem(id, emptyPrefixName, true));
@@ -1119,18 +1113,18 @@
         return;
 
     if (oldId && oldId->l)
-        removeId(DOMString(oldId).string());
+        removeId(DOMString(oldId));
 
     if (newId && newId->l)
-        addId(DOMString(newId).string());
+        addId(DOMString(newId));
 }
 
-void ElementImpl::removeId(const QString& id)
+void ElementImpl::removeId(const DOMString& id)
 {
   document()->getElementByIdCache().remove(id, this);
 }
 
-void ElementImpl::addId(const QString& id)
+void ElementImpl::addId(const DOMString& id)
 {
   document()->getElementByIdCache().add(id, this);
 }
Index: khtml/xml/dom_docimpl.cpp
===================================================================
--- khtml/xml/dom_docimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/dom_docimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -318,7 +318,7 @@
     qDeleteAll( m_dict );
 }
 
-void ElementMappingCache::add(const QString& id, ElementImpl* nd)
+void ElementMappingCache::add(const DOMString& id, ElementImpl* nd)
 {
     if (id.isEmpty()) return;
 
@@ -337,7 +337,7 @@
     }
 }
 
-void ElementMappingCache::set(const QString& id, ElementImpl* nd)
+void ElementMappingCache::set(const DOMString& id, ElementImpl* nd)
 {
     if (id.isEmpty()) return;
 
@@ -346,7 +346,7 @@
     info->nd = nd;
 }
 
-void ElementMappingCache::remove(const QString& id, ElementImpl* nd)
+void ElementMappingCache::remove(const DOMString& id, ElementImpl* nd)
 {
     if (id.isEmpty()) return;
 
@@ -365,13 +365,13 @@
     }
 }
 
-bool ElementMappingCache::contains(const QString& id)
+bool ElementMappingCache::contains(const DOMString& id)
 {
     if (id.isEmpty()) return false;
     return m_dict.contains(id);
 }
 
-ElementMappingCache::ItemInfo* ElementMappingCache::get(const QString& id)
+ElementMappingCache::ItemInfo* ElementMappingCache::get(const DOMString& id)
 {
     if (id.isEmpty()) return 0;
     return m_dict.value(id);
@@ -597,14 +597,12 @@
         *pExceptioncode = DOMException::INVALID_CHARACTER_ERR;
         return 0;
     }
-    DOMString prefix, localName;
-    splitPrefixLocalName(name.implementation(), prefix, localName);
-    bool htmlCompat = (htmlMode() != XHtml);
-    if (htmlCompat) {
-        localName = localName.lower();
-        prefix = prefix.lower();
-    }
-    XMLElementImpl* e = new XMLElementImpl(document(), emptyNamespaceName, LocalName::fromString(localName), PrefixName::fromString(prefix));
+
+    PrefixName prefix;
+    LocalName  localName;
+    bool htmlCompat = htmlMode() != XHtml;
+    splitPrefixLocalName(name, prefix, localName, htmlCompat);
+    XMLElementImpl* e = new XMLElementImpl(document(), emptyNamespaceName, localName, prefix);
     e->setHTMLCompat(htmlCompat); // Not a real HTML element, but inside an html-compat doc all tags are uppercase.
     return e;
 }
@@ -615,15 +613,14 @@
         *pExceptioncode = DOMException::INVALID_CHARACTER_ERR;
         return 0;
     }
-    DOMString prefix, localName;
-    splitPrefixLocalName(tagName.implementation(), prefix, localName);
+
+    PrefixName prefix;
+    LocalName  localName;
     bool htmlCompat = (htmlMode() != XHtml);
-    if (htmlCompat) {
-        localName = localName.lower();
-        prefix = prefix.lower();
-    }
-    AttrImpl* attr = new AttrImpl(0, document(), NamespaceName::fromId(emptyNamespace), LocalName::fromString(localName),
-            PrefixName::fromString(prefix), DOMString("").implementation());
+    splitPrefixLocalName(tagName, prefix, localName, htmlCompat);
+
+    AttrImpl* attr = new AttrImpl(0, document(), NamespaceName::fromId(emptyNamespace),
+            localName, prefix, DOMString("").implementation());
     attr->setHTMLCompat(htmlCompat);
     return attr;
 }
@@ -797,20 +794,20 @@
                                               false/*nameCanBeNull*/, false/*nameCanBeEmpty*/,
                                               pExceptioncode))
         return 0;
-    DOMString prefix, localName;
-    splitPrefixLocalName(_qualifiedName.implementation(), prefix, localName, colonPos);
-    AttrImpl* attr = new AttrImpl(0, document(), NamespaceName::fromString(_namespaceURI), LocalName::fromString(localName),
-            PrefixName::fromString(prefix), DOMString("").implementation());
-    attr->setHTMLCompat( _namespaceURI.isNull() && htmlMode() != XHtml );
+    PrefixName prefix;
+    LocalName  localName;
+    bool htmlCompat =  _namespaceURI.isNull() && htmlMode() != XHtml;
+    splitPrefixLocalName(_qualifiedName, prefix, localName, false, colonPos);
+    AttrImpl* attr = new AttrImpl(0, document(), NamespaceName::fromString(_namespaceURI),
+            localName, prefix, DOMString("").implementation());
+    attr->setHTMLCompat( htmlCompat );
     return attr;
 }
 
 ElementImpl *DocumentImpl::getElementById( const DOMString &elementId ) const
 {
-    QString stringKey = elementId.string();
+    ElementMappingCache::ItemInfo* info = m_getElementByIdCache.get(elementId);
 
-    ElementMappingCache::ItemInfo* info = m_getElementByIdCache.get(stringKey);
-
     if (!info)
         return 0;
 
@@ -2828,8 +2825,8 @@
 
     m_imageLoadEventDispatchingList = m_imageLoadEventDispatchSoonList;
     m_imageLoadEventDispatchSoonList.clear();
-    for (QLinkedListIterator<HTMLImageElementImpl*> it(m_imageLoadEventDispatchingList); it.hasNext(); )
-        it.next()->dispatchLoadEvent();
+    while (!m_imageLoadEventDispatchingList.isEmpty())
+        m_imageLoadEventDispatchingList.takeFirst()->dispatchLoadEvent();
     m_imageLoadEventDispatchingList.clear();
 }
 
Index: khtml/xml/dom_stringimpl.cpp
===================================================================
--- khtml/xml/dom_stringimpl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/dom_stringimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -34,7 +34,7 @@
 using namespace DOM;
 using namespace khtml;
 
-DOMStringImpl::DOMStringImpl(const char *str) : m_hash(0), m_inTable(0)
+DOMStringImpl::DOMStringImpl(const char *str) : m_hash(0), m_inTable(0), m_shallowCopy(0)
 {
     if(str && *str)
     {
@@ -53,7 +53,7 @@
     }
 }
 
-DOMStringImpl::DOMStringImpl(const char *str, uint len) : m_hash(0), m_inTable(0)
+DOMStringImpl::DOMStringImpl(const char *str, uint len) : m_hash(0), m_inTable(0), m_shallowCopy(0)
 {
     if(str && *str)
     {
@@ -72,7 +72,7 @@
     }
 }
 
-DOMStringImpl::DOMStringImpl(const char* str, unsigned len/*gth*/, unsigned hash) : m_hash(hash), m_inTable(true)
+DOMStringImpl::DOMStringImpl(const char* str, unsigned len/*gth*/, unsigned hash) : m_hash(hash), m_inTable(true), m_shallowCopy(0)
 {
     if(str && *str)
     {
@@ -93,6 +93,8 @@
 
 DOMStringImpl::~DOMStringImpl()
 {
+    if (m_shallowCopy)
+        return;
     if (m_inTable)
         khtml::AtomicString::remove(this);
     if (s)
@@ -546,18 +548,42 @@
     return toRet;
 }
 
+enum NoFoldTag    { DoNotFold };
+enum FoldLowerTag { FoldLower };
+enum FoldUpperTag { FoldUpper };
+
+static inline
+unsigned short foldChar(unsigned short c, NoFoldTag)
+{
+    return c;
+}
+
+static inline
+unsigned short foldChar(unsigned short c, FoldLowerTag)
+{
+    // ### fast path for first ones?
+    return QChar::toLower(c);
+}
+
+static inline
+unsigned short foldChar(unsigned short c, FoldUpperTag)
+{
+    // ### fast path for first ones?
+    return QChar::toUpper(c);
+}
+
+// Paul Hsieh's SuperFastHash
+// http://www.azillionmonkeys.com/qed/hash.html
+
 // Golden ratio - arbitrary start value to avoid mapping all 0's to all 0's
 // or anything like that.
 const unsigned PHI = 0x9e3779b9U;
 
-// Paul Hsieh's SuperFastHash
-// http://www.azillionmonkeys.com/qed/hash.html
-unsigned DOMStringImpl::hash() const
+
+template<typename FoldTag>
+static unsigned calcHash(const QChar* s, unsigned l, FoldTag foldMode)
 {
-    if (m_hash != 0) return m_hash;
-  // Note: this is originally from KJS>.
-  unsigned l = this->l;
-  QChar*   s = this->s;
+  // Note: this is originally from KJS
   unsigned hash = PHI;
   unsigned tmp;
 
@@ -566,8 +592,8 @@
 
   // Main loop
   for (; l > 0; l--) {
-    hash += s[0].unicode();
-    tmp = (s[1].unicode() << 11) ^ hash;
+    hash += foldChar(s[0].unicode(), foldMode);
+    tmp = (foldChar(s[1].unicode(), foldMode) << 11) ^ hash;
     hash = (hash << 16) ^ tmp;
     s += 2;
     hash += hash >> 11;
@@ -575,7 +601,7 @@
 
   // Handle end case
   if (rem) {
-    hash += s[0].unicode();
+    hash += foldChar(s[0].unicode(), foldMode);
     hash ^= hash << 11;
     hash += hash >> 17;
   }
@@ -593,9 +619,31 @@
   if (hash == 0)
     hash = 0x80000000;
 
-  return m_hash = hash;
+  return hash;
 }
 
+unsigned DOMStringImpl::hash() const
+{
+    if (m_hash != 0) return m_hash;
+
+    return m_hash = calcHash(s, l, DoNotFold);
+}
+
+unsigned DOMStringImpl::lowerHash() const
+{
+    return calcHash(s, l, FoldLower);
+}
+
+unsigned DOMStringImpl::upperHash() const
+{
+    return calcHash(s, l, FoldUpper);
+}
+
+unsigned DOMStringImpl::computeHash(const QChar* str, unsigned int length)
+{
+    return calcHash(str, length, DoNotFold);
+}
+
 DOMStringImpl* DOMStringImpl::empty()
 {
     static DOMString e;
Index: khtml/xml/xml_tokenizer.cpp
===================================================================
--- khtml/xml/xml_tokenizer.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ khtml/xml/xml_tokenizer.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -148,11 +148,16 @@
 
 bool XMLHandler::endPrefixMapping(const QString& prefix)
 {
-    QStack<QString>& stack = namespaceInfo[prefix];
-    stack.pop();
-    if (stack.isEmpty())
-        namespaceInfo.remove(prefix);
-    return true;
+    if (namespaceInfo.contains(prefix)) {
+        QStack<QString>& stack = namespaceInfo[prefix];
+        stack.pop();
+        if (stack.isEmpty()) {
+            namespaceInfo.remove(prefix);
+        }
+        return true;
+    } else {
+        return false;
+    }
 }
 
 void XMLHandler::fixUpNSURI(QString& uri, const QString& qname)
Index: interfaces/ktexteditor/ktexteditorplugin.desktop
===================================================================
--- interfaces/ktexteditor/ktexteditorplugin.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ interfaces/ktexteditor/ktexteditorplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -64,6 +64,7 @@
 Comment[ro]=Modul editor de text
 Comment[ru]=Расширение KTextEditor
 Comment[se]=KDE-čállinprográmma lassemodula
+Comment[si]=KTextEditor ප්ලගීනය
 Comment[sk]=Modul KTextEditor
 Comment[sl]=Vstavek KTextEditor
 Comment[sr]=Прикључак за уређивање текста
Index: interfaces/ktexteditor/kcm_ktexteditor.desktop
===================================================================
--- interfaces/ktexteditor/kcm_ktexteditor.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ interfaces/ktexteditor/kcm_ktexteditor.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -91,7 +91,7 @@
 Comment[bn]=টেক্সট সম্পাদক সার্ভিসটি বিভিন্ন অ্যাপলিকেশন-কে একটি টেক্সট প্রদর্শক এবং সম্পাদক ব্যবহার করার সুযোগ দেয়। কোন কে.ডি.ই. অ্যাপলিকেশন টেক্সট সম্পাদনা করার সুবিধা দিতে চাইলে তার এই সার্ভিসটি ব্যবহার করা উচিত্‍।
 Comment[bn_IN]=টেক্সট এডিটর পরিসেবার সাহায্যে টেক্সট প্রদর্শন ব্যবস্থা ও এডিটর উপলব্ধ করা হয়। টেক্সট এডিটরের কর্ম উপলব্ধকারী KDE অ্যাপ্লিকেশনগুলি দ্বারা এই পরিসেবা ব্যবহার করা আবশ্যক।
 Comment[ca]=El servei de l'editor de text proveeix d'aplicacions amb un visor i un editor de text. Les aplicacions KDE que proveeixen de facilitats d'edició haurien d'emprar aquest servei.
-Comment[cs]=Služba textového editoru poskytuje aplikacím prohlížeč a editor textu. Aplikace KDE, které umožňují editovat text, by měly používat tuto službu.
+Comment[cs]=Služba textového editoru poskytuje aplikacím prohlížeč a editor textu. Aplikace KDE, které umožňují upravovat text, by měly používat tuto službu.
 Comment[csb]=Ùsłëżnota tekstowegò editorë zezwôlô aplikaceją na przezéranié ë edicejã tekstów. Programë KDE, jaczé ùprzistãpniają nã edicëjną fùnkcëjã, mają brëkòwac ti ùsłëżnotë.
 Comment[cy]=Mae'r gwasanaeth golygu testun yn darparu gwelydd testun a golygydd i gymhwysiadau.  dylai cymhwysiadau KDE sy'n darparu galluoedd golygu testun ddefnyddio'r gwasanaeth yma.
 Comment[da]=Teksteditor-tjenesten udstyrer programmer med en tekstfremviser og editor. KDE-programmer der bruger tekstredigeringsfaciliteter bør benytte denne tjeneste.
Index: knotify/tests/knotifytest.notifyrc
===================================================================
--- knotify/tests/knotifytest.notifyrc	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ knotify/tests/knotifytest.notifyrc	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -132,6 +132,7 @@
 Name[ro]=Grup
 Name[ru]=Группа
 Name[se]=Joavku
+Name[si]=සමූහය
 Name[sk]=Skupina
 Name[sl]=Skupina
 Name[sr]=Група
@@ -203,6 +204,7 @@
 Comment[ro]=Grupul
 Comment[ru]=Группа
 Comment[se]=Joavku
+Comment[si]=සමූහය
 Comment[sk]=Skupina
 Comment[sl]=Skupina
 Comment[sr]=Група
@@ -271,6 +273,7 @@
 Name[ro]=Conectat
 Name[ru]=В сети
 Name[se]=Láktašuvvon
+Name[si]=සබැඳි
 Name[sl]=Na zvezi
 Name[sr]=На вези
 Name[sr@latin]=Na vezi
Index: kate/plugins/kdatatool/ktexteditor_kdatatool.desktop
===================================================================
--- kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -68,6 +68,7 @@
 Name[ro]=Utilitare de date
 Name[ru]=Обработка данных
 Name[se]=Dáhtareaiddut
+Name[si]=දත්ත මෙවලම්
 Name[sk]=Dátové nástroje
 Name[sl]=Podatkovna orodja
 Name[sr]=Алатке за податке
Index: kate/plugins/insertfile/ktexteditor_insertfile.desktop
===================================================================
--- kate/plugins/insertfile/ktexteditor_insertfile.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/plugins/insertfile/ktexteditor_insertfile.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -42,7 +42,7 @@
 Name[gu]=ફાઇલ ઉમેરો
 Name[he]=הוספת קובץ
 Name[hi]=फ़ाइल प्रविष्ट करें
-Name[hne]=फाइल घुसाव
+Name[hne]=फाइल भरव
 Name[hsb]=Dokument zasunyć
 Name[hu]=Fájl beszúrása
 Name[is]=Skjóta inn skrá
@@ -74,6 +74,7 @@
 Name[ro]=Inserează fișier
 Name[ru]=Вставить файл
 Name[se]=Bija fiilla sisa
+Name[si]=ගොනුව එක් කරන්න
 Name[sk]=Vložiť súbor
 Name[sl]=Vstavi datoteko
 Name[sr]=Уметање фајла
@@ -120,7 +121,7 @@
 Comment[gu]=કર્સર સ્થિતિ પર કોઇપણ વાંચી શકાય તેવી ફાઇલ દાખલ કરો
 Comment[he]=מוסיף כל קובץ הניתן לקריאה במיקום הסמן
 Comment[hi]=संकेतक के स्थान पर कोई भी पढ़ने योग्य फ़ाइल प्रविष्ट करें
-Comment[hne]=संकेतक के जगह फेर कोनो पढ़े जा सके फाइल घुसाव
+Comment[hne]=संकेतक के जगह तिर कोनो पढ़े जा सके फाइल भरव
 Comment[hr]=Na položaju pokazivača umetnite bilo koju čitljivu datoteku
 Comment[hsb]=Zasunje lubowólnu čitajomnu dataju na poziciji cursora
 Comment[hu]=Tetszőleges olvasható fájl beszúrása a kurzorpozíciónál
Index: kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop
===================================================================
--- kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -68,6 +68,7 @@
 Name[ro]=Semne de carte automate pentru KTextEditor
 Name[ru]=Автозакладки
 Name[se]=Automáhtalaš girjemerkejeaddji
+Name[si]=ස්වයංක්‍රීය පිටුසලකුණු
 Name[sk]=Autovytvárač záložiek
 Name[sl]=Samodejni zaznamki
 Name[sr]=Аутоматско маркирање
Index: kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop
===================================================================
--- kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -150,6 +150,7 @@
 Comment[pt_BR]=Complementação direcional ou baseada em popup, a partir de palavras do documento
 Comment[ro]=Propune completarea cuvintelor din document dintr-o listă popup sau direcțională
 Comment[ru]=Автозавершение слов в документе
+Comment[se]=Ollášuhttin mii oidno čállingiettis vai listtus mii bahccá
 Comment[sk]=Dopĺňanie slov v dokumente priame alebo pomocou dialógu
 Comment[sl]=Neposredno ali pojavno dopolnjevanje iz besed v dokumentu
 Comment[sr]=Дирекционо или искачуће допуњавање према речима из документа
Index: kate/plugins/wordcompletion/ktexteditor_docwordcompletion_config.desktop
===================================================================
--- kate/plugins/wordcompletion/ktexteditor_docwordcompletion_config.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/plugins/wordcompletion/ktexteditor_docwordcompletion_config.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -68,6 +68,7 @@
 Name[ro]=Comportare
 Name[ru]=Поведение
 Name[se]=Láhtten
+Name[si]=හැසිරීම
 Name[sk]=Pozadie
 Name[sl]=Obnašanje
 Name[sr]=Понашање
Index: kate/plugins/timedate/ktexteditor_timedate.desktop
===================================================================
--- kate/plugins/timedate/ktexteditor_timedate.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/plugins/timedate/ktexteditor_timedate.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -74,6 +74,7 @@
 Name[ro]=Oră și dată
 Name[ru]=Дата и время
 Name[se]=Dáhton ja áigi
+Name[si]=දිනය සහ වේලාව
 Name[sk]=Čas & Dátum
 Name[sl]=Čas in datum
 Name[sr]=Време и датум
@@ -117,7 +118,7 @@
 Comment[gu]=હાલનો સમય & તારીખ ઉમેરો
 Comment[he]=הוספת התאריך והשעה הנוכחיים
 Comment[hi]=वर्तमान समय व तिथि प्रविष्ट करें
-Comment[hne]=अभी हाल के समय व तारीक घुसाव
+Comment[hne]=अभी हाल के समय व तारीक भरव
 Comment[hsb]=Zasunje aktualny čas a datum
 Comment[hu]=Az aktuális dátum és idő beszúrása
 Comment[hy]=Մտցրեք ընթացիք Ժամը և Ամսաթիվը
Index: kate/syntax/data/lilypond.xml
===================================================================
--- kate/syntax/data/lilypond.xml	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/syntax/data/lilypond.xml	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -14,7 +14,7 @@
   <!ENTITY markupwithtextargs "markup|bold|(rounded-)?box|bracket|caps|(center|general|left|right)-align|circle|((center|dir|left|right)-)?column|combine|concat|dynamic|fill-line|finger|fontCaps|(abs-)?fontsize|fraction|halign|hbracket|hcenter-in|hcenter|hspace|huge|italic|justify|larger?|line|lower|magnify|medium|normal-size-(sub|super)|normal-text|normalsize|number|on-the-fly|override|pad-(around|markup|to-box|x)|page-ref|postscript|put-adjacent|raise|roman|rotate|sans|small(er)?|smallCaps|sub|super|teeny|text|tiny|translate(-scaled)?|transparent|typewriter|underline|upright|vcenter|whiteout|with-(color|dimensions|url)|wordwrap|(markup|column-|justified-|override-|wordwrap-)lines|wordwrap-(string-)?internal">
   <!ENTITY deprecatedmarkup "bigger|h?center">
   <!ENTITY headervars "dedication|(sub){,2}title|poet|composer|meter|opus|arranger|instrument|piece|breakbefore|copyright|tagline|mutopia(title|composer|poet|opus|instrument)|date|enteredby|source|style|maintainer(Email|Web)?|moreInfo|lastupdated|texidoc|footer">
-  <!ENTITY papervars "annotate-spacing|(print-)?first-page-number|print-page-number|paper-(width|height)|(top|bottom|left|right)-margin|line-width|(head|foot)-separation|page-top-space|ragged-(bottom|last(-bottom)?|right)|page-count|between-system-(space|padding)|page-breaking-between-system-padding|horizontal-shift|(before|after|between)-title-space|print-all-headers|indent|force-assignment|input-encoding|output-scale|blank(-after-score|-last)?-page-force|page-limit-inter-system-space(-factor)?|(systemSeparator|(even|odd)(Footer|Header)|(book|score|toc)Title|tocItem)Markup">
+  <!ENTITY papervars "annotate-spacing|(print-)?first-page-number|print-page-number|paper-(width|height)|(top|bottom|left|right)-margin|line-width|(head|foot)-separation|page-top-space|ragged-(bottom|last(-bottom)?|right)|page-count|between-system-(space|padding)|page-breaking-between-system-padding|horizontal-shift|(before|after|between)-title-space|print-all-headers|indent|force-assignment|input-encoding|output-scale|blank(-after-score|-last)?-page-force|page-limit-inter-system-space(-factor)?|system-separator-markup|((even|odd)(Footer|Header)|(book|score|toc)Title|tocItem)Markup">
   <!ENTITY layoutvars "system-count|(short-)?indent">
   <!ENTITY toplevelvars "dash(Hat|Plus|Dash|Bar|Larger|Dot|Underscore)|fermataMarkup|pipeSymbol|slashSeparator">
   <!ENTITY performer "Beam|Control_track|Drum_note|Dynamic|Key|Lyric|Note|Piano_pedal|Slur|Staff|Swallow|Tempo|Tie|Time_signature">
Index: kate/syntax/data/ruby.xml
===================================================================
--- kate/syntax/data/ruby.xml	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/syntax/data/ruby.xml	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -327,8 +327,8 @@
 			
 			<!-- Internal context used by check_div_2 -->
 			<context name="check_div_2_internal" attribute="Normal Text" fallthrough="true" fallthroughContext="#pop#pop" lineEndContext="#pop#pop">
-				<DetectChar attribute="Operator" char="%" context="#pop#pop"/>
-				<RegExpr attribute="Operator" String="/(?=\s)" context="#pop#pop"/>
+<!-- 				<DetectChar attribute="Operator" char="%" context="#pop#pop"/> -->
+				<RegExpr attribute="Operator" String="[/%](?=\s)" context="#pop#pop"/>
 			</context>
 			
 			<!-- Same as check_div_2, but with double pop to exit the surrounding context -->
@@ -359,12 +359,10 @@
 				<RegExpr attribute="String" String="\\\&quot;" context="#stay"/>
 				<RegExpr attribute="Substitution" String="#@{1,2}" context="Short Subst"/>
 				<Detect2Chars attribute="Substitution" char="#" char1="{" context="Subst"/>
-				<!--HlCChar attribute="Char" context="#pop"/-->
 				<DetectChar char="&quot;" attribute="String" context="check_div_1_pop"/>
 			</context>
 			
 			<context name="Apostrophed String" attribute="Raw String" lineEndContext="#stay">
-				<!-- <HlCChar attribute="Char" context="#pop"/> -->
 				<StringDetect attribute="String" String="\\" context="#stay"/>
 				<RegExpr attribute="String" String="\\\'" context="#stay"/>
 				<DetectChar char="'" attribute="Raw String" context="check_div_1_pop"/>
@@ -375,11 +373,10 @@
 				<RegExpr attribute="String" String="\\\`" context="#stay"/>
 				<RegExpr attribute="Substitution" String="#@{1,2}" context="Short Subst"/>
 				<Detect2Chars attribute="Substitution" char="#" char1="{" context="Subst"/>
-				<HlCChar attribute="Char" context="check_div_1_pop"/>
 				<DetectChar char="`" attribute="Command" context="check_div_1_pop"/>
 			</context>
 			
-			<context name="Embedded documentation" attribute="Comment" lineEndContext="#stay">
+			<context name="Embedded documentation" attribute="Blockcomment" lineEndContext="#stay">
 				<RegExpr attribute="Comment" String="^=end(?:\s.*|$)" context="#pop" endRegion="comment block" column="0"/>
 			</context>
 			
Index: kate/tests/highlight.rb
===================================================================
--- kate/tests/highlight.rb	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/tests/highlight.rb	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -422,10 +422,17 @@
 10 % 4          # modulo
 
 foo%4           # modulo
-foo %4          # modulo
+# foo %4          # illegal %string
 foo% 4          # modulo
 foo % 4         # modulo
 
+foo % (4)       # modulo
+
+foo %(4)        # %string
+foo %q(4)       # %string
+foo %Q(4)       # %string
+foo %%4%        # %string
+
 foo = %|blah|   # GDL input
 foo % %|blah|   # modulo and GDL
 
@@ -470,6 +477,10 @@
 %x{ls -l |
 grep test }
 
+# alternative syntax
+`ls -l`
+`echo ' '`
+
 # token array
 %w{one two three}
 %w(one two three)
Index: kate/script/data/ruby.js
===================================================================
--- kate/script/data/ruby.js	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/script/data/ruby.js	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -293,10 +293,16 @@
   if (prevStmt.end < 0)
     return -2; // Can't indent the first line
 
-  // HACK Must have a way to detect if we are inside a non-code context
-  if (document.attribute(line-1, document.lineLength(line-1)-1) == 34) {
+  var prev = document.prevNonEmptyLine(line);
+
+  // HACK Detect here documents
+  if (document.isAttributeName(prev, document.lineLength(prev)-1, "Ruby:Here Document")) {
     return -1; // HERE-DOCUMENT
   }
+  // HACK Detect embedded comments
+  if (document.isAttributeName(prev, document.lineLength(prev)-1, "Ruby:Blockcomment")) {
+    return -1;
+  }
 
   var prevStmtCnt = prevStmt.content();
   var prevStmtInd = prevStmt.indent();
Index: kate/script/katescriptdocument.cpp
===================================================================
--- kate/script/katescriptdocument.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/script/katescriptdocument.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -465,13 +465,31 @@
   return m_document->highlight()->getCommentEnd(i);
 }
 
-int KateScriptDocument::attribute(int i, int j)
+int KateScriptDocument::attribute(int line, int column)
 {
-  KateTextLine::Ptr textLine = m_document->kateTextLine(i);
+  KateTextLine::Ptr textLine = m_document->kateTextLine(line);
   if(!textLine) return 0;
-  return textLine->attribute(j);
+  return textLine->attribute(column);
 }
 
+bool KateScriptDocument::isAttribute(int line, int column, int attr)
+{
+  return attr == attribute(line, column);
+}
+
+QString KateScriptDocument::attributeName(int line, int column)
+{
+  KateDocCursor cursor(line, column, m_document);
+  QList<KTextEditor::Attribute::Ptr> attributes = m_document->highlight()->attributes(((KateView*) m_document->activeView())->renderer()->config()->schema());
+  KTextEditor::Attribute::Ptr a = attributes[cursor.currentAttrib()];
+  return a->property(KateExtendedAttribute::AttributeName).toString();
+}
+
+bool KateScriptDocument::isAttributeName(int line, int column, const QString &name)
+{
+  return name == attributeName(line, column);
+}
+
 QString KateScriptDocument::variable(const QString &s)
 {
   return m_document->variable(s);
Index: kate/script/katescriptdocument.h
===================================================================
--- kate/script/katescriptdocument.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/script/katescriptdocument.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -94,7 +94,27 @@
     Q_INVOKABLE QString commentMarker(int i);
     Q_INVOKABLE QString commentStart(int i);
     Q_INVOKABLE QString commentEnd(int i);
-    Q_INVOKABLE int attribute(int i, int j);
+
+    /**
+     * Get the syntax highlighting attribute at a given position in the document.
+     */
+    Q_INVOKABLE int attribute(int line, int column);
+
+    /**
+     * Return true if the highlight attribute equals @p attr.
+     */
+    Q_INVOKABLE bool isAttribute(int line, int column, int attr);
+
+    /**
+     * Get the name of the syntax highlighting attribute at the given position.
+     */
+    Q_INVOKABLE QString attributeName(int line, int column);
+
+    /**
+     * Return true is the name of the syntax attribute equals @p name.
+     */
+    Q_INVOKABLE bool isAttributeName(int line, int column, const QString &name);
+
     Q_INVOKABLE QString variable(const QString &s);
     //END
 
Index: kate/completion/katecompletionmodel.cpp
===================================================================
--- kate/completion/katecompletionmodel.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/completion/katecompletionmodel.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -573,7 +573,9 @@
 
 void KateCompletionModel::createGroups()
 {
-  clearGroups(false); //Reset is done below
+  //After clearing the model, it has to be reset, else we will be in an invalid state while inserting
+  //new groups.
+  clearGroups(true);
 
   bool has_groups=false;
   foreach (CodeCompletionModel* sourceModel, m_completionModels) {
@@ -945,8 +947,10 @@
     updateBestMatches();
   }
 
+  if(changeType == Broaden)
+    reset(); //There is a bug in changeCompletions() notification code of the "Broaden" operation, so just reset
+
   clearExpanding(); //We need to do this, or be aware of expanding-widgets while filtering.
-// reset();
   emit contentGeometryChanged();
 }
 
@@ -974,7 +978,7 @@
 #define COMPLETE_DELETE \
   if (rowDeleteStart != -1) { \
     if (!g->isEmpty) \
-      deleteRows(g, filtered, index - rowDeleteStart, rowDeleteStart); \
+      deleteRows(g, filtered, index - rowDeleteStart, rowDeleteStart, changeType != Broaden); \
     filterIndex -= index - rowDeleteStart + 1; \
     index -= index - rowDeleteStart; \
     rowDeleteStart = -1; \
@@ -982,7 +986,7 @@
 
 #define COMPLETE_ADD \
   if (rowAddStart != -1) { \
-    addRows(g, filtered, rowAddStart, rowAdd); \
+    addRows(g, filtered, rowAddStart, rowAdd, changeType != Broaden); \
     filterIndex += rowAdd.count(); \
     index += rowAdd.count(); \
     rowAddStart = -1; \
@@ -1116,7 +1120,9 @@
   COMPLETE_DELETE
   COMPLETE_ADD
 
-  hideOrShowGroup(g);
+  //Only notify the model if the changetype is not broaden, else it will barf on it
+  //because the code above has a bug in that case. We do a reset() anyway afterwards in that case.
+  hideOrShowGroup(g, changeType != Broaden);
 }
 
 int KateCompletionModel::Group::orderNumber() const {
@@ -1150,7 +1156,7 @@
     return orderNumber() < other->orderNumber();
 }
 
-void KateCompletionModel::hideOrShowGroup(Group* g)
+void KateCompletionModel::hideOrShowGroup(Group* g, bool notifyModel)
 {
   if( g == m_argumentHints ) {
     emit argumentHintsChanged();
@@ -1164,10 +1170,10 @@
       g->isEmpty = true;
       int row = m_rowTable.indexOf(g);
       if (row != -1) {
-        if (hasGroups())
+        if (hasGroups() && notifyModel)
           beginRemoveRows(QModelIndex(), row, row);
         m_rowTable.removeAt(row);
-        if (hasGroups())
+        if (hasGroups() && notifyModel)
           endRemoveRows();
         m_emptyGroups.append(g);
       } else {
@@ -1190,23 +1196,27 @@
         row = a+1;
       }
 
-      if (hasGroups())
-        beginInsertRows(QModelIndex(), row, row);
-      else
-        beginInsertRows(QModelIndex(), 0, g->filtered.count());
+      if(notifyModel) {
+        if (hasGroups())
+          beginInsertRows(QModelIndex(), row, row);
+        else
+          beginInsertRows(QModelIndex(), 0, g->filtered.count());
+      }
       m_rowTable.insert(row, g);
-      endInsertRows();
+      if(notifyModel)
+        endInsertRows();
       m_emptyGroups.removeAll(g);
     }
   }
 }
 
-void KateCompletionModel::deleteRows( Group* g, QMutableListIterator<Item> & filtered, int countBackwards, int startRow )
+void KateCompletionModel::deleteRows( Group* g, QMutableListIterator<Item> & filtered, int countBackwards, int startRow, bool notify )
 {
   QModelIndex groupIndex = indexForGroup(g);
   Q_ASSERT(!hasGroups() || groupIndex.isValid());
 
-  beginRemoveRows(groupIndex, startRow, startRow + countBackwards - 1);
+  if(notify)
+    beginRemoveRows(groupIndex, startRow, startRow + countBackwards - 1);
 
   for (int i = 0; i < countBackwards; ++i) {
     filtered.remove();
@@ -1221,12 +1231,13 @@
 
     filtered.previous();
   }
-
-  endRemoveRows();
+  
+  if(notify)
+    endRemoveRows();
 }
 
 
-void KateCompletionModel::addRows( Group * g, QMutableListIterator<Item> & filtered, int startRow, const QList<Item> & newItems )
+void KateCompletionModel::addRows( Group * g, QMutableListIterator<Item> & filtered, int startRow, const QList<Item> & newItems, bool notify )
 {
   //bool notify = true;
 
@@ -1237,13 +1248,13 @@
 
   kDebug( 13035 ) << "Group" << g->title << "addRows" << startRow << "to " << (startRow + newItems.count() - 1);
 
-  //if (notify)
+  if (notify)
     beginInsertRows(groupIndex, startRow, startRow + newItems.count() - 1);
 
   for (int i = 0; i < newItems.count(); ++i)
     filtered.insert(newItems[i]);
 
-  //if (notify)
+  if (notify)
     endInsertRows();
 }
 
@@ -1997,6 +2008,7 @@
 
 //Updates the best-matches group
 void KateCompletionModel::updateBestMatches() {
+  int maxMatches = 300; //We cannot do too many operations here, because they are all executed whenever a character is added. Would be nice if we could split the operations up somewhat using a timer.
 
   m_updateBestMatchesTimer->stop();
   //Maps match-qualities to ModelRows paired together with the BestMatchesCount returned by the items.
@@ -2020,6 +2032,9 @@
       }
       
       ++row;
+      --maxMatches;
+      if(maxMatches < 0)
+        break;
     }
     
     if(!rowsForQuality.isEmpty()) {
@@ -2043,7 +2058,6 @@
   }
   
   ///@todo Cache the CodeCompletionModel::BestMatchesCount
-  int maxMatches = 50; //We cannot do too many operations here, because they are all executed whenever a character is added. Would be nice if we could split the operations up somewhat using a timer.
   foreach (Group* g, m_rowTable) {
     if( g == m_bestMatches )
       continue;
Index: kate/completion/katecompletionmodel.h
===================================================================
--- kate/completion/katecompletionmodel.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/completion/katecompletionmodel.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -271,6 +271,8 @@
 	//-1 if none was set
 	int customSortingKey;
     };
+    
+    bool hasGroups() const;
 
   private:
     void createGroups();
@@ -282,7 +284,7 @@
     QSet<Group*> deleteItems(const QModelIndex& i);
     Group* createItem(const HierarchicalModelHandler&, const QModelIndex& i, bool notifyModel = false);
     void clearGroups(bool reset = true);
-    void hideOrShowGroup(Group* g);
+    void hideOrShowGroup(Group* g, bool notifyModel = true);
     /// When forceGrouping is enabled, all given attributes will be used for grouping, regardless of the completion settings.
     Group* fetchGroup(int attribute, const QString& scope = QString(), bool forceGrouping = false);
     //If this returns nonzero on an index, the index is the header of the returned group
@@ -300,10 +302,9 @@
 
     void changeCompletions(Group* g, changeTypes changeType);
 
-    void deleteRows(Group* g, QMutableListIterator<Item>& filtered, int countBackwards, int startRow);
-    void addRows(Group* g, QMutableListIterator<Item>& filtered, int startRow, const QList<Item>& newItems);
+    void deleteRows(Group* g, QMutableListIterator<Item>& filtered, int countBackwards, int startRow, bool notify);
+    void addRows(Group* g, QMutableListIterator<Item>& filtered, int startRow, const QList<Item>& newItems, bool notify);
 
-    bool hasGroups() const;
     bool hasCompletionModel() const;
 
     /// Removes attributes not used in grouping from the input \a attribute
Index: kate/completion/katecompletionwidget.cpp
===================================================================
--- kate/completion/katecompletionwidget.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/completion/katecompletionwidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -102,6 +102,8 @@
   m_entryList->setColumnWidth(0, 0); //These will be determined automatically in KateCompletionTree::resizeColumns
   m_entryList->setColumnWidth(1, 0);
   m_entryList->setColumnWidth(2, 0);
+  
+  m_entryList->setVerticalScrollMode(QAbstractItemView::ScrollPerItem);
 
   m_argumentHintTree->setParent(0, Qt::ToolTip);
   m_argumentHintTree->setModel(m_argumentHintModel);
@@ -203,6 +205,9 @@
 void KateCompletionWidget::rowsInserted(const QModelIndex& parent, int rowFrom, int rowEnd)
 {
   m_entryList->setAnimated(false);
+  if(!model()->isGroupingEnabled())
+    return;
+
   if (!parent.isValid())
     for (int i = rowFrom; i <= rowEnd; ++i)
       m_entryList->expand(m_presentationModel->index(i, 0, parent));
@@ -446,11 +451,16 @@
           int h = 0;
           for(int a = 0; a < m_presentationModel->columnCount(index); ++a) {
             int localHeight = treeView()->sizeHintForIndex(index.child(row2, a)).height();
-            if(localHeight > 0)
+            if(localHeight > h)
               h = localHeight;
           }
           baseHeight += h;
+          if(baseHeight > maxBaseHeight)
+            break;
         }
+
+        if(baseHeight > maxBaseHeight)
+          break;
       }
     }
     
@@ -461,11 +471,18 @@
   
   if(m_entryList->horizontalScrollBar()->isVisible())
     baseHeight += m_entryList->horizontalScrollBar()->height();
-  
+
+
   if(baseHeight < minBaseHeight)
     baseHeight = minBaseHeight;
-  if(baseHeight > maxBaseHeight)
+  if(baseHeight > maxBaseHeight) {
     baseHeight = maxBaseHeight;
+    m_entryList->setVerticalScrollBarPolicy(Qt::ScrollBarAsNeeded);
+  }else{
+    //Somewhere there seems to be a bug that makes QTreeView add a scroll-bar
+    //even if the content exactly fits in. So forcefully disable the scroll-bar in that case
+    m_entryList->setVerticalScrollBarPolicy(Qt::ScrollBarAlwaysOff);
+}
   
   int newExpandingAddedHeight = 0;
   
@@ -506,7 +523,8 @@
   geom.setHeight(finalHeight);
 
   setGeometry(geom);
-    m_entryList->resize(m_entryList->width(), height() - 2*frameWidth());
+
+  m_entryList->resize(m_entryList->width(), finalHeight - 2*frameWidth());
 }
 
 
@@ -517,25 +535,34 @@
 
   KTextEditor::Cursor cursor = view()->cursorPosition();
 
+  QList<KTextEditor::CodeCompletionModel*> checkCompletionRanges = m_completionRanges.keys();
+
   //Check the models and eventuall abort some
-  QMutableMapIterator<KTextEditor::CodeCompletionModel*, KateSmartRange*> i(m_completionRanges);
-  while (i.hasNext()) {
-      i.next();
-      KTextEditor::CodeCompletionModel *model = i.key();
-      KateSmartRange* range = i.value();
+  for(QList<KTextEditor::CodeCompletionModel*>::iterator it = checkCompletionRanges.begin();
+      it != checkCompletionRanges.end(); ++it) {
+      if(!m_completionRanges.contains(*it))
+        continue;
+
+      KTextEditor::CodeCompletionModel *model = *it;
+      KateSmartRange* range = m_completionRanges[*it];
+
       modelController(model)->updateCompletionRange(view(), *range);
       QString currentCompletion = modelController(model)->filterString(view(), *range, view()->cursorPosition());
       bool abort = modelController(model)->shouldAbortCompletion(view(), *range, currentCompletion);
 
+      if(!m_completionRanges.contains(*it))
+        continue;
+
       if (abort) {
         if (m_completionRanges.count() == 1) {
           //last model - abort whole completion
           abortCompletion();
           return;
         } else {
+          delete m_completionRanges[*it];
+          m_completionRanges.remove(*it);
+
           modelController(model)->aborted(view());
-          i.remove();
-          delete range;
           m_presentationModel->removeCompletionModel(model);
         }
       } else {
@@ -938,13 +965,17 @@
 
 void KateCompletionWidget::switchList() {
   if( m_inCompletionList ) {
-      m_entryList->setCurrentIndex(QModelIndex());
-      if( m_argumentHintModel->rowCount(QModelIndex()) != 0 )
+      if( m_argumentHintModel->rowCount(QModelIndex()) != 0 ) {
+        m_entryList->setCurrentIndex(QModelIndex());
         m_argumentHintTree->setCurrentIndex(m_argumentHintModel->index(m_argumentHintModel->rowCount(QModelIndex())-1, 0));
+      }
   } else {
-      m_argumentHintTree->setCurrentIndex(QModelIndex());
-      if( m_presentationModel->rowCount(QModelIndex()) != 0 )
+      if( m_presentationModel->rowCount(QModelIndex()) != 0 ) {
+        m_argumentHintTree->setCurrentIndex(QModelIndex());
         m_entryList->setCurrentIndex(m_presentationModel->index(0, 0));
+        if(model()->hasGroups()) //If we have groups we have to move on, because the first item is a label
+          m_entryList->nextCompletion();
+      }
   }
   m_inCompletionList = !m_inCompletionList;
 }
Index: kate/view/kateviewinternal.cpp
===================================================================
--- kate/view/kateviewinternal.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kate/view/kateviewinternal.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -834,6 +834,10 @@
   m_doc->editEnd();
   tagRange(selection, true);
   updateDirty();
+#ifdef __GNUC__
+#warning "Probably this updateCursor call is not the real solution for #178379, find it"
+#endif
+  updateCursor(m_cursor, true);
 }
 
 class CalculatingCursor : public KTextEditor::Cursor {
@@ -1201,11 +1205,6 @@
 
 void KateViewInternal::end( bool sel )
 {
-  if (m_view->isCompletionActive()) {
-    view()->completionWidget()->bottom();
-    return;
-  }
-
   QMutexLocker lock(m_doc->smartMutex());
 
   KateTextLayout layout = currentLayout();
@@ -2847,7 +2846,7 @@
     //We need to check whether the mouse position is actually within the widget,
     //because other widgets like the icon border forward their events to this,
     //and we will create invalid text hint requests if we don't check
-    if (m_textHintEnabled && geometry().contains(mapFromGlobal(e->globalPos())))
+    if (m_textHintEnabled && geometry().contains(parentWidget()->mapFromGlobal(e->globalPos())))
     {
        m_textHintTimer.start(m_textHintTimeout);
        m_textHintMouseX=e->x();
Index: kfile/kfilewidget.cpp
===================================================================
--- kfile/kfilewidget.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kfile/kfilewidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -773,7 +773,7 @@
             KUrl::List urlList;                            // one time is always enough.
             int start = 0;
             KUrl topMostUrl;
-            KIO::StatJob *statJob;
+            KIO::StatJob *statJob = 0;
             bool res = false;
 
             // we need to check for a valid first url, so in theory we only iterate one time over
@@ -836,12 +836,13 @@
     } else if (locationEditCurrentTextList.count()) {
         // if we are on file or files mode, and we have an absolute url written by
         // the user, convert it to relative
-        KUrl _url(locationEditCurrentText);
         if (!locationEditCurrentText.isEmpty() && !(mode & KFile::Directory) &&
-            (QDir::isAbsolutePath(locationEditCurrentText) || !_url.protocol().isEmpty())) {
+            (QDir::isAbsolutePath(locationEditCurrentText) ||
+             containsProtocolSection(locationEditCurrentText))) {
+
             QString fileName;
-            KUrl url(_url);
-            KIO::StatJob *statJob = KIO::stat(_url, KIO::HideProgressInfo);
+            KUrl url(locationEditCurrentText);
+            KIO::StatJob *statJob = KIO::stat(url, KIO::HideProgressInfo);
             bool res = KIO::NetAccess::synchronousRun(statJob, 0);
             if (res) {
                 if (!statJob->statResult().isDir()) {
Index: kfile/kdirselectdialog.cpp
===================================================================
--- kfile/kdirselectdialog.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kfile/kdirselectdialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -198,7 +198,7 @@
 
 void KDirSelectDialog::Private::_k_slotContextMenu( const QPoint& pos )
 {
-    m_contextMenu->popup( pos );
+    m_contextMenu->popup( m_treeView->viewport()->mapToGlobal(pos) );
 }
 
 void KDirSelectDialog::Private::_k_slotExpand(const QModelIndex &index)
@@ -248,6 +248,7 @@
 
     d->m_treeView = new KFileTreeView(page);
     d->m_treeView->setDirOnlyMode(true);
+    d->m_treeView->setContextMenuPolicy(Qt::CustomContextMenu);
 
     for (int i = 1; i < d->m_treeView->model()->columnCount(); ++i)
         d->m_treeView->hideColumn(i);
Index: kfile/kfileplacesview.cpp
===================================================================
--- kfile/kfileplacesview.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kfile/kfileplacesview.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -130,7 +130,7 @@
     const KFilePlacesModel *filePlacesModel = static_cast<const KFilePlacesModel*>(index.model());
     Solid::Device device = filePlacesModel->deviceForIndex(index);
 
-    return QSize(option.rect.width(), 2 * KDialog::marginHint() + qMax(iconSize, option.fontMetrics.height()));
+    return QSize(option.rect.width(), option.fontMetrics.height() / 2 + qMax(iconSize, option.fontMetrics.height()));
 }
 
 void KFilePlacesViewDelegate::paint(QPainter *painter, const QStyleOptionViewItem &option, const QModelIndex &index) const
@@ -856,7 +856,7 @@
     }
 
     const int iconSize = KIconLoader::global()->currentSize(KIconLoader::Dialog);
-    return QSize(iconSize + textWidth + 2*KDialog::marginHint(), height);
+    return QSize(iconSize + textWidth + fm.height() / 2, height);
 }
 
 void KFilePlacesView::Private::setCurrentIndex(const QModelIndex &index)
@@ -920,7 +920,7 @@
 
     const int margin = q->style()->pixelMetric(QStyle::PM_FocusFrameHMargin, 0, q) + 1;
     const int maxWidth = q->viewport()->width() - textWidth - 4 * margin - 1;
-    const int maxHeight = ((q->height() - 2 * KDialog::marginHint() * rowCount) / rowCount) - 1;
+    const int maxHeight = ((q->height() - (fm.height() / 2) * rowCount) / rowCount) - 1;
 
     int size = qMin(maxHeight, maxWidth);
 
Index: kfile/kfilepreviewgenerator.cpp
===================================================================
--- kfile/kfilepreviewgenerator.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kfile/kfilepreviewgenerator.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -19,6 +19,7 @@
 #include <config.h> // for HAVE_XRENDER
 
 #include "kfilepreviewgenerator.h"
+#include <kdebug.h>
 
 #include "../kio/kio/defaultviewadapter_p.h"
 #include "../kio/kio/imagefilter_p.h"
@@ -611,15 +612,7 @@
 {
     const QMimeData* mimeData = QApplication::clipboard()->mimeData();
     const KUrl::List cutUrls = KUrl::List::fromMimeData(mimeData);
-
-    const KUrl itemUrl = item.url();
-    foreach (const KUrl& url, cutUrls) {
-        if (url == itemUrl) {
-            return true;
-        }
-    }
-
-    return false;
+    return cutUrls.contains(item.url());
 }
 
 void KFilePreviewGenerator::Private::applyCutItemEffect()
@@ -630,6 +623,8 @@
         return;
     }
 
+    const QSet<KUrl> cutUrls = KUrl::List::fromMimeData(mimeData).toSet();
+
     KFileItemList items;
     KDirLister* dirLister = m_dirModel->dirLister();
     const KUrl::List dirs = dirLister->directories();
@@ -639,7 +634,7 @@
 
     DataChangeObtainer obt(this);
     foreach (const KFileItem& item, items) {
-        if (isCutItem(item)) {
+        if (cutUrls.contains(item.url())) {
             const QModelIndex index = m_dirModel->indexForItem(item);
             const QVariant value = m_dirModel->data(index, Qt::DecorationRole);
             if (value.type() == QVariant::Icon) {
Index: kdoctools/kio_help.cpp
===================================================================
--- kdoctools/kio_help.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdoctools/kio_help.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -21,6 +21,7 @@
 
 
 #include "kio_help.h"
+#include <QDir>
 
 #include <config.h>
 
@@ -147,7 +148,7 @@
 {
    data(fromUnicode( QString(
         "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=%1\"></head>\n"
-        "%2</html>" ).arg( QString( QTextCodec::codecForLocale()->name() ), t ) ) );
+        "%2</html>" ).arg( QString( QTextCodec::codecForLocale()->name() ), Qt::escape(t) ) ) );
 }
 
 HelpProtocol *slave = 0;
@@ -160,18 +161,21 @@
 
 void HelpProtocol::get( const KUrl& url )
 {
-    kDebug( 7119 ) << "get: path=" << url.path()
-              << " query=" << url.query() << endl;
+    kDebug( 7119 ) << "path=" << url.path()
+                   << "query=" << url.query();
 
     bool redirect;
-    QString doc;
-    doc = url.path();
+    QString doc = QDir::cleanPath(url.path());
+    if (doc.contains("..")) {
+        error( KIO::ERR_DOES_NOT_EXIST, url.url() );
+        return;
+    }
 
     if ( !mGhelp ) {
-        if (doc.at(0) != '/')
+        if (!doc.startsWith('/'))
             doc = doc.prepend(QLatin1Char('/'));
 
-        if (doc.at(doc.length() - 1) == '/')
+        if (doc.endsWith('/'))
             doc += "index.html";
     }
 
@@ -260,10 +264,10 @@
                 infoMessage( i18n( "Saving to cache" ) );
 #ifdef Q_WS_WIN
                 QFileInfo fi(file);
-                // make sure filenames do not contain the base path, otherwise 
-                // accessing user data from another location invalids cached files 
-                // Accessing user data under a different path is possible 
-                // when using usb sticks - this may affect unix/mac systems also 
+                // make sure filenames do not contain the base path, otherwise
+                // accessing user data from another location invalids cached files
+                // Accessing user data under a different path is possible
+                // when using usb sticks - this may affect unix/mac systems also
                 QString cache = '/' + fi.absolutePath().remove(KStandardDirs::installPath("html"),Qt::CaseInsensitive).replace('/','_') + '_' + fi.baseName() + '.';
 #else
                 QString cache = file.left( file.length() - 7 );
@@ -388,7 +392,7 @@
 
     while( 1 )
     {
-        qint64 n = f.read(array.data(),array.size()); 
+        qint64 n = f.read(array.data(),array.size());
         if (n == -1) {
             error( KIO::ERR_COULD_NOT_READ, url.path());
             f.close();
Index: kioslave/file/file.protocol
===================================================================
--- kioslave/file/file.protocol	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kioslave/file/file.protocol	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1,6 +1,7 @@
 [Protocol]
 exec=kio_file
 protocol=file
+Icon=folder
 input=none
 output=filesystem
 listing=Name,Type,Size,Date,AccessDate,Access,Owner,Group,Link
Index: kioslave/file/file.cpp
===================================================================
--- kioslave/file/file.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kioslave/file/file.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -139,6 +139,16 @@
 {
 }
 
+#ifdef HAVE_POSIX_ACL
+static QString aclToText(acl_t acl) {
+    ssize_t size = 0;
+    char* txt = acl_to_text(acl, &size);
+    const QString ret = QString::fromLatin1(txt, size);
+    acl_free(txt);
+    return ret;
+}
+#endif
+
 int FileProtocol::setACL( const char *path, mode_t perm, bool directoryDefault )
 {
     int ret = 0;
@@ -157,8 +167,7 @@
         acl = acl_from_text( ACLString.toLatin1() );
         if ( acl_valid( acl ) == 0 ) { // let's be safe
             ret = acl_set_file( path, ACL_TYPE_ACCESS, acl );
-            ssize_t size = acl_size( acl );
-            kDebug(7101) << "Set ACL on: " << path << " to: " << acl_to_text( acl, &size );
+            kDebug(7101) << "Set ACL on: " << path << " to: " << aclToText(acl);
         }
         acl_free( acl );
         if ( ret != 0 ) return ret; // better stop trying right away
@@ -172,8 +181,7 @@
             acl_t acl = acl_from_text( defaultACLString.toLatin1() );
             if ( acl_valid( acl ) == 0 ) { // let's be safe
                 ret += acl_set_file( path, ACL_TYPE_DEFAULT, acl );
-                ssize_t size = acl_size( acl );
-                kDebug(7101) << "Set Default ACL on: " << path << " to: " << acl_to_text( acl, &size );
+                kDebug(7101) << "Set Default ACL on: " << path << " to: " << aclToText(acl);
             }
             acl_free( acl );
         }
@@ -430,7 +438,11 @@
         flags |= O_TRUNC;
     }
 
-    int fd = KDE_open( openPath.data(), flags);
+    int fd = -1;
+    if ( flags & O_CREAT)
+       fd = KDE_open( openPath.data(), flags, 0666);
+    else
+       fd = KDE_open( openPath.data(), flags);
     if ( fd < 0 ) {
         error( KIO::ERR_CANNOT_OPEN_FOR_READING, openPath );
         return;
@@ -1343,14 +1355,12 @@
     }
     if ( withACL ) {
         if ( acl ) {
-            ssize_t size = acl_size( acl );
-            const QString str = QString::fromLatin1( acl_to_text( acl, &size ) );
+            const QString str = aclToText(acl);
             entry.insert( KIO::UDSEntry::UDS_ACL_STRING, str );
             kDebug(7101) << path.data() << "ACL: " << str;
         }
         if ( defaultAcl ) {
-            ssize_t size = acl_size( defaultAcl );
-            const QString str = QString::fromLatin1( acl_to_text( defaultAcl, &size ) );
+            const QString str = aclToText(defaultAcl);
             entry.insert( KIO::UDSEntry::UDS_DEFAULT_ACL_STRING, str );
             kDebug(7101) << path.data() << "DEFAULT ACL: " << str;
         }
Index: kioslave/file/file_win.cpp
===================================================================
--- kioslave/file/file_win.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kioslave/file/file_win.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -56,6 +56,54 @@
     return PROGRESS_CONTINUE;
 }
 
+static UDSEntry createUDSEntryWin( const QFileInfo &fileInfo )
+{
+    UDSEntry entry;
+
+    entry.insert( KIO::UDSEntry::UDS_NAME, fileInfo.fileName() );
+    if( fileInfo.isSymLink() ) {
+        entry.insert( KIO::UDSEntry::UDS_TARGET_URL, fileInfo.symLinkTarget() );
+/* TODO - or not useful on windows?
+        if ( details > 1 ) {
+            // It is a link pointing to nowhere
+            type = S_IFMT - 1;
+            access = S_IRWXU | S_IRWXG | S_IRWXO;
+
+            entry.insert( KIO::UDSEntry::UDS_FILE_TYPE, type );
+            entry.insert( KIO::UDSEntry::UDS_ACCESS, access );
+            entry.insert( KIO::UDSEntry::UDS_SIZE, 0LL );
+            goto notype;
+
+        }
+*/
+    }
+    int type = S_IFREG;
+    int access = 0;
+    if( fileInfo.isDir() )
+        type = S_IFDIR;
+    else if( fileInfo.isSymLink() )
+        type = S_IFLNK;
+    if( fileInfo.isReadable() )
+        access |= S_IRUSR;
+    if( fileInfo.isWritable() )
+        access |= S_IWUSR;
+    if( fileInfo.isExecutable() )
+        access |= S_IXUSR;
+
+    entry.insert( KIO::UDSEntry::UDS_FILE_TYPE, type );
+    entry.insert( KIO::UDSEntry::UDS_ACCESS, access );
+    entry.insert( KIO::UDSEntry::UDS_SIZE, fileInfo.size() );
+    if( fileInfo.isHidden() )
+      entry.insert( KIO::UDSEntry::UDS_HIDDEN, true );
+
+    entry.insert( KIO::UDSEntry::UDS_MODIFICATION_TIME, fileInfo.lastModified().toTime_t() );
+    entry.insert( KIO::UDSEntry::UDS_USER, fileInfo.owner() );
+    entry.insert( KIO::UDSEntry::UDS_GROUP, fileInfo.group() );
+    entry.insert( KIO::UDSEntry::UDS_ACCESS_TIME, fileInfo.lastRead().toTime_t() );
+
+    return entry;
+}
+
 void FileProtocol::copy( const KUrl &src, const KUrl &dest,
                          int _mode, JobFlags _flags )
 {
@@ -134,6 +182,7 @@
     }
 
     QDir dir( url.toLocalFile() );
+    dir.setFilter( QDir::AllEntries|QDir::Hidden );
 
     if ( !dir.exists() ) {
         kDebug(7101) << "========= ERR_DOES_NOT_EXIST  =========";
@@ -150,47 +199,8 @@
     UDSEntry entry;
     while( it.hasNext() ) {
         it.next();
-        QFileInfo fileInfo = it.fileInfo();
+        UDSEntry entry = createUDSEntryWin( it.fileInfo() );
 
-        entry.insert( KIO::UDSEntry::UDS_NAME, it.fileName() );
-        if( fileInfo.isSymLink() ) {
-            entry.insert( KIO::UDSEntry::UDS_TARGET_URL, fileInfo.symLinkTarget() );
-/* TODO - or not useful on windows?
-            if ( details > 1 ) {
-                // It is a link pointing to nowhere
-                type = S_IFMT - 1;
-                access = S_IRWXU | S_IRWXG | S_IRWXO;
-
-                entry.insert( KIO::UDSEntry::UDS_FILE_TYPE, type );
-                entry.insert( KIO::UDSEntry::UDS_ACCESS, access );
-                entry.insert( KIO::UDSEntry::UDS_SIZE, 0LL );
-                goto notype;
-
-            }
-*/
-        }
-        int type = S_IFREG;
-        int access = 0;
-        if( fileInfo.isDir() )
-            type = S_IFDIR;
-        else if( fileInfo.isSymLink() )
-            type = S_IFLNK;
-        if( fileInfo.isReadable() )
-            access |= S_IRUSR;
-        if( fileInfo.isWritable() )
-            access |= S_IWUSR;
-        if( fileInfo.isExecutable() )
-            access |= S_IXUSR;
-
-        entry.insert( KIO::UDSEntry::UDS_FILE_TYPE, type );
-        entry.insert( KIO::UDSEntry::UDS_ACCESS, access );
-        entry.insert( KIO::UDSEntry::UDS_SIZE, fileInfo.size() );
-
-        entry.insert( KIO::UDSEntry::UDS_MODIFICATION_TIME, fileInfo.lastModified().toTime_t() );
-        entry.insert( KIO::UDSEntry::UDS_USER, fileInfo.owner() );
-        entry.insert( KIO::UDSEntry::UDS_GROUP, fileInfo.group() );
-        entry.insert( KIO::UDSEntry::UDS_ACCESS_TIME, fileInfo.lastRead().toTime_t() );
-
         listEntry( entry, false );
         entry.clear();
     }
@@ -232,7 +242,7 @@
            error( KIO::ERR_FILE_ALREADY_EXIST, _dest.filePath() );
            return;
         }
-        
+
         dwFlags = MOVEFILE_REPLACE_EXISTING;
     }
 
@@ -273,7 +283,7 @@
 
     if (isfile) {
         kDebug( 7101 ) << "Deleting file " << _path;
-        
+
         if( DeleteFileW( ( LPCWSTR ) _path.utf16() ) == 0 ) {
             DWORD dwLastErr = GetLastError();
             if ( dwLastErr == ERROR_PATH_NOT_FOUND )
@@ -289,7 +299,9 @@
             }
         }
     } else {
-        kDebug( 7101 ) << "Deleting directory " << url.url();
+        kDebug( 7101 ) << "Deleting directory " << _path;
+        if (!deleteRecursive(_path))
+            return;
         if( RemoveDirectoryW( ( LPCWSTR ) _path.utf16() ) == 0 ) {
             DWORD dwLastErr = GetLastError();
             if ( dwLastErr == ERROR_FILE_NOT_FOUND )
Index: kioslave/http/http.cpp
===================================================================
--- kioslave/http/http.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kioslave/http/http.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -2944,18 +2944,12 @@
     }
 
     // Cache management
-    tIt = tokenizer.iterator("date");
+    tIt = tokenizer.iterator("etag");
     if (tIt.hasNext()) {
         //note QByteArray -> QString conversion will make a deep copy; we want one.
         m_request.cacheTag.etag = QString(tIt.next());
     }
 
-    tIt = tokenizer.iterator("date");
-    if (tIt.hasNext()) {
-        //note QByteArray -> QString conversion will make a deep copy; we want one.
-        m_request.cacheTag.etag = QString(tIt.next());
-    }
-
     tIt = tokenizer.iterator("expires");
     if (tIt.hasNext()) {
         expireDate = KDateTime::fromString(tIt.next(), KDateTime::RFCDate).toTime_t();
Index: kinit/klauncher.cpp
===================================================================
--- kinit/klauncher.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kinit/klauncher.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -971,9 +971,9 @@
        KService::Ptr service = KService::serviceByDesktopName(desktopName);
        if (service)
            send_service_startup_info(request, service,
-                                     request->startup_id, QStringList());
+                                     startup_id.toLocal8Bit(), QStringList());
        else // no .desktop file, no startup info
-           cancel_service_startup_info(request, request->startup_id, envs);
+           cancel_service_startup_info(request, startup_id.toLocal8Bit(), envs);
    }
    msg.setDelayedReply(true);
    request->transaction = msg;
@@ -1105,7 +1105,7 @@
     arg_list << protocol;
     arg_list << mConnectionServer.address();
     arg_list << app_socket;
-    name = KStandardDirs::findExe("kioslave");
+    name = KStandardDirs::findExe(QLatin1String("kioslave"));
 #else
     QString arg1 = protocol;
     QString arg2 = mConnectionServer.address();
Index: kimgio/qimageio_plugin.desktop
===================================================================
--- kimgio/qimageio_plugin.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kimgio/qimageio_plugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -55,6 +55,7 @@
 Comment[ro]=Modul QImageIOHandler
 Comment[ru]=Расширение QImageIOHandler
 Comment[se]=QImageIOHandler-modula
+Comment[si]=QImageIOHandler ප්ලගීනය
 Comment[sk]=QImageIOHandler rozšírenie
 Comment[sl]=Vstavek QImageIOHandler
 Comment[sr]=Прикључак QImageIO руковаоца
Index: kio/kio/kfileitem.cpp
===================================================================
--- kio/kio/kfileitem.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/kfileitem.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -420,10 +420,22 @@
     // even though it's not really part of the permissions per se.
     if (m_bLink)
         buffer[0] = 'l';
-    else if (m_fileMode != KFileItem::Unknown && S_ISDIR(m_fileMode))
-        buffer[0] = 'd';
-    else
+    else if (m_fileMode != KFileItem::Unknown) {
+        if (S_ISDIR(m_fileMode))
+            buffer[0] = 'd';
+        else if (S_ISSOCK(m_fileMode))
+            buffer[0] = 's';
+        else if (S_ISCHR(m_fileMode))
+            buffer[0] = 'c';
+        else if (S_ISBLK(m_fileMode))
+            buffer[0] = 'b';
+        else if (S_ISFIFO(m_fileMode))
+            buffer[0] = 'p';
+        else
+            buffer[0] = '-';
+    } else {
         buffer[0] = '-';
+    }
 
     buffer[1] = ((( perm & S_IRUSR ) == S_IRUSR ) ? 'r' : '-' );
     buffer[2] = ((( perm & S_IWUSR ) == S_IWUSR ) ? 'w' : '-' );
Index: kio/kio/kacl.cpp
===================================================================
--- kio/kio/kacl.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/kacl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -177,8 +177,9 @@
 #if 0
 static void printACL( acl_t acl, const QString &comment )
 {
-    ssize_t size = acl_size( acl );
-    kDebug() << comment << acl_to_text( acl, &size );
+    const char* txt = acl_to_text(acl);
+    kDebug() << comment << txt;
+    acl_free(txt);
 }
 #endif
 #endif
@@ -609,8 +610,11 @@
 QString KACL::asString() const
 {
 #ifdef HAVE_POSIX_ACL
-    ssize_t size = acl_size( d->m_acl );
-    return QString::fromLatin1( acl_to_text( d->m_acl, &size ) );
+    ssize_t size = 0;
+    char* txt = acl_to_text(d->m_acl, &size);
+    const QString ret = QString::fromLatin1(txt, size);
+    acl_free(txt);
+    return ret;
 #else
     return QString();
 #endif
Index: kio/kio/renamedialog.h
===================================================================
--- kio/kio/renamedialog.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/renamedialog.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1,6 +1,6 @@
 /* This file is part of the KDE libraries
     Copyright (C) 2000 Stephan Kulow <coolo@kde.org>
-                       David Faure <faure@kde.org>
+                  1999 - 2008 David Faure <faure@kde.org>
                   2001 Holger Freyther <freyther@kde.org>
 
     This library is free software; you can redistribute it and/or
Index: kio/kio/delegateanimationhandler.cpp
===================================================================
--- kio/kio/delegateanimationhandler.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/delegateanimationhandler.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -110,11 +110,23 @@
 
 
 DelegateAnimationHandler::DelegateAnimationHandler(QObject *parent)
-    : QObject(parent), timerId(0)
+    : QObject(parent)
 {
 }
 
+DelegateAnimationHandler::~DelegateAnimationHandler()
+{
+    timer.stop();
 
+    QMapIterator<const QAbstractItemView*, AnimationList*> i(animationLists);
+    while (i.hasNext()) {
+        i.next();
+        qDeleteAll(*i.value());
+        delete i.value();
+    }
+    animationLists.clear();
+}
+
 AnimationState *DelegateAnimationHandler::animationState(const QStyleOption &option,
                                                          const QModelIndex &index,
                                                          const QAbstractItemView *view)
@@ -216,10 +228,8 @@
     state->time.start();
     state->animating = true;
 
-    if (!timerId)
-    {
-        timerId = startTimer(1000 / 30); // 30 fps
-    }
+    if (!timer.isActive())
+        timer.start(1000 / 30, this); // 30 fps
 }
 
 
@@ -290,11 +300,8 @@
         activeAnimations += runAnimations(list, view);
     }
 
-    if (activeAnimations == 0 && timerId)
-    {
-        killTimer(timerId);
-        timerId = 0;
-    }
+    if (activeAnimations == 0 && timer.isActive())
+        timer.stop();
 }
 
 }
Index: kio/kio/kdirwatch.cpp
===================================================================
--- kio/kio/kdirwatch.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/kdirwatch.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -335,7 +335,7 @@
                 kDebug(7001).nospace() << counter << "instance(s) monitoring the new"
                                        << (isDir ? "dir " : "file ") << tpath;
               } else {
-                kDebug(7001) << "ERROR: couldn't stat the new item" << tpath;
+                //kDebug(7001) << "ERROR: couldn't stat the new item" << tpath;
               }
             }
           }
@@ -1418,7 +1418,7 @@
             msg += (isDir ? "dir " : "file ") + tpath;
             kDebug(7001) << msg;
           } else {
-            kDebug(7001) << "ERROR: couldn't stat the new item" << tpath;
+            //kDebug(7001) << "ERROR: couldn't stat the new item" << tpath;
           }
         }
       }
Index: kio/kio/renamedialog.cpp
===================================================================
--- kio/kio/renamedialog.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/renamedialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1,7 +1,7 @@
 /* This file is part of the KDE libraries
     Copyright (C) 2000 Stephan Kulow <coolo@kde.org>
-                       David Faure <faure@kde.org>
-                  2001,2006 Holger Freyther <freyther@kde.org>
+                  1999 - 2008 David Faure <faure@kde.org>
+                  2001, 2006 Holger Freyther <freyther@kde.org>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -293,9 +293,10 @@
     layout2->addWidget( d->m_pLineEdit );
     if ( d->bRename ) {
         const QString fileName = d->dest.fileName();
-    d->m_pLineEdit->setText( KIO::decodeFileName( fileName ) );
+        d->m_pLineEdit->setText( KIO::decodeFileName( fileName ) );
         connect(d->m_pLineEdit, SIGNAL(textChanged(const QString &)),
                 SLOT(enableRenameButton(const QString &)));
+        d->m_pLineEdit->setFocus();
     } else {
         d->m_pLineEdit->hide();
     }
Index: kio/kio/job.cpp
===================================================================
--- kio/kio/job.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/job.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1491,6 +1491,7 @@
     Q_ASSERT( d->m_data.isNull() ); // check that we're only called once
     Q_ASSERT( d->m_uploadOffset == 0 ); // no upload started yet
     d->m_data = arr;
+    setTotalSize( d->m_data.size() );
 }
 
 QByteArray StoredTransferJob::data() const
Index: kio/kio/delegateanimationhandler_p.h
===================================================================
--- kio/kio/delegateanimationhandler_p.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/delegateanimationhandler_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -22,6 +22,7 @@
 #ifndef DELEGATEANIMATIONHANDLER_P_H
 #define DELEGATEANIMATIONHANDLER_P_H
 
+#include <QBasicTimer>
 #include <QMap>
 #include <QLinkedList>
 #include <QPersistentModelIndex>
@@ -80,7 +81,7 @@
 
 public:
     DelegateAnimationHandler(QObject *parent = 0);
-    ~DelegateAnimationHandler() {}
+    ~DelegateAnimationHandler();
 
     AnimationState *animationState(const QStyleOption &option, const QModelIndex &index, const QAbstractItemView *view);
 
@@ -97,7 +98,7 @@
 private:
     QMap<const QAbstractItemView*, AnimationList*> animationLists;
     QTime fadeInAddTime;
-    int timerId;
+    QBasicTimer timer;
 };
 
 }
Index: kio/kio/kdirmodel.cpp
===================================================================
--- kio/kio/kdirmodel.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kio/kdirmodel.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -40,8 +40,8 @@
 
 static KUrl cleanupUrl(const KUrl& url) {
     KUrl u = url;
+    u.cleanPath(); // remove double slashes in the path, simplify "foo/." to "foo/", etc.
     u.adjustPath(KUrl::RemoveTrailingSlash); // KDirLister does this too, so we remove the slash before comparing with the root node url.
-    u.cleanPath(); // remove double slashes in the path
     u.setQuery(QString());
     u.setRef(QString());
     return u;
Index: kio/kfile/kpropertiesdialog.cpp
===================================================================
--- kio/kfile/kpropertiesdialog.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/kfile/kpropertiesdialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1732,7 +1732,6 @@
    */
   int i, maxEntries = 1000;
   struct passwd *user;
-  struct group *ge;
 
   /* File owner: For root, offer a KLineEdit with autocompletion.
    * For a user, who can never chown() a file, offer a QLabel.
@@ -1768,38 +1767,27 @@
     strUser = user->pw_name;
 
 #ifdef Q_OS_UNIX
-  setgrent();
-  for (i=0; ((ge = getgrent()) != 0L) && (i < maxEntries); ++i)
-  {
-    if (IamRoot)
-      groupList += QString::fromLatin1(ge->gr_name);
-    else
-    {
-      /* pick the groups to which the user belongs */
-      char ** members = ge->gr_mem;
-      char * member;
-      while ((member = *members) != 0L) {
-        if (strUser == member) {
-          groupList += QString::fromLocal8Bit(ge->gr_name);
-          break;
+    // pick the groups to which the user belongs
+    int groupCount = 0;
+    gid_t *groups = NULL;
+    if (getgrouplist(strUser, user->pw_gid, NULL, &groupCount) < 0) {
+        groups = new gid_t[groupCount];
+        if (groups) {
+            getgrouplist(strUser, user->pw_gid, groups, &groupCount);
+        } else {
+            groupCount = 0;
         }
-        ++members;
-      }
     }
-  }
-  endgrent();
-#endif //Q_OS_UNIX
 
-  /* add the effective Group to the list .. */
-  ge = getgrgid (getegid());
-  if (ge) {
-    QString name = QString::fromLatin1(ge->gr_name);
-    if (name.isEmpty())
-      name.setNum(ge->gr_gid);
-    if (groupList.indexOf(name) == -1)
-      groupList += name;
-  }
+    for (i = 0; i < groupCount; i++) {
+        struct group *mygroup = getgrgid(groups[i]);
+        if (mygroup)
+            groupList += QString::fromLocal8Bit(mygroup->gr_name);
+    }
 
+    delete[] groups;
+#endif //Q_OS_UNIX
+
   bool isMyGroup = groupList.contains(d->strGroup);
 
   /* add the group the file currently belongs to ..
Index: kio/misc/kpac/proxyscout.notifyrc
===================================================================
--- kio/misc/kpac/proxyscout.notifyrc	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/misc/kpac/proxyscout.notifyrc	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -334,7 +334,7 @@
 Comment[gu]=પ્રોક્સી રૂપરેખાંકન સ્ક્રિપ્ટ ડાઉનલોડ કરી શકાતી નથી
 Comment[he]=אין אפשרות להוריד את תסריט הגדרות שרת המתווך
 Comment[hi]=प्रॉक्सी कॉन्फ़िगरेशन स्क्रिप्ट को डाउनलोड नहीं किया जा सका
-Comment[hne]=प्राक्सी कान्फिगरेसन स्क्रिप्ट ल डाउनलोड नइ कर सकीस
+Comment[hne]=प्राक्सी कान्फिगरेसन स्क्रिप्ट ल डाउनलोड नइ कर सकिस
 Comment[hr]=Skripta konfiguriranja proxyja nije mogla biti preuzetom s Interneta
 Comment[hsb]=Konfiguraciski skript za proxy njehodźi so sćahnyć
 Comment[hu]=A proxyszkriptet nem sikerült letölteni
Index: kio/misc/kmailservice.protocol
===================================================================
--- kio/misc/kmailservice.protocol	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/misc/kmailservice.protocol	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -10,6 +10,6 @@
 makedir=false
 deleting=false
 X-DocPath=kioslave/mailto/index.html
-Icon=mail_new
+Icon=mail-message-new
 Class=:internet
 URIMode=mailto
Index: kio/tests/kdirmodeltest.cpp
===================================================================
--- kio/tests/kdirmodeltest.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/tests/kdirmodeltest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -591,8 +591,12 @@
 
     QTest::newRow("the root, nothing to do")
         << false << QString() << QStringList();
+    QTest::newRow(".")
+        << false << "." << (QStringList());
     QTest::newRow("subdir")
         << false << "subdir" << (QStringList()<<"subdir");
+    QTest::newRow("subdir/.")
+        << false << "subdir/." << (QStringList()<<"subdir");
 
     const QString subsubdir = "subdir/subsubdir";
     // Must list root, emit expand for subdir, list subdir, emit expand for subsubdir.
@@ -655,7 +659,7 @@
     }
 
     // Now it should exist
-    if (!expandToPath.isEmpty()) {
+    if (!expandToPath.isEmpty() && expandToPath != ".") {
         kDebug() << "Do I know" << m_urlToExpandTo << "?";
         QVERIFY(m_dirModelForExpand->indexForUrl(m_urlToExpandTo).isValid());
     }
Index: kio/data.protocol
===================================================================
--- kio/data.protocol	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/data.protocol	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -3,7 +3,7 @@
 input=stream
 output=none
 reading=true
-Icon=www
+Icon=applications-internet
 Class=:internet
 Description=A kioslave for data URIs (rfc2397)
 Description[af]= ´n kioslave vir data URIs (rfc2397)
Index: kio/application.desktop
===================================================================
--- kio/application.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kio/application.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -65,6 +65,7 @@
 Name[ro]=Aplicație
 Name[ru]=Приложение
 Name[se]=Prográmma
+Name[si]=යෙදුම්
 Name[sk]=Aplikácia
 Name[sl]=Program
 Name[sr]=Програм
Index: kdeui/kernel/kstyle.cpp
===================================================================
--- kdeui/kernel/kstyle.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/kernel/kstyle.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -3226,12 +3226,6 @@
                 }
                 State mflags = bflags;
 
-                // mouse pressed...
-                if (tool->activeSubControls & SC_ToolButton)
-                    bflags |= State_Sunken;
-                if (tool->activeSubControls & SC_ToolButtonMenu)
-                    mflags |= State_Sunken;
-
                 QStyleOption tOpt(0);
                 tOpt.palette = pal;
 
Index: kdeui/dialogs/kcupsoptionsjobwidget_p.cpp
===================================================================
--- kdeui/dialogs/kcupsoptionsjobwidget_p.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/dialogs/kcupsoptionsjobwidget_p.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -33,7 +33,8 @@
 #include <kcombobox.h>
 #include <klineedit.h>
 #include <klocale.h>
-#include <kdebug.h>
+#include <kdatetime.h>
+//#include <kdebug.h>
 
 /** @internal */
 KCupsOptionsJobWidget::KCupsOptionsJobWidget( QPrintDialog *parent ) : KCupsOptionsWidget( parent )
@@ -56,14 +57,20 @@
 {
     switch ( jobHold() )
     {
-        case NoHold       :                                                 break; //default
+        case NoHold       : break; //default
         case Indefinite   : setCupsOption( cupsOptions, "job-hold-until", "indefinite"   ); break;
         case DayTime      : setCupsOption( cupsOptions, "job-hold-until", "day-time"     ); break;
         case Night        : setCupsOption( cupsOptions, "job-hold-until", "night"        ); break;
         case SecondShift  : setCupsOption( cupsOptions, "job-hold-until", "second-shift" ); break;
         case ThirdShift   : setCupsOption( cupsOptions, "job-hold-until", "third-shift"  ); break;
         case Weekend      : setCupsOption( cupsOptions, "job-hold-until", "weekend"      ); break;
-        case SpecificTime : setCupsOption( cupsOptions, "job-hold-until", jobHoldTime().toString("HH:mm") ); break;
+        case SpecificTime : //CUPS expects the time in UTC, user has entered in local time, so get the UTS equivalent
+                            KDateTime localDateTime = KDateTime::currentLocalDateTime();
+                            //Check if time is for tomorrow in case of DST change overnight
+                            if ( jobHoldTime() < localDateTime.time() ) localDateTime.addDays(1);
+                            localDateTime.setTime( jobHoldTime() );
+                            setCupsOption( cupsOptions, "job-hold-until", localDateTime.toUtc().time().toString("HH:mm") );
+                            break;
     }
 
     if ( !jobBilling().isEmpty() ) {
Index: kdeui/dialogs/kdialog.cpp
===================================================================
--- kdeui/dialogs/kdialog.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/dialogs/kdialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -149,6 +149,10 @@
   mButtonList.insert( key, button );
   mButtonSignalMapper.setMapping( button, key );
 
+  // since focus may not be on default button, disable auto-default
+  // (an auto-defaulted focused button "beats" the real default)
+  button->setAutoDefault( false );
+
     QObject::connect(button, SIGNAL(clicked()),
            &mButtonSignalMapper, SLOT( map() ) );
 }
Index: kdeui/shortcuts/kshortcut.cpp
===================================================================
--- kdeui/shortcuts/kshortcut.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/shortcuts/kshortcut.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -106,6 +106,8 @@
     if (sCuts.count() >= 1) {
         QString k = sCuts.at(0);
         k.replace( "Win+", "Meta+" ); // workaround for KDE3-style shortcuts
+        k.replace("Plus", "+"); // workaround for KDE3-style "Alt+Plus"
+        k.replace("Minus", "-"); // workaround for KDE3-style "Alt+Plus"
         d->primary = QKeySequence::fromString(k);
         // Complain about a unusable shortcuts sequence only if we have got
         // something.
Index: kdeui/tests/kshortcuttest.cpp
===================================================================
--- kdeui/tests/kshortcuttest.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/tests/kshortcuttest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -67,6 +67,12 @@
         cut = KShortcut("Meta+E");
         QVERIFY(cut.primary()[0] == (Qt::META | Qt::Key_E));
 
+        //qDebug() << QKeySequence(Qt::ALT | Qt::Key_Plus).toString();
+        //qDebug() << QKeySequence(Qt::ALT | Qt::Key_Minus).toString();
+        cut = KShortcut("Alt+Plus"); // KDE3 said "Alt+Plus", while Qt4 says "Alt++", so KShortcut has to handle this
+        QVERIFY(cut.primary()[0] == (Qt::ALT | Qt::Key_Plus));
+        cut = KShortcut("Alt+Minus"); // KDE3 said "Alt+Minus", while Qt4 says "Alt+-", so KShortcut has to handle this
+        QVERIFY(cut.primary()[0] == (Qt::ALT | Qt::Key_Minus));
     }
 };
 
Index: kdeui/tests/kiconloader_unittest.cpp
===================================================================
--- kdeui/tests/kiconloader_unittest.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/tests/kiconloader_unittest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -128,6 +128,13 @@
         QTest::newRow("non-existing icon") << "foo-bar" << "application-octet-stream.png";
         // Test this again, because now we won't go into the "fast path" of loadMimeTypeIcon anymore.
         QTest::newRow("existing icon again") << "text-plain" << "text-plain.png";
+        QTest::newRow("generic fallback") << "image-foo-bar" << "image-x-generic.png";
+        QTest::newRow("image-x-generic itself") << "image-x-generic" << "image-x-generic.png";
+        QTest::newRow("x-office-document icon") << "x-office-document" << "x-office-document.png";
+        QTest::newRow("mimetype generic icon") << "application-x-fluid" << "x-office-document.png";
+        QTest::newRow("unavailable generic icon") << "application/x-font-vfont" << "application-octet-stream.png";
+        QTest::newRow("#184852") << "audio/x-tuxguitar" << "audio-x-generic.png";
+
     }
 
     void testLoadMimeTypeIcon()
Index: kdeui/widgets/ktextedit.cpp
===================================================================
--- kdeui/widgets/ktextedit.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/widgets/ktextedit.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -19,6 +19,7 @@
 */
 
 #include "ktextedit.h"
+#include <kdebug.h>
 
 #include <QApplication>
 #include <QClipboard>
@@ -364,6 +365,15 @@
     cursor.movePosition( QTextCursor::EndOfLine );
     parent->setTextCursor( cursor );
     return true;
+  } else if (KStandardShortcut::find().contains(key)) {
+        parent->slotFind();
+        return true;
+  } else if (KStandardShortcut::findNext().contains(key)) {
+        parent->slotFindNext();
+        return true;
+  } else if (KStandardShortcut::replace().contains(key)) {
+        parent->slotReplace();
+        return true;
   } else if ( KStandardShortcut::pasteSelection().contains( key ) ) {
     QString text = QApplication::clipboard()->text( QClipboard::Selection );
     if ( !text.isEmpty() )
@@ -407,7 +417,7 @@
           separatorAction = actionList.at( idx );
       if ( separatorAction )
       {
-          KAction *clearAllAction = KStandardAction::clear(this, SLOT(undoableClear()), this);
+          KAction *clearAllAction = KStandardAction::clear(this, SLOT(undoableClear()), popup);
           if ( emptyDocument )
               clearAllAction->setEnabled( false );
           popup->insertAction( separatorAction, clearAllAction );
@@ -434,15 +444,17 @@
 
       if (d->findReplaceEnabled)
       {
-          KAction *findAction = KStandardAction::find( this, SLOT( slotFind() ), this );
-          KAction *findNextAction = KStandardAction::findNext( this, SLOT( slotFindNext() ), this );
-          KAction *replaceAction = KStandardAction::replace( this, SLOT( slotReplace() ), this );
+          KAction *findAction = KStandardAction::find(this, SLOT(slotFind()), popup);
+          KAction *findNextAction = KStandardAction::findNext(this, SLOT(slotFindNext()), popup);
+          KAction *replaceAction = KStandardAction::replace(this, SLOT(slotReplace()), popup);
           if (emptyDocument)
           {
               findAction->setEnabled(false);
-              findNextAction->setEnabled(d->find != 0 );
+              findNextAction->setEnabled(false );
               replaceAction->setEnabled(false);
           }
+	  else
+	      findNextAction->setEnabled(d->find != 0 );
           popup->addSeparator();
           popup->addAction(findAction);
           popup->addAction(findNextAction);
@@ -472,14 +484,14 @@
     QString selectedWord = wordSelectCursor.selectedText();
 
     // Clear the selection again, we re-select it below (without the apostrophes).
-    wordSelectCursor.movePosition(QTextCursor::PreviousCharacter,
-                                  QTextCursor::MoveAnchor, selectedWord.size());
+    wordSelectCursor.setPosition(wordSelectCursor.position()-selectedWord.size());
     if (selectedWord.startsWith('\'') || selectedWord.startsWith('\"')) {
         selectedWord = selectedWord.right(selectedWord.size() - 1);
         wordSelectCursor.movePosition(QTextCursor::NextCharacter, QTextCursor::MoveAnchor);
     }
     if (selectedWord.endsWith('\'') || selectedWord.endsWith('\"'))
         selectedWord.chop(1);
+
     wordSelectCursor.movePosition(QTextCursor::NextCharacter,
                                   QTextCursor::KeepAnchor, selectedWord.size());
 
@@ -734,6 +746,14 @@
         return;
     }
 
+    if(d->repDlg->pattern().isEmpty()) {
+        d->replace->disconnect(this);
+        d->replace->deleteLater(); // we are in a slot connected to m_replace, don't delete it right away
+        d->replace = 0;
+        ensureCursorVisible();
+        return;
+    }
+
     delete d->replace;
     d->replace = new KReplace(d->repDlg->pattern(), d->repDlg->replacement(), d->repDlg->options(), this);
     d->repIndex = 0;
@@ -791,7 +811,13 @@
         // Should really assert()
         return;
     }
-
+    if( d->findDlg->pattern().isEmpty())
+    {
+        d->find->disconnect(this);
+        d->find->deleteLater(); // we are in a slot connected to m_find, don't delete right away
+        d->find = 0;
+        return;
+    }
     delete d->find;
     d->find = new KFind(d->findDlg->pattern(), d->findDlg->options(), this);
     d->findIndex = 0;
@@ -815,6 +841,13 @@
 {
     if (!d->find)
         return;
+    if(document()->isEmpty())
+    {
+        d->find->disconnect(this);
+        d->find->deleteLater(); // we are in a slot connected to m_find, don't delete right away
+        d->find = 0;
+        return;
+    }
 
     KFind::Result res = KFind::NoMatch;
     if (d->find->needData())
@@ -909,6 +942,12 @@
     return true;
   } else if ( KStandardShortcut::pasteSelection().contains( key ) ) {
     return true;
+  } else if (KStandardShortcut::find().contains(key)) {
+      return true;
+  } else if (KStandardShortcut::findNext().contains(key)) {
+      return true;
+  } else if (KStandardShortcut::replace().contains(key)) {
+      return true;
   } else if (event->matches(QKeySequence::SelectAll)) { // currently missing in QTextEdit
       return true;
   } else if (event->modifiers() == Qt::ControlModifier &&
Index: kdeui/widgets/kstatusbar.cpp
===================================================================
--- kdeui/widgets/kstatusbar.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/widgets/kstatusbar.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -84,8 +84,6 @@
     bool grip_enabled = group.readEntry(QLatin1String("SizeGripEnabled"), false);
 #endif
     setSizeGripEnabled(grip_enabled);
-
-    setStyleSheet( "::item { border: 0px; }" );
 }
 
 KStatusBar::~KStatusBar ()
Index: kdeui/widgets/ktabwidget.cpp
===================================================================
--- kdeui/widgets/ktabwidget.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/widgets/ktabwidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -170,7 +170,6 @@
   }
 
   title = KStringHandler::rsqueeze( title, m_currentMaxLength ).leftJustified( m_minLength, ' ' );
-  title.replace( '&', "&&" );
 
   if ( m_parent->QTabWidget::tabText( index ) != title )
     m_parent->QTabWidget::setTabText( index, title );
Index: kdeui/widgets/klineedit.cpp
===================================================================
--- kdeui/widgets/klineedit.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/widgets/klineedit.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -67,6 +67,7 @@
         drawClickMsg = false;
         enableClickMsg = false;
         threeStars = false;
+        completionRunning = false;
         if ( !initialized )
         {
             KConfigGroup config( KGlobal::config(), "General" );
@@ -103,6 +104,15 @@
             clearButton->setAnimationsEnabled(KGlobalSettings::graphicEffectsLevel() & KGlobalSettings::SimpleAnimationEffects);
         }
     }
+    
+    void _k_updateUserText( const QString &txt)
+    {  
+        if ((!completionRunning) && (txt != userText))
+	{
+	    userText = txt;
+	    emit q->userTextChanged(txt);
+	}
+    }
 
     /**
      * Checks whether we should/should not consume a key used as a shortcut.
@@ -123,11 +133,13 @@
     bool handleURLDrops:1;
     bool grabReturnKeyEvents:1;
     bool enableSqueezedText:1;
+    bool completionRunning:1; 
 
     int squeezedEnd;
     int squeezedStart;
     QPalette::ColorRole bgRole;
     QString squeezedText;
+    QString userText;
 
     QString clickMessage;
     bool enableClickMsg:1;
@@ -228,6 +240,9 @@
     QStyle *lineEditStyle = new KLineEditStyle(this, d);
     lineEditStyle->setParent(this);
     setStyle(lineEditStyle);
+  
+    connect( this, SIGNAL(textChanged( const QString&)), this, SLOT(_k_updateUserText( const QString&)));
+
 }
 
 QString KLineEdit::clickMessage() const
@@ -639,6 +654,7 @@
     QLineEdit::resizeEvent(ev);
 }
 
+
 void KLineEdit::keyPressEvent( QKeyEvent *e )
 {
     const int key = e->key() | e->modifiers();
@@ -650,6 +666,9 @@
     }
     else if ( KStandardShortcut::paste().contains( key ) )
     {
+      // TODO:
+      // we should restore the original text (not autocompleted), otherwise the paste
+      // will get into troubles Bug: 134691
         paste();
         return;
     }
@@ -750,7 +769,11 @@
                 setText(old_txt);
                 setCursorPosition(cPosition);
                 if (e->key() ==Qt::Key_Right && cPosition > start )
+		{
                     setSelection(cPosition, old_txt.length());
+		    //the user explicitly accepted the autocompletion
+		    d->_k_updateUserText(text());
+		}
                 else
                     setSelection(start, old_txt.length());
 
@@ -1541,6 +1564,14 @@
 
 void KLineEdit::setUserSelection(bool userSelection)
 {
+    //if !d->userSelection && userSelection we are accepting a completion, 
+    //so trigger an update 
+  
+    if (!d->userSelection && userSelection) 
+    { 
+	d->_k_updateUserText(text());
+    }
+  
     QPalette p = palette();
 
     if (userSelection)
@@ -1590,6 +1621,11 @@
     return text();
 }
 
+QString KLineEdit::userText() const
+{
+    return d->userText;
+}
+
 bool KLineEdit::autoSuggest() const
 {
     return d->autoSuggest;
@@ -1701,10 +1737,11 @@
     if (emitSignals()) {
         emit completion(txt); // emit when requested...
     }
-
+    d->completionRunning = true;
     if (handleSignals()) {
         makeCompletion(txt);  // handle when requested...
     }
+    d->completionRunning = false;
 }
 
 #include "klineedit.moc"
Index: kdeui/widgets/kpushbutton.cpp
===================================================================
--- kdeui/widgets/kpushbutton.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/widgets/kpushbutton.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -172,6 +172,7 @@
     QPushButton::setText( d->item.text() );
     setIcon( d->item.icon() );
     setToolTip( d->item.toolTip() );
+    setEnabled( d->item.isEnabled() );
     setWhatsThis( d->item.whatsThis() );
 }
 
Index: kdeui/widgets/kkeysequencewidget.cpp
===================================================================
--- kdeui/widgets/kkeysequencewidget.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/widgets/kkeysequencewidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -248,7 +248,7 @@
     QString conflictingShortcuts;
     Q_FOREACH(const KAction *action, actions) {
         conflictingShortcuts += i18n("Shortcut(s) '%1' for action '%2'\n",
-                action->shortcut().toString(),
+                action->shortcut().toString(QKeySequence::NativeText),
                 KGlobal::locale()->removeAcceleratorMarker(action->text()));
     }
     QString message = i18n(
Index: kdeui/widgets/klineedit.h
===================================================================
--- kdeui/widgets/klineedit.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/widgets/klineedit.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -309,6 +309,14 @@
     QString originalText() const;
 
     /**
+     * Returns the text as given by the user (i.e. not autocompleted)
+     * if the widget has autocompletion disabled, this function
+     * returns the same as QLineEdit::text().
+     * @since 4.2.2
+     */
+    QString userText() const;
+
+    /**
      * Set the completion-box to be used in completion mode
      * KGlobalSettings::CompletionPopup.
      * This will do nothing if a completion-box already exists.
@@ -387,6 +395,12 @@
     void substringCompletion( const QString& );
 
     /**
+     * Emitted when the text is changed NOT by autocompletion
+     * @since 4.2.2
+     */
+    void userTextChanged( const QString & ); 
+
+    /**
      * Emitted when the text rotation key-bindings are pressed.
      *
      * The argument indicates which key-binding was pressed.
@@ -637,6 +651,7 @@
     KLineEditPrivate *const d;
 
     Q_PRIVATE_SLOT( d, void _k_slotSettingsChanged( int category ) )
+    Q_PRIVATE_SLOT( d, void _k_updateUserText(const QString&) )
 };
 
 #endif
Index: kdeui/icons/kiconloader.cpp
===================================================================
--- kdeui/icons/kiconloader.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/icons/kiconloader.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -175,6 +175,14 @@
 
     /**
      * @internal
+     * tries to find an icon with the name.
+     * This is one layer above findMatchingIcon -- it also implements generic fallbacks
+     * such as generic icons for mimetypes.
+     */
+    K3Icon findMatchingIconWithGenericFallbacks(const QString& name, int size) const;
+
+    /**
+     * @internal
      * Adds themes installed in the application's directory.
      **/
     void addAppThemes(const QString& appname);
@@ -238,6 +246,53 @@
     void drawOverlays(const KIconLoader *loader, KIconLoader::Group group, int state, QPixmap& pix, const QStringList& overlays);
 };
 
+class KIconLoaderGlobalData
+{
+public:
+    KIconLoaderGlobalData() {
+        const QStringList genericIconsFiles = KGlobal::dirs()->findAllResources("xdgdata-mime", "generic-icons");
+        //kDebug() << genericIconsFiles;
+        Q_FOREACH(const QString& file, genericIconsFiles) {
+            parseGenericIconsFiles(file);
+        }
+    }
+
+    QString genericIconFor(const QString& icon) const {
+        return m_genericIcons.value(icon);
+    }
+
+private:
+    void parseGenericIconsFiles(const QString& fileName);
+    QHash<QString, QString> m_genericIcons;
+};
+
+void KIconLoaderGlobalData::parseGenericIconsFiles(const QString& fileName)
+{
+    QFile file(fileName);
+    if (file.open(QIODevice::ReadOnly)) {
+        QTextStream stream(&file);
+        stream.setCodec("ISO 8859-1");
+        while (!stream.atEnd()) {
+            const QString line = stream.readLine();
+            if (line.isEmpty() || line[0] == '#')
+                continue;
+            const int pos = line.indexOf(':');
+            if (pos == -1) // syntax error
+                continue;
+            QString mimeIcon = line.left(pos);
+            const int slashindex = mimeIcon.indexOf(QLatin1Char('/'));
+            if (slashindex != -1) {
+                mimeIcon[slashindex] = QLatin1Char('-');
+            }
+
+            const QString genericIcon = line.mid(pos+1);
+            m_genericIcons.insert(mimeIcon, genericIcon);
+            //kDebug(264) << mimeIcon << "->" << genericIcon;
+        }
+    }
+}
+K_GLOBAL_STATIC(KIconLoaderGlobalData, s_globalData)
+
 void KIconLoaderPrivate::drawOverlays(const KIconLoader *iconLoader, KIconLoader::Group group, int state, QPixmap& pix, const QStringList& overlays)
 {
     if (overlays.isEmpty()) {
@@ -657,6 +712,41 @@
 }
 
 
+K3Icon KIconLoaderPrivate::findMatchingIconWithGenericFallbacks(const QString& name, int size) const
+{
+    K3Icon icon = findMatchingIcon(name, size);
+    if (icon.isValid())
+        return icon;
+
+    const QString genericIcon = s_globalData->genericIconFor(name);
+    if (!genericIcon.isEmpty()) {
+        icon = findMatchingIcon(genericIcon, size);
+        if (icon.isValid())
+            return icon;
+    }
+
+    // From update-mime-database.c
+    static const char* const media_types[] = {
+        "text", "application", "image", "audio",
+        "inode", "video", "message", "model", "multipart",
+        "x-content", "x-epoc"
+    };
+    // Shared-mime-info spec says:
+    // "If [generic-icon] is not specified then the mimetype is used to generate the
+    // generic icon by using the top-level media type (e.g. "video" in "video/ogg")
+    // and appending "-x-generic" (i.e. "video-x-generic" in the previous example)."
+    for (uint i = 0 ; i < sizeof(media_types)/sizeof(*media_types) ; i++) {
+        if (name.startsWith(QLatin1String(media_types[i]))) {
+            icon = findMatchingIcon(QString::fromLatin1(media_types[i]) + "-x-generic", size);
+            if (icon.isValid())
+                return icon;
+            break;
+        }
+    }
+    // not found
+    return icon;
+}
+
 K3Icon KIconLoaderPrivate::findMatchingIcon(const QString& name, int size) const
 {
     const_cast<KIconLoaderPrivate*>(this)->initIconThemes();
@@ -751,6 +841,9 @@
 
         while (!nameParts.isEmpty())
         {
+
+            //kDebug(264) << "Looking up" << currentName;
+
 // The following code has been commented out because the Qt SVG renderer needs
 // to be improved. If you are going to change/remove some code from this part,
 // please contact me before (ereslibre@kde.org), or kde-core-devel@kde.org. (ereslibre)
@@ -864,7 +957,7 @@
             return d->unknownIconPath(size);
     }
 
-    K3Icon icon = d->findMatchingIcon(name, size);
+    K3Icon icon = d->findMatchingIconWithGenericFallbacks(name, size);
 
     if (!icon.isValid())
     {
@@ -1075,7 +1168,7 @@
         else
         {
             if (!name.isEmpty())
-                icon = d->findMatchingIcon(favIconOverlay ? QString("text-html") : name, size);
+                icon = d->findMatchingIconWithGenericFallbacks(favIconOverlay ? QString("text-html") : name, size);
 
             if (!icon.isValid())
             {
Index: kdeui/findreplace/kfind_p.h
===================================================================
--- kdeui/findreplace/kfind_p.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdeui/findreplace/kfind_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -47,7 +47,9 @@
 
     ~Private()
     {
-        dialog->deleteLater();
+        if (dialog)
+            dialog->deleteLater();
+        dialog = 0;
         data.clear();
         delete emptyMatch;
         emptyMatch = 0;
Index: security/crypto/crypto.desktop
===================================================================
--- security/crypto/crypto.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ security/crypto/crypto.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -78,7 +78,7 @@
 Comment[cs]=Nastavení SSL, správa certifikátů a ostatní nastavení šifrování
 Comment[csb]=Kònfigùracëjô SSL, sprôwianié certifikatama ë jinszëma ùstôwóma kriptografiji
 Comment[da]=Konfigurér SSL, håndtér certifikater og andre kryptografiske indstillinger
-Comment[de]=Einrichtung von SSL, Zertifikat-Verwaltung und weitere kryptographische Einstellungen
+Comment[de]=Einrichtung von SSL, Zertifikat-Verwaltung und weitere kryptografische Einstellungen 
 Comment[el]=Ρύθμιση SSL, διαχείριση πιστοποιητικών, και άλλες ρυθμίσεις κρυπτογραφίας
 Comment[en_GB]=Configure SSL, manage certificates and other cryptography settings
 Comment[eo]=Agordi SSLon, administri atestilojn, kaj aliajn kriptografiajn agordojn
Index: kdecore/kernel/kautostart.cpp
===================================================================
--- kdecore/kernel/kautostart.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/kernel/kautostart.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -89,16 +89,16 @@
     bool starts = d->df->desktopGroup().exists();
 
     // check the hidden field
-    starts &= !d->df->desktopGroup().readEntry("Hidden", false);
+    starts = starts && !d->df->desktopGroup().readEntry("Hidden", false);
 
     if (!environment.isEmpty())
     {
-        starts &= (allowedEnvironments().indexOf(environment) != -1);
+        starts = starts && (allowedEnvironments().indexOf(environment) != -1);
     }
 
     if (check == CheckCommand)
     {
-        starts &= d->df->tryExec();
+        starts = starts && d->df->tryExec();
     }
 
     return starts;
Index: kdecore/kernel/kcmdlineargs.cpp
===================================================================
--- kdecore/kernel/kcmdlineargs.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/kernel/kcmdlineargs.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -83,13 +83,13 @@
 // Helper classes
 //
 
-class KCmdLineParsedOptions : public QHash<QString,QString>
+class KCmdLineParsedOptions : public QHash<QByteArray,QByteArray>
 {
 public:
    KCmdLineParsedOptions() { }
 };
 
-class KCmdLineParsedArgs : public QList<QString>
+class KCmdLineParsedArgs : public QList<QByteArray>
 {
 public:
    KCmdLineParsedArgs() { }
@@ -112,7 +112,7 @@
 
 class KCmdLineOptionsPrivate {
     public:
-    QStringList names;
+    QList<QByteArray> names;
     QList<KLocalizedString> descriptions;
     QStringList defaults;
 };
@@ -143,7 +143,7 @@
                                        const KLocalizedString &description,
                                        const QByteArray &defaultValue)
 {
-    d->names.append(QString::fromUtf8(name));
+    d->names.append(name);
     d->descriptions.append(description);
     d->defaults.append(QString::fromUtf8(defaultValue));
     return *this;
@@ -171,7 +171,7 @@
     char **argv; // The original argv
     bool parsed : 1; // Whether we have parsed the arguments since calling init
     bool ignoreUnknown : 1; // Ignore unknown options and arguments
-    QString mCwd; // Current working directory. Important for KUnqiueApp!
+    QByteArray mCwd; // Current working directory. Important for KUnqiueApp!
     KCmdLineArgs::StdCmdLineArgs mStdargs;
 
     KCmdLineOptions qt_options;
@@ -220,15 +220,15 @@
      *
      *  +4 - no more options follow         // !fork
      */
-    static int findOption(const KCmdLineOptions &options, QString &opt,
-                          QString &opt_name, QString &def, bool &enabled);
+    static int findOption(const KCmdLineOptions &options, QByteArray &opt,
+                          QByteArray &opt_name, QString &def, bool &enabled);
 
     /**
      * @internal
      *
      * Checks what to do with a single option
      */
-    static void findOption(const QString &optv, const QString &_opt,
+    static void findOption(const QByteArray &optv, const QByteArray &_opt,
                            int &i, bool _enabled, bool &moreOptions);
 
     /**
@@ -246,7 +246,7 @@
      *
      * @param id The name of the options to be removed.
      */
-    static void removeArgs(const QString &id);
+    static void removeArgs(const QByteArray &id);
 };
 
 K_GLOBAL_STATIC(KCmdLineArgsStatic, s)
@@ -336,7 +336,7 @@
 {
     friend class KCmdLineArgsStatic;
 public:
-    KCmdLineArgsPrivate(const KCmdLineOptions &_options, const KLocalizedString &_name, const QString &_id)
+    KCmdLineArgsPrivate(const KCmdLineOptions &_options, const KLocalizedString &_name, const QByteArray &_id)
         : options(_options)
         , name(_name)
         , id(_id)
@@ -351,7 +351,7 @@
     }
     const KCmdLineOptions options;
     const KLocalizedString name;
-    const QString id;
+    const QByteArray id;
     KCmdLineParsedOptions *parsedOptionList;
     KCmdLineParsedArgs *parsedArgList;
     bool isQt;
@@ -361,21 +361,21 @@
      *
      *  Set a boolean option
      */
-    void setOption(const QString &option, bool enabled);
+    void setOption(const QByteArray &option, bool enabled);
 
     /**
      * @internal
      *
      *  Set a string option
      */
-    void setOption(const QString &option, const QString &value);
+    void setOption(const QByteArray &option, const QByteArray &value);
 
     /**
      * @internal
      *
      * Add an argument
      */
-    void addArgument(const QString &argument);
+    void addArgument(const QByteArray &argument);
 
     /**
      * @internal
@@ -469,13 +469,13 @@
 
    s->about = _about;
    s->parsed = false;
-   s->mCwd = QDir::currentPath();
+   s->mCwd = QDir::currentPath().toLocal8Bit(); //currentPath() uses fromLocal8Bit internally apparently
    addStdCmdLineOptions(stdargs);
 }
 
 QString KCmdLineArgs::cwd()
 {
-   return s->mCwd;
+   return QString::fromLocal8Bit(s->mCwd);
 }
 
 QString KCmdLineArgs::appName()
@@ -499,14 +499,11 @@
 
 void
 KCmdLineArgs::addCmdLineOptions( const KCmdLineOptions &options, const KLocalizedString &name,
-         const QByteArray &_id, const QByteArray &_afterId)
+         const QByteArray &id, const QByteArray &afterId)
 {
    if (!s->argsList)
       s->argsList = new KCmdLineArgsList;
 
-   QString id = QString::fromUtf8(_id);
-   QString afterId = QString::fromUtf8(_afterId);
-
    int pos = s->argsList->count();
    // To make sure that the named options come before unnamed.
    if (pos > 0 && !id.isEmpty() && s->argsList->last()->d->name.isEmpty())
@@ -527,7 +524,7 @@
 
    Q_ASSERT( s->parsed == false ); // You must add _ALL_ cmd line options
                                    // before accessing the arguments!
-   s->argsList->insert(pos, new KCmdLineArgs(options, name, id.toUtf8()));
+   s->argsList->insert(pos, new KCmdLineArgs(options, name, id));
 }
 
 void
@@ -540,8 +537,7 @@
    s->removeArgs("qt");
    s->removeArgs("kde");
 
-   QByteArray qCwd = QFile::encodeName(s->mCwd);
-   ds << qCwd;
+   ds << s->mCwd;
 
    uint count = s->argsList ? s->argsList->count() : 0;
    ds << count;
@@ -579,16 +575,15 @@
    QByteArray qCwd;
    ds >> qCwd;
 
-   s->mCwd = QFile::decodeName(qCwd); //FIXME: Is this proper decoding?
+   s->mCwd = qCwd;
 
    uint count;
    ds >> count;
 
    while(count--)
    {
-     QByteArray idRaw;
-     ds >> idRaw;
-     QString id = idRaw;  //FIXME: What about decoding?
+     QByteArray id;
+     ds >> id;
      Q_ASSERT( s->argsList );
      for(args = s->argsList->begin(); args != s->argsList->end(); ++args)
      {
@@ -602,9 +597,8 @@
    s->parsed = true;
 }
 
-KCmdLineArgs *KCmdLineArgs::parsedArgs(const QByteArray &_id)
+KCmdLineArgs *KCmdLineArgs::parsedArgs(const QByteArray &id)
 {
-   QString id = QString::fromUtf8(_id);
    if (!s->argsList)
       return 0;
    KCmdLineArgsList::Iterator args = s->argsList->begin();
@@ -622,7 +616,7 @@
    return 0;
 }
 
-void KCmdLineArgsStatic::removeArgs(const QString &id)
+void KCmdLineArgsStatic::removeArgs(const QByteArray &id)
 {
    if (!s->argsList)
       return;
@@ -646,8 +640,8 @@
 }
 
 int
-KCmdLineArgsStatic::findOption(const KCmdLineOptions &options, QString &opt,
-                               QString &opt_name, QString &def, bool &enabled)
+KCmdLineArgsStatic::findOption(const KCmdLineOptions &options, QByteArray &opt,
+                               QByteArray &opt_name, QString &def, bool &enabled)
 {
    int result;
    bool inverse;
@@ -686,7 +680,7 @@
                i++;
                if (i >= options.d->names.size())
                   return result+0;
-               QString nextOption = options.d->names[i];
+               QByteArray nextOption = options.d->names[i];
                int p = nextOption.indexOf(' ');
                if (p > 0)
                   nextOption = nextOption.left(p);
@@ -717,14 +711,14 @@
 }
 
 void
-KCmdLineArgsStatic::findOption(const QString &optv, const QString &_opt,
+KCmdLineArgsStatic::findOption(const QByteArray &optv, const QByteArray &_opt,
                                int &i, bool _enabled, bool &moreOptions)
 {
    KCmdLineArgsList::Iterator args = s->argsList->begin();
-   QString opt = _opt;
-   QString opt_name;
+   QByteArray opt = _opt;
+   QByteArray opt_name;
    QString def;
-   QString argument;
+   QByteArray argument;
    int j = opt.indexOf('=');
    if (j != -1)
    {
@@ -753,7 +747,7 @@
       int p = 1;
       while (true)
       {
-         QString singleCharOption = " ";
+         QByteArray singleCharOption = " ";
          singleCharOption[0] = optv[p];
          args = s->argsList->begin();
          while (args != s->argsList->end())
@@ -800,7 +794,7 @@
 			return;
 #endif
       KCmdLineArgs::enable_i18n();
-      KCmdLineArgs::usageError( i18n("Unknown option '%1'.", _opt));
+      KCmdLineArgs::usageError( i18n("Unknown option '%1'.", QString::fromLocal8Bit(_opt)));
    }
 
    if ((result & 4) != 0)
@@ -820,7 +814,7 @@
 				return;
 #endif
          KCmdLineArgs::enable_i18n();
-         KCmdLineArgs::usageError( i18n("Unknown option '%1'.", _opt));
+         KCmdLineArgs::usageError( i18n("Unknown option '%1'.", QString::fromLocal8Bit(_opt)));
       }
       if (argument.isEmpty())
       {
@@ -828,9 +822,9 @@
          if (i >= s->argc)
          {
             KCmdLineArgs::enable_i18n();
-            KCmdLineArgs::usageError( i18nc("@info:shell %1 is cmdoption name","'%1' missing.",  opt_name));
+            KCmdLineArgs::usageError( i18nc("@info:shell %1 is cmdoption name","'%1' missing.",  QString::fromLocal8Bit(opt_name)));
          }
-         argument = s->decodeInput(s->argv[i]);
+         argument = s->argv[i];
       }
       (*args)->d->setOption(opt, argument);
    }
@@ -849,16 +843,10 @@
    KCmdLineArgs *appOptions = s->argsList->last();
    if (appOptions->d->id.isEmpty())
    {
-     const KCmdLineOptions &option = appOptions->d->options;
-     for (int i = 0; i < option.d->names.size(); i++)
+     foreach(const QByteArray& name, appOptions->d->options.d->names)
      {
-       if (option.d->names[i].startsWith('+'))
-           allowArgs = true;
-       if ( option.d->names[i].startsWith("!+") )
-       {
-           allowArgs = true;
-           everythingAfterArgIsArgs = true;
-       }
+       everythingAfterArgIsArgs = everythingAfterArgIsArgs || name.startsWith("!+");
+       allowArgs = allowArgs || name.startsWith('+') || everythingAfterArgIsArgs;
      }
    }
    for(int i = 1; i < s->argc; i++)
@@ -869,8 +857,8 @@
       if ((s->argv[i][0] == '-') && s->argv[i][1] && inOptions)
       {
          bool enabled = true;
-         QString orig = decodeInput(s->argv[i]);
-         QString option = orig.mid(1);
+         QByteArray orig = s->argv[i];
+         QByteArray option = orig.mid(1);
          if (option.startsWith('-'))
          {
             option = option.mid(1);
@@ -887,7 +875,7 @@
          }
          else if (option.startsWith("help-"))
          {
-            KCmdLineArgs::usage(option.mid(5).toUtf8());
+            KCmdLineArgs::usage(option.mid(5));
          }
          else if ((option == "version") || (option == "v"))
          {
@@ -924,9 +912,8 @@
          {
            if (s->about->bugAddress().isEmpty() || s->about->bugAddress() == "submit@bugs.kde.org" )
              s->printQ( i18n( "Please use http://bugs.kde.org to report bugs.\n" ) );
-           else {
+           else
              s->printQ( i18n( "Please report bugs to %1.\n" , s->about->bugAddress()) );
-           }
          }
          else
          {
@@ -955,7 +942,7 @@
          }
          else
          {
-            appOptions->d->addArgument(s->decodeInput(s->argv[i]));
+            appOptions->d->addArgument(s->argv[i]);
             if (everythingAfterArgIsArgs)
                 inOptions = false;
          }
@@ -1009,7 +996,7 @@
    if (!(s->mStdargs & KCmdLineArgs::CmdLineArgQt))
    {
      s_qt_argv = new char*[2];
-     s_qt_argv[0] = qstrdup(s->encodeOutput(appName()));
+     s_qt_argv[0] = qstrdup(s->argc?s->argv[0]:"");
      s_qt_argv[1] = 0;
 
      return s_qt_argv;
@@ -1026,12 +1013,13 @@
       exit(255);
    }
 
-   s_qt_argv = new char*[ args->count() + 2 ];
-   s_qt_argv[0] = qstrdup(s->encodeOutput(appName()));
+   int count=args->count();
+   s_qt_argv = new char*[ count + 2 ];
+   s_qt_argv[0] = qstrdup(s->argc?s->argv[0]:"");
    int i = 0;
-   for(; i < args->count(); i++)
+   for(; i < count; i++)
    {
-      s_qt_argv[i+1] = qstrdup(s->encodeOutput(args->arg(i)));
+      s_qt_argv[i+1] = qstrdup(args->d->parsedArgList->at(i));
    }
    s_qt_argv[i+1] = 0;
 
@@ -1110,7 +1098,7 @@
      const KCmdLineOptions &option = appOptions->d->options;
      for (int i = 0; i < option.d->names.size(); i++)
      {
-       QString opt_name = option.d->names[i];
+       QByteArray opt_name = option.d->names[i];
        if (opt_name.startsWith('+'))
           usage = usage + (opt_name.mid(1)) + ' ';
        else if ( opt_name.startsWith("!+") )
@@ -1129,7 +1117,7 @@
    {
       if (!(*args)->d->name.isEmpty() && !(*args)->d->id.isEmpty())
       {
-         QString option = QString("--help-%1").arg((*args)->d->id);
+         QString option = QString("--help-%1").arg(QString::fromLatin1((*args)->d->id));
          QString desc = i18n("Show %1 specific options", (*args)->d->name.toString());
 
          s->printQ(optionFormatString.arg(option, -25).arg(desc));
@@ -1169,7 +1157,7 @@
      while (args != s->argsList->end())
      {
        const KCmdLineOptions &option = (*args)->d->options;
-       QString opt;
+       QByteArray opt;
 
        for (int i = 0; i < option.d->names.size(); i++)
        {
@@ -1214,7 +1202,7 @@
             description = dl.first();
             dl.erase( dl.begin() );
          }
-         QString name = option.d->names[i];
+         QByteArray name = option.d->names[i];
          if (name.startsWith('!'))
              name = name.mid(1);
 
@@ -1229,7 +1217,7 @@
             name = name.mid(1);
             if (name.startsWith('[') && name.endsWith(']'))
                 name = name.mid(1, name.length()-2);
-            s->printQ(optionFormatString.arg(name, -25).arg(description));
+            s->printQ(optionFormatString.arg(QString::fromLocal8Bit(name), -25).arg(description));
          }
          else
          {
@@ -1259,7 +1247,7 @@
                   s->printQ(optionFormatStringDef.arg(QString( opt ), -25)
                             .arg(description, option.d->defaults[i]));
                }
-               opt = "";
+               opt.clear();
             }
          }
          for(QStringList::Iterator it = dl.begin();
@@ -1309,24 +1297,21 @@
 void
 KCmdLineArgs::setCwd( const QByteArray &cwd )
 {
-    s->mCwd = QString::fromUtf8(cwd);
+    s->mCwd = cwd;
 }
 
 void
 KCmdLineArgs::clear()
 {
-   delete d->parsedArgList;
-   d->parsedArgList = 0;
-   delete d->parsedOptionList;
-   d->parsedOptionList = 0;
+   delete d->parsedArgList;     d->parsedArgList = 0;
+   delete d->parsedOptionList;  d->parsedOptionList = 0;
 }
 
 void
 KCmdLineArgs::reset()
 {
    if ( s->argsList ) {
-      delete s->argsList;
-      s->argsList = 0;
+      delete s->argsList; s->argsList = 0;
    }
    s->parsed = false;
 }
@@ -1356,23 +1341,21 @@
 
    if (parsedOptionList->count() == 0)
    {
-      delete parsedOptionList;
-      parsedOptionList = 0;
+      delete parsedOptionList;  parsedOptionList = 0;
    }
    if (parsedArgList->count() == 0)
    {
-      delete parsedArgList;
-      parsedArgList = 0;
+      delete parsedArgList;     parsedArgList = 0;
    }
 }
 
 void
-KCmdLineArgsPrivate::setOption(const QString &opt, bool enabled)
+KCmdLineArgsPrivate::setOption(const QByteArray &opt, bool enabled)
 {
    if (isQt)
    {
       // Qt does it own parsing.
-      QString argString = "-";
+      QByteArray argString = "-";
       if( !enabled )
           argString += "no";
       argString += opt;
@@ -1383,18 +1366,18 @@
    }
 
    if (enabled)
-      parsedOptionList->insert( opt, QString::fromUtf8("t") );
+      parsedOptionList->insert( opt, "t" );
    else
-      parsedOptionList->insert( opt, QString::fromUtf8("f") );
+      parsedOptionList->insert( opt, "f" );
 }
 
 void
-KCmdLineArgsPrivate::setOption(const QString &opt, const QString &value)
+KCmdLineArgsPrivate::setOption(const QByteArray &opt, const QByteArray &value)
 {
    if (isQt)
    {
       // Qt does it's own parsing.
-      QString argString = "-";
+      QByteArray argString = "-";
       argString += opt;
       addArgument(argString);
       addArgument(value);
@@ -1403,7 +1386,7 @@
       // Hack coming up!
       if (argString == "-display")
       {
-         setenv(DISPLAY, s->encodeOutput(value).data(), true);
+         setenv(DISPLAY, value.data(), true);
       }
 #endif
    }
@@ -1417,17 +1400,17 @@
 QString
 KCmdLineArgs::getOption(const QByteArray &_opt) const
 {
-   QString opt = QString::fromUtf8(_opt);
-   QString value;
+   QByteArray opt = _opt;
+   QByteArray value;
    if (d->parsedOptionList)
    {
       value = d->parsedOptionList->value(opt);
    }
    if (!value.isEmpty())
-      return value;
+       return QString::fromLocal8Bit(value);
 
    // Look up the default.
-   QString opt_name;
+   QByteArray opt_name;
    QString def;
    bool dummy = true;
    int result = s->findOption( d->options, opt, opt_name, def, dummy) & ~4;
@@ -1436,7 +1419,7 @@
    {
       fprintf(stderr, "\n\nFAILURE (KCmdLineArgs):\n");
       fprintf(stderr, "Application requests for getOption(\"%s\") but the \"%s\" option\n",
-                      s->encodeOutput(opt).data(), s->encodeOutput(opt).data());
+                      opt.data(), opt.data());
       fprintf(stderr, "has never been specified via addCmdLineOptions( ... )\n\n");
 
       Q_ASSERT( 0 );
@@ -1446,20 +1429,18 @@
 }
 
 QStringList
-KCmdLineArgs::getOptionList(const QByteArray &_opt) const
+KCmdLineArgs::getOptionList(const QByteArray &opt) const
 {
-   QString opt = QString::fromUtf8(_opt);
-
    QStringList result;
    if (!d->parsedOptionList)
       return result;
 
    while(true)
    {
-      QString value = d->parsedOptionList->take(opt);
+      QByteArray value = d->parsedOptionList->take(opt);
       if (value.isEmpty())
          break;
-      result.prepend(value);
+      result.prepend(QString::fromLocal8Bit(value));
    }
 
    // Reinsert items in dictionary
@@ -1469,7 +1450,7 @@
    // So taking them out and then putting them back is the only way.
    Q_FOREACH(const QString &str, result)
    {
-      d->parsedOptionList->insertMulti(opt, str);
+      d->parsedOptionList->insertMulti(opt, str.toLocal8Bit());
    }
    return result;
 }
@@ -1478,8 +1459,8 @@
 KCmdLineArgs::isSet(const QByteArray &_opt) const
 {
    // Look up the default.
-   QString opt = QString::fromUtf8(_opt);
-   QString opt_name;
+   QByteArray opt = _opt;
+   QByteArray opt_name;
    QString def;
    int result = 0;
    KCmdLineArgsList::Iterator args = s->argsList->begin();
@@ -1495,14 +1476,14 @@
    {
       fprintf(stderr, "\n\nFAILURE (KCmdLineArgs):\n");
       fprintf(stderr, "Application requests for isSet(\"%s\") but the \"%s\" option\n",
-                      s->encodeOutput(opt).data(), s->encodeOutput(opt).data());
+                      opt.data(), opt.data());
       fprintf(stderr, "has never been specified via addCmdLineOptions( ... )\n\n");
 
       Q_ASSERT( 0 );
       exit(255);
    }
 
-   QString value;
+   QByteArray value;
    if (d->parsedOptionList)
    {
       value = d->parsedOptionList->value(opt);
@@ -1513,7 +1494,7 @@
       if (result == 3)
          return true;
       else
-         return (value[0] == 't');
+         return (value.at(0) == 't');
    }
 
    if (result == 3)
@@ -1527,9 +1508,7 @@
 int
 KCmdLineArgs::count() const
 {
-   if (!d->parsedArgList)
-      return 0;
-   return d->parsedArgList->count();
+   return d->parsedArgList?d->parsedArgList->count():0;
 }
 
 QString
@@ -1545,7 +1524,7 @@
       exit(255);
    }
 
-   return d->parsedArgList->at(n);
+   return QString::fromLocal8Bit(d->parsedArgList->at(n));
 }
 
 KUrl
@@ -1575,7 +1554,7 @@
 }
 
 void
-KCmdLineArgsPrivate::addArgument(const QString &argument)
+KCmdLineArgsPrivate::addArgument(const QByteArray &argument)
 {
    if (!parsedArgList)
       parsedArgList = new KCmdLineParsedArgs;
@@ -1594,7 +1573,5 @@
 bool KCmdLineArgs::isTempFileSet()
 {
     KCmdLineArgs* args = KCmdLineArgs::parsedArgs( "kde-tempfile" );
-    if ( args )
-        return args->isSet( "tempfile" );
-    return false;
+    return args && args->isSet( "tempfile" );
 }
Index: kdecore/kernel/kkernel_win.cpp
===================================================================
--- kdecore/kernel/kkernel_win.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/kernel/kkernel_win.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -3,7 +3,7 @@
    Copyright (C) 2004 Jarosław Staniek <staniek@kde.org>
    Copyright (C) 2007 Christian Ehrlicher <ch.ehrlicher@gmx.de>
    Copyright (C) 2007 Bernhard Loos <nhuh.put@web.de>
-   Copyright (C) 2008 Ralf Habacker <ralf.habacker@freenet.de>
+   Copyright (C) 2008-2009 Ralf Habacker <ralf.habacker@freenet.de>
 
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
@@ -34,10 +34,23 @@
 #include <QtCore/QDir>
 #include <QtCore/QString>
 
+#ifdef Q_CC_MINGW
+#define _WIN32_WINNT 0x500
+#endif
 #include <windows.h>
 #include <shellapi.h>
 #include <process.h>
 
+// console related includes
+#include <stdio.h>
+#include <fcntl.h>
+#include <io.h>
+#include <iostream>
+#include <fstream>
+#ifndef _USE_OLD_IOSTREAMS
+using namespace std;
+#endif
+
 #if defined(__MINGW32__)
 # define WIN32_CAST_CHAR (const WCHAR*)
 #else
@@ -199,9 +212,9 @@
 }
 
 /** 
-  debug message printer for win32 gui applications 
+  kde and qt debug message printer using windows debug message port
  */ 
-static void kMessageGuiOutput(QtMsgType type, const char *msg)
+static void kMessageOutputDebugString(QtMsgType type, const char *msg)
 {
     int BUFSIZE=4096;
     char *buf = new char[BUFSIZE];
@@ -230,11 +243,10 @@
 }
 
 /** 
-  debug message printer for win32 console applications 
+  kde and qt debug message printer using FILE pointer based output
  */ 
-static void kMessageConsoleOutput(QtMsgType type, const char *msg)
+static void kMessageOutputFileIO(QtMsgType type, const char *msg)
 {
-    kMessageGuiOutput(type,msg);
     switch (type) {
     case QtDebugMsg:
         fprintf(stderr, "Debug: %s\n", msg);
@@ -251,7 +263,82 @@
     }
 }
 
+/** 
+  try to attach to the parents console
+  \return true if console has been attached, false otherwise
+*/
+static bool attachToConsole()
+{
+    return AttachConsole(~0U) != 0;
+}
+
 /**
+  redirect stdout, stderr and
+  cout, wcout, cin, wcin, wcerr, cerr, wclog and clog to console
+*/ 
+static void redirectToConsole()
+{
+    int hCrt;
+    FILE *hf;
+    int i;
+    
+    hCrt = _open_osfhandle((long) GetStdHandle(STD_INPUT_HANDLE),_O_TEXT);
+    hf = _fdopen( hCrt, "r" );
+    *stdin = *hf;
+    i = setvbuf( stdin, NULL, _IONBF, 0 );
+
+    hCrt = _open_osfhandle((long) GetStdHandle(STD_OUTPUT_HANDLE),_O_TEXT);
+    hf = _fdopen( hCrt, "w" );
+    *stdout = *hf;
+    i = setvbuf( stdout, NULL, _IONBF, 0 );
+    
+    hCrt = _open_osfhandle((long) GetStdHandle(STD_ERROR_HANDLE),_O_TEXT);
+    hf = _fdopen( hCrt, "w" );
+    *stderr = *hf;
+    i = setvbuf( stderr, NULL, _IONBF, 0 );
+
+    // make cout, wcout, cin, wcin, wcerr, cerr, wclog and clog
+    // point to console as well
+    ios::sync_with_stdio();
+}
+
+#include <streambuf>
+
+/** 
+  ios related debug message printer for win32
+*/
+class debug_streambuf: public std::streambuf
+{
+    public:
+        debug_streambuf(char *prefix)
+        {
+            strcpy(buf,prefix);
+            index = rindex = strlen(buf);
+        }
+
+    protected:
+        virtual int overflow(int c = EOF)
+        {
+            if (c != EOF)
+            {
+                char cc = traits_type::to_char_type(c);
+                // @TODO: buffer size checking
+                buf[index++] = cc;
+                if (cc == '\n')
+                {
+                    buf[index] = '\0';
+                    OutputDebugStringA((LPCSTR)buf);
+                    index = rindex;
+                }
+            }
+            return traits_type::not_eof(c);
+        }
+    private:
+        char buf[4096];
+        int index, rindex;
+};
+
+/**
   retrieve type of win32 subsystem from the executable header 
   \return type of win32 subsystem - the subsystem types are defined at http://msdn.microsoft.com/en-us/library/ms680339(VS.85).aspx 
 */
@@ -273,30 +360,81 @@
 }
     
 /**
-     setup win32 debug printer output
- 
-         gui applications     - uses OutputDebugString 
-         console applications - uses OutputDebugString and stderr 
+ win32 debug and console output handling
 
-     in both cases the message type is identified by a specific prefix string
+ source type of output 
+    1. kde/qt debug system  - kDebug(), kWarning(), kFatal(), kError(), qDebug(), qWarning(), qFatal() 
+    2. ios  - cout, wcout, wcerr, cerr, wclog and clog
+    3. FILE * - stdout,stderr
 
+ application  console    ------------------ output -----------------
+    type     available   qt/kde-debug         ios             FILE *   
+
+    cui        yes        console           console         console
+    cui        no        win32debug         win32debug      no output[1]
+
+    gui        yes       win32debug         console         console
+    gui        no        win32debug         win32debug      win32debug 
+
+[1]no redirect solution for FILE * based output yet
+
  TODO: report events to the windows event log system 
  http://msdn.microsoft.com/en-us/library/aa363680(VS.85).aspx
 */
 
+/**
+ setup up debug output 
+*/ 
 static class kMessageOutputInstaller {
     public:
-        kMessageOutputInstaller() 
+        kMessageOutputInstaller() : stdoutBuffer("stdout:"), stderrBuffer("stderr:"), oldStdoutBuffer(0), oldStderrBuffer(0)
         {
             if (subSystem() == IMAGE_SUBSYSTEM_WINDOWS_CUI) {
-                qInstallMsgHandler(kMessageConsoleOutput);
+                if (attachToConsole()) {
+                    // setup kde and qt level 
+                    qInstallMsgHandler(kMessageOutputFileIO);
+                    // redirect ios and file io to console
+                    redirectToConsole();
+                }
+                else {
+                    // setup kde and qt level 
+                    qInstallMsgHandler(kMessageOutputDebugString);
+                    // redirect ios to debug message port 
+                    oldStdoutBuffer = std::cout.rdbuf(&stdoutBuffer);
+                    oldStderrBuffer = std::cerr.rdbuf(&stderrBuffer);
+                }
             }
             else if (subSystem() == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
-                qInstallMsgHandler(kMessageGuiOutput);
+                // setup kde and qt level 
+                qInstallMsgHandler(kMessageOutputDebugString);
+                // try to get a console
+                if (attachToConsole()) {
+                    redirectToConsole();
+                }
+                else {
+                    // redirect ios to debug message port
+                    oldStdoutBuffer = std::cout.rdbuf(&stdoutBuffer);
+                    oldStderrBuffer = std::cerr.rdbuf(&stderrBuffer);
+                    // TODO: redirect FILE * level to console, no idea how to do yet
+                }
             }
             else
                 qWarning("unknown subsystem %d detected, could not setup qt message handler",subSystem());
         }
+        ~kMessageOutputInstaller()
+        {
+            if (oldStdoutBuffer) 
+                std::cout.rdbuf(oldStdoutBuffer);
+            if (oldStderrBuffer) 
+                std::cerr.rdbuf(oldStderrBuffer);
+        }
+    
+    private:
+        debug_streambuf stdoutBuffer;
+        debug_streambuf stderrBuffer;
+        std::streambuf* oldStdoutBuffer;
+        std::streambuf* oldStderrBuffer;
+
 } kMessageOutputInstallerInstance;
 
 
Index: kdecore/services/yacc.y
===================================================================
--- kdecore/services/yacc.y	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/services/yacc.y	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -137,4 +137,5 @@
 {
   KTraderParse_initFlex( _code );
   yyparse();
+  kiotraderlex_destroy();
 }
Index: kdecore/services/kservicetypeprofile.cpp
===================================================================
--- kdecore/services/kservicetypeprofile.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/services/kservicetypeprofile.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -84,7 +84,7 @@
             const QString serviceId = config.readEntry( "Entry" + num + "_Service", QString() );
             Q_ASSERT(!serviceId.isEmpty());
             const int pref = config.readEntry( "Entry" + num + "_Preference", 0 );
-            //kDebug(7014) << "KServiceTypeProfile::initStatic adding service " << serviceId << " to profile for " << type << " with preference " << pref;
+            //kDebug(7014) << "adding service " << serviceId << " to profile for " << type << " with preference " << pref;
             p->addService( serviceId, pref );
         }
     }
@@ -210,8 +210,9 @@
     config.deleteGroup( serviceType );
     config.sync();
 
-    if (s_serviceTypeProfiles.exists())
-        s_serviceTypeProfiles->remove( serviceType );
+    if (s_serviceTypeProfiles.exists()) {
+        delete s_serviceTypeProfiles->take( serviceType );
+    }
 }
 
 void KServiceTypeProfile::setConfigurationMode()
Index: kdecore/kdebugrc
===================================================================
--- kdecore/kdebugrc	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/kdebugrc	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -80,6 +80,9 @@
 [5006]
 InfoOutput=2
 
+[5120]
+InfoOutput=2
+
 # KitchenSync (Syncing Algorithm)
 [5250]
 InfoOutput=4
Index: kdecore/localization/kcatalog.cpp
===================================================================
--- kdecore/localization/kcatalog.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/localization/kcatalog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -30,6 +30,24 @@
 #include <locale.h>
 #include "gettext.h"
 
+
+static bool s_localeSet = false;
+
+// Initialize the locale very early during application startup
+// This is necessary for e.g. toLocal8Bit() to work, even before
+// a Q[Core]Application exists (David)
+int kInitializeLocale()
+{
+    setlocale(LC_ALL, "");
+#if QT_VERSION >= 0x040500
+    extern Q_CORE_EXPORT bool qt_locale_initialized; // in Qt since 4.5.0
+    qt_locale_initialized = true; // as recommended by Thiago
+#endif
+    s_localeSet = true;
+    return 1;
+}
+Q_CONSTRUCTOR_FUNCTION(kInitializeLocale)
+
 // not defined on win32 :(
 #ifdef _WIN32
 # ifndef LC_MESSAGES
@@ -50,7 +68,6 @@
 
   QByteArray systemLanguage;
 
-  static int localeSet;
   static QByteArray currentLanguage;
 
   void setupGettextEnv ();
@@ -62,17 +79,15 @@
   return debug << c.d->language << " " << c.d->name << " " << c.d->localeDir;
 }
 
-int KCatalogPrivate::localeSet = 0;
 QByteArray KCatalogPrivate::currentLanguage;
 
 KCatalog::KCatalog(const QString & name, const QString & language )
   : d( new KCatalogPrivate )
 {
-  // Set locales only once.
-  if (! KCatalogPrivate::localeSet) {
-    setlocale(LC_ALL, "");
-    KCatalogPrivate::localeSet = 1;
-  }
+    // Set locales if the static initializer didn't work
+    if (!s_localeSet) {
+        kInitializeLocale();
+    }
 
   // Find locale directory for this catalog.
   QString localeDir = catalogLocaleDir( name, language );
Index: kdecore/localization/kencodingdetector.cpp
===================================================================
--- kdecore/localization/kencodingdetector.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/localization/kencodingdetector.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -1052,10 +1052,8 @@
     }
 
     if (len<20)
-    {
-        setEncoding("",DefaultEncoding);
         return false;
-    }
+
 #ifdef DECODE_DEBUG
     kDebug( 6005 ) << "KEncodingDetector: using heuristics (" << strlen(data) << ")";
 #endif
@@ -1110,10 +1108,9 @@
             // huh. somethings broken in this code ### FIXME
             //enc = 0; //Reset invalid codec we tried, so we get back to latin1 fallback.
             break;
-        }
+    }
 
-        setEncoding("",DefaultEncoding);
-        return true;
+    return true;
 }
 
 
Index: kdecore/all_languages.desktop
===================================================================
--- kdecore/all_languages.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/all_languages.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -4154,9 +4154,13 @@
 Name[ca]=Chattisgarbi
 Name[es]=Chhattisgarhí
 Name[hu]=Cshattíszgarhi
+Name[ja]=チャッティースガリー語
+Name[ru]=Чхаттисгархи
+Name[se]=Čattisgarhigiella
 Name[sr]=чатисгархи
 Name[sr@latin]=чатисгархи
 Name[uk]=Чхатісгархі
+Name[x-test]=xxChhattisgarhixx
 Name[zh_CN]=恰蒂斯加尔语
 [ho]
 Name=Hiri Motu
Index: kdecore/sonnet/sonnetspeller.desktop
===================================================================
--- kdecore/sonnet/sonnetspeller.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/sonnet/sonnetspeller.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -45,6 +45,7 @@
 Comment[mk]=Sonnet-клиент за правопис
 Comment[ml]=സോണറ്റ് സ്പെല്‍ ക്ലയന്റ്
 Comment[mr]=सोनेट शब्दलेखन क्लाएंट
+Comment[ms]=Klien Ejaan Sonnet
 Comment[nb]=Sonnet staveklient
 Comment[nds]=Schriefwiesprööv-Client Sonnet
 Comment[ne]=सोनेट स्पेल क्लाइन्ट
Index: kdecore/io/kurl.h
===================================================================
--- kdecore/io/kurl.h	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/io/kurl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -65,12 +65,12 @@
  * \endcode
  *
  * If you have the URL of a local file or directory and need the absolute path,
- * you would use path().
+ * you would use toLocalFile().
  * \code
  *    KUrl url( "file:///bar/%23foo%23" );
  *    ...
  *    if ( url.isLocalFile() )
- *       QString path = url.path();       // -> "/bar/#foo#"
+ *       QString path = url.toLocalFile();       // -> "/bar/#foo#"
  * \endcode
  *
  * This must also be considered when you have separated directory and file
Index: kdecore/kconfig_compiler/kconfig_compiler.cpp
===================================================================
--- kdecore/kconfig_compiler/kconfig_compiler.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ kdecore/kconfig_compiler/kconfig_compiler.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -442,8 +442,9 @@
 
     } else if ( type == "Path" && !defaultValue.isEmpty() ) {
       defaultValue = literalString( defaultValue );
-
-    } else if ( (type == "StringList" || type == "PathList") && !defaultValue.isEmpty() ) {
+    } else if ( type == "Url" && !defaultValue.isEmpty() ) {
+      defaultValue = "KUrl( " + literalString(defaultValue) + ")";
+    } else if ( ( type == "UrlList" || type == "StringList" || type == "PathList") && !defaultValue.isEmpty() ) {
       QTextStream cpp( &code, QIODevice::WriteOnly | QIODevice::Append );
       if (!code.isEmpty())
          cpp << endl;
@@ -452,8 +453,15 @@
       const QStringList defaults = defaultValue.split( ',' );
       QStringList::ConstIterator it;
       for( it = defaults.constBegin(); it != defaults.constEnd(); ++it ) {
-        cpp << "  default" << name << ".append( QString::fromUtf8( \"" << *it << "\" ) );"
-            << endl;
+        cpp << "  default" << name << ".append( ";
+        if( type == "UrlList" ) {
+          cpp << "KUrl(";       
+        }
+        cpp << "QString::fromUtf8( \"" << *it << "\" ) ";
+        if( type == "UrlList" ) {
+          cpp << ") ";
+        }
+        cpp << ");" << endl;
       }
       defaultValue = "default" + name;
 
Index: plasma/servicetypes/plasma-containment.desktop
===================================================================
--- plasma/servicetypes/plasma-containment.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ plasma/servicetypes/plasma-containment.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -20,7 +20,7 @@
 Comment[gl]=Un contedor de applet de Plasma e pintor do fondo
 Comment[gu]=પ્લાઝમા એપ્લેટ ધરાવનાર અને પાશ્ચભાગ રંગનાર
 Comment[he]=תוחם של יישומון Plasma וצובע הרקע
-Comment[hne]=प्लाज्मा एपलेट कंटेनर अउ पिछोत पुतइया
+Comment[hne]=प्लाज्मा एपलेट कंटेनर अउ पिछोत अंगना पुतइया
 Comment[hsb]=Plasma-container za applet a molowadło pozadka
 Comment[hu]=Tartóelem és háttérrajzoló Plasma-kisalkalmazásokhoz
 Comment[is]=Grunnur fyrir Plasma smáforrit og bakgrunnslitun
Index: plasma/servicetypes/plasma-applet-extenderapplet.desktop
===================================================================
--- plasma/servicetypes/plasma-applet-extenderapplet.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ plasma/servicetypes/plasma-applet-extenderapplet.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -50,6 +50,7 @@
 Name[zh_TW]=內部延伸容器
 Type=Service
 Icon=utilities-desktop-extra
+NoDisplay=true
 X-KDE-ServiceTypes=Plasma/Applet
 X-KDE-PluginInfo-Name=internal:extender
 X-KDE-PluginInfo-EnabledByDefault=false
Index: plasma/servicetypes/plasma-runner.desktop
===================================================================
--- plasma/servicetypes/plasma-runner.desktop	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ plasma/servicetypes/plasma-runner.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -47,6 +47,7 @@
 Comment[ro]=Modul KRunner
 Comment[ru]=Расширение KRunner
 Comment[se]=KRunner-lassemodula
+Comment[si]=KRunner ප්ලගීනය
 Comment[sk]=KRunner rozšírenie
 Comment[sl]=Vstavek za KRunner
 Comment[sr]=Прикључак за К‑извођач
Index: plasma/abstractrunner.cpp
===================================================================
--- plasma/abstractrunner.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ plasma/abstractrunner.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -132,14 +132,13 @@
 {
 }
 
-void AbstractRunner::performMatch(Plasma::RunnerContext &globalContext)
+void AbstractRunner::performMatch(Plasma::RunnerContext &localContext)
 {
     static const int reasonableRunTime = 1500;
     static const int fastEnoughTime = 250;
 
     d->runtime.restart();
-//TODO :this is a copy ctor
-    RunnerContext localContext(globalContext, 0);
+    
     match(localContext);
     // automatically rate limit runners that become slooow
     const int runtime = d->runtime.elapsed();
Index: plasma/svg.cpp
===================================================================
--- plasma/svg.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ plasma/svg.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -454,7 +454,7 @@
 void Svg::paint(QPainter *painter, const QRectF &rect, const QString &elementID)
 {
     QPixmap pix(d->findInCache(elementID, rect.size()));
-    painter->drawPixmap(rect, pix, QRectF(QPointF(0, 0), pix.size()));
+    painter->drawPixmap(QRectF(rect.topLeft(), pix.size()), pix, QRectF(QPointF(0, 0), pix.size()));
 }
 
 void Svg::paint(QPainter *painter, int x, int y, int width, int height, const QString &elementID)
Index: plasma/runnercontext.cpp
===================================================================
--- plasma/runnercontext.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ plasma/runnercontext.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -142,8 +142,15 @@
 {
     // We will detach if we are a copy of someone. But we will reset
     // if we are the 'main' context others copied from. Resetting
-    // one RunnerContext makes all the copies oneobsolete.
+    // one RunnerContext makes all the copies obsolete.
+    
+    d->q = 0; //we need to mark the q pointer of the detached RunnerContextPrivate 
+              //as dirty on detach to avoid receiving results for old queries   
+
     d.detach();
+    
+    d->q = this; //now that we detached the d pointer we need to mark its q pointer as
+                 //this to receive the signals 
 
     // we still have to remove all the matches, since if the
     // ref count was 1 (e.g. only the RunnerContext is using
@@ -151,7 +158,7 @@
     if (!d->matches.isEmpty()) {
         d->matchesById.clear();
         d->matches.clear();
-        emit d->q->matchesChanged();
+        emit matchesChanged();
     }
 
     d->term.clear();
@@ -194,7 +201,7 @@
 {
     Q_UNUSED(term)
 
-    if (matches.isEmpty()) {
+    if (matches.isEmpty() || (!d->q)) { //Bail out if the query is empty or the qptr is dirty 
         return false;
     }
 
@@ -214,6 +221,7 @@
     // we always want to sent the signal of the object that created
     // the d pointer
     emit d->q->matchesChanged();
+    
     return true;
 }
 
@@ -221,12 +229,17 @@
 {
     Q_UNUSED(term)
 
+    if (!d->q) { // Bail out if the qptr is dirty
+        return false;
+    }
+    
     LOCK_FOR_WRITE(this)
     d->matches.append(match);
     d->matchesById.insert(match.id(), &d->matches.at(d->matches.size() - 1));
     UNLOCK(this);
     //kDebug()<< "added match" << match->text();
-    emit d->q->matchesChanged();
+    emit d->q->matchesChanged(); 
+    
 
     return true;
 }
Index: plasma/runnermanager.cpp
===================================================================
--- plasma/runnermanager.cpp	(.../tags/KDE/4.2.1/kdelibs)	(wersja 942069)
+++ plasma/runnermanager.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 942069)
@@ -138,19 +138,23 @@
 
     int priority() const;
     Plasma::AbstractRunner *runner() const;
+    void setStale();
+    bool isStale() const;
 
 protected:
     void run();
 private:
-    Plasma::RunnerContext *m_context;
+    Plasma::RunnerContext m_context;
     Plasma::AbstractRunner *m_runner;
+    bool m_stale;
 };
 
 FindMatchesJob::FindMatchesJob(Plasma::AbstractRunner *runner,
                                Plasma::RunnerContext *context, QObject *parent)
     : ThreadWeaver::Job(parent),
-      m_context(context),
-      m_runner(runner)
+      m_context(*context, 0),
+      m_runner(runner),
+      m_stale(false)
 {
     if (runner->speed() == Plasma::AbstractRunner::SlowSpeed) {
         assignQueuePolicy(&RunnerRestrictionPolicy::instance());
@@ -161,7 +165,7 @@
 {
 //     kDebug() << "Running match for " << m_runner->objectName()
 //              << " in Thread " << thread()->id() << endl;
-    m_runner->performMatch(*m_context);
+    m_runner->performMatch(m_context);
 }
 
 int FindMatchesJob::priority() const
@@ -174,6 +178,16 @@
     return m_runner;
 }
 
+void FindMatchesJob::setStale() 
+{
+    m_stale = true;
+}
+
+bool FindMatchesJob::isStale() const
+{
+    return m_stale;
+}
+
 /*****************************************************
 *  RunnerManager::Private class
 *
@@ -287,8 +301,9 @@
         FindMatchesJob *runJob = static_cast<FindMatchesJob*>(job);
         if (deferredRun.isEnabled() && runJob->runner() == deferredRun.runner()) {
             //kDebug() << "job actually done, running now **************";
-            deferredRun.run(context);
-            deferredRun = QueryMatch(0);
+            QueryMatch tmpRun = deferredRun;
+            deferredRun = QueryMatch(0);	  
+            tmpRun.run(context);
         }
         searchJobs.removeAll(runJob);
         delete runJob;
@@ -375,18 +390,21 @@
     AbstractRunner *runner = match.runner();
 
     foreach (FindMatchesJob *job, d->searchJobs) {
-        if (job->runner() == runner && !job->isFinished()) {
-            //kDebug() << "!!!!!!!!!!!!!!!!!!! uh oh!";
+        if (job->runner() == runner && !job->isFinished() && !job->isStale()) {
+            kDebug() << "!!!!!!!!!!!!!!!!!!! uh oh!";
             d->deferredRun = match;
             return;
         }
     }
 
-    match.run(d->context);
-
     if (d->deferredRun.isValid()) {
         d->deferredRun = QueryMatch(0);
     }
+    
+    match.run(d->context);
+
+
+    
 }
 
 QList<QAction*> RunnerManager::actionsForMatch(const QueryMatch &match)
@@ -483,8 +501,8 @@
         //kDebug() << "ignored!";
         return false;
     }
-
-    r->performMatch(d->context);
+    RunnerContext localContext(d->context, 0);
+    r->performMatch(localContext);
     //kDebug() << "succeeded with" << d->context.matches().count() << "results";
     emit matchesChanged(d->context.matches());
     return true;
@@ -503,12 +521,18 @@
         d->searchJobs.clear();
     } else {
         Weaver::instance()->dequeue();
+        // Since we cannot safely delete the jobs, mark them as stale 
+        // TODO: delete them eventually?
+        foreach (FindMatchesJob *job, d->searchJobs) {
+	    job->setStale();
+        }
     }
 
     if (d->deferredRun.isEnabled()) {
         //kDebug() << "job actually done, running now **************";
-        d->deferredRun.run(d->context);
+        QueryMatch tmpRun = d->deferredRun;
         d->deferredRun = QueryMatch(0);
+        tmpRun.run(d->context);
     }
 
     d->context.reset();

Zmiany atrybutów dla: .
___________________________________________________________________
Dodane: svn:externals
   + 


