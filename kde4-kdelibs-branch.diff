Index: khtml/khtmlview.cpp
===================================================================
--- khtml/khtmlview.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/khtmlview.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -136,6 +136,9 @@
 static const int sSmoothScrollTick = 14;
 static const int sSmoothScrollMinStaticPixels = 320*200;
 
+static const int sMaxMissedDeadlines = 12;
+static const int sWayTooMany = -1;
+
 class KHTMLViewPrivate {
     friend class KHTMLView;
 public:
@@ -164,6 +167,7 @@
         postponed_autorepeat = NULL;
         scrollingFromWheelTimerId = 0;
         smoothScrollMode = KHTMLView::SSMWhenEfficient;
+
         reset();
         vpolicy = Qt::ScrollBarAsNeeded;
  	hpolicy = Qt::ScrollBarAsNeeded;
@@ -246,6 +250,7 @@
         smoothScrolling = false;
         smoothScrollModeIsDefault = true;
         shouldSmoothScroll = false;
+        smoothScrollMissedDeadlines = 0;
         hasFrameset = false;
 #ifdef FIX_QT_BROKEN_QWIDGET_SCROLL
         oldVScrollUpdatesEnabled = true;
@@ -450,6 +455,7 @@
     bool possibleTripleClick			:1;
     bool dirtyLayout                           :1;
     bool m_dialogsAllowed			:1;
+    short smoothScrollMissedDeadlines;
     int layoutCounter;
     int layoutAttemptCounter;
     int scheduledLayoutCounter;
@@ -3754,8 +3760,6 @@
             if (defaultHandled || me->defaultPrevented())
                 swallowEvent = true;
         }
-        me->deref();
-
         if (eventId == EventImpl::MOUSEDOWN_EVENT && !me->defaultPrevented()) {
             // Focus should be shifted on mouse down, not on a click.  -dwh
             // Blur current focus node when a link/button is clicked; this
@@ -3769,6 +3773,7 @@
             else if (!nodeImpl || !nodeImpl->focused())
                 m_part->xmlDocImpl()->setFocusNode(0);
         }
+        me->deref();
     }
 
     return swallowEvent;
@@ -3925,7 +3930,7 @@
     }
 
     if ( d->shouldSmoothScroll && d->smoothScrollMode != SSMDisabled && m_part->xmlDocImpl() &&
-          m_part->xmlDocImpl()->renderer()) {
+          m_part->xmlDocImpl()->renderer() && (d->smoothScrollMode != SSMWhenEfficient || d->smoothScrollMissedDeadlines != sWayTooMany)) {
 
         bool doSmoothScroll = (!d->staticWidget || d->smoothScrollMode == SSMEnabled);
 
@@ -4161,6 +4166,17 @@
 
         d->ddx -= dddx;
         d->ddy -= dddy;
+        d->smoothScrollMissedDeadlines = 0;
+    } else {
+        if (d->smoothScrollMissedDeadlines != sWayTooMany && 
+                (!m_part->xmlDocImpl() || !m_part->xmlDocImpl()->parsing())) {
+            d->smoothScrollMissedDeadlines++;
+            if (d->smoothScrollMissedDeadlines >= sMaxMissedDeadlines) {
+                // we missed many deadlines in a row!
+                // time to signal we had enough..
+                d->smoothScrollMissedDeadlines = sWayTooMany;
+            }
+        }
     }
     d->smoothScrollStopwatch.start();
 }
Index: khtml/dom/dom_node.cpp
===================================================================
--- khtml/dom/dom_node.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/dom/dom_node.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -390,6 +390,13 @@
         throw DOMException(exceptioncode);
 }
 
+unsigned Node::compareDocumentPosition(const Node& other)
+{
+    if (!impl || !other.impl)
+	throw DOMException(DOMException::NOT_FOUND_ERR);
+    return impl->compareDocumentPosition(other.impl);
+}
+
 unsigned int Node::elementId() const
 {
     if (!impl) return 0;
Index: khtml/dom/dom_node.h
===================================================================
--- khtml/dom/dom_node.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/dom/dom_node.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -837,7 +837,7 @@
     bool dispatchEvent(const Event &evt);
 
     /**
-     * Introduced in DOM Level 2
+     * Introduced in DOM Level 3
      *
      * This attribute returns the text content of this node and its
      * descendants. When it is defined to be null, setting it has no
@@ -854,7 +854,7 @@
      * textual content.
      */
     DOMString textContent() const;
-    
+        
     /**
      * see textContent()
      * 
@@ -862,6 +862,40 @@
      * NO_MODIFICATION_ALLOWED_ERR: Raised when the node is readonly.
      */
     void setTextContent(const DOMString& text);
+    
+    /**
+     * Introduced in DOM Level 3.
+     * 
+     * These constants represent bitflags returned by the compareDocumentPosition
+     * method.
+     *
+     * @since 4.2.4
+     */
+    enum DocumentPosition {
+	DOCUMENT_POSITION_DISCONNECTED = 0x01,
+	DOCUMENT_POSITION_PRECEDING    = 0x02,
+	DOCUMENT_POSITION_FOLLOWING    = 0x04,
+	DOCUMENT_POSITION_CONTAINS     = 0x08,
+	DOCUMENT_POSITION_CONTAINED_BY = 0x10,
+	DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC = 0x20
+    };
+    
+    /**
+     * Introduced in DOM Level 3.
+     * 
+     * This method compares the current node's position with that of 'other'
+     * and returns it as a combination of DocumentPosition bitfields.
+     * Here DOCUMENT_POSITION_FOLLOWING means that the 'other' is 
+     * after the current.
+     *
+     * The notion of order here is a logical one; for example attributes
+     * are viewed as if they were children of an element inserted
+     * right before the real children. The method will also assign
+     * some total order even if the nodes are not connected. 
+     *
+     * @since 4.2.4
+     */
+    unsigned compareDocumentPosition(const DOM::Node& other);
 
     /**
      * @internal
Index: khtml/misc/loader.cpp
===================================================================
--- khtml/misc/loader.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/misc/loader.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -329,7 +329,7 @@
     if (strncmp(d, "@charset \"",10) == 0)
     {
         // the string until "; is the charset name
-        char *p = strchr(d+10, '"');
+        const char *p = strchr(d+10, '"');
         if (p == 0) return m_charset;
         QString charset = QString::fromAscii(d+10, p-(d+10));
 	return charset;
Index: khtml/misc/paintbuffer.h
===================================================================
--- khtml/misc/paintbuffer.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/misc/paintbuffer.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -124,7 +124,8 @@
     }
     
     void transfer( float opacity ) {
-        bool constantOpacity = m_origPainter->paintEngine() && m_origPainter->paintEngine()->hasFeature(QPaintEngine::ConstantOpacity);
+        // ### when using DestinationIn with an alpha above 0.99, the resulting buffer ends up black in Qt 4.5.1
+        bool constantOpacity = (opacity > 0.99) || m_origPainter->paintEngine() && m_origPainter->paintEngine()->hasFeature(QPaintEngine::ConstantOpacity);
         if (!constantOpacity) {
             QColor color;
             color.setAlphaF(opacity);
Index: khtml/khtml.desktop
===================================================================
--- khtml/khtml.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/khtml.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -79,8 +79,8 @@
 Comment[uz@cyrillic]=Ичига ўрнатиб бўладиган HTML кўрувчи компонент
 Comment[vi]=Thành phần xem HTML có khả năng nhúng.
 Comment[wa]=Ravalé compôzant di håynaedje HTML
+Comment[xh]=Inxenye yemboniselo elungisiweyo ye HTML
 Comment[x-test]=xxEmbeddable HTML viewing componentxx
-Comment[xh]=Inxenye yemboniselo elungisiweyo ye HTML
 Comment[zh_CN]=可嵌入的 HTML 查看部件
 Comment[zh_HK]=可嵌入的 HTML 檢視元件
 Comment[zh_TW]=可嵌入的 HTML 檢視元件
Index: khtml/khtmlimage.desktop
===================================================================
--- khtml/khtmlimage.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/khtmlimage.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -79,8 +79,8 @@
 Comment[uz@cyrillic]=Ичига ўрнатиб бўладиган расм кўрувчи компонент
 Comment[vi]=Thành phần xem ảnh có khả năng nhúng.
 Comment[wa]=Ravalé compôzant håyneu d' imådjes
+Comment[xh]=Ingxenye Yemboniselo Yomfanekiso Olungisiweyo
 Comment[x-test]=xxEmbeddable Image Viewing Componentxx
-Comment[xh]=Ingxenye Yemboniselo Yomfanekiso Olungisiweyo
 Comment[zh_CN]=可嵌入的图像查看部件
 Comment[zh_HK]=可嵌入的圖檔檢視元件
 Comment[zh_TW]=可嵌入的影像檢視元件
@@ -164,8 +164,8 @@
 Name[uz@cyrillic]=Расм кўрувчи
 Name[vi]=Bộ xem ảnh có khả năng nhúng
 Name[wa]=Ravalé håyneu d' imådjes
+Name[xh]=Umboniseli Womfanekiso Olungisiweyo
 Name[x-test]=xxEmbeddable Image Viewerxx
-Name[xh]=Umboniseli Womfanekiso Olungisiweyo
 Name[zh_CN]=可嵌入的图像查看器
 Name[zh_HK]=可嵌入的圖檔檢視器
 Name[zh_TW]=可嵌入的影像檢視器
Index: khtml/svg/SVGElement.cpp
===================================================================
--- khtml/svg/SVGElement.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/svg/SVGElement.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -154,7 +154,7 @@
     else*/
     if (attr->id() == ATTR_ID) {
         setHasID();
-        document()->incDOMTreeVersion();
+        document()->incDOMTreeVersion(DocumentImpl::TV_IDNameHref);
     } else
         StyledElement::parseAttribute(attr);
 }
Index: khtml/html/html_miscimpl.cpp
===================================================================
--- khtml/html/html_miscimpl.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/html/html_miscimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -56,7 +56,7 @@
 
     QHash<QString,QList<NodeImpl*>* > nameCache;
 
-    CollectionCache(): nameCache(){}
+    CollectionCache(): Cache(DocumentImpl::TV_IDNameHref) {}
 
     virtual void clear(DocumentImpl* doc)
     {
Index: khtml/html/html_formimpl.cpp
===================================================================
--- khtml/html/html_formimpl.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/html/html_formimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -71,6 +71,7 @@
 
 using namespace DOM;
 using namespace khtml;
+using namespace WTF;
 
 HTMLFormElementImpl::HTMLFormElementImpl(DocumentImpl *doc, bool implicit)
     : HTMLElementImpl(doc)
@@ -245,6 +246,19 @@
     return str;
 }
 
+Vector<HTMLGenericFormElementImpl*> HTMLFormElementImpl::gatherInTreeOrder(NodeImpl* root,
+                                                               const HashSet<NodeImpl*>& toGather)
+{
+    Vector<HTMLGenericFormElementImpl*> out;
+    out.reserveCapacity(toGather.size());
+    
+    for (NodeImpl* cur = root; cur; cur = cur->traverseNextNode(root)) {
+        if (toGather.contains(cur))
+            out.append(static_cast<HTMLGenericFormElementImpl*>(cur));
+    }
+    return out;
+}
+
 QByteArray HTMLFormElementImpl::formData(bool& ok)
 {
 #ifdef FORMS_DEBUG
@@ -296,9 +310,27 @@
         m_encCharset[i] = m_encCharset[i].toLatin1() == ' ' ? QChar('-') : m_encCharset[i].toLower();
 
     QStringList fileUploads, fileNotUploads;
+    
+    /**
+     Frameworks such as mootools Sortables expect form element values to be submitted in 
+     tree order (and HTML5 specifies this behavior); however formElements need not be 
+     ordered thus. Hence we walk through the tree and the formElements as we go --- 
+     first in our kids, then if needed in the parent
+    */
+    HashSet<NodeImpl*> formElementsSet;
+    foreach (HTMLGenericFormElementImpl* fe, formElements)
+        formElementsSet.add(fe);
+        
+    Vector<HTMLGenericFormElementImpl*> ordered = gatherInTreeOrder(this, formElementsSet);
+    
+    if (ordered.size() < (unsigned)formElements.size()) {
+        // Some of our elements not contained within us due to parsing hijinks -- scan 
+        // the entire document.
+        ordered = gatherInTreeOrder(document()->documentElement(), formElementsSet);
+    }
 
-    for (QListIterator<HTMLGenericFormElementImpl*> it(formElements); it.hasNext();) {
-        HTMLGenericFormElementImpl* const current = it.next();
+    for (unsigned i = 0; i < ordered.size(); ++i) {
+        HTMLGenericFormElementImpl* const current = ordered[i];
         khtml::encodingList lst;
 
         if (!current->disabled() && current->encoding(codec, lst, m_multipart))
Index: khtml/html/html_elementimpl.cpp
===================================================================
--- khtml/html/html_elementimpl.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/html/html_elementimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -161,7 +161,7 @@
     case ATTR_ID:
         // unique id
         setHasID();
-        document()->incDOMTreeVersion();
+        document()->incDOMTreeVersion(DocumentImpl::TV_IDNameHref);
         break;
     case ATTR_CLASS:
         if (attr->val()) {
@@ -175,9 +175,10 @@
         } else {
             setHasClass(false);
         }
+        document()->incDOMTreeVersion(DocumentImpl::TV_Class);
         break;
     case ATTR_NAME:
-        document()->incDOMTreeVersion();
+        document()->incDOMTreeVersion(DocumentImpl::TV_IDNameHref);
         break;
     case ATTR_CONTENTEDITABLE:
         setContentEditable(attr);
Index: khtml/html/html_miscimpl.h
===================================================================
--- khtml/html/html_miscimpl.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/html/html_miscimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -24,6 +24,7 @@
 #define HTML_MISCIMPL_H
 
 #include "html_elementimpl.h"
+#include "xml/dom_nodelistimpl.h"
 #include "misc/shared.h"
 
 namespace DOM {
Index: khtml/html/html_formimpl.h
===================================================================
--- khtml/html/html_formimpl.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/html/html_formimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -28,6 +28,8 @@
 #include "html/html_elementimpl.h"
 #include "html/html_imageimpl.h"
 #include "dom/html_element.h"
+#include <wtf/HashSet.h>
+#include <wtf/Vector.h>
 
 class QTextCodec;
 
@@ -107,6 +109,10 @@
     friend class HTMLFormCollectionImpl;
 
 private:
+    // Collects nodes that are inside the toGather set in tree order
+    WTF::Vector<HTMLGenericFormElementImpl*> gatherInTreeOrder(NodeImpl* root,
+                                               const WTF::HashSet<NodeImpl*>& toGather);
+
     void gatherWalletData();
     QList<HTMLGenericFormElementImpl*> formElements;
     QList<HTMLImageElementImpl*> imgElements;
Index: khtml/html/html_inlineimpl.cpp
===================================================================
--- khtml/html/html_inlineimpl.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/html/html_inlineimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -176,7 +176,7 @@
     {
         bool hadAnchor = m_hasAnchor;
         m_hasAnchor = attr->val() != 0;
-        document()->incDOMTreeVersion();
+        document()->incDOMTreeVersion(DocumentImpl::TV_IDNameHref);
         if (hadAnchor != m_hasAnchor)
             setChanged();
         if (m_hasAnchor && document()->part() && document()->part()->dnsPrefetch()) {
Index: khtml/ecma/kjs_dom.cpp
===================================================================
--- khtml/ecma/kjs_dom.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/ecma/kjs_dom.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -72,6 +72,12 @@
   DOCUMENT_TYPE_NODE    DOM::Node::DOCUMENT_TYPE_NODE   DontDelete|ReadOnly
   DOCUMENT_FRAGMENT_NODE DOM::Node::DOCUMENT_FRAGMENT_NODE  DontDelete|ReadOnly
   NOTATION_NODE     DOM::Node::NOTATION_NODE        DontDelete|ReadOnly
+  DOCUMENT_POSITION_DISCONNECTED                DOM::Node::DOCUMENT_POSITION_DISCONNECTED  DontDelete|ReadOnly
+  DOCUMENT_POSITION_PRECEDING                   DOM::Node::DOCUMENT_POSITION_PRECEDING  DontDelete|ReadOnly
+  DOCUMENT_POSITION_FOLLOWING                   DOM::Node::DOCUMENT_POSITION_FOLLOWING   DontDelete|ReadOnly
+  DOCUMENT_POSITION_CONTAINS                    DOM::Node::DOCUMENT_POSITION_CONTAINS  DontDelete|ReadOnly
+  DOCUMENT_POSITION_CONTAINED_BY                DOM::Node::DOCUMENT_POSITION_CONTAINED_BY  DontDelete|ReadOnly
+  DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC     DOM::Node::DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC  DontDelete|ReadOnly
 @end
 */
 IMPLEMENT_CONSTANT_TABLE(DOMNodeConstants,"DOMNodeConstants")
@@ -89,6 +95,8 @@
 # DOM2
   normalize	DOMNode::Normalize	DontDelete|Function 0
   isSupported   DOMNode::IsSupported	DontDelete|Function 2
+# DOM3
+  compareDocumentPosition 	DOMNode::CompareDocumentPosition	DontDelete|Function 1
 # from the EventTarget interface
   addEventListener	DOMNode::AddEventListener	DontDelete|Function 3
   removeEventListener	DOMNode::RemoveEventListener	DontDelete|Function 3
@@ -684,6 +692,13 @@
       SharedPtr<NodeListImpl> childNodes = node.childNodes();
       return getDOMNode(exec, childNodes->item(static_cast<unsigned long>(args[0]->toNumber(exec))));
     }
+    case DOMNode::CompareDocumentPosition: {
+       DOM::NodeImpl* other = toNode(args[0]);
+       if (!other)
+          setDOMException(exec, DOMException::TYPE_MISMATCH_ERR);
+       else
+          return jsNumber(node.compareDocumentPosition(other));
+    }
   }
 
   return jsUndefined();
Index: khtml/ecma/kjs_window.cpp
===================================================================
--- khtml/ecma/kjs_window.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/ecma/kjs_window.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1652,6 +1652,10 @@
     KHTMLView *widget = p->view();
     KParts::WindowArgs winargs;
 
+    // Split on commas and syntactic whitespace
+    // Testcase: 'height=600, width=950 left = 30,top = 50,statusbar=0'
+    static const QRegExp m(",|\\b\\s+(?!=)");
+
     // scan feature argument
     if (!features.isEmpty()) {
       // specifying window params means false defaults
@@ -1659,7 +1663,7 @@
       winargs.setToolBarsVisible(false);
       winargs.setStatusBarVisible(false);
       winargs.setScrollBarsVisible(false);
-      const QStringList flist = features.split(',');
+      const QStringList flist = features.trimmed().split(m);
       QStringList::ConstIterator it = flist.begin();
       while (it != flist.end()) {
         QString s = *it++;
Index: khtml/ecma/kjs_dom.h
===================================================================
--- khtml/ecma/kjs_dom.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/ecma/kjs_dom.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -65,7 +65,7 @@
            OnResize, OnScroll, OnSelect, OnSubmit, OnUnload,
            OffsetLeft, OffsetTop, OffsetWidth, OffsetHeight, OffsetParent,
            ClientLeft, ClientTop, ClientWidth, ClientHeight, ScrollLeft, ScrollTop,
-           ScrollWidth, ScrollHeight, SourceIndex, TextContent };
+           ScrollWidth, ScrollHeight, SourceIndex, TextContent, CompareDocumentPosition };
 
     //### toNode? virtual
     DOM::NodeImpl* impl() const { return m_impl.get(); }
Index: khtml/CMakeLists.txt
===================================================================
--- khtml/CMakeLists.txt	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/CMakeLists.txt	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -355,6 +355,7 @@
 set(khtmlxml_STAT_SRCS
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_docimpl.cpp
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_nodeimpl.cpp
+  ${CMAKE_SOURCE_DIR}/khtml/xml/dom_nodelistimpl.cpp  
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_textimpl.cpp
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_elementimpl.cpp
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_stringimpl.cpp
@@ -366,7 +367,6 @@
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom2_viewsimpl.cpp
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_restyler.cpp
   ${CMAKE_SOURCE_DIR}/khtml/xml/ClassNames.cpp
-  ${CMAKE_SOURCE_DIR}/khtml/xml/ClassNodeList.cpp
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_position.cpp
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_positioniterator.cpp
   ${CMAKE_SOURCE_DIR}/khtml/xml/dom_selection.cpp
Index: khtml/rendering/bidi.cpp
===================================================================
--- khtml/rendering/bidi.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/bidi.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -2078,8 +2078,10 @@
 
                         // For wrapping text only, include the hyphen.  We need to ensure it will fit
                         // on the line if it shows when we break.
-                        if (o->style()->autoWrap())
-                            tmpW += t->width(pos, 1, f);
+                        if (o->style()->autoWrap()) {
+                            const QChar softHyphen(0x00ad);
+                            tmpW += f->charWidth(&softHyphen, 1, 0, true);
+                        }
 
                         BidiIterator startMid(0, o, pos+1);
                         addMidpoint(startMid);
Index: khtml/rendering/render_box.h
===================================================================
--- khtml/rendering/render_box.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/render_box.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -141,7 +141,7 @@
     int calcHeightUsing(const Length& height);
     int calcReplacedWidthUsing(WidthType widthType) const;
     int calcReplacedHeightUsing(HeightType heightType) const;
-    int calcPercentageHeight(const Length& height, bool treatAsReplaced = false) const;
+    int calcPercentageHeight(const Length& height) const;
     int availableHeightUsing(const Length& h) const;
     int availableWidthUsing(const Length& w) const;
     int calcImplicitContentHeight() const;
Index: khtml/rendering/render_container.cpp
===================================================================
--- khtml/rendering/render_container.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/render_container.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -195,6 +195,37 @@
         if (oldChild->isPosWithStaticDim() && childrenInline())
             dirtyLinesFromChangedChild(oldChild);
 
+        // We are about to take out node from the rendering tree and therefore
+        // it's possible that we're modifying the line box tree too.
+        // In order to properly recalculate it later we need
+        // to delete all the boxes from the current flow of the removed child. (vtokarev)
+        // In particular that's relevant when we're merging splitted inline flow. (continuations)
+        // We're taking the render objects from one block and insert into another
+        // so we have to force line box tree recalculation
+        if (oldChild->isInline()) {
+            if (oldChild->isText()) {
+                InlineTextBox* box = static_cast<RenderText*>(oldChild)->firstTextBox();
+                InlineTextBox* nextTextBox;
+                assert(!box || box->parent());
+                // delete all the text boxes
+                for (; box; box = nextTextBox) {
+                    nextTextBox = box->nextTextBox();
+                    box->remove();
+                    box->deleteLine(renderArena());
+                }
+            } else if (oldChild->isInlineFlow()) {
+                InlineFlowBox* box = static_cast<RenderFlow*>(oldChild)->firstLineBox();
+                InlineFlowBox* nextFlowBox;
+                assert(!box || box->parent());
+                // delete all the flow
+                for (; box; box = nextFlowBox) {
+                    nextFlowBox = box->nextFlowBox();
+                    box->remove();
+                    box->deleteLine(renderArena());
+                }
+            }
+        }
+
         // if oldChild is the start or end of the selection, then clear
         // the selection to avoid problems of invalid pointers
 
Index: khtml/rendering/render_box.cpp
===================================================================
--- khtml/rendering/render_box.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/render_box.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1351,7 +1351,7 @@
     return ch - top - bottom - borderTop() - borderBottom() - paddingTop() - paddingBottom();;
 }
 
-int RenderBox::calcPercentageHeight(const Length& height, bool treatAsReplaced) const
+int RenderBox::calcPercentageHeight(const Length& height) const
 {
     int result = -1;
     RenderBlock* cb = containingBlock();
@@ -1366,7 +1366,7 @@
         result = cb->calcContentHeight(cb->style()->height().value());
     else if (cb->style()->height().isPercent()) {
         // We need to recur and compute the percentage height for our containing block.
-        result = cb->calcPercentageHeight(cb->style()->height(), treatAsReplaced);
+        result = cb->calcPercentageHeight(cb->style()->height());
         if (result != -1)
             result = cb->calcContentHeight(result);
     }
@@ -1400,15 +1400,16 @@
         // take the used height - at the padding edge since we are positioned (10.1)
         result = cb->height() - cb->borderTop() - cb->borderBottom();
     }
-    else if (cb->isAnonymousBlock() || treatAsReplaced && style()->htmlHacks()) {
+    else if (cb->hasImplicitHeight()) {
+        result = cb->calcImplicitContentHeight();
+    }
+    else if (cb->isAnonymousBlock() || style()->htmlHacks()) {
         // IE quirk.
-        result = cb->calcPercentageHeight(cb->style()->height(), treatAsReplaced);
+        assert( cb->style()->height().isVariable() );
+        result = cb->calcPercentageHeight(cb->style()->height());
         if (result != -1)
             result = cb->calcContentHeight(result);
     }
-    else if (cb->hasImplicitHeight()) {
-        result = cb->calcImplicitContentHeight();
-    }
 
     if (result != -1) {
         result = height.width(result);
@@ -1491,7 +1492,7 @@
         return calcContentHeight(h.value());
     case Percent:
       {
-        int th = calcPercentageHeight(h, true);
+        int th = calcPercentageHeight(h);
         if (th != -1)
             return calcContentHeight(th);
         // fall through
Index: khtml/rendering/render_block.h
===================================================================
--- khtml/rendering/render_block.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/render_block.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -114,6 +114,7 @@
     void insertPositionedObject(RenderObject *o);
     void removePositionedObject(RenderObject *o);
 
+    QRegion visibleFloatingRegion(int x, int y) const;
     // Called to lay out the legend for a fieldset.
     virtual RenderObject* layoutLegend(bool /*relayoutChildren*/) { return 0; }
 
Index: khtml/rendering/render_form.cpp
===================================================================
--- khtml/rendering/render_form.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/render_form.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -92,12 +92,12 @@
     {
         KHTMLProxyStyle(QWidget *parent)
             : KdeUiProxyStyle(parent)
-        { noBorder = false; left = right = top = bottom = 0;}
+        { noBorder = false; left = right = top = bottom = 0; m_style = parent->style(); }
         QRect subElementRect(
                 SubElement element, const QStyleOption *option, const QWidget *widget
             ) const
         {
-            QRect r = KdeUiProxyStyle::subElementRect(element, option, widget);
+            QRect r = m_style->subElementRect(element, option, widget);
             switch (element) {
               case QStyle::SE_PushButtonContents:
               case QStyle::SE_LineEditContents:
@@ -114,7 +114,7 @@
                const QStyleOptionButton *o = qstyleoption_cast<const QStyleOptionButton *>(option);
                if (o) {
                    QStyleOptionButton opt = *o;
-                   opt.rect = subElementRect(SE_PushButtonFocusRect, &opt, widget);
+                   opt.rect = m_style->subElementRect(SE_PushButtonFocusRect, &opt, widget);
                    KdeUiProxyStyle::drawControl(CE_PushButtonLabel, &opt, painter, widget);
                }
                return;
@@ -146,22 +146,23 @@
                     }
                     
                     // Now let sizeFromContent add in extra stuff.
-                    maxW = KdeUiProxyStyle::sizeFromContents(QStyle::CT_ComboBox, opt, QSize(maxW, 1), widget).width();
+                    maxW = m_style->sizeFromContents(QStyle::CT_ComboBox, opt, QSize(maxW, 1), widget).width();
                     
                     // How much more room do we need for the text?
                     int extraW = maxW > cbOpt->rect.width() ? maxW - cbOpt->rect.width() : 0;
                     
-                    QRect r = KdeUiProxyStyle::subControlRect(cc, opt, sc, widget);
+                    QRect r = m_style->subControlRect(cc, opt, sc, widget);
                     r.setWidth(r.width() + extraW);
                     return r;
                 }
             }
             
-            return KdeUiProxyStyle::subControlRect(cc, opt, sc, widget);
+            return m_style->subControlRect(cc, opt, sc, widget);
         }
 
         int left, right, top, bottom;
         bool noBorder;
+        QStyle* m_style;
     };
 
 // ---------------------------------------------------------------------
Index: khtml/rendering/render_object.cpp
===================================================================
--- khtml/rendering/render_object.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/render_object.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -3047,14 +3047,13 @@
     bool returnSelf = false;
     for (RenderObject* ro=firstChild();ro;ro=ro->nextSibling()) {
         if( !ro->layer() && !ro->isFloating() && ro->style()->visibility() == VISIBLE) {
-            // ### fix horizontal float extent
             const RenderStyle *s = ro->style();
             int ow = s->outlineSize();
             if (ro->isInlineFlow() || ro->isText()) {
                 returnSelf = true;
                 break;
             }
-            if ( s->backgroundImage() || s->backgroundColor().isValid() || s->hasBorder() || ro->isReplaced() ) {
+            if ( s->backgroundImage() || s->backgroundColor().isValid() || s->hasBorder() || ro->isReplaced() || ow ) {
                 r += QRect(x -ow +ro->effectiveXPos(),y -ow + ro->effectiveYPos(), 
                                   ro->effectiveWidth()+ow*2, ro->effectiveHeight()+ow*2);
             } else {
@@ -3062,6 +3061,9 @@
             }
         }
     }
+    if (hasFloats()) {
+        r += static_cast<const RenderBlock*>(this)->visibleFloatingRegion(x, y);
+    }
     if (returnSelf) {
         int ow = style()->outlineSize();
         r+= QRect(x-xPos()-ow +effectiveXPos(),y-yPos()-ow + effectiveYPos(),
Index: khtml/rendering/font.cpp
===================================================================
--- khtml/rendering/font.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/font.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -88,6 +88,10 @@
     
     Qt::LayoutDirection saveDir = p->layoutDirection();
     p->setLayoutDirection(d);
+    // Qt 4 avoids rendering soft-hyphens by default.
+    // Append normal hyphen instead.
+    if (qs.endsWith(QChar(0xad)))
+        qs.append(QChar('-'));
     p->drawText(x, y, qs);
     p->setLayoutDirection(saveDir);
 }
Index: khtml/rendering/render_block.cpp
===================================================================
--- khtml/rendering/render_block.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/rendering/render_block.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1826,6 +1826,31 @@
 #endif
 }
 
+QRegion RenderBlock::visibleFloatingRegion(int x, int y) const
+{
+    if (!m_floatingObjects)
+        return QRegion();
+    FloatingObject* fo;
+    QRegion r;
+    QListIterator<FloatingObject*> it(*m_floatingObjects);
+    while ( it.hasNext() ) {
+        fo = it.next();
+        if (!fo->noPaint && !fo->node->layer() && fo->node->style()->visibility() == VISIBLE) {
+            const RenderStyle *s = fo->node->style();
+            int ow = s->outlineSize();
+            if ( s->backgroundImage() || s->backgroundColor().isValid() || s->hasBorder() || fo->node->isReplaced() || ow ) {
+                r += QRect(x -ow +fo->left+fo->node->marginLeft(),
+                           y -ow +fo->startY+fo->node->marginTop(),
+                           fo->width +ow*2 -fo->node->marginLeft() -fo->node->marginRight(),
+                           fo->endY-fo->startY +ow*2 -fo->node->marginTop() -fo->node->marginBottom());
+            } else {
+                r += fo->node->visibleFlowRegion(x+fo->left+fo->node->marginLeft(), y+fo->startY+fo->node->marginTop());
+            }
+        }
+    }
+    return r;
+}
+                                 
 void RenderBlock::paintFloats(PaintInfo& pI, int _tx, int _ty, bool paintSelection)
 {
     if (!m_floatingObjects)
Index: khtml/css/cssparser.cpp
===================================================================
--- khtml/css/cssparser.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/css/cssparser.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -2163,18 +2163,20 @@
 {
     ValueList* args = value->function->args;
     Value* v = args->current();
+
     // Get the first value
     if (!validUnit(v, FInteger | FPercent, true))
         return false;
-    colorArray[0] = static_cast<int>(v->fValue * (v->unit == CSSPrimitiveValue::CSS_PERCENTAGE ? 256.0 / 100.0 : 1.0));
+    bool isPercent = (v->unit == CSSPrimitiveValue::CSS_PERCENTAGE);
+    colorArray[0] = static_cast<int>(v->fValue * (isPercent ? 256.0 / 100.0 : 1.0));
     for (int i = 1; i < 3; i++) {
         v = args->next();
         if (v->unit != Value::Operator && v->iValue != ',')
             return false;
         v = args->next();
-        if (!validUnit(v, FInteger | FPercent, true))
+        if (!validUnit(v, (isPercent ? FPercent : FInteger), true))
             return false;
-        colorArray[i] = static_cast<int>(v->fValue * (v->unit == CSSPrimitiveValue::CSS_PERCENTAGE ? 256.0 / 100.0 : 1.0));
+        colorArray[i] = static_cast<int>(v->fValue * (isPercent ? 256.0 / 100.0 : 1.0));
     }
     if (parseAlpha) {
         v = args->next();
@@ -2777,6 +2779,12 @@
     return start;
 }
 
+// When we reach the end of the input we switch over
+// the lexer to this alternative buffer and keep it stuck here.
+// (and as it contains nulls, flex will keep on reporting 
+//  end of buffer, and we will keep reseting the input
+//  pointer to the beginning of this).
+static unsigned short postEofBuf[2];
 
 #define YY_DECL int DOM::CSSParser::lex()
 #define yyconst const
@@ -2796,7 +2804,12 @@
 #define INITIAL 0
 #define YY_STATE_EOF(state) (YY_END_OF_BUFFER + state + 1)
 #define YY_START ((yy_start - 1) / 2)
-#define yyterminate() yyTok = END; return yyTok
+#define yyterminate()\
+    do { \
+        if (yy_act == YY_END_OF_BUFFER) \
+            yy_c_buf_p = postEofBuf; \
+        yyTok = END; return yyTok; \
+     } while (0)
 #define YY_FATAL_ERROR(a) qFatal(a)
 #define BEGIN yy_start = 1 + 2 *
 #define COMMENT 1
Index: khtml/css/quirks.css
===================================================================
--- khtml/css/quirks.css	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/css/quirks.css	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -27,6 +27,7 @@
     line-height: normal;
     color: -khtml-text;
     font-size: medium;
+    font-variant: normal;
     empty-cells: hide;
     text-align: -khtml-auto;
     font-weight: initial;
Index: khtml/css/cssstyleselector.cpp
===================================================================
--- khtml/css/cssstyleselector.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/css/cssstyleselector.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -899,6 +899,15 @@
             style->setOverflowX(OVISIBLE);
         if (style->overflowY() != OVISIBLE && style->overflowY() != OHIDDEN)
             style->setOverflowY(OVISIBLE);
+
+        // do comparable resets as Mozilla's nsStyleContext::ApplyStyleFixups
+        // except they decided to do it only for center and right, for whatever strange reason. cf.#193093
+        if (style->display() == TABLE && (style->textAlign() == KHTML_LEFT ||
+                                          style->textAlign() == KHTML_RIGHT ||
+                                          style->textAlign() == KHTML_CENTER)) {
+            style->setTextAlign( TAAUTO );
+        }
+
     }
 
     // Cull out any useless layers and also repeat patterns into additional layers.
Index: khtml/xml/ClassNodeList.cpp
===================================================================
--- khtml/xml/ClassNodeList.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/xml/ClassNodeList.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1,63 +0,0 @@
-/*
- * Copyright (C) 2007 Apple Inc. All rights reserved.
- * Copyright (C) 2007 David Smith (catfish.man@gmail.com)
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- *
- * 1.  Redistributions of source code must retain the above copyright
- *     notice, this list of conditions and the following disclaimer.
- * 2.  Redistributions in binary form must reproduce the above copyright
- *     notice, this list of conditions and the following disclaimer in the
- *     documentation and/or other materials provided with the distribution.
- * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
- *     its contributors may be used to endorse or promote products derived
- *     from this software without specific prior written permission.
- *
- * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
- * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
- * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
- * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
- * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
- * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
- * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
- * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-#include "ClassNodeList.h"
-
-#include "Document.h"
-#include "misc/htmlattrs.h"
-
-namespace DOM {
-
-ClassNodeList::ClassNodeList(NodeImpl* rootNode, const DOMString& classNames)
-    : NodeListImpl(rootNode, UNCACHEABLE)
-{
-    m_classNames.parseClassAttribute(classNames.string(), m_refNode->document()->inCompatMode());
-}
-
-bool ClassNodeList::nodeMatches(NodeImpl *testNode, bool& doRecurse) const
-{
-    if (!testNode->isElementNode()) {
-        doRecurse = false;
-        return false;
-    }
-
-    if (!testNode->hasClass())
-        return false;
-
-    if (!m_classNames.size())
-        return false;
-
-    const ClassNames& classes = static_cast<ElementImpl*>(testNode)->classNames();
-    for (size_t i = 0; i < m_classNames.size(); ++i)
-        if (!classes.contains(m_classNames[i]))
-            return false;
-    return true;
-}
-
-} // namespace DOM
Index: khtml/xml/ClassNodeList.h
===================================================================
--- khtml/xml/ClassNodeList.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/xml/ClassNodeList.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1,52 +0,0 @@
-/*
- * Copyright (C) 2007 Apple Inc. All rights reserved.
- * Copyright (C) 2007 David Smith (catfish.man@gmail.com)
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- *
- * 1.  Redistributions of source code must retain the above copyright
- *     notice, this list of conditions and the following disclaimer.
- * 2.  Redistributions in binary form must reproduce the above copyright
- *     notice, this list of conditions and the following disclaimer in the
- *     documentation and/or other materials provided with the distribution.
- * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
- *     its contributors may be used to endorse or promote products derived
- *     from this software without specific prior written permission.
- *
- * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
- * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
- * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
- * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
- * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
- * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
- * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
- * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
- * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-#ifndef ClassNodeList_h
-#define ClassNodeList_h
-
-#include "ClassNames.h"
-#include "dom_nodeimpl.h"
-
-namespace DOM {
-
-    class String;
-
-    class ClassNodeList : public NodeListImpl {
-    public:
-        ClassNodeList(NodeImpl* rootNode, const DOMString& classNames);
-
-    private:
-        virtual bool nodeMatches(NodeImpl *testNode, bool& doRecurse) const;
-
-        ClassNames m_classNames;
-    };
-
-} // namespace DOM
-
-#endif // ClassNodeList_h
Index: khtml/xml/dom_nodelistimpl.cpp
===================================================================
--- khtml/xml/dom_nodelistimpl.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 0)
+++ khtml/xml/dom_nodelistimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -0,0 +1,332 @@
+/*
+ * This file is part of the DOM implementation for KDE.
+ *
+ * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
+ *           (C) 1999 Antti Koivisto (koivisto@kde.org)
+ *           (C) 2001 Dirk Mueller (mueller@kde.org)
+ *           (C) 2004, 2005, 2006, 2007 Apple Inc. All rights reserved.
+ *           (C) 2005, 2009 Maksim Orlovich (maksim@kde.org)
+ *           (C) 2006 Allan Sandfeld Jensen (kde@carewolf.com)
+ *           (C) 2007 David Smith (catfish.man@gmail.com)
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public License
+ * along with this library; see the file COPYING.LIB.  If not, write to
+ * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+ * Boston, MA 02110-1301, USA.
+ *
+ *
+ * The code for ClassNodeListImpl was originally licensed under the following terms
+ * (but in this version is available only as above):
+ *     Redistribution and use in source and binary forms, with or without
+ *     modification, are permitted provided that the following conditions
+ *     are met:
+ *
+ *     1.  Redistributions of source code must retain the above copyright
+ *         notice, this list of conditions and the following disclaimer.
+ *     2.  Redistributions in binary form must reproduce the above copyright
+ *         notice, this list of conditions and the following disclaimer in the
+ *         documentation and/or other materials provided with the distribution.
+ *     3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
+ *         its contributors may be used to endorse or promote products derived
+ *         from this software without specific prior written permission.
+ *
+ *     THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
+ *     EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ *     WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+ *     DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
+ *     DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+ *     (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ *     LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
+ *     ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ *     (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
+ *     THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#include "dom_nodelistimpl.h"
+#include "dom_nodeimpl.h"
+#include "dom_docimpl.h"
+#include <kdebug.h>
+
+using namespace DOM;
+using namespace khtml;
+
+NodeImpl *NodeListImpl::item( unsigned long index ) const
+{
+    unsigned long requestIndex = index;
+
+    m_cache->updateNodeListInfo(m_refNode->document());
+
+    NodeImpl* n;
+    bool usedCache = false;
+    if (m_cache->current.node) {
+        //Compute distance from the requested index to the cache node
+        unsigned long cacheDist = qAbs(long(index) - long(m_cache->position));
+
+        if (cacheDist < (unsigned long)index) { //Closer to the cached position
+            usedCache = true;
+            if (index >= m_cache->position) { //Go ahead
+                unsigned long relIndex = index - m_cache->position;
+                n = recursiveItem(m_refNode, m_cache->current.node, relIndex);
+            } else { //Go backwards
+                unsigned long relIndex = m_cache->position - index;
+                n = recursiveItemBack(m_refNode, m_cache->current.node, relIndex);
+            }
+        }
+    }
+
+    if (!usedCache)
+        n = recursiveItem(m_refNode, m_refNode->firstChild(), index);
+
+    //We always update the cache state, to make starting iteration
+    //where it was left off easy.
+    m_cache->current.node  = n;
+    m_cache->position = requestIndex;
+    return n;
+}
+
+unsigned long NodeListImpl::length() const
+{
+    m_cache->updateNodeListInfo(m_refNode->document());
+    if (!m_cache->hasLength) {
+        m_cache->length    = calcLength( m_refNode );
+        m_cache->hasLength = true;
+    }
+    return m_cache->length;
+}
+
+unsigned long NodeListImpl::calcLength(NodeImpl *start) const
+{
+    unsigned long len = 0;
+    for(NodeImpl *n = start->firstChild(); n != 0; n = n->nextSibling()) {
+        bool recurse = true;
+        if (nodeMatches(n, recurse))
+                len++;
+        if (recurse)
+            len+= NodeListImpl::calcLength(n);
+    }
+
+    return len;
+}
+
+NodeListImpl::NodeListImpl( NodeImpl *n, int type, CacheFactory* factory )
+{
+    m_refNode = n;
+    m_refNode->ref();
+
+    m_cache = m_refNode->document()->acquireCachedNodeListInfo(
+                  factory, n, type );
+}
+
+NodeListImpl::~NodeListImpl()
+{
+    m_refNode->document()->releaseCachedNodeListInfo(m_cache);
+    m_refNode->deref();
+}
+
+/**
+ Next item in the pre-order walk of tree from node, but not going outside
+ absStart
+*/
+static NodeImpl* helperNext(NodeImpl* node, NodeImpl* absStart)
+{
+    //Walk up until we wind a sibling to go to.
+    while (!node->nextSibling() && node != absStart)
+        node = node->parentNode();
+
+    if (node != absStart)
+        return node->nextSibling();
+    else
+        return 0;
+}
+
+NodeImpl *NodeListImpl::recursiveItem ( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const
+{
+    for(NodeImpl *n = start; n != 0; n = helperNext(n, absStart)) {
+        bool recurse = true;
+        if (nodeMatches(n, recurse))
+            if (!offset--)
+                return n;
+
+        NodeImpl *depthSearch = recurse ? recursiveItem(n, n->firstChild(), offset) : 0;
+        if (depthSearch)
+            return depthSearch;
+    }
+
+    return 0; // no matching node in this subtree
+}
+
+NodeImpl *NodeListImpl::recursiveItemBack ( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const
+{
+    //### it might be cleaner/faster to split nodeMatches and recursion
+    //filtering.
+    bool dummy   = true;
+    NodeImpl* n  = start;
+
+    do {
+        bool recurse = true;
+
+        //Check whether the current node matches.
+        if (nodeMatches(n, dummy))
+            if (!offset--)
+                return n;
+
+        if (n->previousSibling()) {
+            //Move to the last node of this whole subtree that we should recurse into
+            n       = n->previousSibling();
+            recurse = true;
+
+            while (n->lastChild()) {
+                (void)nodeMatches(n, recurse);
+                if (!recurse)
+                   break; //Don't go there
+                n = n->lastChild();
+            }
+        } else {
+            //We're done with this whole subtree, so move up
+            n = n->parentNode();
+        }
+    }
+    while (n && n != absStart);
+
+    return 0;
+}
+
+// ---------------------------------------------------------------------------
+
+NodeListImpl::Cache* NodeListImpl::Cache::makeStructuralOnly()
+{
+   return new Cache(DocumentImpl::TV_Structural); // will check the same ver twice
+}
+
+NodeListImpl::Cache* NodeListImpl::Cache::makeNameOrID()
+{
+   return new Cache(DocumentImpl::TV_IDNameHref);
+}
+
+NodeListImpl::Cache* NodeListImpl::Cache::makeClassName()
+{
+   return new Cache(DocumentImpl::TV_Class);
+}
+
+NodeListImpl::Cache::Cache(unsigned short relSecondaryVer):relevantSecondaryVer(relSecondaryVer)
+{}
+
+NodeListImpl::Cache::~Cache()
+{}
+
+void NodeListImpl::Cache::clear(DocumentImpl* doc)
+{
+   hasLength = false;
+   current.node = 0;
+   version          = doc->domTreeVersion(DocumentImpl::TV_Structural);
+   secondaryVersion = doc->domTreeVersion(relevantSecondaryVer);
+}
+
+void NodeListImpl::Cache::updateNodeListInfo(DocumentImpl* doc)
+{
+    //If version doesn't match, clear
+    if (doc->domTreeVersion(DocumentImpl::TV_Structural) != version ||
+        doc->domTreeVersion(relevantSecondaryVer) != secondaryVersion)
+        clear(doc);
+}
+
+// ---------------------------------------------------------------------------
+ChildNodeListImpl::ChildNodeListImpl( NodeImpl *n ): NodeListImpl(n, CHILD_NODES, NodeListImpl::Cache::makeStructuralOnly)
+{}
+
+bool ChildNodeListImpl::nodeMatches( NodeImpl* /*testNode*/, bool& doRecurse ) const
+{
+    doRecurse = false;
+    return true;
+}
+
+// ---------------------------------------------------------------------------
+TagNodeListImpl::TagNodeListImpl(NodeImpl *n, NamespaceName namespaceName, LocalName localName, PrefixName prefix)
+  : NodeListImpl(n, UNCACHEABLE, NodeListImpl::Cache::makeStructuralOnly),
+    m_namespaceAware(false)
+{
+    m_namespace = namespaceName;
+    m_localName = localName;
+    m_prefix = prefix;
+}
+
+TagNodeListImpl::TagNodeListImpl( NodeImpl *n, const DOMString &namespaceURI, const DOMString &localName )
+  : NodeListImpl(n, UNCACHEABLE, NodeListImpl::Cache::makeStructuralOnly),
+    m_namespaceAware(true)
+{
+    if (namespaceURI == "*")
+        m_namespace = NamespaceName::fromId(anyNamespace);
+    else
+        m_namespace = NamespaceName::fromString(namespaceURI);
+    if (localName == "*")
+        m_localName = LocalName::fromId(anyLocalName);
+    else
+        m_localName = LocalName::fromString(localName);
+    m_prefix = PrefixName::fromId(emptyPrefix);
+}
+
+
+bool TagNodeListImpl::nodeMatches(NodeImpl *testNode, bool& /*doRecurse*/) const
+{
+    if (testNode->nodeType() != Node::ELEMENT_NODE)
+        return false;
+
+    if (m_namespaceAware) {
+        return (m_namespace.id() == anyNamespace || m_namespace.id() == namespacePart(testNode->id())) &&
+            (m_localName.id() == anyLocalName || m_localName.id() == localNamePart(testNode->id()));
+    } else {
+        return (m_localName.id() == anyLocalName) || (m_localName.id() == localNamePart(testNode->id()) &&
+            m_prefix == static_cast<ElementImpl*>(testNode)->prefixName());
+    }
+}
+
+// ---------------------------------------------------------------------------
+NameNodeListImpl::NameNodeListImpl(NodeImpl *n, const DOMString &t )
+  : NodeListImpl(n, UNCACHEABLE, NodeListImpl::Cache::makeNameOrID),
+    nodeName(t)
+{}
+
+bool NameNodeListImpl::nodeMatches( NodeImpl *testNode, bool& /*doRecurse*/ ) const
+{
+    if ( testNode->nodeType() != Node::ELEMENT_NODE ) return false;
+    return static_cast<ElementImpl *>(testNode)->getAttribute(ATTR_NAME) == nodeName;
+}
+
+// ---------------------------------------------------------------------------
+ClassNodeListImpl::ClassNodeListImpl(NodeImpl* rootNode, const DOMString& classNames)
+    : NodeListImpl(rootNode, UNCACHEABLE, NodeListImpl::Cache::makeClassName)
+{
+    m_classNames.parseClassAttribute(classNames.string(), m_refNode->document()->inCompatMode());
+}
+
+bool ClassNodeListImpl::nodeMatches(NodeImpl *testNode, bool& doRecurse) const
+{
+    if (!testNode->isElementNode()) {
+        doRecurse = false;
+        return false;
+    }
+
+    if (!testNode->hasClass())
+        return false;
+
+    if (!m_classNames.size())
+        return false;
+
+    const ClassNames&  classes = static_cast<ElementImpl*>(testNode)->classNames();
+    for (size_t i = 0; i < m_classNames.size(); ++i) {
+        if (!classes.contains(m_classNames[i]))
+            return false;
+    }
+
+    return true;
+}

Zmiany atrybutów dla: khtml/xml/dom_nodelistimpl.cpp
___________________________________________________________________
Dodane: svn:mime-type
   + text/x-c++src
Dodane: svn:keywords
   + Author Date Id Revision
Dodane: svn:mergeinfo
Dodane: svn:eol-style
   + native

Index: khtml/xml/dom_nodeimpl.h
===================================================================
--- khtml/xml/dom_nodeimpl.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/xml/dom_nodeimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -111,6 +111,9 @@
 
     // HTML 5
     NodeListImpl* getElementsByClassName(const DOMString &name);
+    
+    // DOM3. See the wrapper (DOM::Node for the constants used in the return value
+    unsigned compareDocumentPosition(const DOM::NodeImpl* other);
 
     // insertBefore, replaceChild and appendChild also close newChild
     // unlike the speed optimized addChild (which is used by the parser)
@@ -582,140 +585,6 @@
     void dispatchChildRemovalEvents( NodeImpl *child, int &exceptioncode );
 };
 
-// --------------------------------------------------------------------------
-class Node;
-class NodeImpl;
-
-class NodeListImpl : public khtml::Shared<NodeListImpl>
-{
-public:
-    //Type of the item stored in the cache.
-    enum Type {
-        UNCACHEABLE, //Too complex to be cached like this
-        CHILD_NODES,
-        LAST_NODE_LIST = CHILD_NODES
-    };
-
-    struct CacheKey
-    {
-        NodeImpl* baseNode;
-        int       type;
-
-        CacheKey(): type(UNCACHEABLE) {}
-
-        CacheKey(NodeImpl* _baseNode, int _type):
-            baseNode(_baseNode), type(_type)
-        {}
-
-        int hash() const
-        {
-            return int(reinterpret_cast<unsigned long>(baseNode) >> 2) ^
-                       (unsigned(type) << 26);
-        }
-
-        bool operator==(const CacheKey& other) const
-        {
-            return baseNode == other.baseNode &&
-                   type     == other.type;
-        }
-    };
-
-    struct Cache: public khtml::Shared<Cache>
-    {
-        static Cache* make() { return new Cache; }
-
-        CacheKey key;//### We must store this in here due to QCache in Qt3 sucking
-
-        unsigned int version;
-        union
-        {
-            NodeImpl*    node;
-            unsigned int index;
-        } current;
-        unsigned int position;
-        unsigned int length;
-        bool         hasLength;
-
-        void updateNodeListInfo(DocumentImpl* doc);
-
-        virtual void clear(DocumentImpl* doc);
-        virtual ~Cache();
-    };
-
-    typedef Cache* CacheFactory();
-
-    NodeListImpl(NodeImpl* node, int type, CacheFactory* factory = 0);
-    virtual ~NodeListImpl();
-
-    // DOM methods & attributes for NodeList
-    virtual unsigned long length() const;
-    virtual NodeImpl *item ( unsigned long index ) const;
-
-    // Other methods (not part of DOM)
-
-protected:
-    virtual unsigned long calcLength(NodeImpl *start) const;
-    // helper functions for searching all ElementImpls in a tree
-
-    NodeImpl *recursiveItem    ( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const;
-    NodeImpl *recursiveItemBack( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const;
-
-    // Override this to determine what nodes to return. Set doRecurse to
-    // false if the children of this node do not need to be entered.
-    virtual bool nodeMatches( NodeImpl *testNode, bool& doRecurse ) const = 0;
-
-    NodeImpl*      m_refNode;
-    mutable Cache* m_cache;
-};
-
-class ChildNodeListImpl : public NodeListImpl
-{
-public:
-
-    ChildNodeListImpl( NodeImpl *n);
-
-protected:
-    virtual bool nodeMatches( NodeImpl *testNode, bool& doRecurse ) const;
-};
-
-
-/**
- * NodeList which lists all Nodes in a document with a given tag name
- */
-class TagNodeListImpl : public NodeListImpl
-{
-public:
-    TagNodeListImpl(NodeImpl *n, NamespaceName namespaceName, LocalName localName, PrefixName);
-    TagNodeListImpl(NodeImpl *n, const DOMString &namespaceURI, const DOMString &localName);
-
-    // Other methods (not part of DOM)
-
-protected:
-    virtual bool nodeMatches(NodeImpl *testNode, bool& doRecurse) const;
-    NamespaceName m_namespace;
-    LocalName m_localName;
-    PrefixName m_prefix;
-
-    bool m_namespaceAware;
-};
-
-
-/**
- * NodeList which lists all Nodes in a Element with a given "name=" tag
- */
-class NameNodeListImpl : public NodeListImpl
-{
-public:
-    NameNodeListImpl( NodeImpl *doc, const DOMString &t );
-
-    // Other methods (not part of DOM)
-
-protected:
-    virtual bool nodeMatches( NodeImpl *testNode, bool& doRecurse ) const;
-
-    DOMString nodeName;
-};
-
 // Generic NamedNodeMap interface
 // Other classes implement this for more specific situations e.g. attributes
 // of an element
Index: khtml/xml/dom_docimpl.h
===================================================================
--- khtml/xml/dom_docimpl.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/xml/dom_docimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -28,6 +28,7 @@
 #define _DOM_DocumentImpl_h_
 
 #include "xml/dom_elementimpl.h"
+#include "xml/dom_nodelistimpl.h"
 #include "xml/dom_textimpl.h"
 #include "xml/dom2_traversalimpl.h"
 #include "misc/shared.h"
@@ -554,9 +555,27 @@
     bool queryCommandState(const DOMString &command);
     bool queryCommandSupported(const DOMString &command);
     DOMString queryCommandValue(const DOMString &command);
+    
+    
+    // We version the tree to help determine which collection caches are 
+    // valid. All collections depend on the structural changes; and may depend 
+    // on some set of attributes.
+    enum TreeVersion {
+        TV_Structural,
+        TV_IDNameHref,
+        TV_Class,
+        NumTreeVersions
+    };
+    
+    void incDOMTreeVersion(unsigned ver) { ++m_domTreeVersions[ver]; }
+    unsigned int domTreeVersion(unsigned ver) const { return m_domTreeVersions[ver]; }
 
-    void incDOMTreeVersion() { ++m_domtree_version; }
-    unsigned int domTreeVersion() const { return m_domtree_version; }
+    // Since applications often re-creat nodelists all over the place, we cache 
+    // their caches in the documents. For now, we only do it for things that can be 
+    // parametrices by type + base node.
+    NodeListImpl::Cache* acquireCachedNodeListInfo(NodeListImpl::CacheFactory* fact,
+                                                   NodeImpl* base, int type);
+    void                 releaseCachedNodeListInfo(NodeListImpl::Cache* cache);
 
     JSEditor *jsEditor();
 
@@ -564,15 +583,10 @@
     void setCounters(const khtml::RenderObject* o, QHash<QString,khtml::CounterNode*> *dict) { m_counterDict.insert(o, dict);}
     void removeCounters(const khtml::RenderObject* o) { delete m_counterDict.take(o); }
 
-
     ElementMappingCache& underDocNamedCache() {
         return m_underDocNamedCache;
     }
-
-    NodeListImpl::Cache* acquireCachedNodeListInfo(NodeListImpl::CacheFactory* fact,
-                                                   NodeImpl* base, int type);
-    void                 releaseCachedNodeListInfo(NodeListImpl::Cache* cache);
-
+    
     ElementMappingCache& getElementByIdCache() const {
         return m_getElementByIdCache;
     }
@@ -630,7 +644,7 @@
     NodeImpl *m_activeNode;
     NodeImpl *m_cssTarget;
 
-    unsigned int m_domtree_version;
+    unsigned int m_domTreeVersions[NumTreeVersions];
 
     WebCore::SVGDocumentExtensions* m_svgExtensions;
 
@@ -775,3 +789,4 @@
 
 } //namespace
 #endif
+// kate: indent-width 4; replace-tabs on; tab-width 4; space-indent on;
Index: khtml/xml/dom_nodeimpl.cpp
===================================================================
--- khtml/xml/dom_nodeimpl.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/xml/dom_nodeimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -33,10 +33,10 @@
 #include "dom_textimpl.h"
 #include "dom2_eventsimpl.h"
 #include "dom_docimpl.h"
+#include "dom_nodelistimpl.h"
 #include "xml/dom_position.h"
 #include "xml/dom_selection.h"
 #include "dom_restyler.h"
-#include "ClassNodeList.h"
 #include "html/html_objectimpl.h"
 
 #include <kglobal.h>
@@ -666,7 +666,7 @@
 void NodeImpl::dispatchSubtreeModifiedEvent()
 {
     childrenChanged();
-    document()->incDOMTreeVersion();
+    document()->incDOMTreeVersion(DocumentImpl::TV_Structural);
     if (!document()->hasListenerType(DocumentImpl::DOMSUBTREEMODIFIED_LISTENER))
         return;
     int exceptioncode = 0;
@@ -959,7 +959,7 @@
         if (closed()) m_render->close();
         if (hovered()) m_render->setMouseInside();
     }
-    document()->incDOMTreeVersion();
+    document()->incDOMTreeVersion(DocumentImpl::TV_Structural);
     m_attached = true;
 }
 
@@ -971,7 +971,7 @@
         m_render->detach();
 
     m_render = 0;
-    document()->incDOMTreeVersion();
+    document()->incDOMTreeVersion(DocumentImpl::TV_Structural);
     m_attached = false;
 }
 
@@ -1135,7 +1135,7 @@
 {
     return renderer() ? renderer()->caretMinOffset() : 0;
 }
- 
+
 long NodeImpl::caretMaxOffset() const
 {
     return renderer() ? renderer()->caretMaxOffset() : 1;
@@ -1257,7 +1257,7 @@
 
 NodeListImpl* NodeImpl::getElementsByClassName(const DOMString &name)
 {
-    return new ClassNodeList(this, name);
+    return new ClassNodeListImpl(this, name);
 }
 
 bool NodeImpl::hasAttributes() const
@@ -1283,6 +1283,105 @@
         return doc;
 }
 
+// Helper for compareDocumentPosition --- this extends the notion of a parent node
+// beyond structural to also include elements containing attributes, etc.
+static const NodeImpl* logicalParentNode(const DOM::NodeImpl* node)
+{
+    NodeImpl* parent = node->parentNode();
+    if (parent)
+        return parent;
+        
+    switch (node->nodeType()) {
+        case Node::ATTRIBUTE_NODE:
+            return static_cast<const AttrImpl*>(node)->ownerElement();
+        
+        case Node::ENTITY_NODE:
+        case Node::NOTATION_NODE:
+            return node->ownerDocument()->doctype();
+            
+        default:
+            return 0;
+    }
+}
+
+unsigned NodeImpl::compareDocumentPosition(const DOM::NodeImpl* other)
+{
+    if (other == this)
+        return 0; 
+        
+    // First, collect paths of the parents of this and other to the root of their subtrees.
+    // Root goes first, hence the use of QList, with its fast prepends
+    QList<const NodeImpl*> thisPath;
+    for (const NodeImpl* cur = this; cur; cur = logicalParentNode(cur))
+        thisPath.prepend(cur);
+        
+    QList<const NodeImpl*> otherPath;
+    for (const NodeImpl* cur = other; cur; cur = logicalParentNode(cur))
+        otherPath.prepend(cur);
+        
+    // if the roots aren't the same, we're disconnected. We're also supposed to 
+    // return IMPLEMENTATION_SPECIFIC here, and, reading tea leaves, make some 
+    // sort of a stable decision to get a total order.
+    if (thisPath[0] != otherPath[0]) {
+        return Node::DOCUMENT_POSITION_DISCONNECTED | Node::DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC |
+               (this > other ? Node::DOCUMENT_POSITION_PRECEDING : Node::DOCUMENT_POSITION_FOLLOWING);
+    }
+        
+    // Now find our common container.
+    const NodeImpl* common = 0;
+    int   diffPos = -1;
+    for (int pos = 0; pos < thisPath.size() && pos < otherPath.size(); ++pos) {
+        if (thisPath[pos] == otherPath[pos]) {
+            common = thisPath[pos];
+        } else {
+            diffPos = pos;
+            break;
+        }
+    }
+    
+    // Do we have direct containment? 
+    if (common == this)
+        return Node::DOCUMENT_POSITION_CONTAINED_BY | Node::DOCUMENT_POSITION_FOLLOWING;
+    else if (common == other)
+        return Node::DOCUMENT_POSITION_CONTAINS | Node::DOCUMENT_POSITION_PRECEDING;
+        
+    // OK, so now we are not nested, so there are ancestors of both nodes
+    // below common that are different. Since some of those may be logically and not 
+    // physically contained in common, we have to treat the logical containment case specially.
+    const NodeImpl* thisAnc  = thisPath [diffPos];
+    const NodeImpl* otherAnc = otherPath[diffPos];
+    
+    bool thisAncLogical  = thisAnc->parentNode() == 0;
+    bool otherAncLogical = otherAnc->parentNode() == 0;
+    kDebug() << thisAncLogical << otherAncLogical;
+    
+    if (thisAncLogical && otherAncLogical) {
+        // First, try to order by nodeType.
+        if (thisAnc->nodeType() != otherAnc->nodeType())
+            return (thisAnc->nodeType() < otherAnc->nodeType()) ? 
+                Node::DOCUMENT_POSITION_FOLLOWING : Node::DOCUMENT_POSITION_PRECEDING;
+                
+        // If not, another implementation-specific order.
+        return Node::DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC |
+               (this > other ? Node::DOCUMENT_POSITION_PRECEDING : Node::DOCUMENT_POSITION_FOLLOWING);
+    }
+    
+    if (thisAncLogical)
+        return Node::DOCUMENT_POSITION_FOLLOWING;
+        
+    if (otherAncLogical)
+        return Node::DOCUMENT_POSITION_PRECEDING;
+        
+    // Uff. And now the normal case -- just order thisAnc and otherAnc based on their tree order
+    // see if otherAnc follows thisAnc)
+    for (const NodeImpl* cur = thisAnc; cur; cur = cur->nextSibling()) {
+        if (cur == otherAnc)
+            return Node::DOCUMENT_POSITION_FOLLOWING;
+    }
+    
+    return Node::DOCUMENT_POSITION_PRECEDING;
+}
+
 void NodeImpl::setDocument(DocumentImpl* doc)
 {
     if (m_document == doc)
@@ -1951,230 +2050,7 @@
 }
 
 // ---------------------------------------------------------------------------
-NodeImpl *NodeListImpl::item( unsigned long index ) const
-{
-    unsigned long requestIndex = index;
 
-    m_cache->updateNodeListInfo(m_refNode->document());
-
-    NodeImpl* n;
-    bool usedCache = false;
-    if (m_cache->current.node) {
-        //Compute distance from the requested index to the cache node
-        unsigned long cacheDist = qAbs(long(index) - long(m_cache->position));
-
-        if (cacheDist < (unsigned long)index) { //Closer to the cached position
-            usedCache = true;
-            if (index >= m_cache->position) { //Go ahead
-                unsigned long relIndex = index - m_cache->position;
-                n = recursiveItem(m_refNode, m_cache->current.node, relIndex);
-            } else { //Go backwards
-                unsigned long relIndex = m_cache->position - index;
-                n = recursiveItemBack(m_refNode, m_cache->current.node, relIndex);
-            }
-        }
-    }
-
-    if (!usedCache)
-        n = recursiveItem(m_refNode, m_refNode->firstChild(), index);
-
-    //We always update the cache state, to make starting iteration
-    //where it was left off easy.
-    m_cache->current.node  = n;
-    m_cache->position = requestIndex;
-    return n;
-}
-
-unsigned long NodeListImpl::length() const
-{
-    m_cache->updateNodeListInfo(m_refNode->document());
-    if (!m_cache->hasLength) {
-        m_cache->length    = calcLength( m_refNode );
-        m_cache->hasLength = true;
-    }
-    return m_cache->length;
-}
-
-unsigned long NodeListImpl::calcLength(NodeImpl *start) const
-{
-    unsigned long len = 0;
-    for(NodeImpl *n = start->firstChild(); n != 0; n = n->nextSibling()) {
-        bool recurse = true;
-        if (nodeMatches(n, recurse))
-                len++;
-        if (recurse)
-            len+= NodeListImpl::calcLength(n);
-    }
-
-
-    return len;
-}
-
-NodeListImpl::NodeListImpl( NodeImpl *n, int type, CacheFactory* factory )
-{
-    m_refNode = n;
-    m_refNode->ref();
-
-    m_cache = m_refNode->document()->acquireCachedNodeListInfo(
-                  factory ? factory : Cache::make,
-                  n, type );
-}
-
-NodeListImpl::~NodeListImpl()
-{
-    m_refNode->document()->releaseCachedNodeListInfo(m_cache);
-    m_refNode->deref();
-}
-
-
-/**
- Next item in the pre-order walk of tree from node, but not going outside
- absStart
-*/
-static NodeImpl* helperNext(NodeImpl* node, NodeImpl* absStart)
-{
-    //Walk up until we wind a sibling to go to.
-    while (!node->nextSibling() && node != absStart)
-        node = node->parentNode();
-
-    if (node != absStart)
-        return node->nextSibling();
-    else
-        return 0;
-}
-
-NodeImpl *NodeListImpl::recursiveItem ( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const
-{
-    for(NodeImpl *n = start; n != 0; n = helperNext(n, absStart)) {
-        bool recurse = true;
-        if (nodeMatches(n, recurse))
-            if (!offset--)
-                return n;
-
-        NodeImpl *depthSearch = recurse ? recursiveItem(n, n->firstChild(), offset) : 0;
-        if (depthSearch)
-            return depthSearch;
-    }
-
-    return 0; // no matching node in this subtree
-}
-
-
-NodeImpl *NodeListImpl::recursiveItemBack ( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const
-{
-    //### it might be cleaner/faster to split nodeMatches and recursion
-    //filtering.
-    bool dummy   = true;
-    NodeImpl* n  = start;
-
-    do {
-        bool recurse = true;
-
-        //Check whether the current node matches.
-        if (nodeMatches(n, dummy))
-            if (!offset--)
-                return n;
-
-        if (n->previousSibling()) {
-            //Move to the last node of this whole subtree that we should recurse into
-            n       = n->previousSibling();
-            recurse = true;
-
-            while (n->lastChild()) {
-                (void)nodeMatches(n, recurse);
-                if (!recurse)
-                   break; //Don't go there
-                n = n->lastChild();
-            }
-        } else {
-            //We're done with this whole subtree, so move up
-            n = n->parentNode();
-        }
-    }
-    while (n && n != absStart);
-
-    return 0;
-}
-
-
-NodeListImpl::Cache::~Cache()
-{}
-
-void NodeListImpl::Cache::clear(DocumentImpl* doc)
-{
-   hasLength = false;
-   current.node = 0;
-   version   = doc->domTreeVersion();
-}
-
-void NodeListImpl::Cache::updateNodeListInfo(DocumentImpl* doc)
-{
-    //If version doesn't match, clear
-    if (doc->domTreeVersion() != version)
-        clear(doc);
-}
-
-ChildNodeListImpl::ChildNodeListImpl( NodeImpl *n ): NodeListImpl(n, CHILD_NODES)
-{}
-
-bool ChildNodeListImpl::nodeMatches( NodeImpl* /*testNode*/, bool& doRecurse ) const
-{
-    doRecurse = false;
-    return true;
-}
-
-TagNodeListImpl::TagNodeListImpl(NodeImpl *n, NamespaceName namespaceName, LocalName localName, PrefixName prefix)
-  : NodeListImpl(n, UNCACHEABLE),
-    m_namespaceAware(false)
-{
-    m_namespace = namespaceName;
-    m_localName = localName;
-    m_prefix = prefix;
-}
-
-TagNodeListImpl::TagNodeListImpl( NodeImpl *n, const DOMString &namespaceURI, const DOMString &localName )
-  : NodeListImpl(n, UNCACHEABLE),
-    m_namespaceAware(true)
-{
-    if (namespaceURI == "*")
-        m_namespace = NamespaceName::fromId(anyNamespace);
-    else
-        m_namespace = NamespaceName::fromString(namespaceURI);
-    if (localName == "*")
-        m_localName = LocalName::fromId(anyLocalName);
-    else
-        m_localName = LocalName::fromString(localName);
-    m_prefix = PrefixName::fromId(emptyPrefix);
-}
-
-
-bool TagNodeListImpl::nodeMatches(NodeImpl *testNode, bool& /*doRecurse*/) const
-{
-    if (testNode->nodeType() != Node::ELEMENT_NODE)
-        return false;
-
-    if (m_namespaceAware) {
-        return (m_namespace.id() == anyNamespace || m_namespace.id() == namespacePart(testNode->id())) &&
-            (m_localName.id() == anyLocalName || m_localName.id() == localNamePart(testNode->id()));
-    } else {
-        return (m_localName.id() == anyLocalName) || (m_localName.id() == localNamePart(testNode->id()) &&
-            m_prefix == static_cast<ElementImpl*>(testNode)->prefixName());
-    }
-}
-
-NameNodeListImpl::NameNodeListImpl(NodeImpl *n, const DOMString &t )
-  : NodeListImpl(n, UNCACHEABLE),
-    nodeName(t)
-{}
-
-bool NameNodeListImpl::nodeMatches( NodeImpl *testNode, bool& /*doRecurse*/ ) const
-{
-    if ( testNode->nodeType() != Node::ELEMENT_NODE ) return false;
-    return static_cast<ElementImpl *>(testNode)->getAttribute(ATTR_NAME) == nodeName;
-}
-
-// ---------------------------------------------------------------------------
-
 NamedNodeMapImpl::NamedNodeMapImpl()
 {
 }
@@ -2208,7 +2084,7 @@
     PrefixName prefix;
     LocalName  localName;
     splitPrefixLocalName(name, prefix, localName, htmlCompat());
-    
+
     Node r = removeNamedItem(localName.id(), prefix, false, exceptioncode);
     return r;
 }
@@ -2412,3 +2288,5 @@
 RegisteredListenerList::~RegisteredListenerList() {
     delete listeners; listeners = 0;
 }
+
+// kate: indent-width 4; replace-tabs on; tab-width 4; space-indent on; 
Index: khtml/xml/dom_nodelistimpl.h
===================================================================
--- khtml/xml/dom_nodelistimpl.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 0)
+++ khtml/xml/dom_nodelistimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -0,0 +1,214 @@
+/*
+ * This file is part of the DOM implementation for KDE.
+ *
+ * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
+ *           (C) 1999 Antti Koivisto (koivisto@kde.org)
+ *           (C) 2001 Dirk Mueller (mueller@kde.org)
+ *           (C) 2003, 2004, 2005, 2006, 2007 Apple Inc. All rights reserved.
+ *           (C) 2007 David Smith (catfish.man@gmail.com)
+ *           (C) 2005, 2009 Maksim Orlovich (maksim@kde.org)
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public License
+ * along with this library; see the file COPYING.LIB.  If not, write to
+ * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+ * Boston, MA 02110-1301, USA.
+ *
+ * The code for ClassNodeListImpl was originally licensed under the following terms
+ * (but in this version is available only as above):
+ *     Redistribution and use in source and binary forms, with or without
+ *     modification, are permitted provided that the following conditions
+ *     are met:
+ *
+ *     1.  Redistributions of source code must retain the above copyright
+ *         notice, this list of conditions and the following disclaimer.
+ *     2.  Redistributions in binary form must reproduce the above copyright
+ *         notice, this list of conditions and the following disclaimer in the
+ *         documentation and/or other materials provided with the distribution.
+ *     3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
+ *         its contributors may be used to endorse or promote products derived
+ *         from this software without specific prior written permission.
+ *
+ *     THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
+ *     EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ *     WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+ *     DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
+ *     DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+ *     (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ *     LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
+ *     ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ *     (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
+ *     THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#ifndef _DOM_NodeListImpl_h_
+#define _DOM_NodeListImpl_h_
+
+#include "dom/dom_string.h"
+#include "misc/shared.h"
+#include "misc/htmlnames.h"
+#include "ClassNames.h"
+
+namespace DOM {
+
+class NodeImpl;
+class DocumentImpl;
+
+class NodeListImpl : public khtml::Shared<NodeListImpl>
+{
+public:
+    //Type of the item stored in the cache.
+    enum Type {
+        UNCACHEABLE, // Too complex to remember in document -- we still track the position
+        CHILD_NODES,
+        LAST_NODE_LIST = CHILD_NODES
+    };
+    
+    struct CacheKey
+    {
+        NodeImpl* baseNode;
+        int       type;
+
+        CacheKey(): type(UNCACHEABLE) {}
+
+        CacheKey(NodeImpl* _baseNode, int _type):
+            baseNode(_baseNode), type(_type)
+        {}
+
+        int hash() const
+        {
+            return int(reinterpret_cast<unsigned long>(baseNode) >> 2) ^
+                       (unsigned(type) << 26);
+        }
+
+        bool operator==(const CacheKey& other) const
+        {
+            return baseNode == other.baseNode &&
+                   type     == other.type;
+        }
+    };
+
+    struct Cache: public khtml::Shared<Cache>
+    {
+        static Cache* makeStructuralOnly();
+        static Cache* makeNameOrID();
+        static Cache* makeClassName();
+        
+        Cache(unsigned short relSecondaryVer);
+
+        CacheKey key;//### We must store this in here due to QCache in Qt3 sucking
+
+        unsigned int version; // structural version.
+        unsigned int secondaryVersion; 
+        union
+        {
+            NodeImpl*    node;
+            unsigned int index;
+        } current;
+        unsigned int position;
+        unsigned int length;
+        bool         hasLength;
+        unsigned short relevantSecondaryVer;
+
+        void updateNodeListInfo(DocumentImpl* doc);
+
+        virtual void clear(DocumentImpl* doc);
+        virtual ~Cache();
+    };
+
+    typedef Cache* CacheFactory();
+
+    NodeListImpl(NodeImpl* node, int type, CacheFactory* factory);
+    virtual ~NodeListImpl();
+
+    // DOM methods & attributes for NodeList
+    virtual unsigned long length() const;
+    virtual NodeImpl *item ( unsigned long index ) const;
+
+    // Other methods (not part of DOM)
+
+protected:
+    virtual unsigned long calcLength(NodeImpl *start) const;
+    // helper functions for searching all ElementImpls in a tree
+
+    NodeImpl *recursiveItem    ( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const;
+    NodeImpl *recursiveItemBack( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const;
+
+    // Override this to determine what nodes to return. Set doRecurse to
+    // false if the children of this node do not need to be entered.
+    virtual bool nodeMatches( NodeImpl *testNode, bool& doRecurse ) const = 0;
+
+    NodeImpl*      m_refNode;
+    mutable Cache* m_cache;
+};
+
+class ChildNodeListImpl : public NodeListImpl
+{
+public:
+
+    ChildNodeListImpl( NodeImpl *n);
+
+protected:
+    virtual bool nodeMatches( NodeImpl *testNode, bool& doRecurse ) const;
+};
+
+
+/**
+ * NodeList which lists all Nodes in a document with a given tag name
+ */
+class TagNodeListImpl : public NodeListImpl
+{
+public:
+    TagNodeListImpl(NodeImpl *n, NamespaceName namespaceName, LocalName localName, PrefixName);
+    TagNodeListImpl(NodeImpl *n, const DOMString &namespaceURI, const DOMString &localName);
+
+    // Other methods (not part of DOM)
+
+protected:
+    virtual bool nodeMatches(NodeImpl *testNode, bool& doRecurse) const;
+    NamespaceName m_namespace;
+    LocalName m_localName;
+    PrefixName m_prefix;
+
+    bool m_namespaceAware;
+};
+
+
+/**
+ * NodeList which lists all Nodes in a Element with a given "name=" tag
+ */
+class NameNodeListImpl : public NodeListImpl
+{
+public:
+    NameNodeListImpl( NodeImpl *doc, const DOMString &t );
+
+    // Other methods (not part of DOM)
+
+protected:
+    virtual bool nodeMatches( NodeImpl *testNode, bool& doRecurse ) const;
+
+    DOMString nodeName;
+};
+
+/** For getElementsByClassName */
+class ClassNodeListImpl : public NodeListImpl {
+public:
+    ClassNodeListImpl(NodeImpl* rootNode, const DOMString& classNames);
+
+private:
+    virtual bool nodeMatches(NodeImpl *testNode, bool& doRecurse) const;
+
+    ClassNames m_classNames;
+};
+
+} //namespace
+#endif
+// kate: indent-width 4; replace-tabs on; tab-width 4; space-indent on;

Zmiany atrybutów dla: khtml/xml/dom_nodelistimpl.h
___________________________________________________________________
Dodane: svn:mime-type
   + text/x-chdr
Dodane: svn:keywords
   + Author Date Id Revision
Dodane: svn:mergeinfo
Dodane: svn:eol-style
   + native

Index: khtml/xml/dom_docimpl.cpp
===================================================================
--- khtml/xml/dom_docimpl.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ khtml/xml/dom_docimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -382,7 +382,7 @@
 
 // KHTMLView might be 0
 DocumentImpl::DocumentImpl(DOMImplementationImpl *_implementation, KHTMLView *v)
-    : NodeBaseImpl( 0 ), m_svgExtensions(0), m_domtree_version(0), m_counterDict(),
+    : NodeBaseImpl( 0 ), m_svgExtensions(0), m_counterDict(),
       m_imageLoadEventTimer(0)
 {
     m_document.resetSkippingRef(this); //Make document return us..
@@ -443,6 +443,9 @@
     m_jsEditor = 0;
     m_dynamicDomRestyler = new khtml::DynamicDomRestyler();
     m_stateRestorePos = 0;
+    
+    for (int c = 0; c < NumTreeVersions; ++c)
+        m_domTreeVersions[c] = 0;
 }
 
 void DocumentImpl::removedLastRef()
Index: cmake/modules/CheckCXXSymbolExists.cmake
===================================================================
--- cmake/modules/CheckCXXSymbolExists.cmake	(.../tags/KDE/4.2.3/kdelibs)	(wersja 0)
+++ cmake/modules/CheckCXXSymbolExists.cmake	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -0,0 +1,71 @@
+# - Check if the symbol exists in include files, in C++ mode
+# Forked off cmake's CheckSymbolExists.cmake
+# CHECK_CXX_SYMBOL_EXISTS(SYMBOL FILES VARIABLE)
+#
+#  SYMBOL   - symbol
+#  FILES    - include files to check
+#  VARIABLE - variable to return result
+#
+# The following variables may be set before calling this macro to
+# modify the way the check is run:
+#
+#  CMAKE_REQUIRED_FLAGS = string of compile command line flags
+#  CMAKE_REQUIRED_DEFINITIONS = list of macros to define (-DFOO=bar)
+#  CMAKE_REQUIRED_INCLUDES = list of include directories
+#  CMAKE_REQUIRED_LIBRARIES = list of libraries to link
+
+MACRO(CHECK_CXX_SYMBOL_EXISTS SYMBOL FILES VARIABLE)
+  IF("${VARIABLE}" MATCHES "^${VARIABLE}$")
+    SET(CMAKE_CONFIGURABLE_FILE_CONTENT "/* */\n")
+    SET(MACRO_CHECK_SYMBOL_EXISTS_FLAGS ${CMAKE_REQUIRED_FLAGS})
+    IF(CMAKE_REQUIRED_LIBRARIES)
+      SET(CHECK_SYMBOL_EXISTS_LIBS 
+        "-DLINK_LIBRARIES:STRING=${CMAKE_REQUIRED_LIBRARIES}")
+    ELSE(CMAKE_REQUIRED_LIBRARIES)
+      SET(CHECK_SYMBOL_EXISTS_LIBS)
+    ENDIF(CMAKE_REQUIRED_LIBRARIES)
+    IF(CMAKE_REQUIRED_INCLUDES)
+      SET(CMAKE_SYMBOL_EXISTS_INCLUDES
+        "-DINCLUDE_DIRECTORIES:STRING=${CMAKE_REQUIRED_INCLUDES}")
+    ELSE(CMAKE_REQUIRED_INCLUDES)
+      SET(CMAKE_SYMBOL_EXISTS_INCLUDES)
+    ENDIF(CMAKE_REQUIRED_INCLUDES)
+    FOREACH(FILE ${FILES})
+      SET(CMAKE_CONFIGURABLE_FILE_CONTENT
+        "${CMAKE_CONFIGURABLE_FILE_CONTENT}#include <${FILE}>\n")
+    ENDFOREACH(FILE)
+    SET(CMAKE_CONFIGURABLE_FILE_CONTENT
+      "${CMAKE_CONFIGURABLE_FILE_CONTENT}\nvoid cmakeRequireSymbol(int dummy,...){(void)dummy;}\nint main()\n{\n#ifndef ${SYMBOL}\n  cmakeRequireSymbol(0,&${SYMBOL});\n#endif\n  return 0;\n}\n")
+
+    CONFIGURE_FILE("${CMAKE_ROOT}/Modules/CMakeConfigurableFile.in"
+      "${CMAKE_BINARY_DIR}${CMAKE_FILES_DIRECTORY}/CMakeTmp/CheckSymbolExists.cxx" @ONLY)
+
+    MESSAGE(STATUS "Looking for ${SYMBOL}")
+    TRY_COMPILE(${VARIABLE}
+      ${CMAKE_BINARY_DIR}
+      ${CMAKE_BINARY_DIR}${CMAKE_FILES_DIRECTORY}/CMakeTmp/CheckSymbolExists.cxx
+      COMPILE_DEFINITIONS ${CMAKE_REQUIRED_DEFINITIONS}
+      CMAKE_FLAGS 
+      -DCOMPILE_DEFINITIONS:STRING=${MACRO_CHECK_SYMBOL_EXISTS_FLAGS}
+      "${CHECK_SYMBOL_EXISTS_LIBS}"
+      "${CMAKE_SYMBOL_EXISTS_INCLUDES}"
+      OUTPUT_VARIABLE OUTPUT)
+    IF(${VARIABLE})
+      MESSAGE(STATUS "Looking for ${SYMBOL} - found")
+      SET(${VARIABLE} 1 CACHE INTERNAL "Have symbol ${SYMBOL}")
+      FILE(APPEND ${CMAKE_BINARY_DIR}${CMAKE_FILES_DIRECTORY}/CMakeOutput.log 
+        "Determining if the ${SYMBOL} "
+        "exist passed with the following output:\n"
+        "${OUTPUT}\nFile ${CMAKE_BINARY_DIR}${CMAKE_FILES_DIRECTORY}/CMakeTmp/CheckSymbolExists.cxx:\n"
+        "${CMAKE_CONFIGURABLE_FILE_CONTENT}\n")
+    ELSE(${VARIABLE})
+      MESSAGE(STATUS "Looking for ${SYMBOL} - not found.")
+      SET(${VARIABLE} "" CACHE INTERNAL "Have symbol ${SYMBOL}")
+      FILE(APPEND ${CMAKE_BINARY_DIR}${CMAKE_FILES_DIRECTORY}/CMakeError.log 
+        "Determining if the ${SYMBOL} "
+        "exist failed with the following output:\n"
+        "${OUTPUT}\nFile ${CMAKE_BINARY_DIR}${CMAKE_FILES_DIRECTORY}/CMakeTmp/CheckSymbolExists.cxx:\n"
+        "${CMAKE_CONFIGURABLE_FILE_CONTENT}\n")
+    ENDIF(${VARIABLE})
+  ENDIF("${VARIABLE}" MATCHES "^${VARIABLE}$")
+ENDMACRO(CHECK_CXX_SYMBOL_EXISTS)
Index: ConfigureChecks.cmake
===================================================================
--- ConfigureChecks.cmake	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ ConfigureChecks.cmake	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -6,6 +6,7 @@
 include(CheckIncludeFile)
 include(CheckIncludeFiles)
 include(CheckSymbolExists)
+include(CheckCXXSymbolExists)
 include(CheckFunctionExists)
 include(CheckLibraryExists)
 include(CheckPrototypeExists)
@@ -230,7 +231,15 @@
 check_function_exists(random     HAVE_RANDOM)            # kdecore/fakes.c
 check_function_exists(strlcpy    HAVE_STRLCPY)           # kdecore/fakes.c
 check_function_exists(strlcat    HAVE_STRLCAT)           # kdecore/fakes.c
-check_function_exists(strcasestr HAVE_STRCASESTR)        # kdecore/fakes.c
+check_cxx_symbol_exists(__CORRECT_ISO_CPP_STRING_H_PROTO "string.h" HAVE_STRCASESTR_OVERLOAD) # glibc-2.9 strangeness
+if (HAVE_STRCASESTR_OVERLOAD)
+  message(STATUS "string.h defines __CORRECT_ISO_CPP_STRING_H_PROTO")
+  set(HAVE_STRCASESTR 1)
+  set(HAVE_STRCASESTR_PROTO 1)
+else()
+  check_function_exists(strcasestr HAVE_STRCASESTR)        # kdecore/fakes.c
+  check_prototype_exists(strcasestr string.h          HAVE_STRCASESTR_PROTO)
+endif()
 check_function_exists(setenv     HAVE_SETENV)            # kdecore/fakes.c
 check_function_exists(seteuid    HAVE_SETEUID)           # kdecore/fakes.c
 check_function_exists(setmntent  HAVE_SETMNTENT)         # solid, kio, kdecore
@@ -243,7 +252,6 @@
 check_prototype_exists(mkdtemp "stdlib.h;unistd.h"  HAVE_MKDTEMP_PROTO)
 check_prototype_exists(mkstemp "stdlib.h;unistd.h"  HAVE_MKSTEMP_PROTO)
 check_prototype_exists(strlcat string.h             HAVE_STRLCAT_PROTO)
-check_prototype_exists(strcasestr string.h          HAVE_STRCASESTR_PROTO)
 check_prototype_exists(strlcpy string.h             HAVE_STRLCPY_PROTO)
 check_prototype_exists(random stdlib.h              HAVE_RANDOM_PROTO)
 check_prototype_exists(res_init "sys/types.h;netinet/in.h;arpa/nameser.h;resolv.h" HAVE_RES_INIT_PROTO)
Index: interfaces/ktexteditor/ktexteditor.desktop
===================================================================
--- interfaces/ktexteditor/ktexteditor.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ interfaces/ktexteditor/ktexteditor.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -51,7 +51,7 @@
 Comment[ml]=എംബഡ് ചെയ്യാവുന്ന ടെക്സ്റ്റ് എഴുത്തിടമെന്ന ഘടകം (ഡോക്/വ്യൂ വ്യത്യാസത്തോടെ)
 Comment[mr]=अंतर्भूतीत पाठ्य संपादक घटक (दस्तऐवज/प्रदर्शन विभाजन सह)
 Comment[ms]=Komponen Penyunting Teks Boleh Selit (Dokumentasi/Pelihat berasingan)
-Comment[nb]=Innebygget skriveprogram (med Doc/View-skille)
+Comment[nb]=Innebygget skriveprogram-komponent (med Doc/View-skille)
 Comment[nds]=Inbettbor Texteditor-Komponent (mit Dokment/Ansicht-Trennen)
 Comment[ne]=सम्मिलित पाठ सम्पादक अवयव (Doc/View Separation बाट)
 Comment[nl]=Ingebed tekstinvoercomponent (met scheiding van tekst/weergave)
@@ -78,8 +78,8 @@
 Comment[uz@cyrillic]=Ичига ўрнатиб бўладиган матн таҳрирчи компоненти (ҳужжат/кўриниш имконияти билан)
 Comment[vi]=Thành phần Soạn thảo Văn bản có nhúng được (có khả năng phân cách tài liệu/khung xem)
 Comment[wa]=Ravalé compôzant aspougneu d' tecse (avou dispårtaedje documint/vuwe)
+Comment[xh]=Inxenye Yomhleli Wombhalo Olungiselelweyo (ngo Xwebhu/Ulwahlulo Lwemboniselo)
 Comment[x-test]=xxEmbeddable Text Editor Component (with Doc/View Separation)xx
-Comment[xh]=Inxenye Yomhleli Wombhalo Olungiselelweyo (ngo Xwebhu/Ulwahlulo Lwemboniselo)
 Comment[zh_CN]=可嵌入的文本编辑器部件(文档和视图分离)
 Comment[zh_HK]=可嵌入的文字編輯器元件 (Doc/View 分開)
 Comment[zh_TW]=可嵌入的文字編輯器元件 (Doc/View 分開)
Index: interfaces/ktexteditor/ktexteditorplugin.desktop
===================================================================
--- interfaces/ktexteditor/ktexteditorplugin.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ interfaces/ktexteditor/ktexteditorplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -80,8 +80,8 @@
 Comment[uz@cyrillic]=KTextEditor плагини
 Comment[vi]=Bổ sung Soạn thảo Văn bản
 Comment[wa]=Tchôke-divins KTextEditor
+Comment[xh]=KTextEditor ye Plagi efakiweyo
 Comment[x-test]=xxKTextEditor Pluginxx
-Comment[xh]=KTextEditor ye Plagi efakiweyo
 Comment[zh_CN]=KTextEditor 插件
 Comment[zh_HK]=KTextEditor 外掛程式
 Comment[zh_TW]=KTextEditor 外掛程式
Index: interfaces/ktexteditor/kcm_ktexteditor.desktop
===================================================================
--- interfaces/ktexteditor/kcm_ktexteditor.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ interfaces/ktexteditor/kcm_ktexteditor.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -76,8 +76,8 @@
 Name[uz@cyrillic]=Ички матн таҳрирчи
 Name[vi]=Bộ Soạn thảo Văn bản nhúng
 Name[wa]=Ravalé aspougneu di tecse
+Name[xh]=Umhleli Wombhalo Olungiselelweyo
 Name[x-test]=xxEmbedded Text Editorxx
-Name[xh]=Umhleli Wombhalo Olungiselelweyo
 Name[zh_CN]=嵌入式文本编辑器
 Name[zh_HK]=嵌入式文字編輯器
 Name[zh_TW]=嵌入式文字編輯器
@@ -130,7 +130,7 @@
 Comment[ml]=ടെക്സ്റ്റ് എഴുത്തിടത്തിന്റെ സേവനം പ്രയോഗങ്ങള്‍ക്കു് പദാവലി കാണാനും മാറ്റാനുമുള്ള സംവിധാനം ഒരുക്കുന്നു. പദാവലി ലേഖനം ചെയ്യാനുള്ള സൌകര്യങ്ങളൊരുക്കുന്ന കെഡിഇയിലെ പ്രയോഗങ്ങള്‍ ഈ സേവനം ഉപയോഗിയ്ക്കണം.
 Comment[mr]=पाठ्य संपादक सेवा पाठ्य प्रदर्शक व संपादक समाविष्ठीत अनुप्रयोग पुरवितो. KDE अनुप्रयोग जे पाठ्य संपादन सुविधा पुरवितात ही सेवा वापरायला हवी.
 Comment[ms]= Servis penyunting teks yang menyediakan aplikasi dengan pelihat teks dan editor. Aplikasi KDE yang menyediakan kemudahan penyuntingan teks patut menggunakan servis ini.
-Comment[nb]=Det innebygde skriveprogrammet gir mulighet til å vise og redigere tekst. KDE-programmer som kan redigere tekst bør bruke denne tjenesten.
+Comment[nb]=Tjenesten innebygd skriveprogram gir programmer mulighet til å vise og redigere tekst. KDE-programmer som kan redigere tekst bør bruke denne tjenesten.
 Comment[nds]=De Texteditor-Deenst föögt Programmen en Textwieser un -editor to. KDE-Programmen, mit de Texten bewerkt warrt, schöölt em bruken.
 Comment[ne]=पाठ सम्पादक सेवाले पाठ दर्शक र सम्पादक भएको अनुप्रयोग उपलब्ध गराउँछ । पाठ सम्पादक सुविधा उपलब्ध गर्ने केडीई अनुप्रयोगले यो सेवा प्रयोग गर्नु आवश्यक हुन्छ ।
 Comment[nl]=Dit component stelt programma's een tekstinvoercomponent tot hun beschikking. KDE-toepassingen die te maken hebben met het bewerken van tekst kunnen gebruik maken van deze aangeboden dienst.
@@ -157,8 +157,8 @@
 Comment[uz@cyrillic]=Матн тарҳрирчи хизмати дастурларни матн кўрувчи ва таҳрирчи билан таъминлайди. Матн таҳрирлаш имкониятини яратувчи KDE дастурлари шу хизматни ишлатиши керак.
 Comment[vi]=Dịch vụ soạn thảo văn bản cung cấp cho ứng dụng một bộ xem và soạn thảo văn bản. Các ứng dụng KDE mà cung cấp khả năng soạn thảo văn bản nên dùng dịch vụ này.
 Comment[wa]=Li siervice aspougneu d' tecse dene åzès programes on håyneu et èn aspougneu d' tecses. Les programes KDE ki dnèt des fonccionålités d' aspougnaedje di tecse divèt eployî ç' siervice ci.
+Comment[xh]=Inkonzo yomhleli wombhalo onika izicelo ngombonisi wombhalo nomhleli Izicelo ze KDE ezinikezela ngohlelo lombhalo ekufuneka isebenzise lenkonzo.
 Comment[x-test]=xxThe text editor service provides applications with a text viewer and editor. KDE applications that provide text editing facilities should use this service.xx
-Comment[xh]=Inkonzo yomhleli wombhalo onika izicelo ngombonisi wombhalo nomhleli Izicelo ze KDE ezinikezela ngohlelo lombhalo ekufuneka isebenzise lenkonzo.
 Comment[zh_CN]=文本编辑器服务提供了文本查看器和编辑器的应用程序。提供文本编辑功能的 KDE 应用程序都应该使用此服务。
 Comment[zh_HK]=文字編輯服務為各種程式提供一個檢視和編輯文字的介面。任何提供文字編輯功能的 KDE 程式都應該使用這項服務。
 Comment[zh_TW]=文字編輯服務提供程式一個文字檢視器以及編輯器。提供文字編輯功能的 KDE 程式擁該使用這項服務。
Index: kate/plugins/kdatatool/ktexteditor_kdatatool.desktop
===================================================================
--- kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -159,8 +159,8 @@
 Comment[uz@cyrillic]=Луғат ва имлони текшириш воситаларни ёқиш (агар ўрнатилган бўлса)
 Comment[vi]=Hiệu lực công cụ dữ liệu như từ điển đồng nghĩa và bộ bắt lỗi chính tả (nếu được cài đặt).
 Comment[wa]=Mete en alaedje les usteyes po manaedjî les dnêyes, come les diccionaires ou les coridjreces (si astalés)
+Comment[xh]=Yenza izixhobo ze data ezinjenge thesaurus nomkhangeli wopelo (ukuba ifakelwe)
 Comment[x-test]=xxEnable data tools like thesaurus and spell check (if installed)xx
-Comment[xh]=Yenza izixhobo ze data ezinjenge thesaurus nomkhangeli wopelo (ukuba ifakelwe)
 Comment[zh_CN]=启用像辞典和拼写检查这样的数据工具(如果安装了的话)
 Comment[zh_HK]=如果有安裝的話，啟用像同義字字典和拼字檢查等的文字工具
 Comment[zh_TW]=打開資料工具如同義字典與拼字檢查 (如果有安裝的話)
Index: kate/vimode/katevinormalmode.cpp
===================================================================
--- kate/vimode/katevinormalmode.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/vimode/katevinormalmode.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -897,7 +897,7 @@
 }
 
 // insert the text in the given register at the cursor position
-// the cursor should end up at the end of what was pasted
+// the cursor should end up at the beginning of what was pasted
 bool KateViNormalMode::commandPaste()
 {
   KTextEditor::Cursor c( m_view->cursorPosition() );
@@ -913,18 +913,19 @@
     }
   }
 
-  if ( textToInsert.indexOf('\n') != -1 ) { // lines
+  if ( textToInsert.endsWith('\n') ) { // line(s)
     textToInsert.chop( 1 ); // remove the last \n
     c.setColumn( getLine().length() ); // paste after the current line and ...
     textToInsert.prepend( QChar( '\n' ) ); // ... prepend a \n, so the text starts on a new line
 
     cAfter.setLine( cAfter.line()+1 );
-  } else { // one line
+    cAfter.setColumn( 0 );
+  } else {
     if ( getLine( c.line() ).length() > 0 ) {
       c.setColumn( c.column()+1 );
     }
 
-    cAfter.setColumn( cAfter.column() + textToInsert.length() );
+    cAfter = c;
   }
 
   m_doc->insertText( c, textToInsert );
@@ -935,7 +936,7 @@
 }
 
 // insert the text in the given register before the cursor position
-// the cursor should end up at the end of what was pasted
+// the cursor should end up at the beginning of what was pasted
 bool KateViNormalMode::commandPasteBefore()
 {
   KTextEditor::Cursor c( m_view->cursorPosition() );
@@ -951,10 +952,9 @@
     }
   }
 
-  if ( textToInsert.indexOf('\n') != -1 ) { // lines
+  if ( textToInsert.endsWith('\n') ) { // lines
     c.setColumn( 0 );
-  } else {
-    cAfter.setColumn( cAfter.column()+textToInsert.length()-1 );
+    cAfter.setColumn( 0 );
   }
 
   m_doc->insertText( c, textToInsert );
Index: kate/vimode/katevivisualmode.cpp
===================================================================
--- kate/vimode/katevivisualmode.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/vimode/katevivisualmode.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -50,7 +50,7 @@
 void KateViVisualMode::highlight() const
 {
   // FIXME: HACK to avoid highlight bug: remove highlighing and re-set it
-  highlightRange->setAttribute(static_cast<KTextEditor::Attribute::Ptr>(0));
+  highlightRange->setAttribute(KTextEditor::Attribute::Ptr());
   highlightRange->setAttribute(attribute);
 
   KTextEditor::Cursor c1 = m_start;
@@ -100,7 +100,7 @@
 void KateViVisualMode::reset()
 {
     // remove highlighting
-    highlightRange->setAttribute(static_cast<KTextEditor::Attribute::Ptr>(0));
+    highlightRange->setAttribute(KTextEditor::Attribute::Ptr());
 
     m_awaitingMotionOrTextObject.push_back( 0 ); // search for text objects/motion from char 0
 
Index: kate/syntax/data/latex.xml
===================================================================
--- kate/syntax/data/latex.xml	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/syntax/data/latex.xml	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-	  <language name="LaTeX" version="1.31" section="Markup" kateversion="2.3" priority="10" extensions="*.tex; *.ltx; *.dtx; *.sty; *.cls;" mimetype="text/x-tex" casesensitive="1" author="Jeroen Wijnhout (Jeroen.Wijnhout@kdemail.net)+Holger Danielsson (holger.danielsson@versanet.de)+Michel Ludwig (michel.ludwig@kdemail.net)+Thomas Braun (braun@physik.fu-berlin.de)" license="LGPL" >
+	  <language name="LaTeX" version="1.33" section="Markup" kateversion="2.3" priority="10" extensions="*.tex;*.ltx;*.dtx;*.sty;*.cls;" mimetype="text/x-tex" casesensitive="1" author="Jeroen Wijnhout (Jeroen.Wijnhout@kdemail.net)+Holger Danielsson (holger.danielsson@versanet.de)+Michel Ludwig (michel.ludwig@kdemail.net)+Thomas Braun (braun@physik.fu-berlin.de)" license="LGPL" >
   <highlighting>
     <contexts>
       <!-- Normal text -->
@@ -23,9 +23,9 @@
         <DetectChar char="\" attribute="Keyword" context="ContrSeq"/>
         <StringDetect String="$$" attribute="Math" context="MathModeDisplay" beginRegion="mathMode" />
         <DetectChar char="$" attribute="Math" context="MathMode" beginRegion="mathMode" />
-        <DetectChar char="%" attribute="Comment" context="Comment"/>
         <RegExpr String="%\s*BEGIN.*$" attribute="Region Marker" context="#stay" beginRegion="regionMarker" firstNonSpace="true" />
         <RegExpr String="%\s*END.*$" attribute="Region Marker" context="#stay" endRegion="regionMarker" firstNonSpace="true" />
+        <DetectChar char="%" attribute="Comment" context="Comment"/>
         <DetectChar char="&#xd7;" attribute="Bullet" context="#stay"/>
       </context>
 
Index: kate/data/katepart.desktop
===================================================================
--- kate/data/katepart.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/data/katepart.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -77,8 +77,8 @@
 Name[uz@cyrillic]=Матн таҳрирчи
 Name[vi]=Bộ Soạn thảo Văn bản Cấp cao Nhúng
 Name[wa]=Ravalé aspougneu di tecse avancî
+Name[xh]=Umhleli Wombhalo Obhekisa phambili Olungiselweyo
 Name[x-test]=xxEmbedded Advanced Text Editorxx
-Name[xh]=Umhleli Wombhalo Obhekisa phambili Olungiselweyo
 Name[zh_CN]=嵌入式高级文本编辑器
 Name[zh_HK]=嵌入式進階文字編輯器
 Name[zh_TW]=嵌入式進階文字編輯器
Index: kate/completion/katecompletionwidget.cpp
===================================================================
--- kate/completion/katecompletionwidget.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/completion/katecompletionwidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -272,6 +272,7 @@
   m_presentationModel->clearCompletionModels();
   
   if(invocationType == KTextEditor::CodeCompletionModel::UserInvocation) {
+    QMutexLocker lock(view()->doc()->smartMutex());
     qDeleteAll(m_completionRanges);
     m_completionRanges.clear();
   }
@@ -285,6 +286,7 @@
     }
     if(!range.isValid()) {
       if(m_completionRanges.contains(model)) {
+        QMutexLocker lock(view()->doc()->smartMutex());
         KTextEditor::SmartRange *oldRange = m_completionRanges[model];
         m_completionRanges.remove(model);
         delete oldRange;
@@ -297,19 +299,26 @@
         continue; //Leave it running as it is
       }
       else { // delete the range that was used previously
+        QMutexLocker lock(view()->doc()->smartMutex());
         KTextEditor::SmartRange *oldRange = m_completionRanges[model];
         m_completionRanges.remove(model);
         delete oldRange;
       }
     }
     model->completionInvoked(view(), range, invocationType);
+
+    QMutexLocker lock(view()->doc()->smartMutex());
     m_completionRanges[model] = view()->doc()->smartManager()->newSmartRange(range);
     m_completionRanges[model]->setInsertBehavior(KTextEditor::SmartRange::ExpandRight | KTextEditor::SmartRange::ExpandLeft);
     if(!m_completionRanges[model]->isValid()) {
       kWarning(13035) << "Could not construct valid smart-range from" << range << "instead got" << *m_completionRanges[model];
+      lock.unlock();
       abortCompletion();
       return;
     }
+    
+    lock.unlock();
+    
     connect(m_completionRanges[model]->smartStart().notifier(), SIGNAL(characterDeleted(KTextEditor::SmartCursor*, bool)),
               SLOT(startCharacterDeleted(KTextEditor::SmartCursor*, bool)));
   }
@@ -555,6 +564,9 @@
   KTextEditor::Cursor cursor = view()->cursorPosition();
 
   QList<KTextEditor::CodeCompletionModel*> checkCompletionRanges = m_completionRanges.keys();
+  
+  QMutexLocker lock(view()->doc()->smartMutex());
+  lock.unlock();
 
   //Check the models and eventuall abort some
   for(QList<KTextEditor::CodeCompletionModel*>::iterator it = checkCompletionRanges.begin();
@@ -578,8 +590,12 @@
           abortCompletion();
           return;
         } else {
-          delete m_completionRanges[*it];
-          m_completionRanges.remove(*it);
+          {
+            lock.relock();
+            delete m_completionRanges[*it];
+            m_completionRanges.remove(*it);
+            lock.unlock();
+          }
 
           modelController(model)->aborted(view());
           m_presentationModel->removeCompletionModel(model);
@@ -621,7 +637,8 @@
   
   foreach(KTextEditor::CodeCompletionModel* model, m_completionRanges.keys())
     modelController(model)->aborted(view());
-  
+
+  QMutexLocker lock(view()->doc()->smartMutex());
   qDeleteAll(m_completionRanges);
   m_completionRanges.clear();
 }
Index: kate/view/kateviewhelpers.cpp
===================================================================
--- kate/view/kateviewhelpers.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/view/kateviewhelpers.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -328,6 +328,16 @@
   setAutoDeleteCompletionObject( false );
   m_cmdRange.setPattern("^([0-9.$]+)?,([0-9.$]+)?");
   m_gotoLine.setPattern("[+-]?\\d+");
+
+  m_hideTimer = new QTimer(this);
+  m_hideTimer->setSingleShot(true);
+  connect(m_hideTimer, SIGNAL(timeout()), this, SLOT(hideLineEdit()));
+
+  // make sure the timer is stopped when the user switches views. if not, focus will be given to the
+  // wrong view when KateViewBar::hideCurrentBarWidget() is called after 4 seconds. (the timer is
+  // used for showing things like "Success" for four seconds after the user has used the kate
+  // command line)
+  connect(m_view, SIGNAL(focusOut (KTextEditor::View*)), m_hideTimer, SLOT(stop()));
 }
 
 void KateCmdLineEdit::hideEvent(QHideEvent *e)
@@ -514,7 +524,7 @@
   m_cmdend = 0;
 
   m_view->setFocus ();
-  QTimer::singleShot( 4000, this, SLOT(hideLineEdit()) );
+  m_hideTimer->start(4000);
 }
 
 void KateCmdLineEdit::hideLineEdit () // unless i have focus ;)
Index: kate/view/kateviewhelpers.h
===================================================================
--- kate/view/kateviewhelpers.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/view/kateviewhelpers.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -48,6 +48,8 @@
   class AnnotationModel;
 }
 
+class QTimer;
+
 /**
  * This class is required because QScrollBar's sliderMoved() signal is
  * really supposed to be a sliderDragged() signal... so this way we can capture
@@ -411,6 +413,7 @@
     class KateCmdLnWhatsThis *m_help;
     QRegExp m_cmdRange;
     QRegExp m_gotoLine;
+    QTimer *m_hideTimer;
 };
 
 #endif
Index: kate/view/kateviewinternal.cpp
===================================================================
--- kate/view/kateviewinternal.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/view/kateviewinternal.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -3598,12 +3598,13 @@
     KTextEditor::Range oldRange(krange->kStart().lastPosition(), krange->kEnd().lastPosition());
     relayoutRange(oldRange);
   }*/
-
+  QMutexLocker lock(m_doc->smartMutex());
   relayoutRange(*range);
 }
 
 void KateViewInternal::rangeDeleted( KTextEditor::SmartRange * range )
 {
+  QMutexLocker lock(m_doc->smartMutex());
   relayoutRange(*range);
 }
 
@@ -3617,6 +3618,8 @@
 
 void KateViewInternal::rangeAttributeChanged( KTextEditor::SmartRange * range, KTextEditor::Attribute::Ptr currentAttribute, KTextEditor::Attribute::Ptr previousAttribute )
 {
+  QMutexLocker lock(m_doc->smartMutex());
+
   if (currentAttribute != previousAttribute)
     relayoutRange(*range);
 }
Index: kate/document/katebuffer.cpp
===================================================================
--- kate/document/katebuffer.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/document/katebuffer.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -121,7 +121,7 @@
           //may change codec if autodetection was set or BOM was found
           kDebug (13020) << "PROBER TYPE: " << KEncodingProber::nameForProberType(m_prober->proberType());
           m_prober->feed(m_buffer.data(), c);
-          if (m_prober->confidence() > 0.5)
+          if (m_prober->confidence() > 0.5 && QTextCodec::codecForName(m_prober->encodingName()))
             m_codec = QTextCodec::codecForName(m_prober->encodingName());
           m_utf8Borked=errorsIfUtf8(m_buffer.data(), c);
           m_binary=processNull(m_buffer.data(), c);
Index: kate/document/katedocument.cpp
===================================================================
--- kate/document/katedocument.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kate/document/katedocument.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -943,12 +943,12 @@
   else
     m_editSources.push(editSource);
 
+  // Unlocked in editEnd
+  smartMutex()->lock();
+
   if (editSessionNumber > 1)
     return;
 
-  // Unlocked in editEnd
-  smartMutex()->lock();
-
   editIsRunning = true;
   editWithUndo = withUndo;
 
@@ -1060,6 +1060,9 @@
 
   m_editSources.pop();
 
+  // Was locked in editStart
+  smartMutex()->unlock();
+
   if (editSessionNumber > 0)
     return;
 
@@ -1074,9 +1077,6 @@
   foreach(KateView *view, m_views)
     view->editEnd (m_buffer->editTagStart(), m_buffer->editTagEnd(), m_buffer->editTagFrom());
 
-  // Was locked in editStart
-  smartMutex()->unlock();
-
   if (m_buffer->editChanged())
   {
     setModified(true);
Index: kjs/date_object.cpp
===================================================================
--- kjs/date_object.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kjs/date_object.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -615,7 +615,7 @@
 
   if (id == SetTime) {
     double milli = roundValue(exec, args[0]);
-    result = jsNumber(milli);
+    result = jsNumber(timeClip(milli));
     thisDateObj->setInternalValue(result);
     return result;
   }
@@ -711,7 +711,7 @@
   if (id == SetYear || id == SetMilliSeconds || id == SetSeconds ||
       id == SetMinutes || id == SetHours || id == SetDate ||
       id == SetMonth || id == SetFullYear ) {
-    result = jsNumber(isnan(ms) ? ms : makeTime(&t, ms, utc));
+    result = jsNumber(isnan(ms) ? ms : timeClip(makeTime(&t, ms, utc)));
     thisDateObj->setInternalValue(result);
   }
 
Index: kfile/kfilewidget.cpp
===================================================================
--- kfile/kfilewidget.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kfile/kfilewidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -842,16 +842,31 @@
 
             QString fileName;
             KUrl url(locationEditCurrentText);
-            KIO::StatJob *statJob = KIO::stat(url, KIO::HideProgressInfo);
-            bool res = KIO::NetAccess::synchronousRun(statJob, 0);
-            if (res) {
-                if (!statJob->statResult().isDir()) {
-                    url.adjustPath(KUrl::RemoveTrailingSlash);
-                    fileName = url.fileName();
-                    url.setFileName(QString());
-                } else {
-                    url.adjustPath(KUrl::AddTrailingSlash);
+            if (d->operationMode == Opening) {
+                KIO::StatJob *statJob = KIO::stat(url, KIO::HideProgressInfo);
+                bool res = KIO::NetAccess::synchronousRun(statJob, 0);
+                if (res) {
+                    if (!statJob->statResult().isDir()) {
+                        url.adjustPath(KUrl::RemoveTrailingSlash);
+                        fileName = url.fileName();
+                        url.setFileName(QString());
+                    } else {
+                        url.adjustPath(KUrl::AddTrailingSlash);
+                    }
                 }
+            } else {
+                KUrl directory = url;
+                directory.setFileName(QString());
+                //Check if the folder exists
+                KIO::StatJob * statJob = KIO::stat(directory, KIO::HideProgressInfo);
+                bool res = KIO::NetAccess::synchronousRun(statJob, 0);
+                if (res) { 
+                    if (statJob->statResult().isDir()) {
+                        url.adjustPath(KUrl::RemoveTrailingSlash);
+                        fileName = url.fileName();
+                        url.setFileName(QString());
+                    }
+                }
             }
             d->ops->setUrl(url, true);
             const bool signalsBlocked = d->locationEdit->lineEdit()->blockSignals(true);
Index: kfile/kdiroperator.cpp
===================================================================
--- kfile/kdiroperator.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kfile/kdiroperator.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -942,7 +942,7 @@
 
     d->iconsZoom = value;
 
-    if (d->inlinePreviewState == Private::NotForced) {
+    if (d->configGroup && d->inlinePreviewState == Private::NotForced) {
         if (qobject_cast<QListView*>(d->itemView)) {
             d->configGroup->writeEntry("listViewIconSize", d->iconsZoom);
         } else {
Index: kfile/kfiletreeview.cpp
===================================================================
--- kfile/kfiletreeview.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kfile/kfiletreeview.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -155,8 +155,10 @@
 
 void KFileTreeView::setShowHiddenFiles(bool enabled)
 {
+    KUrl url = currentUrl();
     d->mSourceModel->dirLister()->setShowingDotFiles(enabled);
     d->mSourceModel->dirLister()->openUrl(d->mSourceModel->dirLister()->url());
+    setCurrentUrl(url);
 }
 
 void KFileTreeView::setCurrentUrl(const KUrl &url)
Index: kdoctools/customization/ca/user.entities
===================================================================
--- kdoctools/customization/ca/user.entities	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdoctools/customization/ca/user.entities	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -42,8 +42,11 @@
 <!ENTITY revisor.Antoni.Bella		'<othercredit role="reviewer"><firstname>Antoni</firstname><surname>Bella</surname><affiliation><address><email>bella5@teleline.es</email></address></affiliation><contrib>Revisor</contrib></othercredit>'>
 <!ENTITY traductor.Pep.Roca		'<othercredit role="translator"><firstname>Pep</firstname><surname>Roca</surname><affiliation><address><email>pep.roca@gmail.com</email></address></affiliation><contrib>Traductor</contrib></othercredit>'>
 <!ENTITY revisor.Pep.Roca		'<othercredit role="reviewer"><firstname>Pep</firstname><surname>Roca</surname><affiliation><address><email>pep.roca@gmail.com</email></address></affiliation><contrib>Revisor</contrib></othercredit>'>
+<!ENTITY traductor.Rafael.Carreras	'<othercredit role="translator"><firstname>Rafael</firstname><surname>Carreras</surname><affiliation><address><email>rcarreras@caliu.cat</email></address></affiliation><contrib>Traductor</contrib></othercredit>'>
+<!ENTITY revisor.Rafael.Carreras	'<othercredit role="reviewer"><firstname>Rafael</firstname><surname>Carreras</surname><affiliation><address><email>rcarreras@caliu.cat</email></address></affiliation><contrib>Revisor</contrib></othercredit>'>
 
 <!-- CREDITS FOR TRANSLATORS -->
 <!-- Seguir el següent format '<para>Traductor/Revisor de la documentació: &credits.Nom.Cognom;</para>' -->
 <!ENTITY credits.Antoni.Bella		'Antoni Bella <email>bella5@teleline.es</email>'>
 <!ENTITY credits.Pep.Roca		'Pep Roca <email>pep.roca@gmail.com</email>'>
+<!ENTITY credits.Rafael.Carreras	'Rafael Carreras <email>rcarreras@caliu.cat</email>'>
Index: kparts/krop.desktop
===================================================================
--- kparts/krop.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kparts/krop.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -81,8 +81,8 @@
 Comment[uz@cyrillic]=KDE компоненти
 Comment[vi]=Thành phần KDE.
 Comment[wa]=Componint di KDE
+Comment[xh]=Ingxenye ye KDE
 Comment[x-test]=xxKDE Componentxx
-Comment[xh]=Ingxenye ye KDE
 Comment[zh_CN]=KDE 组件
 Comment[zh_HK]=KDE 元件
 Comment[zh_TW]=KDE 元件
Index: kparts/krwp.desktop
===================================================================
--- kparts/krwp.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kparts/krwp.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -81,8 +81,8 @@
 Comment[uz@cyrillic]=KDE компоненти
 Comment[vi]=Thành phần KDE.
 Comment[wa]=Componint di KDE
+Comment[xh]=Ingxenye ye KDE
 Comment[x-test]=xxKDE Componentxx
-Comment[xh]=Ingxenye ye KDE
 Comment[zh_CN]=KDE 组件
 Comment[zh_HK]=KDE 元件
 Comment[zh_TW]=KDE 元件
Index: kparts/tests/notepad.desktop
===================================================================
--- kparts/tests/notepad.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kparts/tests/notepad.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -78,8 +78,8 @@
 Name[uz@cyrillic]=Ён дафтарча (мисол)
 Name[vi]=Tập giấy (thí dụ)
 Name[wa]=Blok di notes (egzimpe)
+Name[xh]=Iphetshan lokubhala (umzekelo)
 Name[x-test]=xxNotepad (example)xx
-Name[xh]=Iphetshan lokubhala (umzekelo)
 Name[zh_CN]=记事本(实例)
 Name[zh_HK]=記事本(範例)
 Name[zh_TW]=記事本(範例)
Index: kparts/browserview.desktop
===================================================================
--- kparts/browserview.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kparts/browserview.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -81,8 +81,8 @@
 Name[uz@cyrillic]=Браузернинг кўриниши
 Name[vi]=Xem duyệt
 Name[wa]=Vuwe foyteuse
+Name[xh]=Imboniselo Yomkhangeli zincwadi
 Name[x-test]=xxBrowser Viewxx
-Name[xh]=Imboniselo Yomkhangeli zincwadi
 Name[zh_CN]=浏览器视图
 Name[zh_HK]=瀏覽器視圖
 Name[zh_TW]=瀏覽器視圖
Index: kparts/kpart.desktop
===================================================================
--- kparts/kpart.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kparts/kpart.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -80,8 +80,8 @@
 Comment[uz@cyrillic]=KDE компоненти
 Comment[vi]=Thành phần KDE.
 Comment[wa]=Componint di KDE
+Comment[xh]=Ingxenye ye KDE
 Comment[x-test]=xxKDE Componentxx
-Comment[xh]=Ingxenye ye KDE
 Comment[zh_CN]=KDE 组件
 Comment[zh_HK]=KDE 元件
 Comment[zh_TW]=KDE 元件
Index: kded/kdedmodule.desktop
===================================================================
--- kded/kdedmodule.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kded/kdedmodule.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -78,8 +78,8 @@
 Comment[uz@cyrillic]=KDED модули
 Comment[vi]=Mô-đun KDED
 Comment[wa]=Module po KDED
+Comment[xh]=KDED Isichatshulwa
 Comment[x-test]=xxKDED Modulexx
-Comment[xh]=KDED Isichatshulwa
 Comment[zh_CN]=KDED 模块
 Comment[zh_HK]=KDED 模組
 Comment[zh_TW]=KDED 模組
Index: mimetypes/kde.xml
===================================================================
--- mimetypes/kde.xml	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ mimetypes/kde.xml	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -89,7 +89,7 @@
   </mime-type>
   <mime-type type="application/x-plasma">
     <comment>plasmoid</comment>
-    <glob pattern="*.plasma"/>
+    <glob pattern="*.plasmoid"/>
   </mime-type>
   <mime-type type="application/x-superkaramba">
     <sub-class-of type="application/zip"/>
Index: CMakeLists.txt
===================================================================
--- CMakeLists.txt	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ CMakeLists.txt	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -8,9 +8,9 @@
 
 set (KDE_VERSION_MAJOR 4)
 set (KDE_VERSION_MINOR 2)
-set (KDE_VERSION_RELEASE 3)
+set (KDE_VERSION_RELEASE 4)
 set (KDE_VERSION "${KDE_VERSION_MAJOR}.${KDE_VERSION_MINOR}.${KDE_VERSION_RELEASE}" )
-set (KDE_VERSION_STRING "${KDE_VERSION} (KDE 4.2.3)")
+set (KDE_VERSION_STRING "${KDE_VERSION} (KDE 4.2.4)")
 
 set (KDE_DISTRIBUTION_TEXT "compiled sources" CACHE STRING "Indicate the distribution in bug reports" )
 
Index: kioslave/http/kcookiejar/kcookiejar.desktop
===================================================================
--- kioslave/http/kcookiejar/kcookiejar.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kioslave/http/kcookiejar/kcookiejar.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -77,8 +77,8 @@
 Name[uz@cyrillic]=KDED куки идиш модули
 Name[vi]=Mô-đun Cookie Jar của KDED
 Name[wa]=Module wårdeu d' coûkes di KDED
+Name[xh]=Isicatshulwa se KDED Cookie Jar
 Name[x-test]=xxKDED Cookie Jar Modulexx
-Name[xh]=Isicatshulwa se KDED Cookie Jar
 Name[zh_CN]=KDED Cookie Jar 模块
 Name[zh_HK]=KDED Cookie Jar 模組
 Name[zh_TW]=KDED Cookie Jar 模組
Index: kioslave/http/http_cache_cleaner.desktop
===================================================================
--- kioslave/http/http_cache_cleaner.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kioslave/http/http_cache_cleaner.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -18,7 +18,7 @@
 Name[de]=Aufräumprogramm für den HTTP-Zwischenspeicher
 Name[el]=Καθαριστής λανθάνουσας μνήμης HTTP
 Name[eo]=HTTP-kaŝmemora purigilo
-Name[es]=Limpiador del caché de HTTP
+Name[es]=Limpiador de la caché de HTTP
 Name[et]=HTTP vahemälu puhastaja
 Name[eu]=HTTP cache-garbitzailea
 Name[fa]=پاک‌کنندۀ نهانگاه قام
@@ -78,8 +78,8 @@
 Name[uz@cyrillic]=HTTP кэш бўшатгич
 Name[vi]=Bộ làm sạch bộ nhớ tạm HTTP
 Name[wa]=Netieu del muchete HTTP
+Name[xh]=Umcoci wendawo efihlakeleyo yokugcina we HTTP
 Name[x-test]=xxHTTP Cache Cleanerxx
-Name[xh]=Umcoci wendawo efihlakeleyo yokugcina we HTTP
 Name[zh_CN]=HTTP 缓存清除程序
 Name[zh_HK]=HTTP 快取清除程式
 Name[zh_TW]=HTTP 快取清除程式
@@ -102,7 +102,7 @@
 Comment[de]=Löscht alte Einträge aus dem HTTP-Zwischenspeicher
 Comment[el]=Καθαρίζει παλιές καταχωρήσεις από τη λανθάνουσα μνήμη HTTP
 Comment[eo]=Forigas malnovajn erojn el HTTP-kaŝmemoro
-Comment[es]=Elimina las entradas antiguas del caché de HTTP
+Comment[es]=Elimina las entradas antiguas de la caché de HTTP
 Comment[et]=Puhastab HTTP vahemälu vanadest kirjetest
 Comment[eu]=HTTP cachearen sarrera zaharrak garbitzen ditu
 Comment[fa]=مدخلهای قدیمی را از نهانگاه قام پاک می‌کند
@@ -163,8 +163,8 @@
 Comment[uz@cyrillic]=HTTP кэшидаги эски элементларни ўчиради
 Comment[vi]=Xoá sạch các mục nhập cũ ra bộ nhớ tạm HTTP.
 Comment[wa]=Neteye les viyès intrêyes del muchete HTTP
+Comment[xh]=Icoca amangeno amadala asuka kwindawo efihlakeleyo yokugcina ye HTTP
 Comment[x-test]=xxCleans up old entries from the HTTP cachexx
-Comment[xh]=Icoca amangeno amadala asuka kwindawo efihlakeleyo yokugcina ye HTTP
 Comment[zh_CN]=从 HTTP 缓存中清除旧条目
 Comment[zh_HK]=從 HTTP 快取中清除舊的項目
 Comment[zh_TW]=從 HTTP 快取中清除舊的項目
Index: kio/kfileplugin.desktop
===================================================================
--- kio/kfileplugin.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/kfileplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -75,8 +75,8 @@
 Name[uz@cyrillic]=KFile мета маълумот учун плагин
 Name[vi]=Bổ sung siêu dữ liệu KFile
 Name[wa]=Tchôke-divins meta-dnêyes des fitchîs
+Name[xh]=Iplagi yangaphakathi ye KFile Meta Data
 Name[x-test]=xxKFile Meta Data Pluginxx
-Name[xh]=Iplagi yangaphakathi ye KFile Meta Data
 Name[zh_CN]=KFile 元数据插件
 Name[zh_HK]=KFile 元資料外掛程式
 Name[zh_TW]=KFile 資料定義外掛程式
Index: kio/kio/tcpslavebase.cpp
===================================================================
--- kio/kio/tcpslavebase.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/kio/tcpslavebase.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -821,7 +821,7 @@
     //rule = KSslCertificateRule(d->socket.peerCertificateChain().first(), whatever);
 
     rule.setExpiryDateTime(ruleExpiry);
-    rule.setIgnoredErrors(remainingErrors);
+    rule.setIgnoredErrors(d->sslErrors);
     cm->setRule(rule);
 
     return ResultOk | ResultOverridden;
Index: kio/kio/chmodjob.cpp
===================================================================
--- kio/kio/chmodjob.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/kio/chmodjob.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -158,7 +158,7 @@
     KIO::UDSEntryList::ConstIterator end = list.end();
     for (; it != end; ++it) {
         const KIO::UDSEntry& entry = *it;
-        const bool isLink = !entry.stringValue( KIO::UDSEntry::UDS_STRING ).isEmpty();
+        const bool isLink = !entry.stringValue( KIO::UDSEntry::UDS_LINK_DEST ).isEmpty();
         const QString relativePath = entry.stringValue( KIO::UDSEntry::UDS_NAME );
         if ( !isLink && relativePath != ".." )
         {
Index: kio/kdatatool.desktop
===================================================================
--- kio/kdatatool.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/kdatatool.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -80,8 +80,8 @@
 Comment[uz@cyrillic]=KDE маълумот воситаси
 Comment[vi]=Công cụ dữ liệu KDE.
 Comment[wa]=Usteyes po les dnêyes di KDE
+Comment[xh]=Isihluzi se Data ye KDE
 Comment[x-test]=xxKDE Data Toolxx
-Comment[xh]=Isihluzi se Data ye KDE
 Comment[zh_CN]=KDE 数据工具
 Comment[zh_HK]=KDE 資料工具
 Comment[zh_TW]=KDE 資料工具
Index: kio/kfile/kpropertiesdialogplugin.desktop
===================================================================
--- kio/kfile/kpropertiesdialogplugin.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/kfile/kpropertiesdialogplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -81,8 +81,8 @@
 Comment[uz@cyrillic]=Хоссалар диалоги учун плагин
 Comment[vi]=Bổ sung cho hộp thoại đặc tả.
 Comment[wa]=Tchôke-divins pol purnea di prôpietés
+Comment[xh]=Iplagi yangaphakathi Yezinto zobumnini Zencoko yababini
 Comment[x-test]=xxPlugin for the Properties Dialogxx
-Comment[xh]=Iplagi yangaphakathi Yezinto zobumnini Zencoko yababini
 Comment[zh_CN]=属性对话框插件
 Comment[zh_HK]=屬性對話盒的外掛程式
 Comment[zh_TW]=屬性對話盒的外掛程式
Index: kio/kfile/kpropertiesdialog.cpp
===================================================================
--- kio/kfile/kpropertiesdialog.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/kfile/kpropertiesdialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1769,9 +1769,17 @@
 #ifdef Q_OS_UNIX
     // pick the groups to which the user belongs
     int groupCount = 0;
+#ifdef Q_OS_MAC
+    int *groups = NULL;
+#else
     gid_t *groups = NULL;
+#endif
     if (getgrouplist(strUser, user->pw_gid, NULL, &groupCount) < 0) {
+#ifdef Q_OS_MAC
+        groups = new int[groupCount];
+#else
         groups = new gid_t[groupCount];
+#endif
         if (groups) {
             getgrouplist(strUser, user->pw_gid, groups, &groupCount);
         } else {
Index: kio/misc/kssld/kssld.desktop
===================================================================
--- kio/misc/kssld/kssld.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/misc/kssld/kssld.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -82,8 +82,8 @@
 Name[uz@cyrillic]=KSSL хизматининг модули
 Name[vi]=Mô-đun trình nền KSSL
 Name[wa]=Module demon KSSL
+Name[xh]=Isicatshulwa se KSSL Daemon
 Name[x-test]=xxKSSL Daemon Modulexx
-Name[xh]=Isicatshulwa se KSSL Daemon
 Name[zh_CN]=KSSL 守护进程模块
 Name[zh_HK]=KSSL 伺服程式模組
 Name[zh_TW]=KSSL 伺服程式模組
Index: kio/misc/kpac/proxyscout.notifyrc
===================================================================
--- kio/misc/kpac/proxyscout.notifyrc	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/misc/kpac/proxyscout.notifyrc	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -90,7 +90,7 @@
 Name[de]=Ungültiges Proxy-Skript
 Name[el]=Μη έγκυρο σενάριο διαμεσολαβητή
 Name[eo]=Nevalida prokura skripto
-Name[es]=Guión de proxy no válido
+Name[es]=Script de proxy no válido
 Name[et]=Vigane puhverserveri skript
 Name[eu]=Proxy script baliogabea
 Name[fa]=دست‌نوشتهٔ نامعتبر پیشکار
@@ -165,7 +165,7 @@
 Comment[de]=Das heruntergeladene Konfigurationsskript für den Proxy ist ungültig.
 Comment[el]=Το ληφθέν σενάριο ρύθμισης διαμεσολαβητή δεν είναι έγκυρο
 Comment[eo]=La elŝutita prokura agordoskripto estas nevalida
-Comment[es]=El guión de configuración del proxy descargado no es válido
+Comment[es]=El script de configuración del proxy descargado no es válido
 Comment[et]=Allalaaditud puhverserveri seadistuse skript on vigane
 Comment[eu]=Deskargatutako proxy-aren konfigurazioko script-a baliogabea da
 Comment[fa]=دست‌نوشتهٔ پیکربندی پیشکار بارگیری شده نامعتبر است
@@ -247,7 +247,7 @@
 Name[de]=Fehler beim Herunterladen des Skripts
 Name[el]=Σφάλμα λήψης σεναρίου
 Name[eo]=Eraro pri elŝuto de skripto
-Name[es]=Error de descarga de guión
+Name[es]=Error de descarga del script
 Name[et]=Viga skripti allalaadimisel
 Name[eu]=Errorea script-a deskargatzean
 Name[fa]=خطا در بارگیری دست‌نوشته
@@ -322,7 +322,7 @@
 Comment[de]=Das Konfigurationskript für den Proxy kann nicht heruntergeladen werden.
 Comment[el]=Αδύνατη η λήψη του σεναρίου ρύθμισης διαμεσολαβητή
 Comment[eo]=Ne povis elŝuti la prokuran agordoskripton
-Comment[es]=No se puede descargar el guión de configuración del proxy
+Comment[es]=No se puede descargar el script de configuración del proxy
 Comment[et]=Puhverserveri seadistuse skripti allalaadimine nurjus
 Comment[eu]=Proxy-aren konfigurazioko script-a ezin izan da deskargatu
 Comment[fa]=دست‌نوشتهٔ پیکربندی پیشکار نتوانست بارگیری شود
@@ -404,7 +404,7 @@
 Name[de]=Fehler bei der Auswertung des Skripts
 Name[el]=Σφάλμα αποτίμησης σεναρίου
 Name[eo]=Eraro pri takso de skripto
-Name[es]=Error de evaluación del guión
+Name[es]=Error de evaluación del script
 Name[et]=Viga skripti hindamisel
 Name[eu]=Script ebaluazioko errorea
 Name[fa]=خطا در ارزیابی دست‌نوشته
@@ -478,7 +478,7 @@
 Comment[de]=Beim Ausführen des Skripts zur Proxy-Konfiguration ist ein Fehler aufgetreten.
 Comment[el]=Παρουσιάστηκε σφάλμα κατά την εκτέλεση του σεναρίου ρύθμισης του διαμεσολαβητή
 Comment[eo]=Eraro okazis pri plenumo de la prokura agordoskripto
-Comment[es]=Ocurrió un error al ejecutar el guión de configuración del proxy
+Comment[es]=Ocurrió un error al ejecutar el script de configuración del proxy
 Comment[et]=Ilmnes tõsine viga puhverserveri seadistuse skripti käivitamisel
 Comment[eu]=Errorea gertatu da proxy-a konfiguratzeko script-ean
 Comment[fa]=خطایی در اجرای دست‌نوشتهٔ پیکربندی پیشکار وجود داشت
Index: kio/tests/jobtest.cpp
===================================================================
--- kio/tests/jobtest.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/tests/jobtest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -20,6 +20,7 @@
 #include "qtest_kde.h"
 
 #include "jobtest.h"
+#include <kprotocolmanager.h>
 
 #include <config.h>
 
@@ -116,6 +117,9 @@
     qRegisterMetaType<KIO::Job*>("KIO::Job*");
     qRegisterMetaType<KUrl>("KUrl");
     qRegisterMetaType<time_t>("time_t");
+
+    // Wrong ksycoca, if this is true in this branch...
+    QVERIFY(!KProtocolManager::canDeleteRecursive(KUrl("file:/")));
 }
 
 static void delDir(const QString& pathOrUrl) {
@@ -1121,7 +1125,20 @@
 void JobTest::deleteDirectory()
 {
     const QString dest = otherTmpDir() + "dirFromHome_copied";
-    QVERIFY(QFile::exists(dest));
+    if (!QFile::exists(dest))
+        createTestDirectory(dest);
+    // Let's put a few things in there to see if the recursive deletion works correctly
+    // A hidden file:
+    createTestFile(dest + "/.hidden");
+#ifndef Q_WS_WIN
+    // A broken symlink:
+    createTestSymlink(dest+"/broken_symlink");
+    // A symlink to a dir:
+    bool symlink_ok = symlink( KDESRCDIR, QFile::encodeName( dest + "/symlink_to_dir" ) ) == 0;
+    if ( !symlink_ok )
+        kFatal() << "couldn't create symlink: " << strerror( errno ) ;
+#endif
+
     KIO::Job* job = KIO::del(KUrl(dest), KIO::HideProgressInfo);
     job->setUiDelegate(0);
     bool ok = KIO::NetAccess::synchronousRun(job, 0);
Index: kio/kurifilterplugin.desktop
===================================================================
--- kio/kurifilterplugin.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/kurifilterplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -80,8 +80,8 @@
 Name[uz@cyrillic]=Тезлаштирилган веб-кўриш плагини
 Name[vi]=Bổ sung duyệt tăng cường
 Name[wa]=Tchôke-divins sipepieus betchtaedje
+Name[xh]=Iplagi yangaphakathi Ekhangela iincwadi Enyusiweyo
 Name[x-test]=xxEnhanced Browsing Pluginxx
-Name[xh]=Iplagi yangaphakathi Ekhangela iincwadi Enyusiweyo
 Name[zh_CN]=增强的浏览插件
 Name[zh_HK]=增強功能的瀏覽外掛程式
 Name[zh_TW]=增強的瀏覽外掛程式
Index: kio/application.desktop
===================================================================
--- kio/application.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/application.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -81,8 +81,8 @@
 Name[uz@cyrillic]=Дастур
 Name[vi]=Ứng dụng
 Name[wa]=Programe
+Name[xh]=Isicelo
 Name[x-test]=xxApplicationxx
-Name[xh]=Isicelo
 Name[zh_CN]=应用程序
 Name[zh_HK]=應用程式
 Name[zh_TW]=應用程式
Index: kio/renamedialogplugin.desktop
===================================================================
--- kio/renamedialogplugin.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kio/renamedialogplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -80,8 +80,8 @@
 Comment[uz@cyrillic]=Номини ўзгартириш диалоги учун плагин
 Comment[vi]=Bổ sung cho hộp thoại thay đổi tên.
 Comment[wa]=Tchôke-divins pol purnea di rlomaedje
+Comment[xh]=Iplagi yangaphakathi Yencoko yababini Yokunika igama elitsha
 Comment[x-test]=xxPlugin for the Rename Dialogxx
-Comment[xh]=Iplagi yangaphakathi Yencoko yababini Yokunika igama elitsha
 Comment[zh_CN]=重命名对话框插件
 Comment[zh_HK]=更名對話盒的外掛程式
 Comment[zh_TW]=更名對話盒的外掛程式
Index: kdeui/dialogs/kdialog_p.h
===================================================================
--- kdeui/dialogs/kdialog_p.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/dialogs/kdialog_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -78,6 +78,7 @@
 
     protected Q_SLOTS:
         void queuedLayoutUpdate();
+        void helpLinkClicked();
 
     private:
         void init(KDialog *);
Index: kdeui/dialogs/kdialog.cpp
===================================================================
--- kdeui/dialogs/kdialog.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/dialogs/kdialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -2,7 +2,7 @@
  *  Copyright (C) 1998 Thomas Tanghus (tanghus@earthling.net)
  *  Additions 1999-2000 by Espen Sand (espen@kde.org)
  *                      by Holger Freyther <freyther@kde.org>
- *            2005-2006 by Olivier Goffart (ogoffart at kde.org)
+ *            2005-2009 by Olivier Goffart (ogoffart at kde.org)
  *
  *  This library is free software; you can redistribute it and/or
  *  modify it under the terms of the GNU Library General Public
@@ -168,6 +168,11 @@
     q->setPlainCaption(KGlobal::caption()); // set appropriate initial window title for case it gets not set later
 }
 
+void KDialogPrivate::helpLinkClicked()
+{
+    q_ptr->slotButtonClicked(KDialog::Help);
+}
+
 KDialog::KDialog( QWidget *parent, Qt::WFlags flags )
   : QDialog(parent, flags), d_ptr(new KDialogPrivate)
 {
@@ -894,27 +899,26 @@
 void KDialog::enableLinkedHelp( bool state )
 {
     Q_D(KDialog);
-  if ( ( d->mUrlHelp != 0 ) == state )
-    return;
-  if ( state ) {
-    if ( d->mUrlHelp )
-      return;
+    if ( ( d->mUrlHelp != 0 ) == state )
+        return;
+    if ( state ) {
+        if ( d->mUrlHelp )
+            return;
 
-    d->mUrlHelp = new KUrlLabel( this );
-    d->mUrlHelp->setText( helpLinkText() );
-    d->mUrlHelp->setFloatEnabled( true );
-    d->mUrlHelp->setUnderline( true );
-    d->mUrlHelp->setMinimumHeight( fontMetrics().height() + marginHint() );
-    connect( d->mUrlHelp, SIGNAL( leftClickedUrl( const QString& ) ),
-             SLOT( helpClickedSlot( const QString& ) ) );
+        d->mUrlHelp = new KUrlLabel( this );
+        d->mUrlHelp->setText( helpLinkText() );
+        d->mUrlHelp->setFloatEnabled( true );
+        d->mUrlHelp->setUnderline( true );
+        d->mUrlHelp->setMinimumHeight( fontMetrics().height() + marginHint() );
+        connect( d->mUrlHelp, SIGNAL(leftClickedUrl()), SLOT(helpLinkClicked()) );
 
-    d->mUrlHelp->show();
-  } else {
-    delete d->mUrlHelp;
-    d->mUrlHelp = 0;
-  }
+        d->mUrlHelp->show();
+    } else {
+        delete d->mUrlHelp;
+        d->mUrlHelp = 0;
+    }
 
-  d->setupLayout();
+    d->setupLayout();
 }
 
 
Index: kdeui/dialogs/kshortcutseditordelegate.cpp
===================================================================
--- kdeui/dialogs/kshortcutseditordelegate.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/dialogs/kshortcutseditordelegate.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -151,8 +151,8 @@
     if (!isExtended(index)) {
         //we only want maximum ONE extender open at any time.
         if (m_editingIndex.isValid()) {
-            QModelIndex idx = index.sibling(m_editingIndex.row(), Name);
-            KShortcutsEditorItem *oldItem = KShortcutsEditorPrivate::itemFromIndex(view, idx);
+            KShortcutsEditorItem *oldItem = KShortcutsEditorPrivate::itemFromIndex(view, 
+                                                                                    m_editingIndex);
             Q_ASSERT(oldItem); //here we really expect nothing but a real KShortcutsEditorItem
 
             oldItem->setNameBold(false);
Index: kdeui/dialogs/kedittoolbar.cpp
===================================================================
--- kdeui/dialogs/kedittoolbar.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/dialogs/kedittoolbar.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -309,6 +309,8 @@
     void slotUpButton();
     void slotDownButton();
 
+    void selectActiveItem(QString);
+    
     void slotChangeIcon();
 
     void slotProcessExited();
@@ -1194,16 +1196,33 @@
 
 void KEditToolBarWidgetPrivate::slotInsertButton()
 {
+  QString internalName = static_cast<ToolBarItem *>(m_inactiveList->currentItem())->internalName();
+  
   insertActive(m_inactiveList->currentItem(), m_activeList->currentItem(), false);
-
   // we're modified, so let this change
   emit m_widget->enableOk(true);
 
   // TODO: #### this causes #97572.
   // It would be better to just "delete item; loadActions( ... , ActiveListOnly );" or something.
   slotToolBarSelected( m_toolbarCombo->currentIndex() );
+  
+  selectActiveItem( internalName );
 }
 
+void KEditToolBarWidgetPrivate::selectActiveItem(QString internalName) 
+{
+  int activeItemCount = m_activeList->count();
+  for(int i = 0; i < activeItemCount; i++)
+  {
+    ToolBarItem * item = static_cast<ToolBarItem *>(m_activeList->item(i));
+    if (item->internalName()==internalName)
+    {
+      m_activeList->setCurrentItem(item);
+      break;
+    }
+  }
+}
+
 void KEditToolBarWidgetPrivate::slotRemoveButton()
 {
   removeActive( m_activeList->currentItem() );
Index: kdeui/dialogs/kdialog.h
===================================================================
--- kdeui/dialogs/kdialog.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/dialogs/kdialog.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -2,7 +2,7 @@
  *  Copyright (C) 1998 Thomas Tanghus (tanghus@earthling.net)
  *  Additions 1999-2000 by Espen Sand (espen@kde.org)
  *                      and Holger Freyther <freyther@kde.org>
- *            2005-2006   Olivier Goffart <ogoffart @ kde.org>
+ *            2005-2009 Olivier Goffart <ogoffart @ kde.org>
  *            2006      Tobias Koenig <tokoe@kde.org>
  *
  *  This library is free software; you can redistribute it and/or
@@ -847,6 +847,7 @@
     private:
         Q_DISABLE_COPY(KDialog)
         Q_PRIVATE_SLOT(d_ptr, void queuedLayoutUpdate())
+        Q_PRIVATE_SLOT(d_ptr, void helpLinkClicked())
 };
 
 Q_DECLARE_OPERATORS_FOR_FLAGS(KDialog::ButtonCodes)
Index: kdeui/dialogs/kbugreport.cpp
===================================================================
--- kdeui/dialogs/kbugreport.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/dialogs/kbugreport.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -320,7 +320,7 @@
 
 void KBugReportPrivate::_k_updateUrl()
 {
-    url = KUrl( "http://bugs.kde.org/wizard.cgi" );
+    url = KUrl( "https://bugs.kde.org/wizard.cgi" );
     url.addQueryItem( "os", os );
     url.addQueryItem( "compiler", KDE_COMPILER_VERSION );
     url.addQueryItem( "kdeVersion", kde_version );
Index: kdeui/colors/kcolordialog.cpp
===================================================================
--- kdeui/colors/kcolordialog.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/colors/kcolordialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1080,18 +1080,6 @@
             SLOT(setBMode()));
 
     //
-    // the entry fields should be wide enough to hold 8888888
-    //
-    int w = d->hedit->fontMetrics().width("8888888");
-    d->hedit->setFixedWidth(w);
-    d->sedit->setFixedWidth(w);
-    d->vedit->setFixedWidth(w);
-
-    d->redit->setFixedWidth(w);
-    d->gedit->setFixedWidth(w);
-    d->bedit->setFixedWidth(w);
-
-    //
     // add a layout for the right side
     //
     d->l_right = new QVBoxLayout;
@@ -1167,7 +1155,7 @@
     d->htmlName = new KLineEdit(page);
     d->htmlName->setMaxLength(13);   // Qt's QColor allows 12 hexa-digits
     d->htmlName->setText("#FFFFFF"); // But HTML uses only 6, so do not worry about the size
-    w = d->htmlName->fontMetrics().width(QLatin1String("#DDDDDDD"));
+    int w = d->htmlName->fontMetrics().width(QLatin1String("#DDDDDDD"));
     d->htmlName->setFixedWidth(w);
     l_grid->addWidget(d->htmlName, 1, 2, Qt::AlignLeft);
 
@@ -1180,6 +1168,15 @@
     connect(d->patch, SIGNAL(colorChanged(const QColor&)),
             SLOT(setColor(const QColor&)));
 
+    //
+    // chain fields together
+    //
+    setTabOrder(d->hedit, d->sedit);
+    setTabOrder(d->sedit, d->vedit);
+    setTabOrder(d->vedit, d->redit);
+    setTabOrder(d->redit, d->gedit);
+    setTabOrder(d->gedit, d->bedit);
+
     tl_layout->activate();
     page->setMinimumSize(page->sizeHint());
 
Index: kdeui/windowmanagement/kwindowsystem_win.cpp
===================================================================
--- kdeui/windowmanagement/kwindowsystem_win.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/windowmanagement/kwindowsystem_win.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -173,12 +173,12 @@
     if(WM_SHELLHOOK==-1) WM_SHELLHOOK  = RegisterWindowMessage(TEXT("SHELLHOOK"));
     
     bool shellHookRegistered = false;
-    if(pRegisterShellHook)
+    if(pRegisterShellHook) {
         kDebug()<<"use RegisterShellHook";
         shellHookRegistered = pRegisterShellHook(winId(),RSH_REGISTER);
         if(!shellHookRegistered)
             shellHookRegistered = pRegisterShellHook(winId(),RSH_TASKMGR);
-    else{     
+    } else {     
         kDebug()<<"use RegisterShellHookWindow";
         //i'm not sure if i have to do this, and what happens if some other process uses KWindowSystem
         //if(pSetTaskmanWindow)
Index: kdeui/windowmanagement/kwindowsystem_mac.cpp
===================================================================
--- kdeui/windowmanagement/kwindowsystem_mac.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/windowmanagement/kwindowsystem_mac.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -371,7 +371,7 @@
 
 bool KWindowSystem::compositingActive()
 {
-    return false;
+    return true;
 }
 
 int KWindowSystem::currentDesktop()
Index: kdeui/widgets/ktextedit.cpp
===================================================================
--- kdeui/widgets/ktextedit.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/widgets/ktextedit.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -388,13 +388,15 @@
     parent->setTextCursor( cursor );
     return true;
   } else if (KStandardShortcut::find().contains(key)) {
-      parent->slotFind();
+      if (findReplaceEnabled)
+          parent->slotFind();
       return true;
   } else if (KStandardShortcut::findNext().contains(key)) {
-      parent->slotFindNext();
+      if (findReplaceEnabled)
+          parent->slotFindNext();
       return true;
   } else if (KStandardShortcut::replace().contains(key)) {
-      if( !parent->isReadOnly() )
+      if (!parent->isReadOnly() && findReplaceEnabled)
           parent->slotReplace();
       return true;
   } else if ( KStandardShortcut::pasteSelection().contains( key ) ) {
Index: kdeui/widgets/kanimatedbutton.cpp
===================================================================
--- kdeui/widgets/kanimatedbutton.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/widgets/kanimatedbutton.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -161,10 +161,10 @@
 void KAnimatedButton::updateIcons()
 {
     const int icon_size = iconDimensions();
+    d->pixmap = QPixmap();
     QMovie *movie = KIconLoader::global()->loadMovie(d->icon_name, KIconLoader::NoGroup, -icon_size);
     if (movie) {
         d->frames = 0;
-        d->pixmap = QPixmap();
         movie->setCacheMode(QMovie::CacheAll);
         connect(movie, SIGNAL(frameChanged(int)), this, SLOT(_k_movieFrameChanged(int)));
         connect(movie, SIGNAL(finished()), this, SLOT(_k_movieFinished()));
@@ -183,6 +183,7 @@
 
     d->current_frame = 0;
     qDeleteAll(d->framesCache);
+    d->framesCache.fill(0);
     d->framesCache.resize(d->frames);
     delete d->movie;
     d->movie = movie;
Index: kdeui/widgets/krestrictedline.cpp
===================================================================
--- kdeui/widgets/krestrictedline.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdeui/widgets/krestrictedline.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -49,7 +49,9 @@
 {
   // let KLineEdit process "special" keys and return/enter
   // so that we still can use the default key binding
-  if (e->key() == Qt::Key_Enter || e->key() == Qt::Key_Return || e->key() == Qt::Key_Delete || e->text().length() < 32)
+  if (e->key() == Qt::Key_Enter || e->key() == Qt::Key_Return || e->key() == Qt::Key_Delete 
+      || e->key() == Qt::Key_Backspace || (e->modifiers() & (Qt::ControlModifier | Qt::AltModifier 
+      | Qt::MetaModifier | Qt::GroupSwitchModifier)))
     {
       KLineEdit::keyPressEvent(e);
       return;
Index: security/kcert/kcertpart.desktop
===================================================================
--- security/kcert/kcertpart.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ security/kcert/kcertpart.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -77,8 +77,8 @@
 Comment[uz@cyrillic]=Ичига ўрнатиб бўладиган шахсий сертификат бошқарувчиси
 Comment[vi]=Bộ Quản lý Chứng nhận Cá nhân có khả năng nhúng
 Comment[wa]=Ravalé manaedjeu d' acertineures da vosse
+Comment[xh]=Umphathi Wesiqinisekiso Sobuntu bakho Obulungiselelweyo
 Comment[x-test]=xxEmbeddable Personal Certificate Managerxx
-Comment[xh]=Umphathi Wesiqinisekiso Sobuntu bakho Obulungiselelweyo
 Comment[zh_CN]=可嵌入的个人证书管理器
 Comment[zh_HK]=可嵌入的個人證書管理工具
 Comment[zh_TW]=嵌入式個人憑證管理員
Index: kdecore/kernel/kcmdlineargs.cpp
===================================================================
--- kdecore/kernel/kcmdlineargs.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/kernel/kcmdlineargs.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -792,8 +792,8 @@
       if (s->ignoreUnknown)
          return;
 #ifdef Q_WS_MACX
-		if (_opt.startsWith("psn_", Qt::CaseInsensitive))
-			return;
+      if (_opt.startsWith("psn_"))
+         return;
 #endif
       KCmdLineArgs::enable_i18n();
       KCmdLineArgs::usageError( i18n("Unknown option '%1'.", QString::fromLocal8Bit(_opt)));
@@ -812,8 +812,8 @@
          if (s->ignoreUnknown)
             return;
 #ifdef Q_WS_MACX
-			if (_opt.startsWith("psn_", Qt::CaseInsensitive))
-				return;
+         if (_opt.startsWith("psn_"))
+		    return;
 #endif
          KCmdLineArgs::enable_i18n();
          KCmdLineArgs::usageError( i18n("Unknown option '%1'.", QString::fromLocal8Bit(_opt)));
Index: kdecore/kernel/kkernel_win.cpp
===================================================================
--- kdecore/kernel/kkernel_win.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/kernel/kkernel_win.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -359,7 +359,7 @@
     if (subSystem > -1)
         return subSystem; 
 
-    PIMAGE_DOS_HEADER dosHeader = (PIMAGE_DOS_HEADER)0x00400000;
+    PIMAGE_DOS_HEADER dosHeader = (PIMAGE_DOS_HEADER)GetModuleHandle(NULL);    
     PIMAGE_NT_HEADERS ntHeader = (PIMAGE_NT_HEADERS) ((char *)dosHeader + dosHeader->e_lfanew);
     if (ntHeader->Signature != 0x00004550) 
     {
Index: kdecore/sycoca/ksycoca.cpp
===================================================================
--- kdecore/sycoca/ksycoca.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/sycoca/ksycoca.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -419,17 +419,15 @@
         // but otherwise we simply need to run kbuildsycoca to recreate the sycoca file.
         if (!QDBusConnection::sessionBus().interface()->isServiceRegistered("org.kde.klauncher")) {
             kDebug(7011) << "We have no database.... launching kdeinit";
-            KToolInvocation::klauncher(); // this calls startKdeinit
+            KToolInvocation::klauncher(); // this calls startKdeinit, and blocks until it returns
+            // and since kdeinit4 only returns after kbuildsycoca4 is done, we can proceed.
         } else {
             kDebug(7011) << "We have no database.... launching " << KBUILDSYCOCA_EXENAME;
             if (QProcess::execute(KStandardDirs::findExe(KBUILDSYCOCA_EXENAME)) != 0)
                 qWarning("ERROR: Running KSycoca failed.");
         }
 
-        // Wait until the DBUS signal from kbuildsycoca
-        QEventLoop eventLoop;
-        QObject::connect(KSycoca::self(), SIGNAL(databaseChanged()), &eventLoop, SLOT(quit()));
-        eventLoop.exec( QEventLoop::ExcludeUserInputEvents );
+        closeDatabase(); // close the dummy one
 
         // Ok, the new database should be here now, open it.
         if (!openDatabase(ifNotFound & IfNotFoundOpenDummy)) {
Index: kdecore/services/kmimetype.cpp
===================================================================
--- kdecore/services/kmimetype.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/services/kmimetype.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -173,7 +173,7 @@
     const char* p = data.data();
     const int end = qMin(32, data.size());
     for (int i = 0; i < end; ++i) {
-        if (p[i] < 32 && p[i] != 9 && p[i] != 10 && p[i] != 13) // ASCII control character
+        if ((unsigned char)(p[i]) < 32 && p[i] != 9 && p[i] != 10 && p[i] != 13) // ASCII control character
             return true;
     }
     return false;
Index: kdecore/localization/kuitformats.cpp
===================================================================
--- kdecore/localization/kuitformats.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/localization/kuitformats.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -28,158 +28,6 @@
 
 #include <kdebug.h>
 
-class KuitFormatsStaticData
-{
-    public:
-
-    KuitFormatsStaticData ();
-
-    QHash<QChar, QChar> westToEastArabicDigit;
-    QChar easternArabicThSep;
-    QChar easternArabicDecSep;
-};
-
-KuitFormatsStaticData::KuitFormatsStaticData ()
-{
-    #define WEA_ENTRY(a, b) do { \
-        westToEastArabicDigit[a] = QString::fromUtf8(b)[0]; \
-    } while (0)
-    WEA_ENTRY('1', "١");
-    WEA_ENTRY('2', "٢");
-    WEA_ENTRY('3', "٣");
-    WEA_ENTRY('4', "٤");
-    WEA_ENTRY('5', "٥");
-    WEA_ENTRY('6', "٦");
-    WEA_ENTRY('7', "٧");
-    WEA_ENTRY('8', "٨");
-    WEA_ENTRY('9', "٩");
-    WEA_ENTRY('0', "٠");
-
-    easternArabicThSep = QString::fromUtf8(".")[0];
-    easternArabicDecSep = QString::fromUtf8(",")[0];
-}
-
-K_GLOBAL_STATIC(KuitFormatsStaticData, staticData)
-
-static QString insertIntegerSeparators (const QString &istr,
-                                        const QChar &sep, int ngrp)
-{
-    int len = istr.length();
-    int flen = (len / ngrp + 1) * (ngrp + 1);
-    QString fistr(flen, ' ');
-    for (int i = 0, fi = 0; i < len; ++i, ++fi) {
-        if (i > 0 && i % 3 == 0) {
-            fistr[flen - fi - 1] = sep;
-            ++fi;
-        }
-        fistr[flen - fi - 1] = istr[len - i - 1];
-    }
-    fistr = fistr.trimmed();
-    return fistr;
-}
-
-static QString toNumberGeneric (const QString &numstr,
-                                const QChar &thosep, const QChar &decsep,
-                                int thosepGE = 0)
-{
-    int len = numstr.length();
-    int p1 = 0;
-    while (p1 < len && !numstr[p1].isDigit()) {
-        ++p1;
-    }
-    if (p1 == len) {
-        return numstr;
-    }
-    int p2 = p1 + 1;
-    while (p2 < len && numstr[p2].isDigit()) {
-        ++p2;
-    }
-    QString intpart = numstr.mid(p1, p2 - p1);
-    int intval = intpart.toInt();
-
-    QString pre = numstr.left(p1);
-    QString mid = intpart;
-    if (intval >= thosepGE) {
-        mid = insertIntegerSeparators(intpart, thosep, 3);
-    }
-
-    QString post = numstr.mid(p2);
-    if (post.startsWith('.')) {
-        post[0] = decsep;
-    }
-
-    return pre + mid + post;
-}
-
-QString KuitFormats::toNumberSystem (const QString &numstr)
-{
-    return KGlobal::locale()->formatNumber(numstr, false);
-}
-
-QString KuitFormats::toNumberUS (const QString &numstr)
-{
-    return toNumberGeneric(numstr, ',', '.');
-}
-
-QString KuitFormats::toNumberEuro (const QString &numstr)
-{
-    return toNumberGeneric(numstr, '.', ',');
-}
-
-QString KuitFormats::toNumberEuro2 (const QString &numstr)
-{
-    return toNumberGeneric(numstr, ' ', ',');
-}
-
-QString KuitFormats::toNumberEuro2ct (const QString &numstr)
-{
-    return toNumberGeneric(numstr, ' ', ',', 10000);
-}
-
-// Translated from a Pascal implementation provided
-// by Youssef Chahibi <chahibi@gmail.com>
-QString KuitFormats::toNumberEArab (const QString &numstr)
-{
-    KuitFormatsStaticData *s = staticData;
-
-    const int power = 3;
-
-    // Construct string with proper separators, but Western Arabic digits.
-    QString sepnum;
-
-    // Find decimal separator in input.
-    int i = 0;
-    while ((i < numstr.length()) && (numstr[i] != '.')) {
-        ++i;
-    }
-
-    // Add thousand separators to integer part.
-    int j = power;
-    while (j < i) {
-        sepnum = s->easternArabicThSep + numstr.mid(i - j, power) + sepnum;
-        j += power;
-    }
-    sepnum = numstr.left(i + power - j) + sepnum;
-
-    // Add decimal part.
-    if (i + 1 < numstr.length()) {
-        sepnum += s->easternArabicDecSep + numstr.mid(i + 1);
-    }
-
-    // Add leading 0 if by any chance the input starts with decimal separator.
-    if (numstr.length() > 1 && numstr[0] == '.') {
-        sepnum = '0' + sepnum;
-    }
-
-    // Replace Western with Eastern Arabic digits in the separated string.
-    QString arnum;
-    for (int i = 0; i < sepnum.length(); ++i) {
-        arnum += s->westToEastArabicDigit.value(sepnum[i], sepnum[i]);
-    }
-
-    return arnum;
-}
-
 QString KuitFormats::toKeyCombo (const QString &shstr, const QString &delim,
                                  const QHash<QString, QString> &keydict)
 {
Index: kdecore/localization/klocale.cpp
===================================================================
--- kdecore/localization/klocale.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/localization/klocale.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -61,8 +61,22 @@
 #include <windows.h>
 #endif
 
-static const char *maincatalog = 0;
+class KLocaleStaticData
+{
+    public:
 
+    KLocaleStaticData ();
+
+    QString maincatalog;
+};
+
+KLocaleStaticData::KLocaleStaticData ()
+{
+}
+
+K_GLOBAL_STATIC(KLocaleStaticData, staticData)
+
+
 QDebug operator<<(QDebug debug, const KCatalogName &cn)
 {
     return debug << cn.name << cn.loadCount;
@@ -74,11 +88,8 @@
     KLocalePrivate(const QString& catalog, KConfig *config, const QString &language_ = QString(), const QString &country_ = QString());
   /**
    * @internal Initializes the catalogs appname, kdelibs and kio for all chosen languages.
-   *
-   * @param config The configuration object used for init
-   * @param useEnv True if we should use environment variables
    */
-  void initMainCatalogs(const QString & catalog);
+  void initMainCatalogs();
 
   /**
    * @internal Initializes the list of valid languages from the user's point of view. This is the list of
@@ -225,7 +236,7 @@
 
   QString calendarType;
   KCalendarSystem * calendar;
-  QString appName;
+  QString catalogName; // catalogName ("app name") used by this KLocale object
   bool nounDeclension:1;
   bool dateMonthNamePossessive:1;
   bool utf8FileEncoding:1;
@@ -238,7 +249,7 @@
     : language(language_),
       country(country_),
       useTranscript(false), codecForEncoding(0),
-      languages(0), calendar(0), appName(catalog)
+      languages(0), calendar(0), catalogName(catalog)
 {
     initEncoding();
     initFileNameEncoding();
@@ -251,7 +262,7 @@
         initLanguageList(config, true);
     }
 
-    initMainCatalogs(catalog);
+    initMainCatalogs();
 
     initFormat(config);
 }
@@ -266,21 +277,23 @@
 {
 }
 
-void KLocalePrivate::initMainCatalogs(const QString & catalog)
+void KLocalePrivate::initMainCatalogs()
 {
-  // Use the first non-null string.
-  QString mainCatalog = catalog;
-  if (maincatalog)
-    mainCatalog = QString::fromLatin1(maincatalog);
+  KLocaleStaticData *s = staticData;
 
-  if (mainCatalog.isEmpty()) {
+  if (!s->maincatalog.isEmpty()) {
+      // If setMainCatalog was called, then we use that (e.g. korgac calls setMainCatalog("korganizer") to use korganizer.po)
+      catalogName = s->maincatalog;
+  }
+
+  if (catalogName.isEmpty()) {
     kDebug(173) << "KLocale instance created called without valid "
                  << "catalog! Give an argument or call setMainCatalog "
                  << "before init" << endl;
   }
   else {
     // do not use insertCatalog here, that would already trigger updateCatalogs
-    catalogNames.append(KCatalogName(mainCatalog));   // application catalog
+    catalogNames.append(KCatalogName(catalogName));   // application catalog
 
     // catalogs from which each application can draw translations
     numberOfSysCatalogs = 4;
@@ -485,9 +498,7 @@
 
 bool KLocalePrivate::setLanguage(const QString & _language, KConfig *config)
 {
-  if ( languageList.contains( _language ) ) {
  	 languageList.removeAll( _language );
-  }
   languageList.prepend( _language ); // let us consider this language to be the most important one
 
   language = _language; // remember main language for shortcut evaluation
@@ -559,8 +570,9 @@
     return true;
   }
 
-  if (maincatalog) {
-    appName = QString::fromLatin1(maincatalog);
+  if (catalogName.isEmpty()) {
+      kDebug() << "no appName!";
+      return false;
   }
 
   // Check for this language and possible transliteration fallbacks.
@@ -568,7 +580,7 @@
   possibles += lang;
   possibles += KTranslit::fallbackList(lang);
   foreach (const QString &lang, possibles) {
-    if ( ! KCatalog::catalogLocaleDir( appName, lang ).isEmpty() ) {
+    if ( ! KCatalog::catalogLocaleDir( catalogName, lang ).isEmpty() ) {
         return true;
     }
   }
@@ -660,14 +672,16 @@
   // the sequence must be e.g. nds/appname nds/kdelibs nds/kio de/appname de/kdelibs de/kio etc.
   // and not nds/appname de/appname nds/kdelibs de/kdelibs etc. Otherwise we would be in trouble with a language
   // sequende nds,en_US, de. In this case en_US must hide everything below in the language list.
-  foreach ( const QString &lang, languageListFB )
-    foreach ( const KCatalogName &name, catalogNames )
+  foreach ( const QString &lang, languageListFB ) {
+    foreach ( const KCatalogName &name, catalogNames ) {
       // create and add catalog for this name and language if it exists
       if ( ! KCatalog::catalogLocaleDir( name.name, lang ).isEmpty() )
       {
         catalogs.append( KCatalog( name.name, lang ) );
         //kDebug(173) << "Catalog: " << name << ":" << lang;
       }
+    }
+  }
 
   // notify KLocalizedString of catalog update.
   KLocalizedString::notifyCatalogsUpdated(languageListFB, catalogNames);
@@ -1402,7 +1416,8 @@
 
 void KLocale::setMainCatalog(const char *catalog)
 {
-  maincatalog = catalog;
+  KLocaleStaticData *s = staticData;
+  s->maincatalog = QString::fromUtf8(catalog);
 }
 
 double KLocale::readNumber(const QString &_str, bool * ok) const
Index: kdecore/localization/kuitsemantics.cpp
===================================================================
--- kdecore/localization/kuitsemantics.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/localization/kuitsemantics.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -94,18 +94,11 @@
         } Var;
     }
 
-    namespace Numfmt { // number formats
-        typedef enum {
-            System, Posix, US, Euro, Euro2, Euro2ct, EArab
-        } Var;
-    }
-
     typedef Tag::Var TagVar;
     typedef Att::Var AttVar;
     typedef Rol::Var RolVar;
     typedef Cue::Var CueVar;
     typedef Fmt::Var FmtVar;
-    typedef Numfmt::Var NumfmtVar;
 }
 
 // -----------------------------------------------------------------------------
@@ -119,7 +112,6 @@
     QHash<QString, Kuit::AttVar> knownAtts;
     QHash<QString, Kuit::FmtVar> knownFmts;
     QHash<QString, Kuit::RolVar> knownRols;
-    QHash<QString, Kuit::NumfmtVar> knownNumfmts;
     QHash<QString, Kuit::CueVar> knownCues;
 
     QHash<Kuit::TagVar, QSet<Kuit::TagVar> > tagSubs;
@@ -138,9 +130,6 @@
     QHash<QString, QString> xmlEntitiesInverse;
 
     KuitSemanticsStaticData ();
-
-    int numfmtInt;
-    int numfmtReal;
 };
 
 KuitSemanticsStaticData::KuitSemanticsStaticData ()
@@ -309,19 +298,6 @@
     SETUP_TAG_NL(Bcode, 1);
     SETUP_TAG_NL(Item, 1);
 
-    // Setup names of number formats.
-    #undef SETUP_NUMFMT
-    #define SETUP_NUMFMT(numfmt, name) do { \
-        knownNumfmts[name] = Kuit::Numfmt::numfmt; \
-    } while (0)
-    SETUP_NUMFMT(System, "system");
-    SETUP_NUMFMT(Posix, "posix");
-    SETUP_NUMFMT(US, "us");
-    SETUP_NUMFMT(Euro, "euro");
-    SETUP_NUMFMT(Euro2, "euro2");
-    SETUP_NUMFMT(Euro2ct, "euro2ct");
-    SETUP_NUMFMT(EArab, "earab");
-
     // Known XML entities, direct/inverse mapping.
     xmlEntities["lt"] = '<';
     xmlEntities["gt"] = '>';
@@ -333,10 +309,6 @@
     xmlEntitiesInverse[QString('&')] = "amp";
     xmlEntitiesInverse[QString('\'')] = "apos";
     xmlEntitiesInverse[QString('"')] = "quot";
-
-    // Global setting for number formatting (<0 means no global setting).
-    numfmtInt = -1;
-    numfmtReal = -1;
 }
 
 K_GLOBAL_STATIC(KuitSemanticsStaticData, staticData)
@@ -432,9 +404,6 @@
           QHash<int, // attribute set key
                 QHash<Kuit::FmtVar, QString> > > m_patterns;
 
-    Kuit::NumfmtVar m_numfmtInt;
-    Kuit::NumfmtVar m_numfmtReal;
-
     QHash<Kuit::FmtVar, QString> m_comboKeyDelim;
     QHash<Kuit::FmtVar, QString> m_guiPathDelim;
 
@@ -814,87 +783,12 @@
                            "%1<br/>"));
 }
 
-static Kuit::NumfmtVar parseNumberFormat (const QString &fmtstr)
-{
-    KuitSemanticsStaticData *s = staticData;
-
-    KConfigGroup cg(KGlobal::config().data(), "Locale");
-    QString currctry = cg.readEntry("Country").toLower();
-    Kuit::NumfmtVar currfmt = Kuit::Numfmt::Posix;
-    foreach (const QString &ctryfmt, fmtstr.toLower().split(',')) {
-        QStringList lst = ctryfmt.split(':');
-        QString ctry, fmtname;
-        if (lst.size() == 2) {
-            ctry = lst[0];
-            fmtname = lst[1];
-        } else if (lst.size() == 1) {
-            fmtname = lst[0];
-        } else {
-            kDebug(173) << QString("Malformed number format specification "
-                                   "'%1' set in kdelibs4.po; "
-                                   "using POSIX format.").arg(ctryfmt);
-            return currfmt;
-        }
-        if (!s->knownNumfmts.contains(fmtname)) {
-            kDebug(173) << QString("Unknown number format '%1' set "
-                                   "in kdelibs4.po; "
-                                   "using POSIX format.").arg(fmtname);
-            return currfmt;
-        }
-        if (ctry == currctry) {
-            // Countries explicitly matched,
-            // use this format without futher lookup.
-            return s->knownNumfmts[fmtname];
-        } else if (ctry.isEmpty()) {
-            // Empty country states default format,
-            // unless an explicit country match is encountered later.
-            currfmt = s->knownNumfmts[fmtname];
-        }
-    }
-    return currfmt;
-}
-
 void KuitSemanticsPrivate::setTextTransformData ()
 {
-    KuitSemanticsStaticData *s = staticData;
-
     // Mask metaTr with I18N_NOOP2 to have stuff extracted.
     #undef I18N_NOOP2
     #define I18N_NOOP2(ctxt, msg) metaTr(ctxt, msg)
 
-    // i18n: Decide how integer-valued amounts will be formatted in this
-    // language. Currently available number formats are:
-    //   posix   - decimal point
-    //   us      - thousands separation by comma, decimal point
-    //   euro    - thousands separation by point, decimal comma
-    //   euro2   - thousands separation by space, decimal comma
-    //   euro2ct - as euro2, except thousand not separated when <10000
-    //   earab   - Eastern Arabic digits, th. sep. by point, dec. comma
-    //   system  - by locale settings (i.e. override language ortography)
-    // If none of the existing formats is appropriate for your language,
-    // write to kde-i18n-doc@kde.org to arrange for a new format.
-    // If different formats are used in different countries in which
-    // this language is spoken, format may be set per country like this:
-    //   "fmt,ctry1:fmt1,ctry2:fmt2,..."
-    // where fmt is the default, ctry1 uses fmt1, ctry2 uses fmt2, etc.
-    // (countries are given by their ISO 3166-1 alpha-2 code,
-    // see http://en.wikipedia.org/wiki/ISO_3166-1 for list of codes).
-    QString fmtstrInt = I18N_NOOP2("number-format:integer", "us");
-    m_numfmtInt = parseNumberFormat(fmtstrInt);
-
-    // i18n: Decide how real-valued amounts will be formatted in this
-    // language. See the comment to previous entry.
-    QString fmtstrReal = I18N_NOOP2("number-format:real", "us");
-    m_numfmtReal = parseNumberFormat(fmtstrReal);
-
-    // If adherence to locale settings requested, set it globally.
-    if (m_numfmtInt == Kuit::Numfmt::System) {
-        s->numfmtInt = Kuit::Numfmt::System;
-    }
-    if (m_numfmtReal == Kuit::Numfmt::System) {
-        s->numfmtReal = Kuit::Numfmt::System;
-    }
-
     // i18n: Decide which string is used to delimit keys in a keyboard
     // shortcut (e.g. + in Ctrl+Alt+Tab) in plain text.
     m_comboKeyDelim[Kuit::Fmt::Plain] = I18N_NOOP2("shortcut-key-delimiter/plain", "+");
@@ -1503,34 +1397,11 @@
                                              int numctx,
                                              Kuit::FmtVar fmt) const
 {
-    KuitSemanticsStaticData *s = staticData;
-
     // numctx < 1 means that the number is not in numeric-id context.
     if (   (tag == Kuit::Tag::NumIntg || tag == Kuit::Tag::NumReal) \
         && numctx < 1)
     {
-        int numfmt;
-        if (tag == Kuit::Tag::NumIntg) {
-            numfmt = s->numfmtInt >= 0 ? s->numfmtInt : m_numfmtInt;
-        } else {
-            numfmt = s->numfmtReal >= 0 ? s->numfmtReal : m_numfmtReal;
-        }
-        switch (numfmt) {
-        case Kuit::Numfmt::System:
-            return KuitFormats::toNumberSystem(text);
-        case Kuit::Numfmt::US:
-            return KuitFormats::toNumberUS(text);
-        case Kuit::Numfmt::Euro:
-            return KuitFormats::toNumberEuro(text);
-        case Kuit::Numfmt::Euro2:
-            return KuitFormats::toNumberEuro2(text);
-        case Kuit::Numfmt::Euro2ct:
-            return KuitFormats::toNumberEuro2ct(text);
-        case Kuit::Numfmt::EArab:
-            return KuitFormats::toNumberEArab(text);
-        default:
-            return text;
-        }
+        return KGlobal::locale()->formatNumber(text, false);
     }
     else if (tag == Kuit::Tag::Filename) {
         return QDir::toNativeSeparators(text);
Index: kdecore/localization/guess_ja_p.h
===================================================================
--- kdecore/localization/guess_ja_p.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/localization/guess_ja_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -42,6 +42,9 @@
 #ifdef Q_WS_WIN
 #undef UNICODE
 #endif 
+#ifdef SOLARIS
+#undef UNICODE
+#endif 
 namespace khtml {
     class guess_arc {
     public:
Index: kdecore/localization/kcatalog.cpp
===================================================================
--- kdecore/localization/kcatalog.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/localization/kcatalog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -23,6 +23,7 @@
 #include <config.h>
 
 #include <QtCore/QFile>
+#include <QMutexLocker>
 
 #include <kdebug.h>
 
@@ -59,6 +60,16 @@
 static const int langenvMaxlen = 42;
 // = "LANGUAGE=" + 32 chars for language code + terminating zero
 
+class KCatalogStaticData
+{
+public:
+    KCatalogStaticData() {}
+
+    QMutex mutex;
+};
+
+K_GLOBAL_STATIC(KCatalogStaticData, catalogStaticData)
+
 class KCatalogPrivate
 {
 public:
@@ -125,6 +136,7 @@
   // Update Gettext environment.
   // (Sometimes Gettext picks up wrong locale directory if bindings are not
   // updated here. No idea why that happens.)
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   d->resetSystemLanguage();
 
@@ -196,6 +208,7 @@
 
 QString KCatalog::translate(const char * msgid) const
 {
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   const char *msgstr = dgettext(d->name, msgid);
   d->resetSystemLanguage();
@@ -204,6 +217,7 @@
 
 QString KCatalog::translate(const char * msgctxt, const char * msgid) const
 {
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   const char *msgstr = dpgettext_expr(d->name, msgctxt, msgid);
   d->resetSystemLanguage();
@@ -213,6 +227,7 @@
 QString KCatalog::translate(const char * msgid, const char * msgid_plural,
                             unsigned long n) const
 {
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   const char *msgstr = dngettext(d->name, msgid, msgid_plural, n);
   d->resetSystemLanguage();
@@ -222,6 +237,7 @@
 QString KCatalog::translate(const char * msgctxt, const char * msgid,
                             const char * msgid_plural, unsigned long n) const
 {
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   const char *msgstr = dnpgettext_expr(d->name, msgctxt, msgid, msgid_plural, n);
   d->resetSystemLanguage();
@@ -230,6 +246,7 @@
 
 QString KCatalog::translateStrict(const char * msgid) const
 {
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   const char *msgstr = dgettext(d->name, msgid);
   d->resetSystemLanguage();
@@ -238,6 +255,7 @@
 
 QString KCatalog::translateStrict(const char * msgctxt, const char * msgid) const
 {
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   const char *msgstr = dpgettext_expr(d->name, msgctxt, msgid);
   d->resetSystemLanguage();
@@ -247,6 +265,7 @@
 QString KCatalog::translateStrict(const char * msgid, const char * msgid_plural,
                                   unsigned long n) const
 {
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   const char *msgstr = dngettext(d->name, msgid, msgid_plural, n);
   d->resetSystemLanguage();
@@ -256,6 +275,7 @@
 QString KCatalog::translateStrict(const char * msgctxt, const char * msgid,
                                   const char * msgid_plural, unsigned long n) const
 {
+  QMutexLocker locker(&catalogStaticData->mutex);
   d->setupGettextEnv();
   const char *msgstr = dnpgettext_expr(d->name, msgctxt, msgid, msgid_plural, n);
   d->resetSystemLanguage();
Index: kdecore/localization/kuitformats_p.h
===================================================================
--- kdecore/localization/kuitformats_p.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/localization/kuitformats_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -25,48 +25,6 @@
 
 namespace KuitFormats {
     /**
-     * Reformat raw number string according to locale settings.
-     * @param numstr raw number string
-     * @returns number string in proper format
-     */
-    QString toNumberSystem (const QString &numstr);
-
-    /**
-     * Reformat raw number string to US standard.
-     * @param numstr raw number string
-     * @returns number string in proper format
-     */
-    QString toNumberUS (const QString &numstr);
-
-    /**
-     * Reformat raw number string to Euro standard.
-     * @param numstr raw number string
-     * @returns number string in proper format
-     */
-    QString toNumberEuro (const QString &numstr);
-
-    /**
-     * Reformat raw number string to Euro2 standard.
-     * @param numstr raw number string
-     * @returns number string in proper format
-     */
-    QString toNumberEuro2 (const QString &numstr);
-
-    /**
-     * Reformat raw number string to Euro2ct standard.
-     * @param numstr raw number string
-     * @returns number string in proper format
-     */
-    QString toNumberEuro2ct (const QString &numstr);
-
-    /**
-     * Reformat raw number string to Eastern Arabic standard.
-     * @param numstr raw number string
-     * @returns number string in proper format
-     */
-    QString toNumberEArab (const QString &numstr);
-
-    /**
      * Reformat keyboard shortcut. The first of encountered of '+' or '-'
      * is taken for key delimiter, and the supplied delimiter is used instead.
      * A dictionary of replacement key names can also be provided, which can
Index: kdecore/network/ktcpsocket.cpp
===================================================================
--- kdecore/network/ktcpsocket.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/network/ktcpsocket.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -23,6 +23,7 @@
 #include <kurl.h>
 #include <kglobal.h>
 #include <kstandarddirs.h>
+#include <klocale.h>
 
 #include <QtCore/QMutex>
 #include <QtCore/QStringList>
@@ -172,34 +173,34 @@
     {                                                                   
         switch (e) {                                                    
         case KSslError::NoError:                                        
-            return "No error";                                          
+            return i18nc("SSL error","No error");                                          
         case KSslError::InvalidCertificateAuthorityCertificate:         
-            return "The certificate authority's certificate is invalid";
+            return i18nc("SSL error","The certificate authority's certificate is invalid");
         case KSslError::ExpiredCertificate:                             
-            return "The certificate has expired";                       
+            return i18nc("SSL error","The certificate has expired");                       
         case KSslError::InvalidCertificate:                             
-            return "The certificate is invalid";                        
+            return i18nc("SSL error","The certificate is invalid");                        
         case KSslError::SelfSignedCertificate:                          
-            return "The certificate is not signed by any trusted certificate authority";
+            return i18nc("SSL error","The certificate is not signed by any trusted certificate authority");
         case KSslError::RevokedCertificate:                                             
-            return "The certificate has been revoked";                                  
+            return i18nc("SSL error","The certificate has been revoked");                                  
         case KSslError::InvalidCertificatePurpose:                                      
-            return "The certificate is unsuitable for this purpose";                    
+            return i18nc("SSL error","The certificate is unsuitable for this purpose");                    
         case KSslError::UntrustedCertificate:                                           
-            return "The root certificate authority's certificate is not trusted for this purpose";
+            return i18nc("SSL error","The root certificate authority's certificate is not trusted for this purpose");
         case KSslError::RejectedCertificate:                                                      
-            return "The certificate authority's certificate is marked to reject this certificate's purpose";
+            return i18nc("SSL error","The certificate authority's certificate is marked to reject this certificate's purpose");
         case KSslError::NoPeerCertificate:                                                                  
-            return "The peer did not present any certificate";                                              
+            return i18nc("SSL error","The peer did not present any certificate");                                              
         case KSslError::HostNameMismatch:                                                                   
-            return "The certificate does not apply to the given host";                                      
+            return i18nc("SSL error","The certificate does not apply to the given host");                                      
         case KSslError::CertificateSignatureFailed:                                                         
-            return "The certificate cannot be verified for internal reasons";                               
+            return i18nc("SSL error","The certificate cannot be verified for internal reasons");                               
         case KSslError::PathLengthExceeded:                                                                 
-            return "The certificate chain is too long";                                                     
+            return i18nc("SSL error","The certificate chain is too long");                                                     
         case KSslError::UnknownError:                                                                       
         default:                                                                                            
-            return "Unknown error";                                                                         
+            return i18nc("SSL error","Unknown error");                                                                         
         }                                                                                                   
     }                                                                                                       
              
Index: kdecore/tests/kdebug_unittest.cpp
===================================================================
--- kdecore/tests/kdebug_unittest.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 0)
+++ kdecore/tests/kdebug_unittest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -0,0 +1,94 @@
+/* This file is part of the KDE libraries
+    Copyright (c) 2009 David Faure <faure@kde.org>
+
+    This library is free software; you can redistribute it and/or modify
+    it under the terms of the GNU Lesser General Public License as published by
+    the Free Software Foundation; either version 2 of the License or ( at
+    your option ) version 3 or, at the discretion of KDE e.V. ( which shall
+    act as a proxy as in section 14 of the GPLv3 ), any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#include "kdebug_unittest.h"
+#include <kconfig.h>
+#include <kconfiggroup.h>
+#include <qtest_kde.h>
+#include <kdebug.h>
+#include <kstandarddirs.h>
+#include "kdebug_unittest.moc"
+
+QTEST_KDEMAIN_CORE( KDebugTest )
+
+void KDebugTest::initTestCase()
+{
+    QString kdebugrc = KStandardDirs::locateLocal("config", "kdebugrc");
+    if (!kdebugrc.isEmpty())
+        QFile::remove(kdebugrc);
+    QFile::remove("kdebug.dbg");
+
+    // Now set up logging to file
+    KConfig config("kdebugrc");
+    config.group("0").writeEntry("InfoOutput", 0 /*FileOutput*/);
+    config.group("126").writeEntry("InfoOutput", 0 /*FileOutput*/);
+    config.sync();
+
+    kClearDebugConfig();
+}
+
+static QList<QByteArray> readLines(const char* fileName = "kdebug.dbg")
+{
+    const QString path = QFile::decodeName(fileName);
+    Q_ASSERT(!path.isEmpty());
+    QFile file(path);
+    Q_ASSERT(file.open(QIODevice::ReadOnly));
+    QList<QByteArray> lines;
+    QByteArray line;
+    do {
+        line = file.readLine();
+        if (!line.isEmpty())
+            lines.append(line);
+    } while(!line.isEmpty());
+    return lines;
+}
+
+void KDebugTest::testDebugToFile()
+{
+    kDebug(126) << "TEST DEBUG 126";
+    kDebug(0) << "TEST DEBUG 0";
+    QVERIFY(QFile::exists("kdebug.dbg"));
+    QList<QByteArray> lines = readLines();
+    QCOMPARE(lines.count(), 2);
+    //qDebug() << lines[0];
+    QVERIFY(lines[0].endsWith(" \n")); // Hmm. Something adds a trailing space.
+    QVERIFY(lines[0].endsWith("/kdecore (KUrl) KDebugTest::testDebugToFile: TEST DEBUG 126 \n"));
+    QVERIFY(lines[1].endsWith("KDebugTest::testDebugToFile: TEST DEBUG 0 \n"));
+}
+
+void KDebugTest::testDisableArea()
+{
+    QFile::remove("kdebug.dbg");
+    KConfig config("kdebugrc");
+    config.group("126").writeEntry("InfoOutput", 4 /*NoOutput*/);
+    config.group("0").writeEntry("InfoOutput", 4 /*NoOutput*/);
+    config.sync();
+    kClearDebugConfig();
+    kDebug(126) << "TEST DEBUG 126 - SHOULD NOT APPEAR";
+    kDebug(0) << "TEST DEBUG 0 - SHOULD NOT APPEAR";
+    QVERIFY(!QFile::exists("kdebug.dbg"));
+}
+
+void KDebugTest::cleanupTestCase()
+{
+    QString kdebugrc = KStandardDirs::locateLocal("config", "kdebugrc");
+    if (!kdebugrc.isEmpty())
+        QFile::remove(kdebugrc);
+}
Index: kdecore/tests/kdebug_unittest.h
===================================================================
--- kdecore/tests/kdebug_unittest.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 0)
+++ kdecore/tests/kdebug_unittest.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -0,0 +1,37 @@
+/* This file is part of the KDE libraries
+    Copyright (c) 2009 David Faure <faure@kde.org>
+
+    This library is free software; you can redistribute it and/or modify
+    it under the terms of the GNU Lesser General Public License as published by
+    the Free Software Foundation; either version 2 of the License or ( at
+    your option ) version 3 or, at the discretion of KDE e.V. ( which shall
+    act as a proxy as in section 14 of the GPLv3 ), any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KDEBUGTEST_H
+#define KDEBUGTEST_H
+
+#include <QtCore/QObject>
+
+class KDebugTest : public QObject
+{
+    Q_OBJECT
+
+private Q_SLOTS:
+    void initTestCase();
+    void testDebugToFile();
+    void testDisableArea();
+    void cleanupTestCase();
+};
+
+#endif
Index: kdecore/tests/kconfigtest.cpp
===================================================================
--- kdecore/tests/kconfigtest.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/tests/kconfigtest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -1103,6 +1103,20 @@
     QCOMPARE(newStamp, oldStamp);
 }
 
+void KConfigTest::testDirtyOnEqualOverdo()
+{
+    QByteArray val1("\0""one", 4);
+    QByteArray val2("\0""two", 4);
+    QByteArray defvalr;
+
+    KConfig sc("kconfigtest");
+    KConfigGroup cgLocal(&sc, "random");
+    cgLocal.writeEntry("someKey", val1);
+    QCOMPARE(cgLocal.readEntry("someKey", defvalr), val1);
+    cgLocal.writeEntry("someKey", val2);
+    QCOMPARE(cgLocal.readEntry("someKey", defvalr), val2);
+}
+
 QList<QByteArray> KConfigTest::readLines()
 {
     const QString path = KStandardDirs::locateLocal("config", "kconfigtest");
Index: kdecore/tests/kconfigtest.h
===================================================================
--- kdecore/tests/kconfigtest.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/tests/kconfigtest.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -62,6 +62,7 @@
     void testAddConfigSources();
     void testWriteOnSync();
     void testDirtyOnEqual();
+    void testDirtyOnEqualOverdo();
     void testCreateDir();
     void testSharedConfig();
     void testOptionOrder();
Index: kdecore/tests/CMakeLists.txt
===================================================================
--- kdecore/tests/CMakeLists.txt	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/tests/CMakeLists.txt	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -56,6 +56,7 @@
  kconfigafterkglobaltest1
  kconfigafterkglobaltest2
  ktcpsockettest
+ kdebug_unittest
 )
 
 if(UNIX)
Index: kdecore/config/kconfigdata.h
===================================================================
--- kdecore/config/kconfigdata.h	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/config/kconfigdata.h	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -69,7 +69,7 @@
 {
     return k1.bGlobal == k2.bGlobal && k1.bImmutable == k2.bImmutable
            && k1.bDeleted == k2.bDeleted && k1.bExpand == k2.bExpand
-           && !qstrcmp(k1.mValue.constData(), k2.mValue.constData());
+           && k1.mValue == k2.mValue;
 }
 
 inline bool operator !=(const KEntry &k1, const KEntry &k2)
Index: kdecore/all_languages.desktop
===================================================================
--- kdecore/all_languages.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/all_languages.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -257,8 +257,8 @@
 Name[uz]=Afrikancha
 Name[uz@cyrillic]=Африканча
 Name[vi]=Hoà Nam Phi
+Name[xh]=Isibhulu
 Name[x-test]=xxAfrikaansxx
-Name[xh]=Isibhulu
 Name[zh_CN]=南非荷兰语
 Name[zh_HK]=南非荷蘭語
 Name[zh_TW]=南非荷蘭語
@@ -2314,8 +2314,8 @@
 Name[uz@cyrillic]=Олмонча
 Name[vi]=Đức
 Name[wa]=Almand
+Name[xh]=Isijamani
 Name[x-test]=xxGermanxx
-Name[xh]=Isijamani
 Name[zh_CN]=德语
 Name[zh_HK]=德語
 Name[zh_TW]=德語
@@ -2506,8 +2506,8 @@
 Name[uz@cyrillic]=Юнонча
 Name[vi]=Hy-lạp
 Name[wa]=Grek
+Name[xh]=isigrike
 Name[x-test]=xxGreekxx
-Name[xh]=isigrike
 Name[zh_CN]=希腊语
 Name[zh_HK]=希臘語
 Name[zh_TW]=希臘語
@@ -2592,8 +2592,8 @@
 Name[uz@cyrillic]=Инглизча
 Name[vi]=Anh
 Name[wa]=Inglès
+Name[xh]=Isingesi
 Name[x-test]=xxEnglishxx
-Name[xh]=Isingesi
 Name[zh_CN]=英语
 Name[zh_HK]=英語
 Name[zh_TW]=英語
@@ -2892,8 +2892,8 @@
 Name[uz@cyrillic]=Испанча
 Name[vi]=Tây-ban-nha
 Name[wa]=Castiyan
+Name[xh]=Isipanishi
 Name[x-test]=xxSpanishxx
-Name[xh]=Isipanishi
 Name[zh_CN]=西班牙语
 Name[zh_HK]=西班牙語
 Name[zh_TW]=西班牙語
@@ -3465,8 +3465,8 @@
 Name[uz@cyrillic]=Французча
 Name[vi]=Pháp
 Name[wa]=Francès
+Name[xh]=Isifrentshi
 Name[x-test]=xxFrenchxx
-Name[xh]=Isifrentshi
 Name[zh_CN]=法语
 Name[zh_HK]=法語
 Name[zh_TW]=法語
@@ -3779,8 +3779,8 @@
 Name[uz@cyrillic]=Галикча
 Name[vi]=Ga-li-ci
 Name[wa]=Galicyin
+Name[xh]=isiGalacian
 Name[x-test]=xxGalicianxx
-Name[xh]=isiGalacian
 Name[zh_CN]=加利西亚语
 Name[zh_TW]=加利西亞語
 [gn]
@@ -4086,8 +4086,8 @@
 Name[uz@cyrillic]=Яҳудийча
 Name[vi]=Do-thái
 Name[wa]=Ebreu
+Name[xh]=Isihebhere
 Name[x-test]=xxHebrewxx
-Name[xh]=Isihebhere
 Name[zh_CN]=希伯来语
 Name[zh_HK]=希伯來語
 Name[zh_TW]=希伯來語
@@ -5038,8 +5038,8 @@
 Name[uz@cyrillic]=Италянча
 Name[vi]=Ý
 Name[wa]=Itålyin
+Name[xh]=isitaliyane
 Name[x-test]=xxItalianxx
-Name[xh]=isitaliyane
 Name[zh_CN]=意大利语
 Name[zh_HK]=意大利語
 Name[zh_TW]=義大利語
@@ -5169,8 +5169,8 @@
 Name[uz@cyrillic]=Японча
 Name[vi]=Nhật
 Name[wa]=Djaponès
+Name[xh]=Isijapani
 Name[x-test]=xxJapanesexx
-Name[xh]=Isijapani
 Name[zh_CN]=日语
 Name[zh_HK]=日語
 Name[zh_TW]=日語
@@ -5702,8 +5702,8 @@
 Name[uz@cyrillic]=Корейсча
 Name[vi]=Triều-tiên
 Name[wa]=Coreyin
+Name[xh]=Isikorea
 Name[x-test]=xxKoreanxx
-Name[xh]=Isikorea
 Name[zh_CN]=韩语
 Name[zh_HK]=韓國語
 Name[zh_TW]=韓國語
@@ -6558,8 +6558,8 @@
 Name[uz@cyrillic]=Латишча
 Name[vi]=Lát-vi-a
 Name[wa]=Letonyin
+Name[xh]=Isilatvian
 Name[x-test]=xxLatvianxx
-Name[xh]=Isilatvian
 Name[zh_CN]=拉脱维亚语
 Name[zh_HK]=拉脫維亞語
 Name[zh_TW]=拉脫維亞語
@@ -7626,8 +7626,8 @@
 Name[uz@cyrillic]=Ндебеле, Шимол
 Name[vi]=N-đe-be-lê (Bắc)
 Name[wa]=Ndebele (bijhe)
+Name[xh]=Isindebele, Emntla
 Name[x-test]=xxNdebele, Northxx
-Name[xh]=Isindebele, Emntla
 Name[zh_CN]=恩德贝莱语(北部)
 Name[zh_HK]=Ndebele語，北部
 Name[zh_TW]=Ndebele語，北部
@@ -7906,8 +7906,8 @@
 Name[uz@cyrillic]=Голландча
 Name[vi]=Hoà-lan
 Name[wa]=Neyerlandès
+Name[xh]=Isidatshi
 Name[x-test]=xxDutchxx
-Name[xh]=Isidatshi
 Name[zh_CN]=荷兰语
 Name[zh_HK]=荷蘭語
 Name[zh_TW]=荷蘭語
@@ -8069,8 +8069,8 @@
 Name[uz@cyrillic]=Ндебеле, Жануб
 Name[vi]=N-đe-be-lê (Nam)
 Name[wa]=Ndebele (nonne)
+Name[xh]=Isindebele, Emazantsi
 Name[x-test]=xxNdebele, Southxx
-Name[xh]=Isindebele, Emazantsi
 Name[zh_CN]=恩德贝莱语(南部)
 Name[zh_HK]=Ndebele語，南部
 Name[zh_TW]=Ndebele語，南部
@@ -9286,8 +9286,8 @@
 Name[uz@cyrillic]=Русча
 Name[vi]=Nga
 Name[wa]=Rûsse
+Name[xh]=Isirashiya
 Name[x-test]=xxRussianxx
-Name[xh]=Isirashiya
 Name[zh_CN]=俄语
 Name[zh_HK]=俄語
 Name[zh_TW]=俄語
@@ -9623,8 +9623,8 @@
 Name[uz@cyrillic]=Шимолий Сами
 Name[vi]=Xa-mi (Bắc)
 Name[wa]=Bijhe såmi
+Name[xh]=Sami Yasemntla
 Name[x-test]=xxNorthern Samixx
-Name[xh]=Sami Yasemntla
 Name[zh_CN]=北萨米语
 Name[zh_HK]=北薩米語
 Name[zh_TW]=北薩米語
@@ -9833,8 +9833,8 @@
 Name[uz@cyrillic]=Словакча
 Name[vi]=Xlô-vák
 Name[wa]=Eslovake
+Name[xh]=isiSlovak
 Name[x-test]=xxSlovakxx
-Name[xh]=isiSlovak
 Name[zh_CN]=斯洛伐克语
 Name[zh_HK]=斯洛伐克語
 Name[zh_TW]=斯洛伐克語
@@ -10047,8 +10047,8 @@
 Name[uk]=Шона
 Name[uz@cyrillic]=Шона
 Name[vi]=Sô-na
+Name[xh]=Isishona
 Name[x-test]=xxShonaxx
-Name[xh]=Isishona
 Name[zh_CN]=修纳语
 Name[zh_HK]=Shona語
 Name[zh_TW]=Shona語
@@ -10421,8 +10421,8 @@
 Name[uz@cyrillic]=Свати
 Name[vi]=Xouă-ti
 Name[wa]=Suwati
+Name[xh]=Isiswati
 Name[x-test]=xxSwatixx
-Name[xh]=Isiswati
 Name[zh_CN]=斯瓦蒂语
 Name[zh_HK]=Swati語
 Name[zh_TW]=Swati語
@@ -10503,8 +10503,8 @@
 Name[uz@cyrillic]=Сотхо, Жанубий
 Name[vi]=Xô-tô (nam)
 Name[wa]=Soto (nonne)
+Name[xh]=Isisuthu, Sasemzantsi
 Name[x-test]=xxSotho, Southernxx
-Name[xh]=Isisuthu, Sasemzantsi
 Name[zh_CN]=索托语(南部)
 Name[zh_HK]=梭托語，南部
 Name[zh_TW]=梭托語，南部
@@ -11181,8 +11181,8 @@
 Name[uz]=Tsvana
 Name[uz@cyrillic]=Тсвана
 Name[vi]=T-xouă-nă
+Name[xh]=Isitswana
 Name[x-test]=xxTswanaxx
-Name[xh]=Isitswana
 Name[zh_CN]=茨瓦纳语
 Name[zh_HK]=班圖語
 Name[zh_TW]=班圖語
@@ -11714,8 +11714,8 @@
 Name[uz@cyrillic]=Украинча
 Name[vi]=U-cợ-rainh
 Name[wa]=Oucrinnyin
+Name[xh]=Ukranian
 Name[x-test]=xxUkrainianxx
-Name[xh]=Ukranian
 Name[zh_CN]=乌克兰语
 Name[zh_HK]=烏克蘭語
 Name[zh_TW]=烏克蘭語
@@ -12268,8 +12268,8 @@
 Name[uz@cyrillic]=Хҳоса
 Name[vi]=Xô-xa
 Name[wa]=Xhossa
+Name[xh]=isixhosa
 Name[x-test]=xxXhosaxx
-Name[xh]=isixhosa
 Name[zh_CN]=科萨语
 Name[zh_HK]=科薩語
 Name[zh_TW]=科薩語
@@ -12523,8 +12523,8 @@
 Name[uz@cyrillic]=Хитойча
 Name[vi]=Hoa
 Name[wa]=Chinwès
+Name[xh]=Isitshayina
 Name[x-test]=xxChinesexx
-Name[xh]=Isitshayina
 Name[zh_CN]=中文
 Name[zh_HK]=中文
 Name[zh_TW]=中文
@@ -12830,8 +12830,8 @@
 Name[uz@cyrillic]=Зулуча
 Name[vi]=Xu-lu
 Name[wa]=Zoulou
+Name[xh]=Isizulu
 Name[x-test]=xxZuluxx
-Name[xh]=Isizulu
 Name[zh_CN]=祖鲁语
 Name[zh_HK]=袓魯語
 Name[zh_TW]=袓魯語
Index: kdecore/io/kdebug.cpp
===================================================================
--- kdecore/io/kdebug.cpp	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ kdecore/io/kdebug.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -234,7 +234,7 @@
         cache.clear();
 
         Area &areaData = cache[0];
-        areaData.clear(QtOutput);
+        areaData.clear();
 
         //AB: this is necessary here, otherwise all output with area 0 won't be
         //prefixed with anything, unless something with area != 0 is called before
@@ -358,12 +358,14 @@
             loadAreaNames();
         }
 
-        if (!cache.contains(num))
+        if (!cache.contains(num)) {
             // unknown area
             return cache.find(0);
+        }
 
         int l = level(type);
         Cache::Iterator it = cache.find(num);
+        //qDebug() << "in cache for" << num << ":" << it->mode[l];
         if (it->mode[l] == Unknown)
             it->mode[l] = areaOutputMode(type, num);
         if (it->mode[l] == FileOutput && it->logFileName[l].isEmpty())
Index: plasma/servicetypes/plasma-scriptengine.desktop
===================================================================
--- plasma/servicetypes/plasma-scriptengine.desktop	(.../tags/KDE/4.2.3/kdelibs)	(wersja 974229)
+++ plasma/servicetypes/plasma-scriptengine.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 974229)
@@ -11,7 +11,7 @@
 Comment[da]=Scriptsprog-udvidelse til Plasma
 Comment[de]=Skriptsprachen-Erweiterung für Plasma
 Comment[el]=Επέκταση γλώσσας σεναρίων για το Plasma
-Comment[es]=Extensión de lenguaje de guiones para Plasma
+Comment[es]=Extensión de lenguaje de scripts para Plasma
 Comment[et]=Skriptikeele laiendus Plasmale
 Comment[eu]=Plasmarako script lengoaien gehigarria
 Comment[fi]=Skriptauskielituki Plasmalle

Zmiany atrybutów dla: .
___________________________________________________________________
Dodane: svn:externals
   + 


